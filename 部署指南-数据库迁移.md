# 数据库迁移部署指南

## 问题描述

服务器部署后出现错误：
```
获取学员详情失败：Unexpected token '<', "<!DOCTYPE "... is not valid JSON
```

**根本原因**：服务器数据库缺少 `communication_records` 表的 `user_id` 字段。

## 解决方案

### 步骤 1：连接到服务器

```bash
ssh your_username@47.100.238.50
```

### 步骤 2：进入项目目录

```bash
cd /path/to/CRM1  # 替换为实际的项目路径
```

### 步骤 3：激活虚拟环境

```bash
source venv/bin/activate
```

### 步骤 4：运行数据库迁移脚本

```bash
python add_user_id_to_communications.py
```

**预期输出**：
```
正在检查 user_id 字段...
正在添加 user_id 字段...
✅ user_id 字段添加成功
```

或者（如果字段已存在）：
```
正在检查 user_id 字段...
✅ user_id 字段已存在，无需添加
```

### 步骤 5：重启服务

根据您的部署方式选择：

#### 如果使用 systemd：
```bash
sudo systemctl restart crm
```

#### 如果使用 supervisor：
```bash
sudo supervisorctl restart crm
```

#### 如果直接运行 Flask：
```bash
# 先停止当前进程
pkill -f "python run.py"

# 重新启动
nohup python run.py > logs/app.log 2>&1 &
```

### 步骤 6：验证修复

1. 打开浏览器访问：http://47.100.238.50
2. 登录系统（使用管理员账号：13900139001）
3. 进入线索列表页
4. 点击任意学员姓名
5. 确认学员详情弹窗正常显示，没有 JSON 错误

## 迁移脚本说明

**文件名**：`add_user_id_to_communications.py`

**功能**：
- 检查 `communication_records` 表是否已有 `user_id` 字段
- 如果没有，则添加该字段（INTEGER 类型，可为空）
- 兼容历史数据（历史记录的 user_id 为 NULL）

**安全性**：
- ✅ 幂等操作：可以重复运行，不会重复添加字段
- ✅ 不影响现有数据：只添加新字段，不修改现有记录
- ✅ 向后兼容：user_id 可为空，历史数据显示"未知"

## 常见问题

### Q1：如果迁移脚本运行失败怎么办？

**检查错误信息**：
```bash
python add_user_id_to_communications.py 2>&1 | tee migration.log
```

**常见错误**：
1. **数据库文件权限问题**：
   ```bash
   sudo chown your_username:your_username instance/crm.db
   ```

2. **虚拟环境未激活**：
   ```bash
   source venv/bin/activate
   ```

3. **依赖包缺失**：
   ```bash
   pip install -r requirements.txt
   ```

### Q2：如何确认字段已添加成功？

**方法 1：使用 Python 检查**
```bash
python -c "
from run import create_app
from models import db
from sqlalchemy import text

app = create_app('production')

with app.app_context():
    result = db.session.execute(text('PRAGMA table_info(communication_records)'))
    columns = [row[1] for row in result]
    
    if 'user_id' in columns:
        print('✅ user_id 字段存在')
    else:
        print('❌ user_id 字段不存在')
"
```

**方法 2：使用 SQLite 命令行**
```bash
sqlite3 instance/crm.db "PRAGMA table_info(communication_records);"
```

查找输出中是否有 `user_id` 字段。

### Q3：迁移后历史数据怎么办？

**历史数据处理**：
- 历史沟通记录的 `user_id` 为 NULL
- 前端显示为"未知"（灰色文字）
- 不影响功能使用
- 新增的沟通记录会自动记录填写人

**如果需要补充历史数据的填写人**：
```python
# 这是可选操作，不是必需的
from run import create_app
from models import db, CommunicationRecord, Lead

app = create_app('production')

with app.app_context():
    # 将所有 user_id 为 NULL 的记录设置为对应线索的责任销售
    records = CommunicationRecord.query.filter_by(user_id=None).all()
    
    for record in records:
        lead = Lead.query.get(record.lead_id)
        if lead and lead.sales_user_id:
            record.user_id = lead.sales_user_id
    
    db.session.commit()
    print(f'✅ 已更新 {len(records)} 条历史记录')
```

## 备份建议

**在运行迁移前，建议备份数据库**：

```bash
# 备份数据库文件
cp instance/crm.db instance/crm.db.backup.$(date +%Y%m%d_%H%M%S)

# 验证备份
ls -lh instance/crm.db*
```

**恢复备份**（如果需要）：
```bash
# 停止服务
sudo systemctl stop crm

# 恢复备份
cp instance/crm.db.backup.20251004_150000 instance/crm.db

# 重启服务
sudo systemctl start crm
```

## 部署检查清单

- [ ] 连接到服务器
- [ ] 进入项目目录
- [ ] 激活虚拟环境
- [ ] 备份数据库
- [ ] 运行迁移脚本
- [ ] 确认迁移成功
- [ ] 重启服务
- [ ] 测试学员详情页
- [ ] 测试新增沟通记录
- [ ] 确认填写人显示正常

## 联系方式

如果遇到问题，请检查：
1. 服务器日志：`tail -f logs/app.log`
2. 数据库文件权限：`ls -l instance/crm.db`
3. 虚拟环境状态：`which python`

---

**最后更新**：2025-10-04
**版本**：v1.0

