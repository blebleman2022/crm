# 字段存储说明文档

**文档版本**: v2.0
**更新时间**: 2025-09-30
**系统**: EduConnect CRM

> ⚠️ **重要更新**: 根据实际业务流程，`competition_award_level` 和 `additional_requirements` 字段已恢复到线索表，销售可以在线索阶段直接设置这些字段。

---

## 📋 概述

本文档详细说明了EduConnect CRM系统中各个关键字段的存储方式，包括服务类型、竞赛等级和额外要求等字段。

---

## 🗂️ 数据表结构

### 线索表 (leads)

**用途**: 存储销售阶段的线索信息

**关键字段**:
- `service_types` - 服务类型（JSON格式）
- `sales_user_id` - 责任销售ID
- `stage` - 线索阶段
- `contract_amount` - 合同金额

### 客户表 (customers)

**用途**: 存储交付阶段的客户信息

**关键字段**:
- `lead_id` - 关联线索ID（外键）
- `teacher_user_id` - 责任班主任ID
- `competition_award_level` - 竞赛奖项等级
- `additional_requirements` - 额外要求
- `exam_year` - 中考或高考年份

---

## 📊 字段详细说明

### 1. 服务类型 (service_types)

#### 存储位置
**表**: `leads` (线索表)  
**字段**: `service_types`  
**类型**: `TEXT`

#### 存储格式
**JSON字符串数组**

```json
["tutoring", "competition", "upgrade_guidance"]
```

#### 可选值
| 值 | 中文名称 | 说明 |
|---|---------|------|
| `tutoring` | 课题辅导 | 科研课题辅导服务 |
| `competition` | 竞赛辅导 | 竞赛奖项辅导服务 |
| `upgrade_guidance` | 升学陪跑 | 升学规划陪跑服务 |

#### 实际存储示例

**示例1: 单个服务**
```python
# 数据库存储
service_types = '["tutoring"]'

# 解析后
['tutoring']  # 只有课题辅导
```

**示例2: 多个服务**
```python
# 数据库存储
service_types = '["tutoring", "competition", "upgrade_guidance"]'

# 解析后
['tutoring', 'competition', 'upgrade_guidance']  # 三种服务都有
```

**示例3: 两个服务**
```python
# 数据库存储
service_types = '["tutoring", "competition"]'

# 解析后
['tutoring', 'competition']  # 课题辅导 + 竞赛辅导
```

#### 读取方式

**方式1: 直接读取（需要手动解析JSON）**
```python
lead = Lead.query.get(1)
service_types_str = lead.service_types  # '["tutoring", "competition"]'

import json
service_list = json.loads(service_types_str)  # ['tutoring', 'competition']
```

**方式2: 使用辅助方法（推荐）**
```python
lead = Lead.query.get(1)
service_list = lead.get_service_types_list()  # ['tutoring', 'competition']
```

**方式3: 从客户表读取（通过关联关系）**
```python
customer = Customer.query.get(1)
service_list = customer.get_service_types()  # 从关联的线索表读取
```

#### 设置方式

**方式1: 直接设置JSON字符串**
```python
import json
lead.service_types = json.dumps(['tutoring', 'competition'])
```

**方式2: 使用辅助方法（推荐）**
```python
lead.set_service_types_list(['tutoring', 'competition'])
```

#### 检查是否包含某个服务

```python
lead = Lead.query.get(1)

# 检查是否包含课题辅导
if lead.has_service_type('tutoring'):
    print("包含课题辅导服务")

# 检查是否包含竞赛辅导
if lead.has_service_type('competition'):
    print("包含竞赛辅导服务")
```

---

### 2. 竞赛奖项等级 (competition_award_level)

#### 存储位置
**表**: `leads` (线索表) + `customers` (客户表)
**字段**: `competition_award_level`
**类型**: `VARCHAR(20)`

> ✨ **v2.0更新**: 该字段已恢复到线索表，销售可以在线索阶段设置，转客户时自动复制到客户表。

#### 存储格式
**普通字符串**

#### 可选值
| 值 | 说明 |
|---|------|
| `None` 或 `NULL` | 无奖项要求 |
| `"市奖"` | 市级奖项 |
| `"国奖"` | 国家级奖项 |

#### 实际存储示例

**示例1: 无奖项要求**
```python
# 数据库存储
competition_award_level = None

# 读取
customer.competition_award_level  # None
```

**示例2: 市奖**
```python
# 数据库存储
competition_award_level = '市奖'

# 读取
customer.competition_award_level  # '市奖'
```

**示例3: 国奖**
```python
# 数据库存储
competition_award_level = '国奖'

# 读取
customer.competition_award_level  # '国奖'
```

#### 读取方式

```python
customer = Customer.query.get(1)
award_level = customer.competition_award_level  # '国奖' 或 '市奖' 或 None
```

#### 设置方式

```python
customer = Customer.query.get(1)

# 设置为国奖
customer.competition_award_level = '国奖'

# 设置为市奖
customer.competition_award_level = '市奖'

# 设置为无要求
customer.competition_award_level = None
```

---

### 3. 额外要求 (additional_requirements)

#### 存储位置
**表**: `leads` (线索表) + `customers` (客户表)
**字段**: `additional_requirements`
**类型**: `TEXT`

> ✨ **v2.0更新**: 该字段已恢复到线索表，销售可以在线索阶段设置，转客户时自动复制到客户表。

#### 存储格式
**普通文本字符串**

#### 实际存储示例

**示例1: 无额外要求**
```python
# 数据库存储
additional_requirements = None

# 读取
customer.additional_requirements  # None
```

**示例2: 有额外要求**
```python
# 数据库存储
additional_requirements = '测试额外要求：需要在2026年5月前完成所有课程并获得国奖'

# 读取
customer.additional_requirements  # '测试额外要求：需要在2026年5月前完成所有课程并获得国奖'
```

**示例3: 复杂的额外要求**
```python
# 数据库存储
additional_requirements = '按时报名赛富创智杯，否则100%退款'

# 读取
customer.additional_requirements  # '按时报名赛富创智杯，否则100%退款'
```

#### 读取方式

```python
customer = Customer.query.get(1)
requirements = customer.additional_requirements  # 字符串或None
```

#### 设置方式

```python
customer = Customer.query.get(1)

# 设置额外要求
customer.additional_requirements = '需要在2026年5月前完成所有课程'

# 清空额外要求
customer.additional_requirements = None
```

---

## 🔄 数据流转

### 线索阶段 → 客户阶段

```
线索表 (leads)                    客户表 (customers)
├─ service_types ────────────┐    ├─ lead_id (关联)
├─ sales_user_id             │    ├─ teacher_user_id
├─ stage                     │    ├─ competition_award_level ✨ 新增
├─ contract_amount           │    ├─ additional_requirements ✨ 新增
└─ ...                       │    └─ exam_year
                             │
                             └──→ 通过关联关系读取
```

### 字段分离逻辑

| 字段 | 线索阶段 | 客户阶段 | 说明 |
|-----|---------|---------|------|
| **服务类型** | ✅ 存储 | 🔗 关联读取 | 在线索表，客户通过关联读取 |
| **责任销售** | ✅ 存储 | 🔗 关联读取 | 在线索表，客户通过关联读取 |
| **竞赛等级** | ❌ 不存储 | ✅ 存储 | 只在客户表存储 |
| **额外要求** | ❌ 不存储 | ✅ 存储 | 只在客户表存储 |

---

## 💡 使用示例

### 完整示例：创建线索并转为客户

```python
from models import Lead, Customer, db
import json

# 1. 创建线索
lead = Lead(
    student_name='张三',
    parent_wechat_display_name='张三家长',
    parent_wechat_name='zhangsan_parent',
    contact_info='13800138000',
    sales_user_id=1,
    stage='获取联系方式',
    service_types='["tutoring", "competition"]'  # JSON字符串
)
db.session.add(lead)
db.session.commit()

# 2. 读取服务类型
services = lead.get_service_types_list()
print(services)  # ['tutoring', 'competition']

# 3. 转为客户
customer = Customer(
    lead_id=lead.id,
    teacher_user_id=2,
    payment_amount=20000,
    competition_award_level='国奖',  # 普通字符串
    additional_requirements='需要在2026年5月前完成',  # 普通文本
    exam_year=2026
)
db.session.add(customer)
db.session.commit()

# 4. 从客户读取服务类型（通过关联）
customer_services = customer.get_service_types()
print(customer_services)  # ['tutoring', 'competition']

# 5. 读取竞赛等级和额外要求
print(customer.competition_award_level)  # '国奖'
print(customer.additional_requirements)  # '需要在2026年5月前完成'
```

---

## 📝 总结

### 存储方式对比

| 字段 | 存储位置 | 数据类型 | 存储格式 | 示例 |
|-----|---------|---------|---------|------|
| **服务类型** | leads.service_types | TEXT | JSON字符串数组 | `'["tutoring", "competition"]'` |
| **竞赛等级** | customers.competition_award_level | VARCHAR(20) | 普通字符串 | `'国奖'` 或 `'市奖'` 或 `None` |
| **额外要求** | customers.additional_requirements | TEXT | 普通文本 | `'需要在2026年5月前完成'` |

### 关键要点

1. ✅ **服务类型使用JSON存储**，支持多个服务类型
2. ✅ **竞赛等级和额外要求使用普通字符串**，简单直接
3. ✅ **服务类型在线索表**，客户通过关联关系读取
4. ✅ **竞赛等级和额外要求在客户表**，只在客户阶段设置
5. ✅ **提供了辅助方法**，简化JSON的读写操作

---

**文档结束**

