<!-- 学员详情弹窗模态框 -->
<div id="studentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <!-- 模态框头部 -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <span class="material-symbols-outlined text-blue-600 mr-2">person</span>
                <h3 class="text-lg font-medium text-gray-900">学员详情</h3>
            </div>
            <button onclick="closeStudentDetailModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- 模态框内容 -->
        <div class="mt-3">
            <!-- 加载状态 -->
            <div id="studentDetailLoading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"></div>
                <p class="mt-3 text-gray-600 text-sm">加载中...</p>
            </div>

            <!-- 学员详情内容 -->
            <div id="studentDetailContent" class="hidden">
                <!-- 基本信息 -->
                <div class="mb-4">
                    <div class="flex items-center mb-3">
                        <span class="material-symbols-outlined text-blue-600 mr-2">account_circle</span>
                        <h4 class="text-sm font-medium text-gray-900">基本信息</h4>
                    </div>
                    <!-- 基本信息表格 -->
                    <div class="overflow-hidden border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50 w-1/3">学员姓名</td>
                                    <td id="studentName" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">年级</td>
                                    <td id="grade" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">家长微信名</td>
                                    <td id="parentWechatDisplayName" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">联系方式</td>
                                    <td id="contactInfo" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">学校</td>
                                    <td id="school" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">行政区</td>
                                    <td id="district" class="px-3 py-2 text-sm font-medium text-gray-900">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 服务内容 -->
                <div id="serviceContent" class="mb-4 hidden">
                    <div class="flex items-center mb-3">
                        <span class="material-symbols-outlined text-blue-600 mr-2">school</span>
                        <h4 class="text-sm font-medium text-gray-900">服务内容</h4>
                    </div>
                    <!-- 服务内容表格 -->
                    <div class="overflow-hidden border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <tbody id="serviceTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 动态生成服务行 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模态框底部 -->
        <div class="flex justify-end pt-4">
            <button onclick="closeStudentDetailModal()"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                关闭
            </button>
        </div>
    </div>
</div>

<script>
let currentStudentData = null;

// 显示学员详情弹窗
function showStudentDetailModal(studentId, isCustomer = false) {
    const modal = document.getElementById('studentDetailModal');
    const loading = document.getElementById('studentDetailLoading');
    const content = document.getElementById('studentDetailContent');
    
    // 显示模态框和加载状态
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    
    // 根据类型选择API端点
    const endpoint = isCustomer ? `/customers/${studentId}/api` : `/leads/${studentId}/api`;
    
    // 获取学员详情数据
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentStudentData = data;
                populateStudentDetail(data, isCustomer);
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            } else {
                throw new Error(data.message || '获取数据失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取学员详情失败：' + error.message);
            closeStudentDetailModal();
        });
}

// 填充学员详情数据
function populateStudentDetail(data, isCustomer) {
    const studentData = isCustomer ? data.customer : data.lead;

    // 基本信息
    document.getElementById('studentName').textContent = studentData.student_name || '-';
    document.getElementById('parentWechatDisplayName').textContent = studentData.parent_wechat_display_name || '-';
    document.getElementById('contactInfo').textContent = studentData.contact_info || '-';
    document.getElementById('grade').textContent = studentData.grade || '-';
    document.getElementById('school').textContent = studentData.school || '-';
    document.getElementById('district').textContent = studentData.district || '-';

    // 服务内容（线索和客户都显示）
    const serviceContent = document.getElementById('serviceContent');
    serviceContent.classList.remove('hidden');

    // 显示服务内容
    if (isCustomer) {
        // 显示客户的服务内容
        displayServiceRows(studentData);
    } else {
        // 显示线索的服务内容
        displayDefaultServiceRows(studentData);
    }
}

// 显示服务内容表格（客户）
function displayServiceRows(studentData) {
    const serviceTableBody = document.getElementById('serviceTableBody');
    serviceTableBody.innerHTML = ''; // 清空表格

    const serviceTypes = studentData.service_types || [];

    // 课题辅导
    if (serviceTypes.includes('tutoring')) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50 w-1/3">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-blue-600 mr-2 text-sm">book</span>
                    <span>课题辅导</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">已选择</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 竞赛辅导
    if (serviceTypes.includes('competition')) {
        const awardText = studentData.competition_award_level || studentData.award_requirement || '无要求';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-purple-600 mr-2 text-sm">military_tech</span>
                    <span>竞赛辅导</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">${awardText}</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 升学陪跑
    if (serviceTypes.includes('upgrade_guidance')) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-green-600 mr-2 text-sm">trending_up</span>
                    <span>升学陪跑</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">已选择</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 额外要求
    if (studentData.additional_requirements) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-red-600 mr-2 text-sm">add_circle</span>
                    <span>额外要求</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">${studentData.additional_requirements}</td>
        `;
        serviceTableBody.appendChild(row);
    }
}

// 显示默认服务内容表格（线索）
function displayDefaultServiceRows(studentData) {
    const serviceTableBody = document.getElementById('serviceTableBody');
    serviceTableBody.innerHTML = ''; // 清空表格

    const serviceTypes = studentData.service_types || [];

    // 课题辅导
    if (serviceTypes.includes('tutoring')) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50 w-1/3">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-blue-600 mr-2 text-sm">book</span>
                    <span>课题辅导</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">已选择</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 竞赛辅导
    if (serviceTypes.includes('competition')) {
        const awardText = studentData.competition_award_level || '无要求';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-purple-600 mr-2 text-sm">military_tech</span>
                    <span>竞赛辅导</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">${awardText}</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 升学陪跑
    if (serviceTypes.includes('upgrade_guidance')) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-green-600 mr-2 text-sm">trending_up</span>
                    <span>升学陪跑</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">已选择</td>
        `;
        serviceTableBody.appendChild(row);
    }

    // 额外要求
    if (studentData.additional_requirements) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-3 py-2 text-sm text-gray-600 bg-gray-50">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-red-600 mr-2 text-sm">add_circle</span>
                    <span>额外要求</span>
                </div>
            </td>
            <td class="px-3 py-2 text-sm font-medium text-gray-900">${studentData.additional_requirements}</td>
        `;
        serviceTableBody.appendChild(row);
    }
}

// 关闭学员详情弹窗
function closeStudentDetailModal() {
    const modal = document.getElementById('studentDetailModal');
    modal.classList.add('hidden');
    currentStudentData = null;

    // 重置状态
    document.getElementById('studentDetailLoading').classList.remove('hidden');
    document.getElementById('studentDetailContent').classList.add('hidden');
    document.getElementById('serviceContent').classList.add('hidden');

    // 清空服务内容表格
    const serviceTableBody = document.getElementById('serviceTableBody');
    if (serviceTableBody) {
        serviceTableBody.innerHTML = '';
    }
}



// 点击模态框外部关闭
document.getElementById('studentDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStudentDetailModal();
    }
});
</script>
