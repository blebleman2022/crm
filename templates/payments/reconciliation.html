{% extends "leads/base.html" %}

{% block title %}付款对账 - EduConnect CRM{% endblock %}
{% block page_title %}付款对账{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <div class="bg-white p-6 rounded-lg shadow-sm">
        
        <!-- 筛选条件 -->
        {% if current_user.is_sales_manager() %}
        <form method="GET" class="mb-6">
            <div class="flex items-center gap-4">
                <label for="teacher_user_id" class="text-sm font-medium text-gray-700">筛选班主任:</label>
                <select name="teacher_user_id" id="teacher_user_id"
                        class="block w-64 rounded-md border-0 py-2 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm">
                    <option value="">全部班主任</option>
                    {% for teacher in teacher_supervisors %}
                        <option value="{{ teacher.id }}" {% if selected_teacher_id == teacher.id %}selected{% endif %}>
                            {{ teacher.username }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <span class="material-symbols-outlined mr-1 text-sm">filter_list</span>
                    筛选
                </button>
            </div>
        </form>
        {% endif %}

        <!-- 统计信息 -->
        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <p class="text-sm text-gray-600">客户总数</p>
                    <p class="text-2xl font-bold text-gray-900">{{ payment_data|length }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">总金额</p>
                    <p class="text-2xl font-bold text-gray-900">¥{{ "{:,.0f}".format(payment_data|sum(attribute='total_amount')) }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">已付款总额</p>
                    <p class="text-2xl font-bold text-green-600">¥{{ "{:,.0f}".format(payment_data|sum(attribute='total_paid')) }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">剩余付款</p>
                    <p class="text-2xl font-bold text-orange-600">¥{{ "{:,.0f}".format(payment_data|sum(attribute='remaining')) }}</p>
                </div>
            </div>
        </div>

        <!-- 付款列表 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <!-- 前5个字段：统一样式 -->
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-28">学员姓名</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-32">家长微信名</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-24">课题</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-24">竞赛</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-24">奖项</th>
                        
                        <!-- 付款信息字段 -->
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28">总金额</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28">第一笔</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-28">付款时间</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28">第二笔</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-28">付款时间</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28">第三笔</th>
                        <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500 w-28">付款时间</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28 bg-green-50">已付款</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 w-28 bg-orange-50">剩余付款</th>
                        {% if current_user.is_sales_manager() %}
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-24">班主任</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for payment in payment_data %}
                    <tr class="hover:bg-gray-50">
                        <!-- 前5个字段：统一样式 -->
                        <td class="px-4 py-3 text-sm font-medium text-gray-900 w-28">{{ payment.student_name or '-' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 w-32">{{ payment.parent_wechat_name or '-' }}</td>
                        <td class="px-4 py-3 text-sm text-center text-gray-700 w-24">
                            <span class="{% if payment.has_tutoring == '是' %}text-green-600 font-medium{% else %}text-gray-400{% endif %}">
                                {{ payment.has_tutoring }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-700 w-24">
                            <span class="{% if payment.has_competition == '是' %}text-green-600 font-medium{% else %}text-gray-400{% endif %}">
                                {{ payment.has_competition }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-700 w-24">
                            {% if payment.award_level == '国奖' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">国奖</span>
                            {% elif payment.award_level == '市奖' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">市奖</span>
                            {% else %}
                                <span class="text-gray-400">{{ payment.award_level }}</span>
                            {% endif %}
                        </td>
                        
                        <!-- 付款信息字段 -->
                        <td class="px-4 py-3 text-sm text-right font-medium text-gray-900 w-28">
                            ¥{{ "{:,.0f}".format(payment.total_amount) if payment.total_amount else '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right text-gray-700 w-28">
                            {{ "¥{:,.0f}".format(payment.first_payment) if payment.first_payment else '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-600 w-28">
                            {{ payment.first_payment_date or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right text-gray-700 w-28">
                            {{ "¥{:,.0f}".format(payment.second_payment) if payment.second_payment else '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-600 w-28">
                            {{ payment.second_payment_date or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right text-gray-700 w-28">
                            {{ "¥{:,.0f}".format(payment.third_payment) if payment.third_payment else '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-600 w-28">
                            {{ payment.third_payment_date or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-medium text-green-600 w-28 bg-green-50">
                            ¥{{ "{:,.0f}".format(payment.total_paid) }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-medium text-orange-600 w-28 bg-orange-50">
                            ¥{{ "{:,.0f}".format(payment.remaining) }}
                        </td>
                        {% if current_user.is_sales_manager() %}
                        <td class="px-4 py-3 text-sm text-gray-700 w-24">{{ payment.teacher_user_name }}</td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="{% if current_user.is_sales_manager() %}15{% else %}14{% endif %}" class="px-6 py-12 text-center text-gray-500">
                            <span class="material-symbols-outlined text-6xl text-gray-300 mb-2">receipt_long</span>
                            <p class="text-lg">暂无付款记录</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

