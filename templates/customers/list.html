{% extends "leads/base.html" %}

{% block title %}å®¢æˆ·ç®¡ç† - EduConnect CRM{% endblock %}
{% block page_title %}å®¢æˆ·ç®¡ç†{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <div class="bg-white p-6 rounded-lg shadow-sm">
        <!-- æœç´¢å’Œç­›é€‰ -->
        <form method="GET" class="mb-6 space-y-4">
            <!-- ç¬¬ä¸€è¡Œï¼šæœç´¢ã€æœåŠ¡å†…å®¹ã€é”€å”® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="sr-only" for="search">æœç´¢</label>
                    <div class="relative">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="material-symbols-outlined text-gray-400">search</span>
                        </div>
                        <input class="block w-full rounded-md border-0 py-2.5 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                               id="search" name="search" placeholder="æœç´¢å­¦å‘˜å§“å" type="search" value="{{ search }}"/>
                    </div>
                </div>

                <div>
                    <select class="block w-full rounded-md border-0 py-2.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                            name="service_type">
                        <option value="">æ‰€æœ‰æœåŠ¡å†…å®¹</option>
                        <option value="tutoring" {% if service_type == 'tutoring' %}selected{% endif %}>è¯¾é¢˜è¾…å¯¼</option>
                        <option value="competition" {% if service_type == 'competition' %}selected{% endif %}>ç«èµ›è¾…å¯¼</option>
                        <option value="upgrade_guidance" {% if service_type == 'upgrade_guidance' %}selected{% endif %}>å‡å­¦é™ªè·‘</option>
                    </select>
                </div>

                <div>
                    <select class="block w-full rounded-md border-0 py-2.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                            name="sales">
                        <option value="">æ‰€æœ‰é”€å”®</option>
                        {% for sales in sales_users %}
                            <option value="{{ sales.id }}" {% if sales_filter == sales.id|string %}selected{% endif %}>{{ sales.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šæ—¶é—´æ®µç­›é€‰ -->
            <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
                <div class="flex items-center gap-2">
                    <label for="start_date" class="text-sm font-medium text-gray-700">å¼€å§‹æ—¥æœŸ:</label>
                    <input type="date"
                           id="start_date"
                           name="start_date"
                           value="{{ start_date }}"
                           class="rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"/>
                </div>

                <div class="flex items-center gap-2">
                    <label for="end_date" class="text-sm font-medium text-gray-700">ç»“æŸæ—¥æœŸ:</label>
                    <input type="date"
                           id="end_date"
                           name="end_date"
                           value="{{ end_date }}"
                           class="rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"/>
                </div>

                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span class="material-symbols-outlined mr-1 text-sm">search</span>
                    æŸ¥è¯¢
                </button>
            </div>
        </form>

        <!-- å®¢æˆ·åˆ—è¡¨ -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-24">å­¦å‘˜å§“å</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">è´£ä»»é”€å”®</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">ç­ä¸»ä»»</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">è¾…å¯¼è€å¸ˆ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">å¥–é¡¹è¦æ±‚</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">ä¸­é«˜è€ƒæ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">è¯¾ç¨‹è¿›åº¦</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">èµ›äº‹è¿›å±•</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">å‡å­¦é™ªè·‘</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-20">æ–°å¢æ—¶é—´</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">æ“ä½œ</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for customer in customers.items %}
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-3 py-4 text-sm font-medium text-gray-900 w-24">
                            <div class="flex items-center space-x-2">
                                {% if customer.is_priority %}
                                    <span class="material-symbols-outlined text-yellow-500 text-lg" title="é‡ç‚¹å…³æ³¨å®¢æˆ·">star</span>
                                {% endif %}
                                <button onclick="showStudentDetailModal({{ customer.id }}, true, {% if current_user.role == 'teacher_supervisor' %}true{% else %}false{% endif %})" class="text-blue-600 hover:text-blue-800 cursor-pointer">
                                    {{ customer.lead.student_name }}
                                </button>
                                {% if customer.lead.additional_requirements %}
                                    <span class="material-symbols-outlined text-red-600 text-sm" title="æœ‰é¢å¤–è¦æ±‚">add_circle</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">{{ customer.lead.sales_user.username }}</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.teacher_user %}
                                {{ customer.teacher_user.username }}
                            {% else %}
                                <span class="text-gray-400">æœªåˆ†é…</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.teacher %}
                                {% if current_user.role == 'teacher_supervisor' %}
                                    <button onclick="showChangeTeacherModal({{ customer.id }}, '{{ customer.lead.student_name }}', {{ customer.teacher.id }}, '{{ customer.teacher.chinese_name }}')"
                                            class="text-blue-600 hover:text-blue-800 cursor-pointer">
                                        {{ customer.teacher.chinese_name }}
                                    </button>
                                {% else %}
                                    <span class="text-gray-900">{{ customer.teacher.chinese_name }}</span>
                                {% endif %}
                            {% else %}
                                {% if current_user.role == 'teacher_supervisor' %}
                                    <button onclick="showAssignTeacherModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="text-red-600 hover:text-red-800 cursor-pointer">å¾…åˆ†é…</button>
                                {% else %}
                                    <span class="text-gray-400">å¾…åˆ†é…</span>
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% if customer.competition_award_level == 'å¸‚å¥–' %}
                                <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">å¸‚å¥–</span>
                            {% elif customer.competition_award_level == 'å›½å¥–' %}
                                <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">å›½å¥–</span>
                            {% else %}
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">æ— </span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.exam_year %}
                                {{ customer.exam_year }}å¹´
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% if customer.tutoring_delivery %}
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ customer.tutoring_delivery.completed_sessions }}/{{ customer.tutoring_delivery.total_sessions }}
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            {% set progress = (customer.tutoring_delivery.completed_sessions / customer.tutoring_delivery.total_sessions * 100) if customer.tutoring_delivery.total_sessions > 0 else 0 %}
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: {{ progress }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% set service_types = customer.lead.get_service_types_list() %}
                            {% if 'competition' in service_types %}
                                {% set comp_count = competition_counts.get(customer.id, 0) %}
                                {% if comp_count > 0 %}
                                    <button onclick="showCompetitionsModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800 hover:bg-blue-200 cursor-pointer">
                                        ğŸ† {{ comp_count }}é¡¹
                                    </button>
                                {% else %}
                                    <button onclick="showCompetitionsModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 hover:bg-gray-200 cursor-pointer">
                                        ğŸ† 0é¡¹
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% set service_types = customer.lead.get_service_types_list() %}
                            {% if 'upgrade_guidance' in service_types %}
                                <span class="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-800">åŒ…å«</span>
                            {% else %}
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">ä¸åŒ…å«</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 w-20">
                            {% if second_payments.get(customer.lead_id) %}
                                {{ second_payments[customer.lead_id].year }}/{{ second_payments[customer.lead_id].month }}/{{ second_payments[customer.lead_id].day }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                            {% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
                            <button onclick="openProgressModal({{ customer.id }}, {{ customer.lead.sales_user_id }})" class="text-blue-600 hover:text-blue-800">è¿›åº¦æ›´æ–°</button>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        {% if customers.pages > 1 %}
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4">
            <div class="flex flex-1 justify-between sm:hidden">
                {% if customers.has_prev %}
                    <a href="{{ url_for('customers.list_customers', page=customers.prev_num, search=search, sales=sales_filter, service_type=service_type) }}"
                       class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">ä¸Šä¸€é¡µ</a>
                {% endif %}
                {% if customers.has_next %}
                    <a href="{{ url_for('customers.list_customers', page=customers.next_num, search=search, sales=sales_filter, service_type=service_type) }}"
                       class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">ä¸‹ä¸€é¡µ</a>
                {% endif %}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        æ˜¾ç¤ºç¬¬ <span class="font-medium">{{ (customers.page - 1) * customers.per_page + 1 }}</span> åˆ°
                        <span class="font-medium">{{ customers.page * customers.per_page if customers.page * customers.per_page < customers.total else customers.total }}</span> æ¡ï¼Œ
                        å…± <span class="font-medium">{{ customers.total }}</span> æ¡è®°å½•
                    </p>
                </div>
                <div>
                    <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm">
                        {% if customers.has_prev %}
                            <a href="{{ url_for('customers.list_customers', page=customers.prev_num, search=search, sales=sales_filter, service_type=service_type) }}"
                               class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                <span class="material-symbols-outlined h-5 w-5">chevron_left</span>
                            </a>
                        {% endif %}

                        {% for page_num in customers.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != customers.page %}
                                    <a href="{{ url_for('customers.list_customers', page=page_num, search=search, sales=sales_filter, service_type=service_type) }}"
                                       class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">{{ page_num }}</a>
                                {% else %}
                                    <span class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300">â€¦</span>
                            {% endif %}
                        {% endfor %}

                        {% if customers.has_next %}
                            <a href="{{ url_for('customers.list_customers', page=customers.next_num, search=search, sales=sales_filter, service_type=service_type) }}"
                               class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                <span class="material-symbols-outlined h-5 w-5">chevron_right</span>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- åˆ†é…è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡† -->
<div id="assignTeacherModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">åˆ†é…è¾…å¯¼è€å¸ˆ</h3>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">å­¦å‘˜ï¼š<span id="assignStudentName" class="font-medium"></span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¾…å¯¼è€å¸ˆ</label>
                    <select id="teacherSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">è¯·é€‰æ‹©è¾…å¯¼è€å¸ˆ</option>
                    </select>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" onclick="assignTeacher()"
                        class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
                    ç¡®å®š
                </button>
                <button type="button" onclick="hideAssignTeacherModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ›´æ¢è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡† -->
<div id="changeTeacherModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">æ›´æ¢è¾…å¯¼è€å¸ˆ</h3>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">å­¦å‘˜ï¼š<span id="changeStudentName" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-3">å½“å‰è¾…å¯¼è€å¸ˆï¼š<span id="currentTeacherName" class="font-medium text-blue-600"></span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ–°è¾…å¯¼è€å¸ˆ</label>
                    <select id="newTeacherSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">è¯·é€‰æ‹©è¾…å¯¼è€å¸ˆ</option>
                    </select>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-yellow-400">warning</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                æ›´æ¢è¾…å¯¼è€å¸ˆéœ€è¦äºŒæ¬¡ç¡®è®¤ï¼Œè¯·è°¨æ…æ“ä½œ
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" onclick="changeTeacher(event)"
                        class="inline-flex w-full justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
                    ç¡®è®¤æ›´æ¢
                </button>
                <button type="button" onclick="hideChangeTeacherModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// è‡ªåŠ¨æäº¤æœç´¢è¡¨å•
document.querySelectorAll('select[name="service_type"], select[name="sales"]').forEach(select => {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});

let currentCustomerId = null;
let currentStudentName = null;
let currentTeacherId = null;
let currentTeacherName = null;
let allTeachers = [];

// åŠ è½½æ‰€æœ‰å¯ç”¨çš„è€å¸ˆ
function loadTeachers() {
    fetch('/teachers/get_active_teachers')
        .then(response => response.json())
        .then(data => {
            allTeachers = data;
        })
        .catch(error => {
            console.error('åŠ è½½è€å¸ˆåˆ—è¡¨å¤±è´¥:', error);
        });
}

// é¡µé¢åŠ è½½æ—¶è·å–è€å¸ˆåˆ—è¡¨
loadTeachers();

// æ˜¾ç¤ºåˆ†é…è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡†
function showAssignTeacherModal(customerId, studentName) {
    currentCustomerId = customerId;
    currentStudentName = studentName;

    // è®¾ç½®å­¦å‘˜åç§°
    document.getElementById('assignStudentName').textContent = studentName;

    // å¡«å……è€å¸ˆä¸‹æ‹‰åˆ—è¡¨
    const teacherSelect = document.getElementById('teacherSelect');
    teacherSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¾…å¯¼è€å¸ˆ</option>';
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = `${teacher.chinese_name}${teacher.english_name ? ' (' + teacher.english_name + ')' : ''}${teacher.major_direction ? ' - ' + teacher.major_direction : ''}`;
        teacherSelect.appendChild(option);
    });

    document.getElementById('assignTeacherModal').classList.remove('hidden');
}

// éšè—åˆ†é…è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡†
function hideAssignTeacherModal() {
    currentCustomerId = null;
    currentStudentName = null;
    document.getElementById('assignTeacherModal').classList.add('hidden');
    document.getElementById('teacherSelect').value = '';
}

// åˆ†é…è¾…å¯¼è€å¸ˆ
function assignTeacher() {
    const teacherId = document.getElementById('teacherSelect').value;
    if (!teacherId) {
        alert('è¯·é€‰æ‹©è¾…å¯¼è€å¸ˆ');
        return;
    }

    const formData = new FormData();
    formData.append('teacher_id', teacherId);

    fetch(`/teachers/assign/${currentCustomerId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            hideAssignTeacherModal();
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// æ˜¾ç¤ºæ›´æ¢è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡†
function showChangeTeacherModal(customerId, studentName, teacherId, teacherName) {
    currentCustomerId = customerId;
    currentStudentName = studentName;
    currentTeacherId = teacherId;
    currentTeacherName = teacherName;

    // è®¾ç½®å­¦å‘˜åç§°å’Œå½“å‰è¾…å¯¼è€å¸ˆ
    document.getElementById('changeStudentName').textContent = studentName;
    document.getElementById('currentTeacherName').textContent = teacherName;

    // å¡«å……è€å¸ˆä¸‹æ‹‰åˆ—è¡¨ï¼ˆæ’é™¤å½“å‰è€å¸ˆï¼‰
    const newTeacherSelect = document.getElementById('newTeacherSelect');
    newTeacherSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¾…å¯¼è€å¸ˆ</option>';
    allTeachers.forEach(teacher => {
        if (teacher.id !== teacherId) {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.chinese_name}${teacher.english_name ? ' (' + teacher.english_name + ')' : ''}${teacher.major_direction ? ' - ' + teacher.major_direction : ''}`;
            newTeacherSelect.appendChild(option);
        }
    });

    document.getElementById('changeTeacherModal').classList.remove('hidden');
}

// éšè—æ›´æ¢è¾…å¯¼è€å¸ˆæ¨¡æ€æ¡†
function hideChangeTeacherModal() {
    currentCustomerId = null;
    currentStudentName = null;
    currentTeacherId = null;
    currentTeacherName = null;
    changeTeacherConfirmed = false;

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    if (changeTeacherButton) {
        changeTeacherButton.disabled = false;
        changeTeacherButton.textContent = 'ç¡®è®¤æ›´æ¢';
        changeTeacherButton.classList.remove('animate-pulse');
        changeTeacherButton = null;
    }

    document.getElementById('changeTeacherModal').classList.add('hidden');
    document.getElementById('newTeacherSelect').value = '';
}

// æ›´æ¢è¾…å¯¼è€å¸ˆï¼ˆéœ€è¦äºŒæ¬¡ç¡®è®¤ï¼‰
let changeTeacherConfirmed = false;
let changeTeacherButton = null;

function changeTeacher(event) {
    const newTeacherId = document.getElementById('newTeacherSelect').value;
    if (!newTeacherId) {
        alert('è¯·é€‰æ‹©æ–°è¾…å¯¼è€å¸ˆ');
        return;
    }

    // ä¿å­˜æŒ‰é’®å¼•ç”¨
    if (!changeTeacherButton) {
        changeTeacherButton = event.target;
    }

    // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œæ˜¾ç¤ºç¡®è®¤æç¤º
    if (!changeTeacherConfirmed) {
        const newTeacher = allTeachers.find(t => t.id == newTeacherId);
        if (confirm(`ç¡®å®šè¦å°†è¾…å¯¼è€å¸ˆä» ${currentTeacherName} æ›´æ¢ä¸º ${newTeacher.chinese_name} å—ï¼Ÿ\n\næ­¤æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤ï¼Œè¯·å†æ¬¡ç‚¹å‡»"ç¡®è®¤æ›´æ¢"æŒ‰é’®ã€‚`)) {
            changeTeacherConfirmed = true;
            // æ”¹å˜æŒ‰é’®æ–‡å­—æç¤ºç”¨æˆ·éœ€è¦å†æ¬¡ç‚¹å‡»
            changeTeacherButton.textContent = 'å†æ¬¡ç‚¹å‡»ç¡®è®¤';
            changeTeacherButton.classList.add('animate-pulse');
        }
        return;
    }

    // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œæ‰§è¡Œæ›´æ¢
    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    changeTeacherButton.disabled = true;
    changeTeacherButton.textContent = 'å¤„ç†ä¸­...';

    fetch(`/teachers/change/${currentCustomerId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            teacher_id: parseInt(newTeacherId),
            confirmed: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            changeTeacherConfirmed = false;
            changeTeacherButton = null;
            hideChangeTeacherModal();
            location.reload();
        } else {
            alert(data.message);
            changeTeacherConfirmed = false;
            changeTeacherButton.disabled = false;
            changeTeacherButton.textContent = 'ç¡®è®¤æ›´æ¢';
            changeTeacherButton.classList.remove('animate-pulse');
            changeTeacherButton = null;
        }
    })
    .catch(error => {
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        changeTeacherConfirmed = false;
        if (changeTeacherButton) {
            changeTeacherButton.disabled = false;
            changeTeacherButton.textContent = 'ç¡®è®¤æ›´æ¢';
            changeTeacherButton.classList.remove('animate-pulse');
        }
        changeTeacherButton = null;
    });
}

{% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
// è¿›åº¦æ›´æ–°æ¨¡æ€çª—å£åŠŸèƒ½
function openProgressModal(customerId, salesUserId) {
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    const currentUserId = {{ current_user.id }};
    const currentUserRole = '{{ current_user.role }}';

    // æƒé™æ£€æŸ¥ï¼šé”€å”®ç®¡ç†åªèƒ½æ›´æ–°è‡ªå·±è´Ÿè´£çš„å®¢æˆ·è¿›åº¦
    if (currentUserRole === 'sales_manager' && salesUserId !== currentUserId) {
        alert('ä¸èƒ½æ›´æ”¹å…¶ä»–é”€å”®è´Ÿè´£çš„å®¢æˆ·è¿›åº¦');
        return;
    }

    // è·å–å®¢æˆ·è¯¦ç»†ä¿¡æ¯
    fetch(`/customers/${customerId}/progress`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const customer = data.customer;

                // è®¾ç½®å…¨å±€å˜é‡
                currentCustomerLeadId = customer.lead_id;
                currentCustomerId = customerId;

                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('progressCustomerId').value = customerId;
                document.getElementById('progressStudentName').textContent = customer.student_name;

                // æ ¹æ®æœåŠ¡ç±»å‹æ˜¾ç¤ºæˆ–éšè—è¯¾ç¨‹è¿›åº¦æ¨¡å—
                const hasTutoringService = customer.service_types && customer.service_types.includes('tutoring');
                const courseProgressSection = document.getElementById('courseProgressSection');
                if (hasTutoringService) {
                    courseProgressSection.classList.remove('hidden');

                    // è¯¾é¢˜åç§°
                    document.getElementById('thesisName').value = customer.thesis_name || '';

                    // è¯¾ç¨‹è¿›åº¦
                    if (customer.tutoring_delivery) {
                        document.getElementById('totalSessions').value = customer.tutoring_delivery.total_sessions || 0;
                        document.getElementById('completedSessions').value = customer.tutoring_delivery.completed_sessions || 0;
                    } else {
                        document.getElementById('totalSessions').value = 0;
                        document.getElementById('completedSessions').value = 0;
                    }
                } else {
                    courseProgressSection.classList.add('hidden');
                }

                // æ ¹æ®æœåŠ¡ç±»å‹æ˜¾ç¤ºæˆ–éšè—èµ›äº‹ç®¡ç†æ¨¡å—
                const hasCompetitionService = customer.service_types && customer.service_types.includes('competition');
                const competitionSection = document.getElementById('competitionManagementSection');
                if (hasCompetitionService) {
                    competitionSection.classList.remove('hidden');
                    // åŠ è½½èµ›äº‹åˆ—è¡¨
                    loadProgressCompetitions(customerId);
                } else {
                    competitionSection.classList.add('hidden');
                }

                // è®¾ç½®æ˜Ÿæ ‡çŠ¶æ€
                updatePriorityStarDisplay(customer.is_priority);

                // åŠ è½½å®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½•
                loadCustomerCommunicationRecords(customer.lead_id, customerId);

                // åŠ è½½è¯¾ç¨‹è®°å½•å›¾ç‰‡ï¼ˆå¦‚æœæœ‰è¯¾é¢˜è¾…å¯¼æœåŠ¡ï¼‰
                if (hasTutoringService) {
                    loadCourseRecordImages(customerId);
                }

                // åŠ è½½è·å¥–è¯ä¹¦å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ç«èµ›è¾…å¯¼æœåŠ¡ï¼‰
                if (hasCompetitionService) {
                    loadAwardCertificateImages(customerId);
                }

                // æ˜¾ç¤ºæ¨¡æ€çª—å£
                document.getElementById('progressModal').classList.remove('hidden');
            } else {
                alert('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥');
            }
        })
        .catch(error => {
            alert('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

function closeProgressModal() {
    document.getElementById('progressModal').classList.add('hidden');
    // æ¸…ç†å…¨å±€å˜é‡
    currentCustomerLeadId = null;
    currentCustomerId = null;
}

function updateProgress() {
    const customerId = document.getElementById('progressCustomerId').value;
    const thesisName = document.getElementById('thesisName').value;
    const totalSessions = document.getElementById('totalSessions').value;
    const completedSessions = document.getElementById('completedSessions').value;

    // éªŒè¯æ•°æ®
    if (parseInt(completedSessions) > parseInt(totalSessions)) {
        alert('å·²å®Œæˆè¯¾ç¨‹æ•°é‡ä¸èƒ½å¤§äºæ€»è¯¾ç¨‹æ•°é‡');
        return;
    }

    fetch(`/customers/${customerId}/update_progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            thesis_name: thesisName,
            total_sessions: parseInt(totalSessions),
            completed_sessions: parseInt(completedSessions)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeProgressModal();
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}
{% endif %}

// åŠ è½½å®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½•
function loadCustomerCommunicationRecords(leadId, customerId) {
    const container = document.getElementById('customerCommunicationRecords');
    const statsContainer = document.getElementById('customerCommunicationStats');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="text-center text-gray-500 text-sm py-4">
            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">hourglass_empty</span>
            <p>åŠ è½½ä¸­...</p>
        </div>
    `;

    // è·å–å®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½•
    fetch(`/consultations/details_data/${leadId}?customer_only=true`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.communication_records) {
                const records = data.data.communication_records;
                const stats = data.data.stats || {};

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                if (statsContainer) {
                    statsContainer.textContent = `å®¢æˆ·é˜¶æ®µ: ${stats.customer_stage_count || 0} æ¡è®°å½•`;
                }

                if (records.length > 0) {
                    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                    records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    // åˆ›å»ºè¡¨æ ¼å½¢å¼æ˜¾ç¤º
                    const recordsHtml = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">æ—¶é—´</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ²Ÿé€šå†…å®¹</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${records.map(record => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">
                                            ${new Date(record.created_at).toLocaleString('zh-CN', {
                                                month: '2-digit',
                                                day: '2-digit',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </td>
                                        <td class="px-3 py-2 text-sm text-gray-900">
                                            <div class="max-w-xs" title="${record.content}">
                                                ${record.content}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    container.innerHTML = recordsHtml;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 text-sm py-8">
                            <span class="material-symbols-outlined text-3xl mb-3 text-gray-300">inbox</span>
                            <p class="text-lg font-medium mb-1">æš‚æ— æ²Ÿé€šè®°å½•</p>
                            <p class="text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡æ²Ÿé€šè®°å½•</p>
                        </div>
                    `;
                }
            } else {
                container.innerHTML = `
                    <div class="text-center text-red-500 text-sm py-4">
                        <span class="material-symbols-outlined mr-2">error</span>
                        åŠ è½½æ²Ÿé€šè®°å½•å¤±è´¥
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading communication records:', error);
            container.innerHTML = `
                <div class="text-center text-red-500 text-sm py-4">
                    <span class="material-symbols-outlined mr-2">error</span>
                    ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•
                </div>
            `;
        });
}

// å…¨å±€å˜é‡å­˜å‚¨å½“å‰å®¢æˆ·ä¿¡æ¯
let currentCustomerLeadId = null;

// æ˜¾ç¤ºæ–°å¢å®¢æˆ·æ²Ÿé€šè®°å½•è¡¨å•
function showAddCustomerCommunicationForm() {
    const modal = document.getElementById('addCustomerCommunicationModal');
    if (modal && currentCustomerLeadId) {
        // è®¾ç½®lead_id
        document.getElementById('customerCommunicationLeadId').value = currentCustomerLeadId;

        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        const timeInput = document.getElementById('customerCommunicationTime');
        if (timeInput) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            timeInput.value = now.toISOString().slice(0, 16);
        }

        modal.classList.remove('hidden');

        // èšç„¦åˆ°å†…å®¹è¾“å…¥æ¡†
        const contentInput = document.getElementById('customerCommunicationContent');
        if (contentInput) {
            setTimeout(() => contentInput.focus(), 100);
        }
    }
}

// å…³é—­æ–°å¢å®¢æˆ·æ²Ÿé€šè®°å½•è¡¨å•
function closeAddCustomerCommunicationModal() {
    const modal = document.getElementById('addCustomerCommunicationModal');
    if (modal) {
        modal.classList.add('hidden');

        // æ¸…ç©ºè¡¨å•
        const form = document.getElementById('addCustomerCommunicationForm');
        if (form) {
            form.reset();
        }
    }
}

// æäº¤å®¢æˆ·æ²Ÿé€šè®°å½•
function submitCustomerCommunicationRecord(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const leadId = document.getElementById('customerCommunicationLeadId').value;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // ç¦ç”¨æäº¤æŒ‰é’®
    submitBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1 animate-spin">hourglass_empty</span>ä¿å­˜ä¸­...';
    submitBtn.disabled = true;

    fetch(`/consultations/add_communication/${leadId}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // å…³é—­è¡¨å•
            closeAddCustomerCommunicationModal();

            // é‡æ–°åŠ è½½æ²Ÿé€šè®°å½•
            loadCustomerCommunicationRecords(leadId, currentCustomerId);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showCustomerNotification('æ²Ÿé€šè®°å½•æ·»åŠ æˆåŠŸï¼', 'success');
        } else {
            throw new Error(data.message || 'æ·»åŠ å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCustomerNotification('æ·»åŠ æ²Ÿé€šè®°å½•å¤±è´¥ï¼š' + error.message, 'error');
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// æ˜¾ç¤ºé€šçŸ¥
function showCustomerNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white ${bgColor}`;
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="material-symbols-outlined mr-2">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
            ${message}
        </div>
    `;

    document.body.appendChild(notification);

    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// é‡ç‚¹å…³æ³¨å®¢æˆ·æ˜Ÿæ ‡åŠŸèƒ½
function updatePriorityStarDisplay(isPriority) {
    const starIcon = document.getElementById('priorityStarIcon');
    const starButton = document.getElementById('priorityStarButton');

    if (isPriority) {
        starIcon.textContent = 'star';
        starIcon.className = 'material-symbols-outlined text-lg text-yellow-500';
        starButton.title = 'ç‚¹å‡»å–æ¶ˆé‡ç‚¹å…³æ³¨';
    } else {
        starIcon.textContent = 'star_border';
        starIcon.className = 'material-symbols-outlined text-lg text-gray-300';
        starButton.title = 'ç‚¹å‡»æ ‡è®°ä¸ºé‡ç‚¹å…³æ³¨å®¢æˆ·';
    }
}

function togglePriorityCustomer() {
    const customerId = document.getElementById('progressCustomerId').value;
    const starIcon = document.getElementById('priorityStarIcon');
    const starButton = document.getElementById('priorityStarButton');

    if (!customerId) {
        showCustomerNotification('å®¢æˆ·IDè·å–å¤±è´¥', 'error');
        return;
    }

    // è·å–å½“å‰çŠ¶æ€
    const currentIsPriority = starIcon.textContent === 'star';
    const newIsPriority = !currentIsPriority;

    // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
    starButton.disabled = true;
    starIcon.textContent = 'hourglass_empty';
    starIcon.className = 'material-symbols-outlined text-lg text-gray-400 animate-spin';

    // å‘é€è¯·æ±‚
    fetch(`/customers/${customerId}/toggle_priority`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            is_priority: newIsPriority
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°æ˜Ÿæ ‡æ˜¾ç¤º
            updatePriorityStarDisplay(data.is_priority);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const message = data.is_priority ? 'å·²æ ‡è®°ä¸ºé‡ç‚¹å…³æ³¨å®¢æˆ·' : 'å·²å–æ¶ˆé‡ç‚¹å…³æ³¨æ ‡è®°';
            showCustomerNotification(message, 'success');

            // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°åˆ—è¡¨ä¸­çš„æ˜Ÿæ ‡æ˜¾ç¤º
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'æ“ä½œå¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCustomerNotification('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error');

        // æ¢å¤åŸçŠ¶æ€
        updatePriorityStarDisplay(currentIsPriority);
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        starButton.disabled = false;
    });
}
</script>

<!-- è¿›åº¦æ›´æ–°æ¨¡æ€çª—å£ - ä»…ç®¡ç†å‘˜ã€é”€å”®ç®¡ç†å’Œç­ä¸»ä»»å¯è§ -->
{% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
<div id="progressModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-0 border-0 w-full max-w-2xl shadow-2xl rounded-xl bg-white mb-10">
        <!-- å¼¹çª—å¤´éƒ¨ - è“è‰²æ¸å˜èƒŒæ™¯ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="material-symbols-outlined text-white text-2xl">edit_note</span>
                    <div>
                        <h3 class="text-lg font-semibold text-white">è¿›åº¦æ›´æ–°</h3>
                        <p class="text-sm text-blue-100 mt-0.5">å­¦å‘˜ï¼š<span id="progressStudentName" class="font-medium"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button"
                            id="priorityStarButton"
                            onclick="togglePriorityCustomer()"
                            class="focus:outline-none hover:scale-110 transition-transform duration-200 p-1"
                            title="ç‚¹å‡»æ ‡è®°/å–æ¶ˆé‡ç‚¹å…³æ³¨å®¢æˆ·">
                        <span id="priorityStarIcon" class="material-symbols-outlined text-xl text-white">star</span>
                    </button>
                    <button type="button"
                            onclick="closeProgressModal()"
                            class="focus:outline-none hover:scale-110 transition-transform duration-200 p-1"
                            title="å…³é—­">
                        <span class="material-symbols-outlined text-xl text-white">close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <div class="p-6">

            <form onsubmit="event.preventDefault(); updateProgress();">
                <input type="hidden" id="progressCustomerId">

                <!-- è¯¾ç¨‹è¿›åº¦ -->
                <div id="courseProgressSection" class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                    <div class="flex items-center mb-3">
                        <span class="material-symbols-outlined text-blue-600 mr-2">school</span>
                        <h4 class="text-sm font-semibold text-gray-900">è¯¾ç¨‹è¿›åº¦</h4>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">è¯¾é¢˜åç§°</label>
                        <input type="text" id="thesisName" placeholder="è¯·è¾“å…¥è¯¾é¢˜åç§°"
                               class="block w-full px-3 py-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">æ€»è¯¾ç¨‹æ•°é‡</label>
                            <input type="number" id="totalSessions" min="0"
                                   class="block w-full px-3 py-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">å·²å®Œæˆæ•°é‡</label>
                            <input type="number" id="completedSessions" min="0"
                                   class="block w-full px-3 py-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                    </div>

                    <!-- è¯¾ç¨‹è®°å½•å›¾ç‰‡ -->
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹è®°å½•å›¾ç‰‡</label>
                            <button type="button" onclick="showCourseRecordImageUpload()"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-blue-600 bg-blue-50 hover:bg-blue-100 transition-all">
                                <span class="material-symbols-outlined text-sm mr-1">add_photo_alternate</span>
                                ä¸Šä¼ å›¾ç‰‡
                            </button>
                        </div>
                        <div id="courseRecordImagesList" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                            <!-- åŠ¨æ€åŠ è½½å›¾ç‰‡ -->
                        </div>

                        <!-- å›¾ç‰‡ä¸Šä¼ è¡¨å•ï¼ˆéšè—ï¼‰ -->
                        <div id="courseRecordImageUploadForm" class="hidden mt-3 p-3 bg-white border border-blue-200 rounded-lg">
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">é€‰æ‹©å›¾ç‰‡</label>
                                <input type="file" id="courseRecordImageInput" accept="image/*" multiple
                                       class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">å›¾ç‰‡æè¿°</label>
                                <input type="text" id="courseRecordImageDescription" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°"
                                       class="block w-full px-2 py-1 text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <button type="button" onclick="uploadCourseRecordImages()"
                                        class="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-all">
                                    <span class="material-symbols-outlined text-sm mr-1">cloud_upload</span>
                                    ä¸Šä¼ 
                                </button>
                                <button type="button" onclick="hideCourseRecordImageUpload()"
                                        class="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-all">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- èµ›äº‹ç®¡ç†ï¼ˆä»…ç«èµ›è¾…å¯¼æœåŠ¡å®¢æˆ·æ˜¾ç¤ºï¼‰ -->
                <div id="competitionManagementSection" class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-2">emoji_events</span>
                            <h4 class="text-sm font-semibold text-gray-900">èµ›äº‹ç®¡ç†</h4>
                        </div>
                        <button type="button" onclick="showAddCompetitionInProgress()"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition-all">
                            <span class="material-symbols-outlined text-sm mr-1">add</span>
                            æ·»åŠ èµ›äº‹
                        </button>
                    </div>
                    <div id="progressCompetitionsList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-white mb-4">
                        <!-- åŠ¨æ€åŠ è½½èµ›äº‹åˆ—è¡¨ -->
                        <div class="text-center text-gray-500 text-sm py-4">
                            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">emoji_events</span>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>

                    <!-- è·å¥–è¯ä¹¦å›¾ç‰‡ -->
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">è·å¥–è¯ä¹¦å›¾ç‰‡</label>
                            <button type="button" onclick="showAwardCertificateImageUpload()"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-blue-600 bg-blue-50 hover:bg-blue-100 transition-all">
                                <span class="material-symbols-outlined text-sm mr-1">add_photo_alternate</span>
                                ä¸Šä¼ å›¾ç‰‡
                            </button>
                        </div>
                        <div id="awardCertificateImagesList" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                            <!-- åŠ¨æ€åŠ è½½å›¾ç‰‡ -->
                        </div>

                        <!-- å›¾ç‰‡ä¸Šä¼ è¡¨å•ï¼ˆéšè—ï¼‰ -->
                        <div id="awardCertificateImageUploadForm" class="hidden mt-3 p-3 bg-white border border-blue-200 rounded-lg">
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">é€‰æ‹©å›¾ç‰‡</label>
                                <input type="file" id="awardCertificateImageInput" accept="image/*" multiple
                                       class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">å›¾ç‰‡æè¿°</label>
                                <input type="text" id="awardCertificateImageDescription" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°"
                                       class="block w-full px-2 py-1 text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <button type="button" onclick="uploadAwardCertificateImages()"
                                        class="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-all">
                                    <span class="material-symbols-outlined text-sm mr-1">cloud_upload</span>
                                    ä¸Šä¼ 
                                </button>
                                <button type="button" onclick="hideAwardCertificateImageUpload()"
                                        class="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-all">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½• -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-2">chat</span>
                            <h4 class="text-sm font-semibold text-gray-900">å®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½•</h4>
                        </div>
                        <button type="button" onclick="showAddCustomerCommunicationForm()"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition-all">
                            <span class="material-symbols-outlined text-sm mr-1">add</span>
                            æ–°å¢è®°å½•
                        </button>
                    </div>

                    <!-- æ²Ÿé€šè®°å½•è¡¨æ ¼ -->
                    <div id="customerCommunicationRecords" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                        <div class="text-center text-gray-500 text-sm py-4">
                            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">inbox</span>
                            <p>æš‚æ— æ²Ÿé€šè®°å½•</p>
                            <p class="text-xs mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡æ²Ÿé€šè®°å½•</p>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="customerCommunicationStats" class="mt-2 text-xs text-gray-500 text-center">
                        å®¢æˆ·é˜¶æ®µ: 0 æ¡è®°å½•
                    </div>
                </div>

                <!-- æŒ‰é’®ç»„ -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeProgressModal()"
                            class="px-5 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                            class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 border-0 rounded-lg text-sm font-medium text-white hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all">
                        <span class="material-symbols-outlined text-sm mr-1 align-middle">save</span>
                        <span class="align-middle">ä¿å­˜</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- æ·»åŠ èµ›äº‹å¼¹çª— -->
<div id="addCompetitionModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative mx-auto p-0 border-0 w-full max-w-md shadow-2xl rounded-xl bg-white animate-fadeIn">
        <!-- å¼¹çª—å¤´éƒ¨ - è“è‰²æ¸å˜èƒŒæ™¯ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined text-white text-2xl">emoji_events</span>
                    <h3 class="text-lg font-semibold text-white">æ·»åŠ èµ›äº‹</h3>
                </div>
                <button onclick="closeAddCompetitionModal()" class="text-white hover:text-blue-100 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <form id="addCompetitionForm" onsubmit="submitAddCompetition(event)" class="p-6 space-y-5">
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                <p class="text-sm text-blue-700">è¯·é€‰æ‹©è¦æ·»åŠ çš„èµ›äº‹åŠåˆå§‹çŠ¶æ€</p>
            </div>

            <!-- èµ›äº‹é€‰æ‹© -->
            <div>
                <label for="competitionSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">emoji_events</span>
                    <span class="align-middle">èµ›äº‹åç§°</span>
                </label>
                <select id="competitionSelect"
                        required
                        class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <option value="">è¯·é€‰æ‹©èµ›äº‹...</option>
                </select>
            </div>

            <!-- åˆå§‹çŠ¶æ€é€‰æ‹© -->
            <div>
                <label for="statusSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">flag</span>
                    <span class="align-middle">åˆå§‹çŠ¶æ€</span>
                </label>
                <select id="statusSelect"
                        required
                        onchange="handleAddCompetitionStatusChange(this.value)"
                        class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <option value="æœªæŠ¥å">æœªæŠ¥å</option>
                    <option value="å·²æŠ¥å">å·²æŠ¥å</option>
                    <option value="å›½å®¶ä¸€ç­‰å¥–">å›½å®¶ä¸€ç­‰å¥–</option>
                    <option value="å›½å®¶äºŒç­‰å¥–">å›½å®¶äºŒç­‰å¥–</option>
                    <option value="å›½å®¶ä¸‰ç­‰å¥–">å›½å®¶ä¸‰ç­‰å¥–</option>
                    <option value="å¸‚çº§ä¸€ç­‰å¥–">å¸‚çº§ä¸€ç­‰å¥–</option>
                    <option value="å¸‚çº§äºŒç­‰å¥–">å¸‚çº§äºŒç­‰å¥–</option>
                    <option value="å¸‚çº§ä¸‰ç­‰å¥–">å¸‚çº§ä¸‰ç­‰å¥–</option>
                    <option value="å…¶ä»–å¥–é¡¹">å…¶ä»–å¥–é¡¹...</option>
                </select>
            </div>

            <!-- è‡ªå®šä¹‰å¥–é¡¹è¾“å…¥æ¡† -->
            <div id="customAwardInputDiv" class="hidden">
                <label for="customAwardInput" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">edit</span>
                    <span class="align-middle">è‡ªå®šä¹‰å¥–é¡¹åç§°</span>
                </label>
                <input type="text"
                       id="customAwardInput"
                       placeholder="ä¾‹å¦‚ï¼šä¼˜ç§€å¥–ã€é¼“åŠ±å¥–"
                       class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button"
                        onclick="closeAddCompetitionModal()"
                        class="px-5 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all">
                    å–æ¶ˆ
                </button>
                <button type="submit"
                        class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 border-0 rounded-lg text-sm font-medium text-white hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle">add</span>
                    <span class="align-middle">ç¡®å®š</span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.animate-fadeIn {
    animation: fadeIn 0.2s ease-out;
}
</style>

<!-- æ–°å¢å®¢æˆ·æ²Ÿé€šè®°å½•æ¨¡æ€æ¡† -->
<div id="addCustomerCommunicationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">æ–°å¢å®¢æˆ·æ²Ÿé€šè®°å½•</h3>
                <button onclick="closeAddCustomerCommunicationModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="addCustomerCommunicationForm" onsubmit="submitCustomerCommunicationRecord(event)" class="space-y-4">
                <input type="hidden" id="customerCommunicationLeadId">

                <div>
                    <label for="customerCommunicationContent" class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm mr-1">edit</span>æ²Ÿé€šå†…å®¹
                    </label>
                    <textarea id="customerCommunicationContent"
                              name="content"
                              rows="4"
                              required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="è¯·è¾“å…¥å®¢æˆ·é˜¶æ®µçš„æ²Ÿé€šå†…å®¹æˆ–åé¦ˆä¿¡æ¯..."></textarea>
                </div>

                <div>
                    <label for="customerCommunicationTime" class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm mr-1">schedule</span>æ²Ÿé€šæ—¶é—´
                    </label>
                    <input type="datetime-local"
                           id="customerCommunicationTime"
                           name="communication_time"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button"
                            onclick="closeAddCustomerCommunicationModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                        <span class="material-symbols-outlined text-sm mr-1">save</span>ä¿å­˜è®°å½•
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- åŒ…å«å­¦å‘˜è¯¦æƒ…å¼¹çª—ç»„ä»¶ -->
{% include 'components/student_detail_modal.html' %}

<!-- èµ›äº‹è¿›å±•æŸ¥çœ‹å¼¹çª—ï¼ˆåªè¯»ï¼‰ -->
<div id="competitionsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <!-- å¼¹çª—æ ‡é¢˜ -->
        <div class="flex justify-between items-center mb-4 pb-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">
                <span id="competitionsModalTitle">èµ›äº‹è¿›å±•</span>
            </h3>
            <button onclick="closeCompetitionsModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- èµ›äº‹åˆ—è¡¨ï¼ˆåªè¯»ï¼‰ -->
        <div id="competitionsList" class="space-y-3 mb-4">
            <!-- åŠ¨æ€åŠ è½½èµ›äº‹åˆ—è¡¨ -->
        </div>

        <!-- å…³é—­æŒ‰é’® -->
        <div class="flex justify-end pt-4 border-t">
            <button onclick="closeCompetitionsModal()"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                å…³é—­
            </button>
        </div>
    </div>
</div>



<script>
let competitionCustomerId = null;
let competitionStudentName = '';
let competitionNames = [];

// æ˜¾ç¤ºèµ›äº‹ç®¡ç†å¼¹çª—
async function showCompetitionsModal(customerId, studentName) {
    competitionCustomerId = customerId;
    competitionStudentName = studentName;

    document.getElementById('competitionsModalTitle').textContent = `${studentName} - èµ›äº‹è¿›å±•ç®¡ç†`;
    document.getElementById('competitionsModal').classList.remove('hidden');

    // åŠ è½½èµ›äº‹åˆ—è¡¨
    await loadCompetitions();
}

// å…³é—­èµ›äº‹ç®¡ç†å¼¹çª—
function closeCompetitionsModal() {
    document.getElementById('competitionsModal').classList.add('hidden');
    competitionCustomerId = null;
    competitionStudentName = '';
}

// åŠ è½½èµ›äº‹åˆ—è¡¨
async function loadCompetitions() {
    try {
        const response = await fetch(`/customers/api/${competitionCustomerId}/competitions`);
        const data = await response.json();

        if (data.success) {
            renderCompetitions(data.competitions);
        } else {
            alert('åŠ è½½èµ›äº‹åˆ—è¡¨å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('åŠ è½½èµ›äº‹åˆ—è¡¨å¤±è´¥:', error);
        alert('åŠ è½½èµ›äº‹åˆ—è¡¨å¤±è´¥');
    }
}

// æ¸²æŸ“èµ›äº‹åˆ—è¡¨ï¼ˆåªè¯»æ¨¡å¼ï¼‰
function renderCompetitions(competitions) {
    const container = document.getElementById('competitionsList');

    if (competitions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <span class="material-symbols-outlined text-4xl mb-2">emoji_events</span>
                <p>æš‚æ— èµ›äº‹è®°å½•</p>
            </div>
        `;
        return;
    }

    container.innerHTML = competitions.map(comp => `
        <div class="border rounded-lg p-3 bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-medium text-gray-900 text-sm mb-1">ğŸ† ${comp.competition_name}</div>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${comp.status_color}">
                        ${comp.display_status}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

// ========== èµ›äº‹ç®¡ç†åŠŸèƒ½ï¼ˆåœ¨è¿›åº¦æ›´æ–°å¼¹çª—ä¸­ï¼‰ ==========

let progressCompetitionNames = [];

// åŠ è½½è¿›åº¦æ›´æ–°å¼¹çª—ä¸­çš„èµ›äº‹åˆ—è¡¨
async function loadProgressCompetitions(customerId) {
    try {
        const response = await fetch(`/customers/api/${customerId}/competitions`);
        const data = await response.json();

        if (data.success) {
            renderProgressCompetitions(data.competitions);
        } else {
            document.getElementById('progressCompetitionsList').innerHTML = `
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>åŠ è½½å¤±è´¥</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½èµ›äº‹åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('progressCompetitionsList').innerHTML = `
            <div class="text-center text-gray-500 text-sm py-4">
                <p>åŠ è½½å¤±è´¥</p>
            </div>
        `;
    }
}

// æ¸²æŸ“è¿›åº¦æ›´æ–°å¼¹çª—ä¸­çš„èµ›äº‹åˆ—è¡¨
function renderProgressCompetitions(competitions) {
    const container = document.getElementById('progressCompetitionsList');

    if (competitions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-4">
                <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">emoji_events</span>
                <p>æš‚æ— èµ›äº‹è®°å½•</p>
            </div>
        `;
        return;
    }

    container.innerHTML = competitions.map(comp => `
        <div class="border rounded-md p-2 bg-white">
            <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-gray-900 text-sm">ğŸ† ${comp.competition_name}</div>
                <button onclick="deleteProgressCompetition(${comp.id}, '${comp.competition_name}')"
                        class="text-red-600 hover:text-red-800 text-xs">
                    åˆ é™¤
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <select onchange="updateProgressCompetitionStatus(${comp.id}, this.value)"
                        data-comp-id="${comp.id}"
                        class="text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 ${comp.status_color} flex-1">
                    <option value="æœªæŠ¥å" ${comp.status === 'æœªæŠ¥å' ? 'selected' : ''}>æœªæŠ¥å</option>
                    <option value="å·²æŠ¥å" ${comp.status === 'å·²æŠ¥å' ? 'selected' : ''}>å·²æŠ¥å</option>
                    <option value="å›½å®¶ä¸€ç­‰å¥–" ${comp.status === 'å›½å®¶ä¸€ç­‰å¥–' ? 'selected' : ''}>å›½å®¶ä¸€ç­‰å¥–</option>
                    <option value="å›½å®¶äºŒç­‰å¥–" ${comp.status === 'å›½å®¶äºŒç­‰å¥–' ? 'selected' : ''}>å›½å®¶äºŒç­‰å¥–</option>
                    <option value="å›½å®¶ä¸‰ç­‰å¥–" ${comp.status === 'å›½å®¶ä¸‰ç­‰å¥–' ? 'selected' : ''}>å›½å®¶ä¸‰ç­‰å¥–</option>
                    <option value="å¸‚çº§ä¸€ç­‰å¥–" ${comp.status === 'å¸‚çº§ä¸€ç­‰å¥–' ? 'selected' : ''}>å¸‚çº§ä¸€ç­‰å¥–</option>
                    <option value="å¸‚çº§äºŒç­‰å¥–" ${comp.status === 'å¸‚çº§äºŒç­‰å¥–' ? 'selected' : ''}>å¸‚çº§äºŒç­‰å¥–</option>
                    <option value="å¸‚çº§ä¸‰ç­‰å¥–" ${comp.status === 'å¸‚çº§ä¸‰ç­‰å¥–' ? 'selected' : ''}>å¸‚çº§ä¸‰ç­‰å¥–</option>
                    <option value="å…¶ä»–å¥–é¡¹" ${comp.status === 'å…¶ä»–å¥–é¡¹' ? 'selected' : ''}>å…¶ä»–å¥–é¡¹...</option>
                </select>
            </div>
            ${comp.status === 'å…¶ä»–å¥–é¡¹' ? `
                <input type="text"
                       id="progressCustomAward_${comp.id}"
                       value="${comp.custom_award || ''}"
                       placeholder="è¾“å…¥å¥–é¡¹åç§°"
                       class="mt-2 text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 w-full"
                       onblur="saveProgressCustomAward(${comp.id})">
            ` : ''}
        </div>
    `).join('');
}

// æ›´æ–°èµ›äº‹çŠ¶æ€
async function updateProgressCompetitionStatus(competitionId, newStatus) {
    // å¦‚æœé€‰æ‹©"å…¶ä»–å¥–é¡¹"ï¼Œéœ€è¦ç­‰å¾…ç”¨æˆ·è¾“å…¥è‡ªå®šä¹‰å¥–é¡¹åç§°
    if (newStatus === 'å…¶ä»–å¥–é¡¹') {
        // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºè¾“å…¥æ¡†
        await loadProgressCompetitions(currentCustomerId);
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus,
                custom_award: null
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast('çŠ¶æ€å·²æ›´æ–°');
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + data.message);
            await loadProgressCompetitions(currentCustomerId);
        }
    } catch (error) {
        console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
        alert('æ›´æ–°çŠ¶æ€å¤±è´¥');
        await loadProgressCompetitions(currentCustomerId);
    }
}

// ä¿å­˜è‡ªå®šä¹‰å¥–é¡¹
async function saveProgressCustomAward(competitionId) {
    const customAward = document.getElementById(`progressCustomAward_${competitionId}`).value.trim();

    if (!customAward) {
        alert('è¯·è¾“å…¥è‡ªå®šä¹‰å¥–é¡¹åç§°');
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'å…¶ä»–å¥–é¡¹',
                custom_award: customAward
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast('çŠ¶æ€å·²æ›´æ–°');
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

// åˆ é™¤èµ›äº‹
async function deleteProgressCompetition(competitionId, competitionName) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤èµ›äº‹"${competitionName}"å—ï¼Ÿ`)) {
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

// æ˜¾ç¤ºæ·»åŠ èµ›äº‹å¼¹çª—
async function showAddCompetitionInProgress() {
    // åŠ è½½èµ›äº‹åç§°åˆ—è¡¨
    await loadProgressCompetitionNames();

    // å¡«å……èµ›äº‹ä¸‹æ‹‰æ¡†
    const competitionSelect = document.getElementById('competitionSelect');
    competitionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©èµ›äº‹...</option>';
    progressCompetitionNames.forEach(cn => {
        const option = document.createElement('option');
        option.value = cn.id;
        option.textContent = cn.name;
        competitionSelect.appendChild(option);
    });

    // é‡ç½®è¡¨å•
    document.getElementById('addCompetitionForm').reset();
    document.getElementById('customAwardInputDiv').classList.add('hidden');
    document.getElementById('customAwardInput').value = '';

    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('addCompetitionModal').classList.remove('hidden');
}

// å…³é—­æ·»åŠ èµ›äº‹å¼¹çª—
function closeAddCompetitionModal() {
    document.getElementById('addCompetitionModal').classList.add('hidden');
}

// å¤„ç†çŠ¶æ€é€‰æ‹©å˜åŒ–
function handleAddCompetitionStatusChange(status) {
    const customAwardDiv = document.getElementById('customAwardInputDiv');
    const customAwardInput = document.getElementById('customAwardInput');

    if (status === 'å…¶ä»–å¥–é¡¹') {
        customAwardDiv.classList.remove('hidden');
        customAwardInput.required = true;
    } else {
        customAwardDiv.classList.add('hidden');
        customAwardInput.required = false;
        customAwardInput.value = '';
    }
}

// æäº¤æ·»åŠ èµ›äº‹è¡¨å•
async function submitAddCompetition(event) {
    event.preventDefault();

    const competitionNameId = document.getElementById('competitionSelect').value;
    const status = document.getElementById('statusSelect').value;
    const customAward = document.getElementById('customAwardInput').value;

    if (!competitionNameId) {
        alert('è¯·é€‰æ‹©èµ›äº‹');
        return;
    }

    if (status === 'å…¶ä»–å¥–é¡¹' && !customAward) {
        alert('è¯·è¾“å…¥è‡ªå®šä¹‰å¥–é¡¹åç§°');
        return;
    }

    // æ·»åŠ èµ›äº‹
    try {
        const response = await fetch(`/customers/api/${currentCustomerId}/competitions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                competition_name_id: parseInt(competitionNameId),
                status: status,
                custom_award: status === 'å…¶ä»–å¥–é¡¹' ? customAward : null
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadProgressCompetitions(currentCustomerId);
            closeAddCompetitionModal();
        } else {
            alert('æ·»åŠ å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥');
    }
}

// åŠ è½½èµ›äº‹åç§°åˆ—è¡¨
async function loadProgressCompetitionNames() {
    try {
        const response = await fetch('/customers/api/competition-names');
        const data = await response.json();

        if (data.success) {
            progressCompetitionNames = data.competition_names;
        }
    } catch (error) {
        console.error('åŠ è½½èµ›äº‹åç§°å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showProgressToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 1000);
}

// ========== è¯¾ç¨‹è®°å½•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==========

// æ˜¾ç¤ºè¯¾ç¨‹è®°å½•å›¾ç‰‡ä¸Šä¼ è¡¨å•
function showCourseRecordImageUpload() {
    document.getElementById('courseRecordImageUploadForm').classList.remove('hidden');
}

// éšè—è¯¾ç¨‹è®°å½•å›¾ç‰‡ä¸Šä¼ è¡¨å•
function hideCourseRecordImageUpload() {
    document.getElementById('courseRecordImageUploadForm').classList.add('hidden');
    document.getElementById('courseRecordImageInput').value = '';
    document.getElementById('courseRecordImageDescription').value = '';
}

// åŠ è½½è¯¾ç¨‹è®°å½•å›¾ç‰‡
async function loadCourseRecordImages(customerId) {
    try {
        const response = await fetch(`/customers/${customerId}/course-record-images`);
        const data = await response.json();

        const container = document.getElementById('courseRecordImagesList');

        if (data.success && data.images.length > 0) {
            container.innerHTML = data.images.map(img => `
                <div class="relative group">
                    <img src="/${img.image_path}" alt="${img.description || 'è¯¾ç¨‹è®°å½•'}"
                         class="w-full h-20 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-75 transition-opacity"
                         onclick="window.open('/${img.image_path}', '_blank')">
                    <button type="button" onclick="deleteCourseRecordImage(${img.id})"
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-xs">close</span>
                    </button>
                    ${img.description ? `<div class="text-xs text-gray-600 mt-1 truncate" title="${img.description}">${img.description}</div>` : ''}
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="col-span-3 text-center text-gray-400 text-xs py-4">æš‚æ— å›¾ç‰‡</div>';
        }
    } catch (error) {
        console.error('åŠ è½½è¯¾ç¨‹è®°å½•å›¾ç‰‡å¤±è´¥:', error);
    }
}

// ä¸Šä¼ è¯¾ç¨‹è®°å½•å›¾ç‰‡
async function uploadCourseRecordImages() {
    const fileInput = document.getElementById('courseRecordImageInput');
    const description = document.getElementById('courseRecordImageDescription').value;

    if (!fileInput.files.length) {
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
        return;
    }

    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('images', fileInput.files[i]);
        formData.append('descriptions', description);
    }

    try {
        const response = await fetch(`/customers/${currentCustomerId}/upload-course-record-image`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadCourseRecordImages(currentCustomerId);
            hideCourseRecordImageUpload();
        } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        alert('ä¸Šä¼ å¤±è´¥');
    }
}

// åˆ é™¤è¯¾ç¨‹è®°å½•å›¾ç‰‡
async function deleteCourseRecordImage(imageId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/customers/delete-course-record-image/${imageId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadCourseRecordImages(currentCustomerId);
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

// ========== è·å¥–è¯ä¹¦å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==========

// æ˜¾ç¤ºè·å¥–è¯ä¹¦å›¾ç‰‡ä¸Šä¼ è¡¨å•
function showAwardCertificateImageUpload() {
    document.getElementById('awardCertificateImageUploadForm').classList.remove('hidden');
}

// éšè—è·å¥–è¯ä¹¦å›¾ç‰‡ä¸Šä¼ è¡¨å•
function hideAwardCertificateImageUpload() {
    document.getElementById('awardCertificateImageUploadForm').classList.add('hidden');
    document.getElementById('awardCertificateImageInput').value = '';
    document.getElementById('awardCertificateImageDescription').value = '';
}

// åŠ è½½è·å¥–è¯ä¹¦å›¾ç‰‡
async function loadAwardCertificateImages(customerId) {
    try {
        const response = await fetch(`/customers/${customerId}/award-certificate-images`);
        const data = await response.json();

        const container = document.getElementById('awardCertificateImagesList');

        if (data.success && data.images.length > 0) {
            container.innerHTML = data.images.map(img => `
                <div class="relative group">
                    <img src="/${img.image_path}" alt="${img.description || 'è·å¥–è¯ä¹¦'}"
                         class="w-full h-20 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-75 transition-opacity"
                         onclick="window.open('/${img.image_path}', '_blank')">
                    <button type="button" onclick="deleteAwardCertificateImage(${img.id})"
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-xs">close</span>
                    </button>
                    ${img.description ? `<div class="text-xs text-gray-600 mt-1 truncate" title="${img.description}">${img.description}</div>` : ''}
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="col-span-3 text-center text-gray-400 text-xs py-4">æš‚æ— å›¾ç‰‡</div>';
        }
    } catch (error) {
        console.error('åŠ è½½è·å¥–è¯ä¹¦å›¾ç‰‡å¤±è´¥:', error);
    }
}

// ä¸Šä¼ è·å¥–è¯ä¹¦å›¾ç‰‡
async function uploadAwardCertificateImages() {
    const fileInput = document.getElementById('awardCertificateImageInput');
    const description = document.getElementById('awardCertificateImageDescription').value;

    if (!fileInput.files.length) {
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
        return;
    }

    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('images', fileInput.files[i]);
        formData.append('descriptions', description);
    }

    try {
        const response = await fetch(`/customers/${currentCustomerId}/upload-award-certificate-image`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadAwardCertificateImages(currentCustomerId);
            hideAwardCertificateImageUpload();
        } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        alert('ä¸Šä¼ å¤±è´¥');
    }
}

// åˆ é™¤è·å¥–è¯ä¹¦å›¾ç‰‡
async function deleteAwardCertificateImage(imageId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/customers/delete-award-certificate-image/${imageId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadAwardCertificateImages(currentCustomerId);
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}

</script>

{% endblock %}
