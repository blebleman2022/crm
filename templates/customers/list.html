{% extends "leads/base.html" %}

{% block title %}客户管理 - EduConnect CRM{% endblock %}
{% block page_title %}客户管理{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <div class="bg-white p-6 rounded-lg shadow-sm">
        <!-- 搜索和筛选 -->
        <form method="GET" class="mb-6 space-y-4">
            <!-- 第一行：搜索、服务内容、销售 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="sr-only" for="search">搜索</label>
                    <div class="relative">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="material-symbols-outlined text-gray-400">search</span>
                        </div>
                        <input class="block w-full rounded-md border-0 py-2.5 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                               id="search" name="search" placeholder="搜索学员姓名" type="search" value="{{ search }}"/>
                    </div>
                </div>

                <div>
                    <select class="block w-full rounded-md border-0 py-2.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                            name="service_type">
                        <option value="">所有服务内容</option>
                        <option value="tutoring" {% if service_type == 'tutoring' %}selected{% endif %}>课题辅导</option>
                        <option value="competition" {% if service_type == 'competition' %}selected{% endif %}>竞赛辅导</option>
                        <option value="upgrade_guidance" {% if service_type == 'upgrade_guidance' %}selected{% endif %}>升学陪跑</option>
                    </select>
                </div>

                <div>
                    <select class="block w-full rounded-md border-0 py-2.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"
                            name="sales">
                        <option value="">所有销售</option>
                        {% for sales in sales_users %}
                            <option value="{{ sales.id }}" {% if sales_filter == sales.id|string %}selected{% endif %}>{{ sales.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- 第二行：时间段筛选 -->
            <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
                <div class="flex items-center gap-2">
                    <label for="start_date" class="text-sm font-medium text-gray-700">开始日期:</label>
                    <input type="date"
                           id="start_date"
                           name="start_date"
                           value="{{ start_date }}"
                           class="rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"/>
                </div>

                <div class="flex items-center gap-2">
                    <label for="end_date" class="text-sm font-medium text-gray-700">结束日期:</label>
                    <input type="date"
                           id="end_date"
                           name="end_date"
                           value="{{ end_date }}"
                           class="rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm"/>
                </div>

                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span class="material-symbols-outlined mr-1 text-sm">search</span>
                    查询
                </button>
            </div>
        </form>

        <!-- 客户列表 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-24">学员姓名</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">责任销售</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">班主任</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">辅导老师</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">奖项要求</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">中高考时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">课程进度</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">赛事进展</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">升学陪跑</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 w-20">新增时间</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">操作</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for customer in customers.items %}
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-3 py-4 text-sm font-medium text-gray-900 w-24">
                            <div class="flex items-center space-x-2">
                                {% if customer.is_priority %}
                                    <span class="material-symbols-outlined text-yellow-500 text-lg" title="重点关注客户">star</span>
                                {% endif %}
                                <button onclick="showStudentDetailModal({{ customer.id }}, true, {% if current_user.role == 'teacher_supervisor' %}true{% else %}false{% endif %})" class="text-blue-600 hover:text-blue-800 cursor-pointer">
                                    {{ customer.lead.student_name }}
                                </button>
                                {% if customer.lead.additional_requirements %}
                                    <span class="material-symbols-outlined text-red-600 text-sm" title="有额外要求">add_circle</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">{{ customer.lead.sales_user.username }}</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.teacher_user %}
                                {{ customer.teacher_user.username }}
                            {% else %}
                                <span class="text-gray-400">未分配</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.teacher %}
                                {% if current_user.role == 'teacher_supervisor' %}
                                    <button onclick="showChangeTeacherModal({{ customer.id }}, '{{ customer.lead.student_name }}', {{ customer.teacher.id }}, '{{ customer.teacher.chinese_name }}')"
                                            class="text-blue-600 hover:text-blue-800 cursor-pointer">
                                        {{ customer.teacher.chinese_name }}
                                    </button>
                                {% else %}
                                    <span class="text-gray-900">{{ customer.teacher.chinese_name }}</span>
                                {% endif %}
                            {% else %}
                                {% if current_user.role == 'teacher_supervisor' %}
                                    <button onclick="showAssignTeacherModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="text-red-600 hover:text-red-800 cursor-pointer">待分配</button>
                                {% else %}
                                    <span class="text-gray-400">待分配</span>
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% if customer.competition_award_level == '市奖' %}
                                <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">市奖</span>
                            {% elif customer.competition_award_level == '国奖' %}
                                <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">国奖</span>
                            {% else %}
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">无</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                            {% if customer.exam_year %}
                                {{ customer.exam_year }}年
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% if customer.tutoring_delivery %}
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ customer.tutoring_delivery.completed_sessions }}/{{ customer.tutoring_delivery.total_sessions }}
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            {% set progress = (customer.tutoring_delivery.completed_sessions / customer.tutoring_delivery.total_sessions * 100) if customer.tutoring_delivery.total_sessions > 0 else 0 %}
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: {{ progress }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% set service_types = customer.lead.get_service_types_list() %}
                            {% if 'competition' in service_types %}
                                {% set comp_count = competition_counts.get(customer.id, 0) %}
                                {% if comp_count > 0 %}
                                    <button onclick="showCompetitionsModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800 hover:bg-blue-200 cursor-pointer">
                                        🏆 {{ comp_count }}项
                                    </button>
                                {% else %}
                                    <button onclick="showCompetitionsModal({{ customer.id }}, '{{ customer.lead.student_name }}')"
                                            class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 hover:bg-gray-200 cursor-pointer">
                                        🏆 0项
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% set service_types = customer.lead.get_service_types_list() %}
                            {% if 'upgrade_guidance' in service_types %}
                                <span class="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-800">包含</span>
                            {% else %}
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">不包含</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 w-20">
                            {% if second_payments.get(customer.lead_id) %}
                                {{ second_payments[customer.lead_id].year }}/{{ second_payments[customer.lead_id].month }}/{{ second_payments[customer.lead_id].day }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                            {% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
                            <button onclick="openProgressModal({{ customer.id }}, {{ customer.lead.sales_user_id }})" class="text-blue-600 hover:text-blue-800">进度更新</button>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        {% if customers.pages > 1 %}
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4">
            <div class="flex flex-1 justify-between sm:hidden">
                {% if customers.has_prev %}
                    <a href="{{ url_for('customers.list_customers', page=customers.prev_num, search=search, sales=sales_filter, service_type=service_type) }}"
                       class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">上一页</a>
                {% endif %}
                {% if customers.has_next %}
                    <a href="{{ url_for('customers.list_customers', page=customers.next_num, search=search, sales=sales_filter, service_type=service_type) }}"
                       class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">下一页</a>
                {% endif %}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        显示第 <span class="font-medium">{{ (customers.page - 1) * customers.per_page + 1 }}</span> 到
                        <span class="font-medium">{{ customers.page * customers.per_page if customers.page * customers.per_page < customers.total else customers.total }}</span> 条，
                        共 <span class="font-medium">{{ customers.total }}</span> 条记录
                    </p>
                </div>
                <div>
                    <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm">
                        {% if customers.has_prev %}
                            <a href="{{ url_for('customers.list_customers', page=customers.prev_num, search=search, sales=sales_filter, service_type=service_type) }}"
                               class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                <span class="material-symbols-outlined h-5 w-5">chevron_left</span>
                            </a>
                        {% endif %}

                        {% for page_num in customers.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != customers.page %}
                                    <a href="{{ url_for('customers.list_customers', page=page_num, search=search, sales=sales_filter, service_type=service_type) }}"
                                       class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">{{ page_num }}</a>
                                {% else %}
                                    <span class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300">…</span>
                            {% endif %}
                        {% endfor %}

                        {% if customers.has_next %}
                            <a href="{{ url_for('customers.list_customers', page=customers.next_num, search=search, sales=sales_filter, service_type=service_type) }}"
                               class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                <span class="material-symbols-outlined h-5 w-5">chevron_right</span>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 分配辅导老师模态框 -->
<div id="assignTeacherModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">分配辅导老师</h3>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">学员：<span id="assignStudentName" class="font-medium"></span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择辅导老师</label>
                    <select id="teacherSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">请选择辅导老师</option>
                    </select>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" onclick="assignTeacher()"
                        class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
                    确定
                </button>
                <button type="button" onclick="hideAssignTeacherModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm">
                    取消
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 更换辅导老师模态框 -->
<div id="changeTeacherModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">更换辅导老师</h3>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">学员：<span id="changeStudentName" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600 mb-3">当前辅导老师：<span id="currentTeacherName" class="font-medium text-blue-600"></span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择新辅导老师</label>
                    <select id="newTeacherSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">请选择辅导老师</option>
                    </select>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-yellow-400">warning</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                更换辅导老师需要二次确认，请谨慎操作
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" onclick="changeTeacher(event)"
                        class="inline-flex w-full justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
                    确认更换
                </button>
                <button type="button" onclick="hideChangeTeacherModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm">
                    取消
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 自动提交搜索表单
document.querySelectorAll('select[name="service_type"], select[name="sales"]').forEach(select => {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});

let currentCustomerId = null;
let currentStudentName = null;
let currentTeacherId = null;
let currentTeacherName = null;
let allTeachers = [];

// 加载所有启用的老师
function loadTeachers() {
    fetch('/teachers/get_active_teachers')
        .then(response => response.json())
        .then(data => {
            allTeachers = data;
        })
        .catch(error => {
            console.error('加载老师列表失败:', error);
        });
}

// 页面加载时获取老师列表
loadTeachers();

// 显示分配辅导老师模态框
function showAssignTeacherModal(customerId, studentName) {
    currentCustomerId = customerId;
    currentStudentName = studentName;

    // 设置学员名称
    document.getElementById('assignStudentName').textContent = studentName;

    // 填充老师下拉列表
    const teacherSelect = document.getElementById('teacherSelect');
    teacherSelect.innerHTML = '<option value="">请选择辅导老师</option>';
    allTeachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = `${teacher.chinese_name}${teacher.english_name ? ' (' + teacher.english_name + ')' : ''}${teacher.major_direction ? ' - ' + teacher.major_direction : ''}`;
        teacherSelect.appendChild(option);
    });

    document.getElementById('assignTeacherModal').classList.remove('hidden');
}

// 隐藏分配辅导老师模态框
function hideAssignTeacherModal() {
    currentCustomerId = null;
    currentStudentName = null;
    document.getElementById('assignTeacherModal').classList.add('hidden');
    document.getElementById('teacherSelect').value = '';
}

// 分配辅导老师
function assignTeacher() {
    const teacherId = document.getElementById('teacherSelect').value;
    if (!teacherId) {
        alert('请选择辅导老师');
        return;
    }

    const formData = new FormData();
    formData.append('teacher_id', teacherId);

    fetch(`/teachers/assign/${currentCustomerId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            hideAssignTeacherModal();
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('操作失败，请重试');
    });
}

// 显示更换辅导老师模态框
function showChangeTeacherModal(customerId, studentName, teacherId, teacherName) {
    currentCustomerId = customerId;
    currentStudentName = studentName;
    currentTeacherId = teacherId;
    currentTeacherName = teacherName;

    // 设置学员名称和当前辅导老师
    document.getElementById('changeStudentName').textContent = studentName;
    document.getElementById('currentTeacherName').textContent = teacherName;

    // 填充老师下拉列表（排除当前老师）
    const newTeacherSelect = document.getElementById('newTeacherSelect');
    newTeacherSelect.innerHTML = '<option value="">请选择辅导老师</option>';
    allTeachers.forEach(teacher => {
        if (teacher.id !== teacherId) {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.chinese_name}${teacher.english_name ? ' (' + teacher.english_name + ')' : ''}${teacher.major_direction ? ' - ' + teacher.major_direction : ''}`;
            newTeacherSelect.appendChild(option);
        }
    });

    document.getElementById('changeTeacherModal').classList.remove('hidden');
}

// 隐藏更换辅导老师模态框
function hideChangeTeacherModal() {
    currentCustomerId = null;
    currentStudentName = null;
    currentTeacherId = null;
    currentTeacherName = null;
    changeTeacherConfirmed = false;

    // 重置按钮状态
    if (changeTeacherButton) {
        changeTeacherButton.disabled = false;
        changeTeacherButton.textContent = '确认更换';
        changeTeacherButton.classList.remove('animate-pulse');
        changeTeacherButton = null;
    }

    document.getElementById('changeTeacherModal').classList.add('hidden');
    document.getElementById('newTeacherSelect').value = '';
}

// 更换辅导老师（需要二次确认）
let changeTeacherConfirmed = false;
let changeTeacherButton = null;

function changeTeacher(event) {
    const newTeacherId = document.getElementById('newTeacherSelect').value;
    if (!newTeacherId) {
        alert('请选择新辅导老师');
        return;
    }

    // 保存按钮引用
    if (!changeTeacherButton) {
        changeTeacherButton = event.target;
    }

    // 第一次点击，显示确认提示
    if (!changeTeacherConfirmed) {
        const newTeacher = allTeachers.find(t => t.id == newTeacherId);
        if (confirm(`确定要将辅导老师从 ${currentTeacherName} 更换为 ${newTeacher.chinese_name} 吗？\n\n此操作需要二次确认，请再次点击"确认更换"按钮。`)) {
            changeTeacherConfirmed = true;
            // 改变按钮文字提示用户需要再次点击
            changeTeacherButton.textContent = '再次点击确认';
            changeTeacherButton.classList.add('animate-pulse');
        }
        return;
    }

    // 第二次点击，执行更换
    // 禁用按钮防止重复点击
    changeTeacherButton.disabled = true;
    changeTeacherButton.textContent = '处理中...';

    fetch(`/teachers/change/${currentCustomerId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            teacher_id: parseInt(newTeacherId),
            confirmed: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            changeTeacherConfirmed = false;
            changeTeacherButton = null;
            hideChangeTeacherModal();
            location.reload();
        } else {
            alert(data.message);
            changeTeacherConfirmed = false;
            changeTeacherButton.disabled = false;
            changeTeacherButton.textContent = '确认更换';
            changeTeacherButton.classList.remove('animate-pulse');
            changeTeacherButton = null;
        }
    })
    .catch(error => {
        alert('操作失败，请重试');
        changeTeacherConfirmed = false;
        if (changeTeacherButton) {
            changeTeacherButton.disabled = false;
            changeTeacherButton.textContent = '确认更换';
            changeTeacherButton.classList.remove('animate-pulse');
        }
        changeTeacherButton = null;
    });
}

{% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
// 进度更新模态窗口功能
function openProgressModal(customerId, salesUserId) {
    // 获取当前用户信息
    const currentUserId = {{ current_user.id }};
    const currentUserRole = '{{ current_user.role }}';

    // 权限检查：销售管理只能更新自己负责的客户进度
    if (currentUserRole === 'sales_manager' && salesUserId !== currentUserId) {
        alert('不能更改其他销售负责的客户进度');
        return;
    }

    // 获取客户详细信息
    fetch(`/customers/${customerId}/progress`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const customer = data.customer;

                // 设置全局变量
                currentCustomerLeadId = customer.lead_id;
                currentCustomerId = customerId;

                // 填充表单数据
                document.getElementById('progressCustomerId').value = customerId;
                document.getElementById('progressStudentName').textContent = customer.student_name;

                // 课程进度
                if (customer.tutoring_delivery) {
                    document.getElementById('totalSessions').value = customer.tutoring_delivery.total_sessions || 0;
                    document.getElementById('completedSessions').value = customer.tutoring_delivery.completed_sessions || 0;
                } else {
                    document.getElementById('totalSessions').value = 0;
                    document.getElementById('completedSessions').value = 0;
                }

                // 根据服务类型显示或隐藏赛事管理模块
                const hasCompetitionService = customer.service_types && customer.service_types.includes('competition');
                const competitionSection = document.getElementById('competitionManagementSection');
                if (hasCompetitionService) {
                    competitionSection.classList.remove('hidden');
                    // 加载赛事列表
                    loadProgressCompetitions(customerId);
                } else {
                    competitionSection.classList.add('hidden');
                }

                // 设置星标状态
                updatePriorityStarDisplay(customer.is_priority);

                // 加载客户阶段沟通记录
                loadCustomerCommunicationRecords(customer.lead_id, customerId);

                // 显示模态窗口
                document.getElementById('progressModal').classList.remove('hidden');
            } else {
                alert('获取客户信息失败');
            }
        })
        .catch(error => {
            alert('获取客户信息失败，请重试');
        });
}

function closeProgressModal() {
    document.getElementById('progressModal').classList.add('hidden');
    // 清理全局变量
    currentCustomerLeadId = null;
    currentCustomerId = null;
}

function updateProgress() {
    const customerId = document.getElementById('progressCustomerId').value;
    const totalSessions = document.getElementById('totalSessions').value;
    const completedSessions = document.getElementById('completedSessions').value;

    // 验证数据
    if (parseInt(completedSessions) > parseInt(totalSessions)) {
        alert('已完成课程数量不能大于总课程数量');
        return;
    }

    fetch(`/customers/${customerId}/update_progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            total_sessions: parseInt(totalSessions),
            completed_sessions: parseInt(completedSessions)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeProgressModal();
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('更新失败，请重试');
    });
}
{% endif %}

// 加载客户阶段沟通记录
function loadCustomerCommunicationRecords(leadId, customerId) {
    const container = document.getElementById('customerCommunicationRecords');
    const statsContainer = document.getElementById('customerCommunicationStats');

    // 显示加载状态
    container.innerHTML = `
        <div class="text-center text-gray-500 text-sm py-4">
            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">hourglass_empty</span>
            <p>加载中...</p>
        </div>
    `;

    // 获取客户阶段沟通记录
    fetch(`/consultations/details_data/${leadId}?customer_only=true`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.communication_records) {
                const records = data.data.communication_records;
                const stats = data.data.stats || {};

                // 更新统计信息
                if (statsContainer) {
                    statsContainer.textContent = `客户阶段: ${stats.customer_stage_count || 0} 条记录`;
                }

                if (records.length > 0) {
                    // 按时间倒序排列
                    records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    // 创建表格形式显示
                    const recordsHtml = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">时间</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">沟通内容</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${records.map(record => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">
                                            ${new Date(record.created_at).toLocaleString('zh-CN', {
                                                month: '2-digit',
                                                day: '2-digit',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </td>
                                        <td class="px-3 py-2 text-sm text-gray-900">
                                            <div class="max-w-xs" title="${record.content}">
                                                ${record.content}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    container.innerHTML = recordsHtml;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 text-sm py-8">
                            <span class="material-symbols-outlined text-3xl mb-3 text-gray-300">inbox</span>
                            <p class="text-lg font-medium mb-1">暂无沟通记录</p>
                            <p class="text-sm">点击上方按钮添加第一条沟通记录</p>
                        </div>
                    `;
                }
            } else {
                container.innerHTML = `
                    <div class="text-center text-red-500 text-sm py-4">
                        <span class="material-symbols-outlined mr-2">error</span>
                        加载沟通记录失败
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading communication records:', error);
            container.innerHTML = `
                <div class="text-center text-red-500 text-sm py-4">
                    <span class="material-symbols-outlined mr-2">error</span>
                    网络错误，请稍后重试
                </div>
            `;
        });
}

// 全局变量存储当前客户信息
let currentCustomerLeadId = null;

// 显示新增客户沟通记录表单
function showAddCustomerCommunicationForm() {
    const modal = document.getElementById('addCustomerCommunicationModal');
    if (modal && currentCustomerLeadId) {
        // 设置lead_id
        document.getElementById('customerCommunicationLeadId').value = currentCustomerLeadId;

        // 设置默认时间为当前时间
        const timeInput = document.getElementById('customerCommunicationTime');
        if (timeInput) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            timeInput.value = now.toISOString().slice(0, 16);
        }

        modal.classList.remove('hidden');

        // 聚焦到内容输入框
        const contentInput = document.getElementById('customerCommunicationContent');
        if (contentInput) {
            setTimeout(() => contentInput.focus(), 100);
        }
    }
}

// 关闭新增客户沟通记录表单
function closeAddCustomerCommunicationModal() {
    const modal = document.getElementById('addCustomerCommunicationModal');
    if (modal) {
        modal.classList.add('hidden');

        // 清空表单
        const form = document.getElementById('addCustomerCommunicationForm');
        if (form) {
            form.reset();
        }
    }
}

// 提交客户沟通记录
function submitCustomerCommunicationRecord(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const leadId = document.getElementById('customerCommunicationLeadId').value;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // 禁用提交按钮
    submitBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-1 animate-spin">hourglass_empty</span>保存中...';
    submitBtn.disabled = true;

    fetch(`/consultations/add_communication/${leadId}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭表单
            closeAddCustomerCommunicationModal();

            // 重新加载沟通记录
            loadCustomerCommunicationRecords(leadId, currentCustomerId);

            // 显示成功提示
            showCustomerNotification('沟通记录添加成功！', 'success');
        } else {
            throw new Error(data.message || '添加失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCustomerNotification('添加沟通记录失败：' + error.message, 'error');
    })
    .finally(() => {
        // 恢复按钮状态
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// 显示通知
function showCustomerNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white ${bgColor}`;
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="material-symbols-outlined mr-2">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
            ${message}
        </div>
    `;

    document.body.appendChild(notification);

    // 3秒后自动移除
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// 重点关注客户星标功能
function updatePriorityStarDisplay(isPriority) {
    const starIcon = document.getElementById('priorityStarIcon');
    const starButton = document.getElementById('priorityStarButton');

    if (isPriority) {
        starIcon.textContent = 'star';
        starIcon.className = 'material-symbols-outlined text-lg text-yellow-500';
        starButton.title = '点击取消重点关注';
    } else {
        starIcon.textContent = 'star_border';
        starIcon.className = 'material-symbols-outlined text-lg text-gray-300';
        starButton.title = '点击标记为重点关注客户';
    }
}

function togglePriorityCustomer() {
    const customerId = document.getElementById('progressCustomerId').value;
    const starIcon = document.getElementById('priorityStarIcon');
    const starButton = document.getElementById('priorityStarButton');

    if (!customerId) {
        showCustomerNotification('客户ID获取失败', 'error');
        return;
    }

    // 获取当前状态
    const currentIsPriority = starIcon.textContent === 'star';
    const newIsPriority = !currentIsPriority;

    // 禁用按钮，显示加载状态
    starButton.disabled = true;
    starIcon.textContent = 'hourglass_empty';
    starIcon.className = 'material-symbols-outlined text-lg text-gray-400 animate-spin';

    // 发送请求
    fetch(`/customers/${customerId}/toggle_priority`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            is_priority: newIsPriority
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新星标显示
            updatePriorityStarDisplay(data.is_priority);

            // 显示成功提示
            const message = data.is_priority ? '已标记为重点关注客户' : '已取消重点关注标记';
            showCustomerNotification(message, 'success');

            // 刷新页面以更新列表中的星标显示
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || '操作失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCustomerNotification('操作失败：' + error.message, 'error');

        // 恢复原状态
        updatePriorityStarDisplay(currentIsPriority);
    })
    .finally(() => {
        // 恢复按钮状态
        starButton.disabled = false;
    });
}
</script>

<!-- 进度更新模态窗口 - 仅管理员、销售管理和班主任可见 -->
{% if current_user.is_admin() or current_user.is_sales_manager() or current_user.role == 'teacher_supervisor' %}
<div id="progressModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-0 border-0 w-full max-w-2xl shadow-2xl rounded-xl bg-white mb-10">
        <!-- 弹窗头部 - 蓝色渐变背景 -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="material-symbols-outlined text-white text-2xl">edit_note</span>
                    <div>
                        <h3 class="text-lg font-semibold text-white">进度更新</h3>
                        <p class="text-sm text-blue-100 mt-0.5">学员：<span id="progressStudentName" class="font-medium"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button"
                            id="priorityStarButton"
                            onclick="togglePriorityCustomer()"
                            class="focus:outline-none hover:scale-110 transition-transform duration-200 p-1"
                            title="点击标记/取消重点关注客户">
                        <span id="priorityStarIcon" class="material-symbols-outlined text-xl text-white">star</span>
                    </button>
                    <button onclick="closeProgressModal()"
                            class="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-white text-sm font-medium transition-all">
                        关闭
                    </button>
                </div>
            </div>
        </div>

        <!-- 弹窗内容 -->
        <div class="p-6">

            <form onsubmit="event.preventDefault(); updateProgress();">
                <input type="hidden" id="progressCustomerId">

                <!-- 课程进度 -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center mb-3">
                        <span class="material-symbols-outlined text-blue-600 mr-2">school</span>
                        <h4 class="text-sm font-semibold text-gray-900">课程进度</h4>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">总课程数量</label>
                            <input type="number" id="totalSessions" min="0"
                                   class="block w-full px-3 py-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">已完成数量</label>
                            <input type="number" id="completedSessions" min="0"
                                   class="block w-full px-3 py-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        </div>
                    </div>
                </div>

                <!-- 赛事管理（仅竞赛辅导服务客户显示） -->
                <div id="competitionManagementSection" class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-2">emoji_events</span>
                            <h4 class="text-sm font-semibold text-gray-900">赛事管理</h4>
                        </div>
                        <button type="button" onclick="showAddCompetitionInProgress()"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition-all">
                            <span class="material-symbols-outlined text-sm mr-1">add</span>
                            添加赛事
                        </button>
                    </div>
                    <div id="progressCompetitionsList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-white">
                        <!-- 动态加载赛事列表 -->
                        <div class="text-center text-gray-500 text-sm py-4">
                            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">emoji_events</span>
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 客户阶段沟通记录 -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-2">chat</span>
                            <h4 class="text-sm font-semibold text-gray-900">客户阶段沟通记录</h4>
                        </div>
                        <button type="button" onclick="showAddCustomerCommunicationForm()"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition-all">
                            <span class="material-symbols-outlined text-sm mr-1">add</span>
                            新增记录
                        </button>
                    </div>

                    <!-- 沟通记录表格 -->
                    <div id="customerCommunicationRecords" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white">
                        <div class="text-center text-gray-500 text-sm py-4">
                            <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">inbox</span>
                            <p>暂无沟通记录</p>
                            <p class="text-xs mt-1">点击上方按钮添加第一条沟通记录</p>
                        </div>
                    </div>

                    <!-- 统计信息 -->
                    <div id="customerCommunicationStats" class="mt-2 text-xs text-gray-500 text-center">
                        客户阶段: 0 条记录
                    </div>
                </div>

                <!-- 按钮组 -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeProgressModal()"
                            class="px-5 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all">
                        取消
                    </button>
                    <button type="submit"
                            class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 border-0 rounded-lg text-sm font-medium text-white hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all">
                        <span class="material-symbols-outlined text-sm mr-1 align-middle">save</span>
                        <span class="align-middle">保存</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加赛事弹窗 -->
<div id="addCompetitionModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative mx-auto p-0 border-0 w-full max-w-md shadow-2xl rounded-xl bg-white animate-fadeIn">
        <!-- 弹窗头部 - 蓝色渐变背景 -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined text-white text-2xl">emoji_events</span>
                    <h3 class="text-lg font-semibold text-white">添加赛事</h3>
                </div>
                <button onclick="closeAddCompetitionModal()" class="text-white hover:text-blue-100 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <!-- 弹窗内容 -->
        <form id="addCompetitionForm" onsubmit="submitAddCompetition(event)" class="p-6 space-y-5">
            <!-- 提示信息 -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                <p class="text-sm text-blue-700">请选择要添加的赛事及初始状态</p>
            </div>

            <!-- 赛事选择 -->
            <div>
                <label for="competitionSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">emoji_events</span>
                    <span class="align-middle">赛事名称</span>
                </label>
                <select id="competitionSelect"
                        required
                        class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <option value="">请选择赛事...</option>
                </select>
            </div>

            <!-- 初始状态选择 -->
            <div>
                <label for="statusSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">flag</span>
                    <span class="align-middle">初始状态</span>
                </label>
                <select id="statusSelect"
                        required
                        onchange="handleAddCompetitionStatusChange(this.value)"
                        class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <option value="未报名">未报名</option>
                    <option value="已报名">已报名</option>
                    <option value="国家一等奖">国家一等奖</option>
                    <option value="国家二等奖">国家二等奖</option>
                    <option value="国家三等奖">国家三等奖</option>
                    <option value="市级一等奖">市级一等奖</option>
                    <option value="市级二等奖">市级二等奖</option>
                    <option value="市级三等奖">市级三等奖</option>
                    <option value="其他奖项">其他奖项...</option>
                </select>
            </div>

            <!-- 自定义奖项输入框 -->
            <div id="customAwardInputDiv" class="hidden">
                <label for="customAwardInput" class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle text-blue-600">edit</span>
                    <span class="align-middle">自定义奖项名称</span>
                </label>
                <input type="text"
                       id="customAwardInput"
                       placeholder="例如：优秀奖、鼓励奖"
                       class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            </div>

            <!-- 按钮组 -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button"
                        onclick="closeAddCompetitionModal()"
                        class="px-5 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all">
                    取消
                </button>
                <button type="submit"
                        class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 border-0 rounded-lg text-sm font-medium text-white hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all">
                    <span class="material-symbols-outlined text-sm mr-1 align-middle">add</span>
                    <span class="align-middle">确定</span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.animate-fadeIn {
    animation: fadeIn 0.2s ease-out;
}
</style>

<!-- 新增客户沟通记录模态框 -->
<div id="addCustomerCommunicationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">新增客户沟通记录</h3>
                <button onclick="closeAddCustomerCommunicationModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="addCustomerCommunicationForm" onsubmit="submitCustomerCommunicationRecord(event)" class="space-y-4">
                <input type="hidden" id="customerCommunicationLeadId">

                <div>
                    <label for="customerCommunicationContent" class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm mr-1">edit</span>沟通内容
                    </label>
                    <textarea id="customerCommunicationContent"
                              name="content"
                              rows="4"
                              required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="请输入客户阶段的沟通内容或反馈信息..."></textarea>
                </div>

                <div>
                    <label for="customerCommunicationTime" class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-sm mr-1">schedule</span>沟通时间
                    </label>
                    <input type="datetime-local"
                           id="customerCommunicationTime"
                           name="communication_time"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button"
                            onclick="closeAddCustomerCommunicationModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                        <span class="material-symbols-outlined text-sm mr-1">save</span>保存记录
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- 包含学员详情弹窗组件 -->
{% include 'components/student_detail_modal.html' %}

<!-- 赛事进展查看弹窗（只读） -->
<div id="competitionsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <!-- 弹窗标题 -->
        <div class="flex justify-between items-center mb-4 pb-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">
                <span id="competitionsModalTitle">赛事进展</span>
            </h3>
            <button onclick="closeCompetitionsModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- 赛事列表（只读） -->
        <div id="competitionsList" class="space-y-3 mb-4">
            <!-- 动态加载赛事列表 -->
        </div>

        <!-- 关闭按钮 -->
        <div class="flex justify-end pt-4 border-t">
            <button onclick="closeCompetitionsModal()"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                关闭
            </button>
        </div>
    </div>
</div>



<script>
let competitionCustomerId = null;
let competitionStudentName = '';
let competitionNames = [];

// 显示赛事管理弹窗
async function showCompetitionsModal(customerId, studentName) {
    competitionCustomerId = customerId;
    competitionStudentName = studentName;

    document.getElementById('competitionsModalTitle').textContent = `${studentName} - 赛事进展管理`;
    document.getElementById('competitionsModal').classList.remove('hidden');

    // 加载赛事列表
    await loadCompetitions();
}

// 关闭赛事管理弹窗
function closeCompetitionsModal() {
    document.getElementById('competitionsModal').classList.add('hidden');
    competitionCustomerId = null;
    competitionStudentName = '';
}

// 加载赛事列表
async function loadCompetitions() {
    try {
        const response = await fetch(`/customers/api/${competitionCustomerId}/competitions`);
        const data = await response.json();

        if (data.success) {
            renderCompetitions(data.competitions);
        } else {
            alert('加载赛事列表失败：' + data.message);
        }
    } catch (error) {
        console.error('加载赛事列表失败:', error);
        alert('加载赛事列表失败');
    }
}

// 渲染赛事列表（只读模式）
function renderCompetitions(competitions) {
    const container = document.getElementById('competitionsList');

    if (competitions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <span class="material-symbols-outlined text-4xl mb-2">emoji_events</span>
                <p>暂无赛事记录</p>
            </div>
        `;
        return;
    }

    container.innerHTML = competitions.map(comp => `
        <div class="border rounded-lg p-3 bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-medium text-gray-900 text-sm mb-1">🏆 ${comp.competition_name}</div>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${comp.status_color}">
                        ${comp.display_status}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

// ========== 赛事管理功能（在进度更新弹窗中） ==========

let progressCompetitionNames = [];

// 加载进度更新弹窗中的赛事列表
async function loadProgressCompetitions(customerId) {
    try {
        const response = await fetch(`/customers/api/${customerId}/competitions`);
        const data = await response.json();

        if (data.success) {
            renderProgressCompetitions(data.competitions);
        } else {
            document.getElementById('progressCompetitionsList').innerHTML = `
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>加载失败</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('加载赛事列表失败:', error);
        document.getElementById('progressCompetitionsList').innerHTML = `
            <div class="text-center text-gray-500 text-sm py-4">
                <p>加载失败</p>
            </div>
        `;
    }
}

// 渲染进度更新弹窗中的赛事列表
function renderProgressCompetitions(competitions) {
    const container = document.getElementById('progressCompetitionsList');

    if (competitions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-4">
                <span class="material-symbols-outlined text-2xl mb-2 text-gray-300">emoji_events</span>
                <p>暂无赛事记录</p>
            </div>
        `;
        return;
    }

    container.innerHTML = competitions.map(comp => `
        <div class="border rounded-md p-2 bg-white">
            <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-gray-900 text-sm">🏆 ${comp.competition_name}</div>
                <button onclick="deleteProgressCompetition(${comp.id}, '${comp.competition_name}')"
                        class="text-red-600 hover:text-red-800 text-xs">
                    删除
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <select onchange="updateProgressCompetitionStatus(${comp.id}, this.value)"
                        data-comp-id="${comp.id}"
                        class="text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 ${comp.status_color} flex-1">
                    <option value="未报名" ${comp.status === '未报名' ? 'selected' : ''}>未报名</option>
                    <option value="已报名" ${comp.status === '已报名' ? 'selected' : ''}>已报名</option>
                    <option value="国家一等奖" ${comp.status === '国家一等奖' ? 'selected' : ''}>国家一等奖</option>
                    <option value="国家二等奖" ${comp.status === '国家二等奖' ? 'selected' : ''}>国家二等奖</option>
                    <option value="国家三等奖" ${comp.status === '国家三等奖' ? 'selected' : ''}>国家三等奖</option>
                    <option value="市级一等奖" ${comp.status === '市级一等奖' ? 'selected' : ''}>市级一等奖</option>
                    <option value="市级二等奖" ${comp.status === '市级二等奖' ? 'selected' : ''}>市级二等奖</option>
                    <option value="市级三等奖" ${comp.status === '市级三等奖' ? 'selected' : ''}>市级三等奖</option>
                    <option value="其他奖项" ${comp.status === '其他奖项' ? 'selected' : ''}>其他奖项...</option>
                </select>
            </div>
            ${comp.status === '其他奖项' ? `
                <input type="text"
                       id="progressCustomAward_${comp.id}"
                       value="${comp.custom_award || ''}"
                       placeholder="输入奖项名称"
                       class="mt-2 text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 w-full"
                       onblur="saveProgressCustomAward(${comp.id})">
            ` : ''}
        </div>
    `).join('');
}

// 更新赛事状态
async function updateProgressCompetitionStatus(competitionId, newStatus) {
    // 如果选择"其他奖项"，需要等待用户输入自定义奖项名称
    if (newStatus === '其他奖项') {
        // 重新渲染以显示输入框
        await loadProgressCompetitions(currentCustomerId);
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus,
                custom_award: null
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast('状态已更新');
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('更新失败：' + data.message);
            await loadProgressCompetitions(currentCustomerId);
        }
    } catch (error) {
        console.error('更新状态失败:', error);
        alert('更新状态失败');
        await loadProgressCompetitions(currentCustomerId);
    }
}

// 保存自定义奖项
async function saveProgressCustomAward(competitionId) {
    const customAward = document.getElementById(`progressCustomAward_${competitionId}`).value.trim();

    if (!customAward) {
        alert('请输入自定义奖项名称');
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: '其他奖项',
                custom_award: customAward
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast('状态已更新');
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('保存失败：' + data.message);
        }
    } catch (error) {
        console.error('保存失败:', error);
        alert('保存失败');
    }
}

// 删除赛事
async function deleteProgressCompetition(competitionId, competitionName) {
    if (!confirm(`确定要删除赛事"${competitionName}"吗？`)) {
        return;
    }

    try {
        const response = await fetch(`/customers/api/competitions/${competitionId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadProgressCompetitions(currentCustomerId);
        } else {
            alert('删除失败：' + data.message);
        }
    } catch (error) {
        console.error('删除失败:', error);
        alert('删除失败');
    }
}

// 显示添加赛事弹窗
async function showAddCompetitionInProgress() {
    // 加载赛事名称列表
    await loadProgressCompetitionNames();

    // 填充赛事下拉框
    const competitionSelect = document.getElementById('competitionSelect');
    competitionSelect.innerHTML = '<option value="">请选择赛事...</option>';
    progressCompetitionNames.forEach(cn => {
        const option = document.createElement('option');
        option.value = cn.id;
        option.textContent = cn.name;
        competitionSelect.appendChild(option);
    });

    // 重置表单
    document.getElementById('addCompetitionForm').reset();
    document.getElementById('customAwardInputDiv').classList.add('hidden');
    document.getElementById('customAwardInput').value = '';

    // 显示弹窗
    document.getElementById('addCompetitionModal').classList.remove('hidden');
}

// 关闭添加赛事弹窗
function closeAddCompetitionModal() {
    document.getElementById('addCompetitionModal').classList.add('hidden');
}

// 处理状态选择变化
function handleAddCompetitionStatusChange(status) {
    const customAwardDiv = document.getElementById('customAwardInputDiv');
    const customAwardInput = document.getElementById('customAwardInput');

    if (status === '其他奖项') {
        customAwardDiv.classList.remove('hidden');
        customAwardInput.required = true;
    } else {
        customAwardDiv.classList.add('hidden');
        customAwardInput.required = false;
        customAwardInput.value = '';
    }
}

// 提交添加赛事表单
async function submitAddCompetition(event) {
    event.preventDefault();

    const competitionNameId = document.getElementById('competitionSelect').value;
    const status = document.getElementById('statusSelect').value;
    const customAward = document.getElementById('customAwardInput').value;

    if (!competitionNameId) {
        alert('请选择赛事');
        return;
    }

    if (status === '其他奖项' && !customAward) {
        alert('请输入自定义奖项名称');
        return;
    }

    // 添加赛事
    try {
        const response = await fetch(`/customers/api/${currentCustomerId}/competitions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                competition_name_id: parseInt(competitionNameId),
                status: status,
                custom_award: status === '其他奖项' ? customAward : null
            })
        });

        const data = await response.json();

        if (data.success) {
            showProgressToast(data.message);
            await loadProgressCompetitions(currentCustomerId);
            closeAddCompetitionModal();
        } else {
            alert('添加失败：' + data.message);
        }
    } catch (error) {
        console.error('添加失败:', error);
        alert('添加失败');
    }
}

// 加载赛事名称列表
async function loadProgressCompetitionNames() {
    try {
        const response = await fetch('/customers/api/competition-names');
        const data = await response.json();

        if (data.success) {
            progressCompetitionNames = data.competition_names;
        }
    } catch (error) {
        console.error('加载赛事名称失败:', error);
    }
}

// 显示提示消息
function showProgressToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 1000);
}

</script>

{% endblock %}
