<!-- Tab导航 -->
<div class="border-b border-gray-200 mb-4">
    <nav class="-mb-px flex space-x-8">
        <button type="button" onclick="switchTab('basic')" id="tab-basic"
                class="tab-button border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600">
            基本信息
        </button>
        <button type="button" onclick="switchTab('service')" id="tab-service"
                class="tab-button border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            服务内容
        </button>
        <button type="button" onclick="switchTab('payment')" id="tab-payment"
                class="tab-button border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            付款管理
        </button>
    </nav>
</div>

<form action="{{ url_for('admin.update_lead', lead_id=lead.id) }}" method="POST" onsubmit="submitEditForm(event)">
    <!-- Tab 1: 基本信息 -->
    <div id="content-basic" class="tab-content space-y-4">
        <!-- 家长微信显示名 -->
        <div>
            <label for="parent_wechat_display_name" class="block text-sm font-medium text-gray-700 mb-2">
                家长微信显示名
            </label>
            <input type="text"
                   id="parent_wechat_display_name"
                   name="parent_wechat_display_name"
                   value="{{ lead.parent_wechat_display_name }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 家长微信号 -->
        <div>
            <label for="parent_wechat_name" class="block text-sm font-medium text-gray-700 mb-2">
                家长微信号
            </label>
            <input type="text"
                   id="parent_wechat_name"
                   name="parent_wechat_name"
                   value="{{ lead.parent_wechat_name }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 学员姓名 -->
        <div>
            <label for="student_name" class="block text-sm font-medium text-gray-700 mb-2">
                学员姓名
            </label>
            <input type="text"
                   id="student_name"
                   name="student_name"
                   value="{{ lead.student_name }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 联系方式 -->
        <div>
            <label for="contact_info" class="block text-sm font-medium text-gray-700 mb-2">
                联系方式
            </label>
            <input type="text"
                   id="contact_info"
                   name="contact_info"
                   value="{{ lead.contact_info }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 年级 -->
        <div>
            <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">
                年级
            </label>
            <select id="grade" 
                    name="grade" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择年级</option>
                <option value="1年级" {% if lead.grade == '1年级' %}selected{% endif %}>1年级</option>
                <option value="2年级" {% if lead.grade == '2年级' %}selected{% endif %}>2年级</option>
                <option value="3年级" {% if lead.grade == '3年级' %}selected{% endif %}>3年级</option>
                <option value="4年级" {% if lead.grade == '4年级' %}selected{% endif %}>4年级</option>
                <option value="5年级" {% if lead.grade == '5年级' %}selected{% endif %}>5年级</option>
                <option value="6年级" {% if lead.grade == '6年级' %}selected{% endif %}>6年级</option>
                <option value="初一" {% if lead.grade == '初一' %}selected{% endif %}>初一</option>
                <option value="初二" {% if lead.grade == '初二' %}selected{% endif %}>初二</option>
                <option value="初三" {% if lead.grade == '初三' %}selected{% endif %}>初三</option>
                <option value="高一" {% if lead.grade == '高一' %}selected{% endif %}>高一</option>
                <option value="高二" {% if lead.grade == '高二' %}selected{% endif %}>高二</option>
                <option value="高三" {% if lead.grade == '高三' %}selected{% endif %}>高三</option>
            </select>
        </div>

        <!-- 学校 -->
        <div>
            <label for="school" class="block text-sm font-medium text-gray-700 mb-2">
                学校
            </label>
            <input type="text" 
                   id="school" 
                   name="school" 
                   value="{{ lead.school }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 行政区 -->
        <div>
            <label for="district" class="block text-sm font-medium text-gray-700 mb-2">
                行政区
            </label>
            <select id="district" 
                    name="district" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择行政区</option>
                <option value="黄浦区" {% if lead.district == '黄浦区' %}selected{% endif %}>黄浦区</option>
                <option value="徐汇区" {% if lead.district == '徐汇区' %}selected{% endif %}>徐汇区</option>
                <option value="长宁区" {% if lead.district == '长宁区' %}selected{% endif %}>长宁区</option>
                <option value="静安区" {% if lead.district == '静安区' %}selected{% endif %}>静安区</option>
                <option value="普陀区" {% if lead.district == '普陀区' %}selected{% endif %}>普陀区</option>
                <option value="虹口区" {% if lead.district == '虹口区' %}selected{% endif %}>虹口区</option>
                <option value="杨浦区" {% if lead.district == '杨浦区' %}selected{% endif %}>杨浦区</option>
                <option value="闵行区" {% if lead.district == '闵行区' %}selected{% endif %}>闵行区</option>
                <option value="宝山区" {% if lead.district == '宝山区' %}selected{% endif %}>宝山区</option>
                <option value="嘉定区" {% if lead.district == '嘉定区' %}selected{% endif %}>嘉定区</option>
                <option value="浦东新区" {% if lead.district == '浦东新区' %}selected{% endif %}>浦东新区</option>
                <option value="金山区" {% if lead.district == '金山区' %}selected{% endif %}>金山区</option>
                <option value="松江区" {% if lead.district == '松江区' %}selected{% endif %}>松江区</option>
                <option value="青浦区" {% if lead.district == '青浦区' %}selected{% endif %}>青浦区</option>
                <option value="奉贤区" {% if lead.district == '奉贤区' %}selected{% endif %}>奉贤区</option>
                <option value="崇明区" {% if lead.district == '崇明区' %}selected{% endif %}>崇明区</option>
            </select>
        </div>

        <!-- 线索来源 -->
        <div>
            <label for="lead_source" class="block text-sm font-medium text-gray-700 mb-2">
                线索来源
            </label>
            <select id="lead_source" 
                    name="lead_source" 
                    onchange="toggleCustomSource()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择线索来源</option>
                <option value="周cc" {% if lead.lead_source == '周cc' %}selected{% endif %}>周cc</option>
                <option value="李博士" {% if lead.lead_source == '李博士' %}selected{% endif %}>李博士</option>
                <option value="喜顺" {% if lead.lead_source == '喜顺' %}selected{% endif %}>喜顺</option>
                <option value="视频号" {% if lead.lead_source == '视频号' %}selected{% endif %}>视频号</option>
                <option value="其他" {% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}selected{% endif %}>其他</option>
            </select>
        </div>

        <!-- 自定义线索来源 -->
        <div id="custom_source_div" style="display: {% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}block{% else %}none{% endif %};">
            <label for="custom_source" class="block text-sm font-medium text-gray-700 mb-2">
                自定义线索来源
            </label>
            <input type="text" 
                   id="custom_source" 
                   name="custom_source" 
                   value="{% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}{{ lead.lead_source }}{% endif %}"
                   placeholder="请输入自定义线索来源"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 责任销售 -->
        <div>
            <label for="sales_user_id" class="block text-sm font-medium text-gray-700 mb-2">
                责任销售
            </label>
            <select id="sales_user_id"
                    name="sales_user_id"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择责任销售</option>
                {% for sales in sales_users %}
                    <option value="{{ sales.id }}" {% if lead.sales_user_id == sales.id %}selected{% endif %}>{{ sales.username }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Tab 2: 服务内容 -->
    <div id="content-service" class="tab-content space-y-4 hidden">
        <!-- 服务类型 -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">服务类型</label>
            {% set service_types = lead.get_service_types_list() %}
            <div class="space-y-2">
                <div class="flex items-center">
                    <input type="checkbox" name="service_types" value="tutoring" id="service_tutoring"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           {% if 'tutoring' in service_types %}checked{% endif %}>
                    <label for="service_tutoring" class="ml-2 text-sm text-gray-700">课题辅导</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="service_types" value="competition" id="service_competition"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           {% if 'competition' in service_types %}checked{% endif %}>
                    <label for="service_competition" class="ml-2 text-sm text-gray-700">竞赛辅导</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="service_types" value="upgrade_guidance" id="service_upgrade"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           {% if 'upgrade_guidance' in service_types %}checked{% endif %}>
                    <label for="service_upgrade" class="ml-2 text-sm text-gray-700">升学陪跑</label>
                </div>
            </div>
        </div>

        <!-- 竞赛奖项等级 -->
        <div id="competition_award_level_section" style="display: {% if 'competition' in service_types %}block{% else %}none{% endif %};">
            <label for="competition_award_level" class="block text-sm font-medium text-gray-700 mb-2">
                竞赛奖项等级
            </label>
            <select id="competition_award_level" name="competition_award_level"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择目标奖项等级</option>
                <option value="市奖" {% if lead.competition_award_level == '市奖' %}selected{% endif %}>市奖</option>
                <option value="国奖" {% if lead.competition_award_level == '国奖' %}selected{% endif %}>国奖</option>
            </select>
            <p class="mt-1 text-sm text-gray-500">选择了竞赛辅导服务，必须设置目标奖项等级</p>
        </div>

        <!-- 额外要求 -->
        <div>
            <label for="additional_requirements" class="block text-sm font-medium text-gray-700 mb-2">
                额外要求
            </label>
            <textarea id="additional_requirements" name="additional_requirements" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      placeholder="请输入客户的额外要求（可选）">{{ lead.additional_requirements or '' }}</textarea>
            <p class="mt-1 text-sm text-gray-500">例如：按时报名竞赛、退款条件、特殊服务要求等</p>
        </div>
    </div>

    <!-- Tab 3: 付款管理 -->
    <div id="content-payment" class="tab-content space-y-4 hidden">
        <!-- 合同金额 -->
        <div>
            <label for="contract_amount" class="block text-sm font-medium text-gray-700 mb-2">
                合同金额
            </label>
            <input type="number"
                   id="contract_amount"
                   name="contract_amount"
                   value="{{ lead.contract_amount or 0 }}"
                   step="0.01"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- 付款记录列表 -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">付款记录</label>
            <div class="text-sm text-gray-500 mb-2">
                付款记录的添加和删除请在完整编辑页面进行
            </div>
            {% if payments %}
            <div class="border border-gray-200 rounded-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">付款日期</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">付款金额</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">备注</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for payment in payments %}
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-900">{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">¥{{ "%.2f"|format(payment.amount) }}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">{{ payment.payment_notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-sm text-gray-500">暂无付款记录</p>
            {% endif %}
        </div>
    </div>

    <!-- 按钮 -->
    <div class="flex gap-3 mt-6">
        <button type="button" 
                onclick="closeEditModal()" 
                class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md hover:bg-gray-300">
            取消
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md hover:bg-blue-700">
            保存
        </button>
    </div>
</form>

<script>
// toggleCustomSource函数保留在这里，因为它是表单特定的
function toggleCustomSource() {
    const leadSource = document.getElementById('lead_source').value;
    const customSourceDiv = document.getElementById('custom_source_div');
    const customSourceInput = document.getElementById('custom_source');

    if (leadSource === '其他') {
        customSourceDiv.style.display = 'block';
        customSourceInput.required = true;
        customSourceInput.focus();
    } else {
        customSourceDiv.style.display = 'none';
        customSourceInput.required = false;
        customSourceInput.value = '';
    }
}
</script>

