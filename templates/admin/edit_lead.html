{% extends "admin/base.html" %}

{% block title %}编辑线索 - 管理员后台{% endblock %}
{% block page_title %}编辑线索{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 返回按钮 -->
    <div class="mb-6">
        <a href="{{ url_for('admin.leads') }}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <span class="material-symbols-outlined mr-2">arrow_back</span>
            返回线索管理
        </a>
    </div>

    <!-- 线索信息卡片 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">线索信息</h2>
            <div class="text-sm text-gray-500">
                ID: {{ lead.id }} | 创建时间: {{ lead.created_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
        </div>

        <!-- 消息提示 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-md {% if category == 'error' %}bg-red-50 border border-red-200 text-red-700{% else %}bg-green-50 border border-green-200 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 编辑表单 -->
        <form method="POST" action="{{ url_for('admin.update_lead', lead_id=lead.id) }}">
            <!-- 基本信息 -->
            <div class="border-b border-gray-200 pb-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">基本信息</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="parent_wechat_display_name" class="block text-sm font-medium text-gray-700 mb-2">
                            家长微信名 <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               id="parent_wechat_display_name"
                               name="parent_wechat_display_name"
                               value="{{ lead.parent_wechat_display_name or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                               placeholder="请输入家长微信名"
                               required>
                    </div>

                    <div>
                        <label for="parent_wechat_name" class="block text-sm font-medium text-gray-700 mb-2">
                            家长微信号 <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               id="parent_wechat_name"
                               name="parent_wechat_name"
                               value="{{ lead.parent_wechat_name or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                               placeholder="请输入家长微信号"
                               required>
                    </div>

                    <div>
                        <label for="student_name" class="block text-sm font-medium text-gray-700 mb-2">学员姓名</label>
                        <input type="text"
                               id="student_name"
                               name="student_name"
                               value="{{ lead.student_name or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                               placeholder="请输入学员姓名">
                    </div>

                    <div>
                        <label for="contact_info" class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                        <input type="text"
                               id="contact_info"
                               name="contact_info"
                               value="{{ lead.contact_info or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                               placeholder="请输入联系电话">
                    </div>

                    <div>
                        <label for="lead_source" class="block text-sm font-medium text-gray-700 mb-2">
                            线索来源 <span class="text-red-500">*</span>
                        </label>
                        <select id="lead_source"
                                name="lead_source"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                required>
                            <option value="">请选择线索来源</option>
                            <option value="周cc" {% if lead.lead_source == '周cc' %}selected{% endif %}>周cc</option>
                            <option value="李博士" {% if lead.lead_source == '李博士' %}selected{% endif %}>李博士</option>
                            <option value="喜顺" {% if lead.lead_source == '喜顺' %}selected{% endif %}>喜顺</option>
                            <option value="视频号" {% if lead.lead_source == '视频号' %}selected{% endif %}>视频号</option>
                            <option value="其他" {% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}selected{% endif %}>其他</option>
                        </select>
                        <!-- 自定义线索来源输入框 -->
                        <div id="custom_source_div" style="display: {% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}block{% else %}none{% endif %};" class="mt-2">
                            <input type="text" name="custom_source" id="custom_source"
                                   value="{% if lead.lead_source not in ['周cc', '李博士', '喜顺', '视频号', ''] %}{{ lead.lead_source }}{% endif %}"
                                   placeholder="请输入自定义线索来源"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <div>
                        <label for="sales_user_id" class="block text-sm font-medium text-gray-700 mb-2">
                            责任销售 <span class="text-red-500">*</span>
                        </label>
                        <select id="sales_user_id"
                                name="sales_user_id"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                required>
                            <option value="">请选择销售</option>
                            {% for user in sales_users %}
                                <option value="{{ user.id }}" {% if lead.sales_user_id == user.id %}selected{% endif %}>
                                    {{ user.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">年级</label>
                        <select id="grade"
                                name="grade"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">请选择年级</option>
                            <option value="1年级" {% if lead.grade == '1年级' %}selected{% endif %}>1年级</option>
                            <option value="2年级" {% if lead.grade == '2年级' %}selected{% endif %}>2年级</option>
                            <option value="3年级" {% if lead.grade == '3年级' %}selected{% endif %}>3年级</option>
                            <option value="4年级" {% if lead.grade == '4年级' %}selected{% endif %}>4年级</option>
                            <option value="5年级" {% if lead.grade == '5年级' %}selected{% endif %}>5年级</option>
                            <option value="6年级" {% if lead.grade == '6年级' %}selected{% endif %}>6年级</option>
                            <option value="7年级" {% if lead.grade == '7年级' %}selected{% endif %}>7年级</option>
                            <option value="8年级" {% if lead.grade == '8年级' %}selected{% endif %}>8年级</option>
                            <option value="9年级" {% if lead.grade == '9年级' %}selected{% endif %}>9年级</option>
                            <option value="高一" {% if lead.grade == '高一' %}selected{% endif %}>高一</option>
                            <option value="高二" {% if lead.grade == '高二' %}selected{% endif %}>高二</option>
                            <option value="高三" {% if lead.grade == '高三' %}selected{% endif %}>高三</option>
                        </select>
                    </div>

                    <div>
                        <label for="district" class="block text-sm font-medium text-gray-700 mb-2">行政区</label>
                        <select id="district"
                                name="district"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">请选择行政区</option>
                            <option value="黄浦区" {% if lead.district == '黄浦区' %}selected{% endif %}>黄浦区</option>
                            <option value="徐汇区" {% if lead.district == '徐汇区' %}selected{% endif %}>徐汇区</option>
                            <option value="长宁区" {% if lead.district == '长宁区' %}selected{% endif %}>长宁区</option>
                            <option value="静安区" {% if lead.district == '静安区' %}selected{% endif %}>静安区</option>
                            <option value="普陀区" {% if lead.district == '普陀区' %}selected{% endif %}>普陀区</option>
                            <option value="虹口区" {% if lead.district == '虹口区' %}selected{% endif %}>虹口区</option>
                            <option value="杨浦区" {% if lead.district == '杨浦区' %}selected{% endif %}>杨浦区</option>
                            <option value="闵行区" {% if lead.district == '闵行区' %}selected{% endif %}>闵行区</option>
                            <option value="宝山区" {% if lead.district == '宝山区' %}selected{% endif %}>宝山区</option>
                            <option value="嘉定区" {% if lead.district == '嘉定区' %}selected{% endif %}>嘉定区</option>
                            <option value="浦东新区" {% if lead.district == '浦东新区' %}selected{% endif %}>浦东新区</option>
                            <option value="金山区" {% if lead.district == '金山区' %}selected{% endif %}>金山区</option>
                            <option value="松江区" {% if lead.district == '松江区' %}selected{% endif %}>松江区</option>
                            <option value="青浦区" {% if lead.district == '青浦区' %}selected{% endif %}>青浦区</option>
                            <option value="奉贤区" {% if lead.district == '奉贤区' %}selected{% endif %}>奉贤区</option>
                            <option value="崇明区" {% if lead.district == '崇明区' %}selected{% endif %}>崇明区</option>
                        </select>
                    </div>

                    <div>
                        <label for="school" class="block text-sm font-medium text-gray-700 mb-2">学校</label>
                        <input type="text"
                               id="school"
                               name="school"
                               value="{{ lead.school or '' }}"
                               placeholder="请输入学校名称"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('admin.leads') }}" 
                   class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    取消
                </a>
                <button type="submit"
                        class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    保存修改
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 线索来源切换函数
    function toggleCustomSource() {
        const sourceSelect = document.getElementById('lead_source');
        const customSourceDiv = document.getElementById('custom_source_div');
        const customSourceInput = document.getElementById('custom_source');

        if (sourceSelect.value === '其他') {
            customSourceDiv.style.display = 'block';
            customSourceInput.required = true;
            customSourceInput.focus();
        } else {
            customSourceDiv.style.display = 'none';
            customSourceInput.required = false;
            customSourceInput.value = '';
        }
    }

    // 线索来源切换事件监听
    const leadSourceSelect = document.getElementById('lead_source');
    if (leadSourceSelect) {
        leadSourceSelect.addEventListener('change', toggleCustomSource);

        // 页面加载时检查是否需要显示自定义输入框
        toggleCustomSource();
    }
});
</script>
{% endblock %}
