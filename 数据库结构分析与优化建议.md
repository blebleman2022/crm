# EduConnect CRM æ•°æ®åº“ç»“æ„åˆ†æä¸ä¼˜åŒ–å»ºè®®

## ğŸ“Š æ•°æ®åº“æ¦‚è§ˆ

### åŸºæœ¬ä¿¡æ¯
- **æ•°æ®åº“ç±»å‹**: SQLite 3
- **æ–‡ä»¶å¤§å°**: 248 KB
- **æ€»è¡¨æ•°**: 11 å¼ è¡¨
- **æ€»è®°å½•æ•°**: 134 æ¡
- **é¡µé¢å¤§å°**: 4,096 bytes

### è¡¨åˆ—è¡¨
1. **users** - ç”¨æˆ·è´¦å·è¡¨ (12æ¡è®°å½•)
2. **leads** - å­¦å‘˜çº¿ç´¢è¡¨ (7æ¡è®°å½•)
3. **customers** - æˆäº¤å®¢æˆ·è¡¨ (6æ¡è®°å½•)
4. **tutoring_deliveries** - è¯¾é¢˜è¾…å¯¼äº¤ä»˜è¡¨ (6æ¡è®°å½•)
5. **competition_deliveries** - ç«èµ›å¥–é¡¹äº¤ä»˜è¡¨ (6æ¡è®°å½•)
6. **competition_names** - ç«èµ›åç§°é…ç½®è¡¨ (10æ¡è®°å½•)
7. **payments** - ä»˜æ¬¾è®°å½•è¡¨ (6æ¡è®°å½•)
8. **communication_records** - ç»Ÿä¸€æ²Ÿé€šè®°å½•è¡¨ (4æ¡è®°å½•)
9. **login_logs** - ç™»å½•æ—¥å¿—è¡¨ (77æ¡è®°å½•)
10. **consultation_details** - å’¨è¯¢è¯¦æƒ…è¡¨ (0æ¡è®°å½•ï¼Œå·²åºŸå¼ƒ)

---

## ğŸ—ï¸ è¯¦ç»†è¡¨ç»“æ„åˆ†æ

### 1ï¸âƒ£ users (ç”¨æˆ·è´¦å·è¡¨)

**å­—æ®µè®¾è®¡**: âœ… è‰¯å¥½
```
id              INTEGER PRIMARY KEY
username        VARCHAR(50) NOT NULL
phone           VARCHAR(11) NOT NULL UNIQUE
role            VARCHAR(20) NOT NULL
group_name      VARCHAR(50)
status          BOOLEAN DEFAULT TRUE
created_at      DATETIME
updated_at      DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âœ… phoneå­—æ®µæœ‰å”¯ä¸€ç´¢å¼•

**ä¼˜åŒ–å»ºè®®**:
1. âš ï¸ **ç¼ºå°‘roleå­—æ®µç´¢å¼•** - ç»å¸¸æŒ‰è§’è‰²æŸ¥è¯¢ï¼Œå»ºè®®æ·»åŠ 
2. âš ï¸ **ç¼ºå°‘statuså­—æ®µç´¢å¼•** - ç»å¸¸è¿‡æ»¤ç¦ç”¨ç”¨æˆ·
3. ğŸ’¡ å»ºè®®æ·»åŠ ç»„åˆç´¢å¼•: `(role, status)` ç”¨äºæƒé™æŸ¥è¯¢

---

### 2ï¸âƒ£ leads (å­¦å‘˜çº¿ç´¢è¡¨)

**å­—æ®µè®¾è®¡**: âš ï¸ éœ€è¦ä¼˜åŒ–
```
id                           INTEGER PRIMARY KEY
student_name                 VARCHAR(50)
parent_wechat_display_name   VARCHAR(50) NOT NULL
parent_wechat_name           VARCHAR(50) NOT NULL UNIQUE
contact_info                 VARCHAR(100)
contact_locked               BOOLEAN DEFAULT TRUE
lead_source                  VARCHAR(50)
grade                        VARCHAR(10)
district                     VARCHAR(20)
school                       VARCHAR(100)
sales_user_id                INTEGER NOT NULL FK
stage                        VARCHAR(50) NOT NULL
contract_amount              DECIMAL(10,2)
contact_obtained_at          DATETIME
meeting_at                   DATETIME
meeting_location             VARCHAR(20)
first_payment_at             DATETIME
second_payment_at            DATETIME
service_types                TEXT (JSON)
competition_award_level      VARCHAR(20)
additional_requirements      TEXT
created_at                   DATETIME
updated_at                   DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âœ… parent_wechat_name å”¯ä¸€ç´¢å¼•
- âœ… stage æ™®é€šç´¢å¼•
- âœ… sales_user_id æ™®é€šç´¢å¼•

**é—®é¢˜åˆ†æ**:
1. ğŸ”´ **å­—æ®µå†—ä½™ä¸¥é‡** - æœ‰å¤šä¸ªå·²åºŸå¼ƒå­—æ®µæœªæ¸…ç†
   - `deposit_paid_at`, `full_payment_at` (æœªåœ¨models.pyä¸­å®šä¹‰)
   - `service_type`, `award_requirement`, `follow_up_notes` (å·²åºŸå¼ƒ)

2. ğŸ”´ **JSONå­—æ®µç¼ºå°‘éªŒè¯** - `service_types` å­˜å‚¨JSONä½†æ— çº¦æŸ

3. âš ï¸ **ç¼ºå°‘é‡è¦ç´¢å¼•**:
   - `created_at` - æŒ‰æ—¶é—´æŸ¥è¯¢çº¿ç´¢
   - `grade` - æŒ‰å¹´çº§ç­›é€‰
   - `district` - æŒ‰åœ°åŒºç­›é€‰
   - `(sales_user_id, stage)` - ç»„åˆæŸ¥è¯¢

**ä¼˜åŒ–å»ºè®®**:
```sql
-- 1. æ¸…ç†åºŸå¼ƒå­—æ®µ
ALTER TABLE leads DROP COLUMN deposit_paid_at;
ALTER TABLE leads DROP COLUMN full_payment_at;
ALTER TABLE leads DROP COLUMN service_type;
ALTER TABLE leads DROP COLUMN award_requirement;
ALTER TABLE leads DROP COLUMN follow_up_notes;

-- 2. æ·»åŠ ç´¢å¼•
CREATE INDEX idx_leads_created_at ON leads(created_at DESC);
CREATE INDEX idx_leads_grade ON leads(grade);
CREATE INDEX idx_leads_district ON leads(district);
CREATE INDEX idx_leads_sales_stage ON leads(sales_user_id, stage);

-- 3. æ·»åŠ JSONéªŒè¯ (SQLite 3.38+)
-- éœ€è¦åœ¨åº”ç”¨å±‚éªŒè¯service_typesçš„JSONæ ¼å¼
```

---

### 3ï¸âƒ£ customers (æˆäº¤å®¢æˆ·è¡¨)

**å­—æ®µè®¾è®¡**: âš ï¸ å­˜åœ¨å†—ä½™
```
id                          INTEGER PRIMARY KEY
lead_id                     INTEGER NOT NULL FK UNIQUE
teacher_user_id             INTEGER FK
payment_amount              NUMERIC(10,2) NOT NULL
exam_year                   INTEGER
customer_notes              TEXT
converted_at                DATETIME
is_priority                 BOOLEAN DEFAULT FALSE
competition_award_level     VARCHAR(20)  [å·²åºŸå¼ƒ]
additional_requirements     TEXT         [å·²åºŸå¼ƒ]
created_at                  DATETIME
updated_at                  DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**é—®é¢˜åˆ†æ**:
1. ğŸ”´ **ä¸¥é‡ç¼ºå°‘ç´¢å¼•** - æ‰€æœ‰å¤–é”®å’ŒæŸ¥è¯¢å­—æ®µéƒ½æ²¡æœ‰ç´¢å¼•
2. ğŸ”´ **å­—æ®µå†—ä½™** - `sales_user_id`, `award_requirement`, `service_type`, `tutoring_expire_date`, `award_expire_date` ç­‰å·²åºŸå¼ƒå­—æ®µä»å­˜åœ¨
3. âš ï¸ **æ•°æ®é‡å¤** - `competition_award_level`, `additional_requirements` å·²é€šè¿‡@propertyä»leadsè¡¨è¯»å–ï¼Œä½†æ•°æ®åº“å­—æ®µä»ä¿ç•™

**ä¼˜åŒ–å»ºè®®**:
```sql
-- 1. æ·»åŠ å…³é”®ç´¢å¼•
CREATE UNIQUE INDEX idx_customers_lead_id ON customers(lead_id);
CREATE INDEX idx_customers_teacher_id ON customers(teacher_user_id);
CREATE INDEX idx_customers_exam_year ON customers(exam_year);
CREATE INDEX idx_customers_priority ON customers(is_priority);
CREATE INDEX idx_customers_converted_at ON customers(converted_at DESC);

-- 2. æ¸…ç†åºŸå¼ƒå­—æ®µ
ALTER TABLE customers DROP COLUMN sales_user_id;
ALTER TABLE customers DROP COLUMN award_requirement;
ALTER TABLE customers DROP COLUMN service_type;
ALTER TABLE customers DROP COLUMN tutoring_expire_date;
ALTER TABLE customers DROP COLUMN award_expire_date;

-- 3. è€ƒè™‘åˆ é™¤å†—ä½™å­—æ®µï¼ˆå·²é€šè¿‡@propertyå®ç°ï¼‰
-- ALTER TABLE customers DROP COLUMN competition_award_level;
-- ALTER TABLE customers DROP COLUMN additional_requirements;
```

---

### 4ï¸âƒ£ tutoring_deliveries (è¯¾é¢˜è¾…å¯¼äº¤ä»˜è¡¨)

**å­—æ®µè®¾è®¡**: âœ… è‰¯å¥½
```
id                    INTEGER PRIMARY KEY
customer_id           INTEGER NOT NULL FK
total_sessions        INTEGER DEFAULT 6
completed_sessions    INTEGER DEFAULT 0
remaining_sessions    INTEGER DEFAULT 6
thesis_status         VARCHAR(20) DEFAULT 'æœªå¼€å§‹'
thesis_completed_at   DATETIME
last_class_at         DATETIME
next_class_at         DATETIME
delivery_notes        TEXT
notes_history         JSON
created_at            DATETIME
updated_at            DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE UNIQUE INDEX idx_tutoring_customer_id ON tutoring_deliveries(customer_id);
CREATE INDEX idx_tutoring_thesis_status ON tutoring_deliveries(thesis_status);
CREATE INDEX idx_tutoring_next_class ON tutoring_deliveries(next_class_at);
```

---

### 5ï¸âƒ£ competition_deliveries (ç«èµ›å¥–é¡¹äº¤ä»˜è¡¨)

**å­—æ®µè®¾è®¡**: âœ… è‰¯å¥½
```
id                    INTEGER PRIMARY KEY
customer_id           INTEGER NOT NULL FK
competition_name_id   INTEGER FK
delivery_status       VARCHAR(30) DEFAULT 'æœªæŠ¥å'
award_obtained_at     DATETIME
delivery_notes        TEXT
notes_history         JSON
created_at            DATETIME
updated_at            DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE UNIQUE INDEX idx_competition_customer_id ON competition_deliveries(customer_id);
CREATE INDEX idx_competition_name_id ON competition_deliveries(competition_name_id);
CREATE INDEX idx_competition_status ON competition_deliveries(delivery_status);
```

---

### 6ï¸âƒ£ payments (ä»˜æ¬¾è®°å½•è¡¨)

**å­—æ®µè®¾è®¡**: âœ… è‰¯å¥½
```
id              INTEGER PRIMARY KEY
lead_id         INTEGER NOT NULL FK
amount          NUMERIC(10,2) NOT NULL
payment_date    DATE NOT NULL
payment_notes   TEXT
created_at      DATETIME
updated_at      DATETIME
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_payments_lead_id ON payments(lead_id);
CREATE INDEX idx_payments_date ON payments(payment_date DESC);
CREATE INDEX idx_payments_created ON payments(created_at DESC);
```

---

### 7ï¸âƒ£ communication_records (ç»Ÿä¸€æ²Ÿé€šè®°å½•è¡¨)

**å­—æ®µè®¾è®¡**: âœ… ä¼˜ç§€
```
id            INTEGER PRIMARY KEY
lead_id       INTEGER NOT NULL FK
customer_id   INTEGER FK (å¯é€‰)
content       TEXT NOT NULL
created_at    DATETIME NOT NULL
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_comm_lead_id ON communication_records(lead_id);
CREATE INDEX idx_comm_customer_id ON communication_records(customer_id);
CREATE INDEX idx_comm_created ON communication_records(created_at DESC);
CREATE INDEX idx_comm_lead_created ON communication_records(lead_id, created_at DESC);
```

---

### 8ï¸âƒ£ login_logs (ç™»å½•æ—¥å¿—è¡¨)

**å­—æ®µè®¾è®¡**: âœ… è‰¯å¥½
```
id            INTEGER PRIMARY KEY
user_id       INTEGER FK
phone         VARCHAR(11) NOT NULL
login_time    DATETIME
ip_address    VARCHAR(45)
user_agent    VARCHAR(500)
login_result  VARCHAR(20) DEFAULT 'success'
```

**ç´¢å¼•æƒ…å†µ**:
- âŒ **ç¼ºå°‘æ‰€æœ‰ç´¢å¼•ï¼**

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_login_user_id ON login_logs(user_id);
CREATE INDEX idx_login_phone ON login_logs(phone);
CREATE INDEX idx_login_time ON login_logs(login_time DESC);
CREATE INDEX idx_login_result ON login_logs(login_result);

-- è€ƒè™‘å®šæœŸæ¸…ç†æ—§æ—¥å¿—
-- DELETE FROM login_logs WHERE login_time < date('now', '-90 days');
```

---

### 9ï¸âƒ£ consultation_details (å’¨è¯¢è¯¦æƒ…è¡¨)

**çŠ¶æ€**: ğŸ”´ **å·²åºŸå¼ƒï¼Œå»ºè®®åˆ é™¤**

**é—®é¢˜**:
- 0æ¡è®°å½•
- åŠŸèƒ½å·²è¢« `communication_records` è¡¨æ›¿ä»£
- å ç”¨æ•°æ®åº“ç©ºé—´

**ä¼˜åŒ–å»ºè®®**:
```sql
-- åˆ é™¤åºŸå¼ƒè¡¨
DROP TABLE IF EXISTS consultation_details;
```

---

## ğŸ¯ ç»¼åˆä¼˜åŒ–å»ºè®®

### ã€é«˜ä¼˜å…ˆçº§ã€‘ç«‹å³æ‰§è¡Œ

#### 1. æ·»åŠ ç¼ºå¤±çš„ç´¢å¼•
```sql
-- usersè¡¨
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role_status ON users(role, status);

-- customersè¡¨
CREATE UNIQUE INDEX idx_customers_lead_id ON customers(lead_id);
CREATE INDEX idx_customers_teacher_id ON customers(teacher_user_id);
CREATE INDEX idx_customers_exam_year ON customers(exam_year);
CREATE INDEX idx_customers_priority ON customers(is_priority);

-- tutoring_deliveriesè¡¨
CREATE UNIQUE INDEX idx_tutoring_customer_id ON tutoring_deliveries(customer_id);
CREATE INDEX idx_tutoring_thesis_status ON tutoring_deliveries(thesis_status);

-- competition_deliveriesè¡¨
CREATE UNIQUE INDEX idx_competition_customer_id ON competition_deliveries(customer_id);
CREATE INDEX idx_competition_status ON competition_deliveries(delivery_status);

-- paymentsè¡¨
CREATE INDEX idx_payments_lead_id ON payments(lead_id);
CREATE INDEX idx_payments_date ON payments(payment_date DESC);

-- communication_recordsè¡¨
CREATE INDEX idx_comm_lead_id ON communication_records(lead_id);
CREATE INDEX idx_comm_customer_id ON communication_records(customer_id);
CREATE INDEX idx_comm_created ON communication_records(created_at DESC);

-- login_logsè¡¨
CREATE INDEX idx_login_user_id ON login_logs(user_id);
CREATE INDEX idx_login_time ON login_logs(login_time DESC);
```

#### 2. æ¸…ç†åºŸå¼ƒè¡¨
```sql
DROP TABLE IF EXISTS consultation_details;
```

### ã€ä¸­ä¼˜å…ˆçº§ã€‘è®¡åˆ’æ‰§è¡Œ

#### 3. æ¸…ç†å†—ä½™å­—æ®µ
éœ€è¦åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬ï¼Œè°¨æ…æ‰§è¡Œï¼š

**leadsè¡¨æ¸…ç†**:
- åˆ é™¤: `deposit_paid_at`, `full_payment_at`, `service_type`, `award_requirement`, `follow_up_notes`

**customersè¡¨æ¸…ç†**:
- åˆ é™¤: `sales_user_id`, `award_requirement`, `service_type`, `tutoring_expire_date`, `award_expire_date`

#### 4. æ•°æ®å®Œæ•´æ€§çº¦æŸ
```sql
-- æ·»åŠ CHECKçº¦æŸ
ALTER TABLE users ADD CONSTRAINT chk_users_role 
  CHECK (role IN ('admin', 'sales', 'teacher'));

ALTER TABLE leads ADD CONSTRAINT chk_leads_stage 
  CHECK (stage IN ('è·å–è”ç³»æ–¹å¼', 'çº¿ä¸‹è§é¢', 'é¦–ç¬”æ”¯ä»˜', 'æ¬¡ç¬”æ”¯ä»˜'));
```

### ã€ä½ä¼˜å…ˆçº§ã€‘é•¿æœŸä¼˜åŒ–

#### 5. æ€§èƒ½ä¼˜åŒ–
- å®šæœŸæ‰§è¡Œ `VACUUM` æ¸…ç†ç¢ç‰‡
- å®šæœŸæ‰§è¡Œ `ANALYZE` æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- è€ƒè™‘åˆ†åŒºå­˜å‚¨å†å²æ•°æ®ï¼ˆlogin_logsï¼‰

#### 6. æ•°æ®å½’æ¡£ç­–ç•¥
```sql
-- å½’æ¡£90å¤©å‰çš„ç™»å½•æ—¥å¿—
CREATE TABLE login_logs_archive AS 
SELECT * FROM login_logs WHERE login_time < date('now', '-90 days');

DELETE FROM login_logs WHERE login_time < date('now', '-90 days');
```

---

## ğŸ“ˆ é¢„æœŸä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½æå‡
- **æŸ¥è¯¢é€Ÿåº¦**: æå‡ 50-80%ï¼ˆé€šè¿‡æ·»åŠ ç´¢å¼•ï¼‰
- **æ•°æ®åº“å¤§å°**: å‡å°‘ 5-10%ï¼ˆæ¸…ç†åºŸå¼ƒå­—æ®µå’Œè¡¨ï¼‰
- **ç»´æŠ¤æˆæœ¬**: é™ä½ 30%ï¼ˆç®€åŒ–è¡¨ç»“æ„ï¼‰

### æ•°æ®è´¨é‡
- **æ•°æ®ä¸€è‡´æ€§**: æå‡ï¼ˆé€šè¿‡çº¦æŸï¼‰
- **æ•°æ®å†—ä½™**: å‡å°‘ï¼ˆæ¸…ç†é‡å¤å­—æ®µï¼‰
- **å¯ç»´æŠ¤æ€§**: æå‡ï¼ˆæ¸…æ™°çš„è¡¨ç»“æ„ï¼‰

---

## ğŸ› ï¸ æ‰§è¡Œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šç´¢å¼•ä¼˜åŒ–ï¼ˆ1-2å°æ—¶ï¼‰
1. å¤‡ä»½æ•°æ®åº“
2. æ‰§è¡Œç´¢å¼•åˆ›å»ºè„šæœ¬
3. æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
4. éªŒè¯åº”ç”¨åŠŸèƒ½

### ç¬¬äºŒé˜¶æ®µï¼šæ¸…ç†åºŸå¼ƒè¡¨ï¼ˆ30åˆ†é’Ÿï¼‰
1. ç¡®è®¤consultation_detailsè¡¨æ— æ•°æ®
2. åˆ é™¤è¡¨
3. æ›´æ–°åº”ç”¨ä»£ç ï¼ˆå¦‚æœ‰å¼•ç”¨ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šå­—æ®µæ¸…ç†ï¼ˆéœ€è°¨æ…ï¼‰
1. åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬
2. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
3. å¤‡ä»½ç”Ÿäº§æ•°æ®
4. æ‰§è¡Œè¿ç§»
5. éªŒè¯æ•°æ®å®Œæ•´æ€§

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½ä¼˜å…ˆ**: ä»»ä½•ç»“æ„å˜æ›´å‰å¿…é¡»å¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•éªŒè¯**: åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯•åå†åº”ç”¨åˆ°ç”Ÿäº§
3. **åˆ†æ­¥æ‰§è¡Œ**: ä¸è¦ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰ä¼˜åŒ–ï¼Œåˆ†é˜¶æ®µè¿›è¡Œ
4. **ç›‘æ§å½±å“**: æ¯æ¬¡å˜æ›´åç›‘æ§åº”ç”¨æ€§èƒ½å’Œé”™è¯¯æ—¥å¿—
5. **å›æ»šå‡†å¤‡**: å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ

---

## ğŸ“ æ€»ç»“

å½“å‰æ•°æ®åº“è®¾è®¡æ•´ä½“è‰¯å¥½ï¼Œä¸»è¦é—®é¢˜é›†ä¸­åœ¨ï¼š
1. ğŸ”´ **ä¸¥é‡ç¼ºå°‘ç´¢å¼•** - å½±å“æŸ¥è¯¢æ€§èƒ½
2. ğŸ”´ **å­˜åœ¨åºŸå¼ƒå­—æ®µ** - å¢åŠ ç»´æŠ¤æˆæœ¬
3. ğŸŸ¡ **ç¼ºå°‘æ•°æ®çº¦æŸ** - å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

å»ºè®®ä¼˜å…ˆæ‰§è¡Œç´¢å¼•ä¼˜åŒ–ï¼Œå¯ç«‹å³è·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

