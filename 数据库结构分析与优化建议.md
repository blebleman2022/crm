# EduConnect CRM 数据库结构分析与优化建议

## 📊 数据库概览

### 基本信息
- **数据库类型**: SQLite 3
- **文件大小**: 248 KB
- **总表数**: 11 张表
- **总记录数**: 134 条
- **页面大小**: 4,096 bytes

### 表列表
1. **users** - 用户账号表 (12条记录)
2. **leads** - 学员线索表 (7条记录)
3. **customers** - 成交客户表 (6条记录)
4. **tutoring_deliveries** - 课题辅导交付表 (6条记录)
5. **competition_deliveries** - 竞赛奖项交付表 (6条记录)
6. **competition_names** - 竞赛名称配置表 (10条记录)
7. **payments** - 付款记录表 (6条记录)
8. **communication_records** - 统一沟通记录表 (4条记录)
9. **login_logs** - 登录日志表 (77条记录)
10. **consultation_details** - 咨询详情表 (0条记录，已废弃)

---

## 🏗️ 详细表结构分析

### 1️⃣ users (用户账号表)

**字段设计**: ✅ 良好
```
id              INTEGER PRIMARY KEY
username        VARCHAR(50) NOT NULL
phone           VARCHAR(11) NOT NULL UNIQUE
role            VARCHAR(20) NOT NULL
group_name      VARCHAR(50)
status          BOOLEAN DEFAULT TRUE
created_at      DATETIME
updated_at      DATETIME
```

**索引情况**:
- ✅ phone字段有唯一索引

**优化建议**:
1. ⚠️ **缺少role字段索引** - 经常按角色查询，建议添加
2. ⚠️ **缺少status字段索引** - 经常过滤禁用用户
3. 💡 建议添加组合索引: `(role, status)` 用于权限查询

---

### 2️⃣ leads (学员线索表)

**字段设计**: ⚠️ 需要优化
```
id                           INTEGER PRIMARY KEY
student_name                 VARCHAR(50)
parent_wechat_display_name   VARCHAR(50) NOT NULL
parent_wechat_name           VARCHAR(50) NOT NULL UNIQUE
contact_info                 VARCHAR(100)
contact_locked               BOOLEAN DEFAULT TRUE
lead_source                  VARCHAR(50)
grade                        VARCHAR(10)
district                     VARCHAR(20)
school                       VARCHAR(100)
sales_user_id                INTEGER NOT NULL FK
stage                        VARCHAR(50) NOT NULL
contract_amount              DECIMAL(10,2)
contact_obtained_at          DATETIME
meeting_at                   DATETIME
meeting_location             VARCHAR(20)
first_payment_at             DATETIME
second_payment_at            DATETIME
service_types                TEXT (JSON)
competition_award_level      VARCHAR(20)
additional_requirements      TEXT
created_at                   DATETIME
updated_at                   DATETIME
```

**索引情况**:
- ✅ parent_wechat_name 唯一索引
- ✅ stage 普通索引
- ✅ sales_user_id 普通索引

**问题分析**:
1. 🔴 **字段冗余严重** - 有多个已废弃字段未清理
   - `deposit_paid_at`, `full_payment_at` (未在models.py中定义)
   - `service_type`, `award_requirement`, `follow_up_notes` (已废弃)

2. 🔴 **JSON字段缺少验证** - `service_types` 存储JSON但无约束

3. ⚠️ **缺少重要索引**:
   - `created_at` - 按时间查询线索
   - `grade` - 按年级筛选
   - `district` - 按地区筛选
   - `(sales_user_id, stage)` - 组合查询

**优化建议**:
```sql
-- 1. 清理废弃字段
ALTER TABLE leads DROP COLUMN deposit_paid_at;
ALTER TABLE leads DROP COLUMN full_payment_at;
ALTER TABLE leads DROP COLUMN service_type;
ALTER TABLE leads DROP COLUMN award_requirement;
ALTER TABLE leads DROP COLUMN follow_up_notes;

-- 2. 添加索引
CREATE INDEX idx_leads_created_at ON leads(created_at DESC);
CREATE INDEX idx_leads_grade ON leads(grade);
CREATE INDEX idx_leads_district ON leads(district);
CREATE INDEX idx_leads_sales_stage ON leads(sales_user_id, stage);

-- 3. 添加JSON验证 (SQLite 3.38+)
-- 需要在应用层验证service_types的JSON格式
```

---

### 3️⃣ customers (成交客户表)

**字段设计**: ⚠️ 存在冗余
```
id                          INTEGER PRIMARY KEY
lead_id                     INTEGER NOT NULL FK UNIQUE
teacher_user_id             INTEGER FK
payment_amount              NUMERIC(10,2) NOT NULL
exam_year                   INTEGER
customer_notes              TEXT
converted_at                DATETIME
is_priority                 BOOLEAN DEFAULT FALSE
competition_award_level     VARCHAR(20)  [已废弃]
additional_requirements     TEXT         [已废弃]
created_at                  DATETIME
updated_at                  DATETIME
```

**索引情况**:
- ❌ **缺少所有索引！**

**问题分析**:
1. 🔴 **严重缺少索引** - 所有外键和查询字段都没有索引
2. 🔴 **字段冗余** - `sales_user_id`, `award_requirement`, `service_type`, `tutoring_expire_date`, `award_expire_date` 等已废弃字段仍存在
3. ⚠️ **数据重复** - `competition_award_level`, `additional_requirements` 已通过@property从leads表读取，但数据库字段仍保留

**优化建议**:
```sql
-- 1. 添加关键索引
CREATE UNIQUE INDEX idx_customers_lead_id ON customers(lead_id);
CREATE INDEX idx_customers_teacher_id ON customers(teacher_user_id);
CREATE INDEX idx_customers_exam_year ON customers(exam_year);
CREATE INDEX idx_customers_priority ON customers(is_priority);
CREATE INDEX idx_customers_converted_at ON customers(converted_at DESC);

-- 2. 清理废弃字段
ALTER TABLE customers DROP COLUMN sales_user_id;
ALTER TABLE customers DROP COLUMN award_requirement;
ALTER TABLE customers DROP COLUMN service_type;
ALTER TABLE customers DROP COLUMN tutoring_expire_date;
ALTER TABLE customers DROP COLUMN award_expire_date;

-- 3. 考虑删除冗余字段（已通过@property实现）
-- ALTER TABLE customers DROP COLUMN competition_award_level;
-- ALTER TABLE customers DROP COLUMN additional_requirements;
```

---

### 4️⃣ tutoring_deliveries (课题辅导交付表)

**字段设计**: ✅ 良好
```
id                    INTEGER PRIMARY KEY
customer_id           INTEGER NOT NULL FK
total_sessions        INTEGER DEFAULT 6
completed_sessions    INTEGER DEFAULT 0
remaining_sessions    INTEGER DEFAULT 6
thesis_status         VARCHAR(20) DEFAULT '未开始'
thesis_completed_at   DATETIME
last_class_at         DATETIME
next_class_at         DATETIME
delivery_notes        TEXT
notes_history         JSON
created_at            DATETIME
updated_at            DATETIME
```

**索引情况**:
- ❌ **缺少所有索引！**

**优化建议**:
```sql
-- 添加索引
CREATE UNIQUE INDEX idx_tutoring_customer_id ON tutoring_deliveries(customer_id);
CREATE INDEX idx_tutoring_thesis_status ON tutoring_deliveries(thesis_status);
CREATE INDEX idx_tutoring_next_class ON tutoring_deliveries(next_class_at);
```

---

### 5️⃣ competition_deliveries (竞赛奖项交付表)

**字段设计**: ✅ 良好
```
id                    INTEGER PRIMARY KEY
customer_id           INTEGER NOT NULL FK
competition_name_id   INTEGER FK
delivery_status       VARCHAR(30) DEFAULT '未报名'
award_obtained_at     DATETIME
delivery_notes        TEXT
notes_history         JSON
created_at            DATETIME
updated_at            DATETIME
```

**索引情况**:
- ❌ **缺少所有索引！**

**优化建议**:
```sql
-- 添加索引
CREATE UNIQUE INDEX idx_competition_customer_id ON competition_deliveries(customer_id);
CREATE INDEX idx_competition_name_id ON competition_deliveries(competition_name_id);
CREATE INDEX idx_competition_status ON competition_deliveries(delivery_status);
```

---

### 6️⃣ payments (付款记录表)

**字段设计**: ✅ 良好
```
id              INTEGER PRIMARY KEY
lead_id         INTEGER NOT NULL FK
amount          NUMERIC(10,2) NOT NULL
payment_date    DATE NOT NULL
payment_notes   TEXT
created_at      DATETIME
updated_at      DATETIME
```

**索引情况**:
- ❌ **缺少所有索引！**

**优化建议**:
```sql
-- 添加索引
CREATE INDEX idx_payments_lead_id ON payments(lead_id);
CREATE INDEX idx_payments_date ON payments(payment_date DESC);
CREATE INDEX idx_payments_created ON payments(created_at DESC);
```

---

### 7️⃣ communication_records (统一沟通记录表)

**字段设计**: ✅ 优秀
```
id            INTEGER PRIMARY KEY
lead_id       INTEGER NOT NULL FK
customer_id   INTEGER FK (可选)
content       TEXT NOT NULL
created_at    DATETIME NOT NULL
```

**索引情况**:
- ❌ **缺少所有索引！**

**优化建议**:
```sql
-- 添加索引
CREATE INDEX idx_comm_lead_id ON communication_records(lead_id);
CREATE INDEX idx_comm_customer_id ON communication_records(customer_id);
CREATE INDEX idx_comm_created ON communication_records(created_at DESC);
CREATE INDEX idx_comm_lead_created ON communication_records(lead_id, created_at DESC);
```

---

### 8️⃣ login_logs (登录日志表)

**字段设计**: ✅ 良好
```
id            INTEGER PRIMARY KEY
user_id       INTEGER FK
phone         VARCHAR(11) NOT NULL
login_time    DATETIME
ip_address    VARCHAR(45)
user_agent    VARCHAR(500)
login_result  VARCHAR(20) DEFAULT 'success'
```

**索引情况**:
- ❌ **缺少所有索引！**

**优化建议**:
```sql
-- 添加索引
CREATE INDEX idx_login_user_id ON login_logs(user_id);
CREATE INDEX idx_login_phone ON login_logs(phone);
CREATE INDEX idx_login_time ON login_logs(login_time DESC);
CREATE INDEX idx_login_result ON login_logs(login_result);

-- 考虑定期清理旧日志
-- DELETE FROM login_logs WHERE login_time < date('now', '-90 days');
```

---

### 9️⃣ consultation_details (咨询详情表)

**状态**: 🔴 **已废弃，建议删除**

**问题**:
- 0条记录
- 功能已被 `communication_records` 表替代
- 占用数据库空间

**优化建议**:
```sql
-- 删除废弃表
DROP TABLE IF EXISTS consultation_details;
```

---

## 🎯 综合优化建议

### 【高优先级】立即执行

#### 1. 添加缺失的索引
```sql
-- users表
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role_status ON users(role, status);

-- customers表
CREATE UNIQUE INDEX idx_customers_lead_id ON customers(lead_id);
CREATE INDEX idx_customers_teacher_id ON customers(teacher_user_id);
CREATE INDEX idx_customers_exam_year ON customers(exam_year);
CREATE INDEX idx_customers_priority ON customers(is_priority);

-- tutoring_deliveries表
CREATE UNIQUE INDEX idx_tutoring_customer_id ON tutoring_deliveries(customer_id);
CREATE INDEX idx_tutoring_thesis_status ON tutoring_deliveries(thesis_status);

-- competition_deliveries表
CREATE UNIQUE INDEX idx_competition_customer_id ON competition_deliveries(customer_id);
CREATE INDEX idx_competition_status ON competition_deliveries(delivery_status);

-- payments表
CREATE INDEX idx_payments_lead_id ON payments(lead_id);
CREATE INDEX idx_payments_date ON payments(payment_date DESC);

-- communication_records表
CREATE INDEX idx_comm_lead_id ON communication_records(lead_id);
CREATE INDEX idx_comm_customer_id ON communication_records(customer_id);
CREATE INDEX idx_comm_created ON communication_records(created_at DESC);

-- login_logs表
CREATE INDEX idx_login_user_id ON login_logs(user_id);
CREATE INDEX idx_login_time ON login_logs(login_time DESC);
```

#### 2. 清理废弃表
```sql
DROP TABLE IF EXISTS consultation_details;
```

### 【中优先级】计划执行

#### 3. 清理冗余字段
需要创建数据迁移脚本，谨慎执行：

**leads表清理**:
- 删除: `deposit_paid_at`, `full_payment_at`, `service_type`, `award_requirement`, `follow_up_notes`

**customers表清理**:
- 删除: `sales_user_id`, `award_requirement`, `service_type`, `tutoring_expire_date`, `award_expire_date`

#### 4. 数据完整性约束
```sql
-- 添加CHECK约束
ALTER TABLE users ADD CONSTRAINT chk_users_role 
  CHECK (role IN ('admin', 'sales', 'teacher'));

ALTER TABLE leads ADD CONSTRAINT chk_leads_stage 
  CHECK (stage IN ('获取联系方式', '线下见面', '首笔支付', '次笔支付'));
```

### 【低优先级】长期优化

#### 5. 性能优化
- 定期执行 `VACUUM` 清理碎片
- 定期执行 `ANALYZE` 更新统计信息
- 考虑分区存储历史数据（login_logs）

#### 6. 数据归档策略
```sql
-- 归档90天前的登录日志
CREATE TABLE login_logs_archive AS 
SELECT * FROM login_logs WHERE login_time < date('now', '-90 days');

DELETE FROM login_logs WHERE login_time < date('now', '-90 days');
```

---

## 📈 预期优化效果

### 性能提升
- **查询速度**: 提升 50-80%（通过添加索引）
- **数据库大小**: 减少 5-10%（清理废弃字段和表）
- **维护成本**: 降低 30%（简化表结构）

### 数据质量
- **数据一致性**: 提升（通过约束）
- **数据冗余**: 减少（清理重复字段）
- **可维护性**: 提升（清晰的表结构）

---

## 🛠️ 执行计划

### 第一阶段：索引优化（1-2小时）
1. 备份数据库
2. 执行索引创建脚本
3. 测试查询性能
4. 验证应用功能

### 第二阶段：清理废弃表（30分钟）
1. 确认consultation_details表无数据
2. 删除表
3. 更新应用代码（如有引用）

### 第三阶段：字段清理（需谨慎）
1. 创建数据迁移脚本
2. 在测试环境验证
3. 备份生产数据
4. 执行迁移
5. 验证数据完整性

---

## ⚠️ 注意事项

1. **备份优先**: 任何结构变更前必须备份数据库
2. **测试验证**: 在测试环境充分测试后再应用到生产
3. **分步执行**: 不要一次性执行所有优化，分阶段进行
4. **监控影响**: 每次变更后监控应用性能和错误日志
5. **回滚准备**: 准备好回滚方案

---

## 📝 总结

当前数据库设计整体良好，主要问题集中在：
1. 🔴 **严重缺少索引** - 影响查询性能
2. 🔴 **存在废弃字段** - 增加维护成本
3. 🟡 **缺少数据约束** - 可能导致数据不一致

建议优先执行索引优化，可立即获得显著的性能提升。

