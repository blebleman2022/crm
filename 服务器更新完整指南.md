# 服务器更新完整指南

## 🎯 本次更新内容

### 主要更新
1. ✅ **约见管理日历视图优化**
   - 第二列显示今天，后续6列显示未来6天
   - 预约只显示"浦东"（绿色）或"浦西"（蓝色）
   - 行高更矮，更紧凑
   - 早晚间时间段字号优化

2. ✅ **数据库文件管理**
   - 数据库文件从Git版本控制中移除
   - 添加到.gitignore，避免误提交

3. ✅ **Nginx配置脚本**
   - 添加自动配置脚本
   - 添加静态文件修复脚本
   - 添加权限修复脚本

---

## ⚠️ 重要说明

### 为什么 `docker compose restart` 没有生效？

**原因**：约见管理日历视图的优化是**前端模板文件**的修改，而 `docker compose restart` 只是重启容器，**不会重新构建镜像**。

**解决方案**：需要重新构建Docker镜像

---

## 🚀 正确的更新步骤

### 方法1: 完整更新（推荐）

```bash
# 1. 进入项目目录
cd ~/crm

# 2. 拉取最新代码
git pull origin master

# 3. 停止容器
docker compose down

# 4. 重新构建镜像（关键步骤！）
docker compose build --no-cache

# 5. 启动容器
docker compose up -d

# 6. 查看日志确认启动成功
docker compose logs -f
```

### 方法2: 一键更新

```bash
cd ~/crm && git pull origin master && docker compose down && docker compose build --no-cache && docker compose up -d && docker compose logs --tail=50
```

### 方法3: 使用验证脚本

```bash
# 1. 拉取最新代码
cd ~/crm
git pull origin master

# 2. 运行验证脚本
bash verify-update.sh

# 3. 根据脚本提示执行更新
```

---

## 🔍 验证更新是否成功

### 1. 检查代码是否拉取成功

```bash
cd ~/crm
git log --oneline -5
```

**预期输出**（应该包含）:
```
4ecc258 feat: 添加服务器更新验证脚本
28ca919 docs: 添加数据库管理说明文档
c603031 chore: 将数据库文件添加到.gitignore，从版本控制中移除
7d5b7e2 feat: 优化约见管理日历视图 - 第二列显示今天，后续6天，简化显示为地点，调整行高和字号
```

### 2. 检查模板文件是否更新

```bash
grep -n "bg-green-500" templates/consultations/list.html
```

**预期输出**:
```
632:        'bg-green-500 text-white hover:bg-green-600' :
```

如果有输出，说明模板文件已更新。

### 3. 检查容器内的文件是否更新

```bash
docker compose exec crm-app grep -n "bg-green-500" /app/templates/consultations/list.html
```

**预期输出**:
```
632:        'bg-green-500 text-white hover:bg-green-600' :
```

如果**没有输出**或**报错**，说明容器内的文件未更新，需要重新构建。

### 4. 检查容器状态

```bash
docker compose ps
```

**预期输出**:
```
NAME       IMAGE       COMMAND            STATUS         PORTS
crm-app    crm-app     "python run.py"    Up X seconds   0.0.0.0:5000->5000/tcp
```

### 5. 浏览器测试

1. 访问约见管理页面
2. 切换到日历视图
3. 检查以下内容：
   - ✅ 第二列是否显示"周X (今天)"
   - ✅ 预约是否只显示"浦东"或"浦西"
   - ✅ 浦东是否是绿色背景
   - ✅ 浦西是否是蓝色背景
   - ✅ 行高是否更紧凑

---

## 🔧 常见问题排查

### 问题1: git pull 后提示"Already up to date"

**原因**: 本地代码已经是最新的

**验证**:
```bash
git log --oneline -1
```

应该显示: `4ecc258 feat: 添加服务器更新验证脚本`

### 问题2: docker compose build 很慢

**原因**: 网络问题或镜像源问题

**解决方案**:
```bash
# 使用国内镜像源
# 已在Dockerfile中配置，正常情况下会自动使用
```

### 问题3: 容器启动后立即退出

**检查日志**:
```bash
docker compose logs
```

**常见原因**:
- 端口被占用
- 配置文件错误
- 依赖包安装失败

### 问题4: 浏览器看不到更新

**原因**: 浏览器缓存

**解决方案**:
1. 按 `Ctrl + F5` 强制刷新
2. 或清除浏览器缓存
3. 或使用隐私模式访问

### 问题5: 容器内文件未更新

**原因**: 没有重新构建镜像

**解决方案**:
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## 📊 Docker命令对比

| 命令 | 作用 | 是否重新构建 | 是否更新代码 |
|------|------|-------------|-------------|
| `docker compose restart` | 重启容器 | ❌ 否 | ❌ 否 |
| `docker compose up -d` | 启动容器 | ❌ 否 | ❌ 否 |
| `docker compose up -d --build` | 启动并构建 | ✅ 是 | ✅ 是 |
| `docker compose build` | 只构建镜像 | ✅ 是 | ✅ 是 |
| `docker compose build --no-cache` | 完全重新构建 | ✅ 是 | ✅ 是 |

**关键点**：
- ✅ 代码更新后，必须使用 `build` 命令重新构建镜像
- ✅ `restart` 只是重启容器，不会更新代码
- ✅ `--no-cache` 确保完全重新构建，不使用缓存

---

## 🎯 完整更新流程图

```
1. 拉取代码
   ↓
   git pull origin master
   ↓
2. 检查更新
   ↓
   git log --online -5
   ↓
3. 停止容器
   ↓
   docker compose down
   ↓
4. 重新构建镜像 ⭐ 关键步骤
   ↓
   docker compose build --no-cache
   ↓
5. 启动容器
   ↓
   docker compose up -d
   ↓
6. 验证更新
   ↓
   docker compose logs
   浏览器测试
```

---

## 📝 更新检查清单

更新完成后，请逐项检查：

- [ ] `git pull` 成功
- [ ] `git log` 显示最新提交
- [ ] `grep "bg-green-500" templates/consultations/list.html` 有输出
- [ ] `docker compose build` 成功
- [ ] `docker compose up -d` 成功
- [ ] `docker compose ps` 显示容器运行中
- [ ] `docker compose logs` 无错误
- [ ] 浏览器访问正常
- [ ] 约见管理日历视图显示正确
- [ ] 浦东显示绿色
- [ ] 浦西显示蓝色

---

## 🚨 紧急回滚

如果更新后出现问题，可以回滚到上一个版本：

```bash
# 1. 查看提交历史
git log --oneline -10

# 2. 回滚到指定版本（例如回滚到上一个版本）
git reset --hard HEAD~1

# 3. 重新构建
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## 💡 最佳实践

### 1. 更新前备份数据库

```bash
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db
```

### 2. 在测试环境先验证

如果有测试环境，先在测试环境更新验证。

### 3. 查看更新日志

```bash
git log --oneline -10
git show <commit-hash>
```

### 4. 使用验证脚本

```bash
bash verify-update.sh
```

---

## 📞 需要帮助？

如果更新过程中遇到问题：

1. 查看日志：`docker compose logs`
2. 运行验证脚本：`bash verify-update.sh`
3. 检查容器状态：`docker compose ps`
4. 查看错误日志：`tail -f logs/crm.log`

---

**最后更新**: 2025-01-02  
**版本**: 1.0

