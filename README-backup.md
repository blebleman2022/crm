# CRM æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½æ–¹æ¡ˆ

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

è‡ªåŠ¨å¤‡ä»½ CRM ç³»ç»Ÿçš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- â° **å®šæ—¶å¤‡ä»½**ï¼šæ¯å¤©å‡Œæ™¨ 3:00 è‡ªåŠ¨æ‰§è¡Œ
- ğŸ“ **å¤‡ä»½è·¯å¾„**ï¼š`/bak/edu_crm_YYYYMMDD.db`
- ğŸ”„ **è‡ªåŠ¨æ¸…ç†**ï¼šåªä¿ç•™æœ€è¿‘ 3 å¤©çš„å¤‡ä»½
- ğŸ“ **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰æ“ä½œè®°å½•åˆ° `/bak/backup.log`

---

## ğŸš€ å¿«é€Ÿå®‰è£…ï¼ˆUbuntu æœåŠ¡å™¨ï¼‰

### æ–¹æ³•ä¸€ï¼šä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰

```bash
# 1. ä¸Šä¼ è„šæœ¬åˆ°æœåŠ¡å™¨
# å°† backup-db.sh å’Œ install-backup-cron.sh ä¸Šä¼ åˆ°æœåŠ¡å™¨ä»»æ„ç›®å½•ï¼ˆå¦‚ /root æˆ– /home/your_userï¼‰

# 2. æ‰§è¡Œå®‰è£…è„šæœ¬
chmod +x install-backup-cron.sh
sudo ./install-backup-cron.sh

# 3. æŒ‰æç¤ºæ“ä½œå³å¯
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…

```bash
# 1. ä¸Šä¼ å¤‡ä»½è„šæœ¬
sudo cp backup-db.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/backup-db.sh

# 2. åˆ›å»ºå¤‡ä»½ç›®å½•
sudo mkdir -p /bak
sudo chown $USER:$USER /bak

# 3. æ·»åŠ  crontab å®šæ—¶ä»»åŠ¡
crontab -e

# åœ¨æ‰“å¼€çš„ç¼–è¾‘å™¨ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š
0 3 * * * /usr/local/bin/backup-db.sh >> /bak/backup.log 2>&1

# ä¿å­˜å¹¶é€€å‡ºï¼ˆvim: æŒ‰ ESCï¼Œè¾“å…¥ :wqï¼Œå›è½¦ï¼‰
```

---

## ğŸ“‚ æ–‡ä»¶è¯´æ˜

### 1. `backup-db.sh` - å¤‡ä»½è„šæœ¬
æ ¸å¿ƒå¤‡ä»½é€»è¾‘ï¼Œè´Ÿè´£ï¼š
- å¤åˆ¶æ•°æ®åº“æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
- æŒ‰æ—¥æœŸå‘½åå¤‡ä»½æ–‡ä»¶
- æ¸…ç†è¶…è¿‡ 3 å¤©çš„æ—§å¤‡ä»½
- è®°å½•è¯¦ç»†æ—¥å¿—

### 2. `install-backup-cron.sh` - å®‰è£…è„šæœ¬
è‡ªåŠ¨åŒ–å®‰è£…å·¥å…·ï¼Œè´Ÿè´£ï¼š
- è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
- åˆ›å»ºå¤‡ä»½ç›®å½•
- æ·»åŠ  crontab å®šæ—¶ä»»åŠ¡
- éªŒè¯å®‰è£…ç»“æœ

### 3. `README-backup.md` - ä½¿ç”¨æ–‡æ¡£
æœ¬æ–‡æ¡£ï¼ŒåŒ…å«å®Œæ•´çš„å®‰è£…å’Œä½¿ç”¨è¯´æ˜ã€‚

---

## âš™ï¸ é…ç½®è¯´æ˜

### ä¿®æ”¹å¤‡ä»½è·¯å¾„

ç¼–è¾‘ `backup-db.sh`ï¼Œä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š

```bash
SOURCE_DB="/crm/instance/edu_crm.db"    # æºæ•°æ®åº“è·¯å¾„
BACKUP_DIR="/bak"                        # å¤‡ä»½ç›®å½•
```

### ä¿®æ”¹ä¿ç•™å¤©æ•°

ç¼–è¾‘ `backup-db.sh`ï¼Œä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š

```bash
KEEP_DAYS=3    # ä¿ç•™å¤©æ•°ï¼ˆé»˜è®¤ 3 å¤©ï¼‰
```

### ä¿®æ”¹æ‰§è¡Œæ—¶é—´

ç¼–è¾‘ crontabï¼š

```bash
crontab -e
```

ä¿®æ”¹æ—¶é—´éƒ¨åˆ†ï¼ˆcron è¡¨è¾¾å¼ï¼‰ï¼š

```
# åˆ† æ—¶ æ—¥ æœˆ å‘¨
0 3 * * *    # æ¯å¤©å‡Œæ™¨ 3:00
0 2 * * *    # æ¯å¤©å‡Œæ™¨ 2:00
0 4 * * 0    # æ¯å‘¨æ—¥å‡Œæ™¨ 4:00
0 3 1 * *    # æ¯æœˆ 1 å·å‡Œæ™¨ 3:00
```

---

## ğŸ” éªŒè¯ä¸æµ‹è¯•

### 1. éªŒè¯ crontab ä»»åŠ¡

```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡
crontab -l

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# 0 3 * * * /path/to/backup-db.sh >> /bak/backup.log 2>&1
```

### 2. æ‰‹åŠ¨æµ‹è¯•å¤‡ä»½

```bash
# ç›´æ¥æ‰§è¡Œå¤‡ä»½è„šæœ¬
sudo /path/to/backup-db.sh

# æˆ–è€…ï¼ˆå¦‚æœå·²å®‰è£…åˆ° /usr/local/binï¼‰
sudo backup-db.sh
```

### 3. æŸ¥çœ‹å¤‡ä»½ç»“æœ

```bash
# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh /bak/edu_crm_*.db

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# -rw-r--r-- 1 root root 2.5M Jan 15 03:00 /bak/edu_crm_20250115.db
```

### 4. æŸ¥çœ‹å¤‡ä»½æ—¥å¿—

```bash
# æŸ¥çœ‹å®Œæ•´æ—¥å¿—
cat /bak/backup.log

# å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆç­‰å¾…ä¸‹æ¬¡å¤‡ä»½ï¼‰
tail -f /bak/backup.log
```

---

## ğŸ“Š æ—¥å¿—ç¤ºä¾‹

```
[2025-01-15 03:00:01] ========== å¼€å§‹æ•°æ®åº“å¤‡ä»½ ==========
[2025-01-15 03:00:01] æ­£åœ¨å¤‡ä»½: /crm/instance/edu_crm.db -> /bak/edu_crm_20250115.db
[2025-01-15 03:00:02] å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶å¤§å°: 2.5M
[2025-01-15 03:00:02] å¼€å§‹æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 3 å¤©ï¼‰...
[2025-01-15 03:00:02] åˆ é™¤æ—§å¤‡ä»½: /bak/edu_crm_20250111.db
[2025-01-15 03:00:02] å½“å‰å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:
[2025-01-15 03:00:02]   -rw-r--r-- 1 root root 2.4M Jan 12 03:00 /bak/edu_crm_20250112.db
[2025-01-15 03:00:02]   -rw-r--r-- 1 root root 2.4M Jan 13 03:00 /bak/edu_crm_20250113.db
[2025-01-15 03:00:02]   -rw-r--r-- 1 root root 2.5M Jan 14 03:00 /bak/edu_crm_20250114.db
[2025-01-15 03:00:02]   -rw-r--r-- 1 root root 2.5M Jan 15 03:00 /bak/edu_crm_20250115.db
[2025-01-15 03:00:02] å½“å‰å…±æœ‰ 4 ä¸ªå¤‡ä»½æ–‡ä»¶
[2025-01-15 03:00:02] ========== å¤‡ä»½å®Œæˆ ==========
```

---

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡

```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å®šæ—¶ä»»åŠ¡
crontab -l

# æŸ¥çœ‹ç³»ç»Ÿçº§å®šæ—¶ä»»åŠ¡
sudo cat /etc/crontab
```

### ç¼–è¾‘å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘å½“å‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡
crontab -e
```

### åˆ é™¤å®šæ—¶ä»»åŠ¡

```bash
# åˆ é™¤å¤‡ä»½ä»»åŠ¡ï¼ˆä¿ç•™å…¶ä»–ä»»åŠ¡ï¼‰
crontab -l | grep -v 'backup-db.sh' | crontab -

# åˆ é™¤æ‰€æœ‰å®šæ—¶ä»»åŠ¡ï¼ˆæ…ç”¨ï¼ï¼‰
crontab -r
```

### æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½

```bash
# æ–¹å¼ 1ï¼šç›´æ¥æ‰§è¡Œè„šæœ¬
sudo /path/to/backup-db.sh

# æ–¹å¼ 2ï¼šå¦‚æœå·²å®‰è£…åˆ° /usr/local/bin
sudo backup-db.sh

# æ–¹å¼ 3ï¼šåœ¨åå°æ‰§è¡Œå¹¶æŸ¥çœ‹æ—¥å¿—
sudo backup-db.sh >> /bak/backup.log 2>&1 &
tail -f /bak/backup.log
```

### æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶

```bash
# åˆ—å‡ºæ‰€æœ‰å¤‡ä»½æ–‡ä»¶
ls -lh /bak/edu_crm_*.db

# æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€åï¼‰
ls -lht /bak/edu_crm_*.db

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶æ•°é‡
ls -1 /bak/edu_crm_*.db | wc -l
```

### æ¢å¤å¤‡ä»½

```bash
# 1. åœæ­¢ CRM æœåŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
sudo systemctl stop crm  # æˆ–æ ¹æ®ä½ çš„æœåŠ¡åç§°

# 2. å¤‡ä»½å½“å‰æ•°æ®åº“ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
sudo cp /crm/instance/edu_crm.db /crm/instance/edu_crm.db.before_restore

# 3. æ¢å¤æŒ‡å®šæ—¥æœŸçš„å¤‡ä»½
sudo cp /bak/edu_crm_20250115.db /crm/instance/edu_crm.db

# 4. è®¾ç½®æ­£ç¡®çš„æƒé™
sudo chown crm_user:crm_user /crm/instance/edu_crm.db  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·
sudo chmod 644 /crm/instance/edu_crm.db

# 5. é‡å¯ CRM æœåŠ¡
sudo systemctl start crm
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è·¯å¾„æ£€æŸ¥
ç¡®ä¿ä»¥ä¸‹è·¯å¾„æ­£ç¡®ï¼š
- æºæ•°æ®åº“ï¼š`/crm/instance/edu_crm.db`
- å¤‡ä»½ç›®å½•ï¼š`/bak`

å¦‚æœè·¯å¾„ä¸åŒï¼Œè¯·ä¿®æ”¹ `backup-db.sh` ä¸­çš„é…ç½®å˜é‡ã€‚

### 2. æƒé™è¦æ±‚
- å¤‡ä»½è„šæœ¬éœ€è¦æœ‰è¯»å–æºæ•°æ®åº“çš„æƒé™
- å¤‡ä»½ç›®å½•éœ€è¦æœ‰å†™å…¥æƒé™
- å»ºè®®ä½¿ç”¨ `sudo` æˆ– root ç”¨æˆ·æ‰§è¡Œ

### 3. ç£ç›˜ç©ºé—´
- æ¯ä¸ªå¤‡ä»½æ–‡ä»¶å¤§å°çº¦ç­‰äºå½“å‰æ•°æ®åº“å¤§å°
- ä¿ç•™ 3 å¤©å¤‡ä»½ï¼Œéœ€è¦è‡³å°‘ 3 å€æ•°æ®åº“å¤§å°çš„ç©ºé—´
- å®šæœŸæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š`df -h /bak`

### 4. æ—¶åŒºè®¾ç½®
- crontab ä½¿ç”¨æœåŠ¡å™¨ç³»ç»Ÿæ—¶åŒº
- ç¡®è®¤æœåŠ¡å™¨æ—¶åŒºï¼š`timedatectl` æˆ– `date`
- å¦‚éœ€ä¿®æ”¹æ—¶åŒºï¼š`sudo timedatectl set-timezone Asia/Shanghai`

### 5. æ—¥å¿—ç®¡ç†
- æ—¥å¿—æ–‡ä»¶ä¼šæŒç»­å¢é•¿
- å»ºè®®å®šæœŸæ¸…ç†æˆ–ä½¿ç”¨ logrotate ç®¡ç†
- æ‰‹åŠ¨æ¸…ç†ï¼š`sudo truncate -s 0 /bak/backup.log`

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå®šæ—¶ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ

**æ£€æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. ç¡®è®¤ cron æœåŠ¡è¿è¡Œ
sudo systemctl status cron

# 2. æŸ¥çœ‹ cron æ—¥å¿—
sudo tail -f /var/log/syslog | grep CRON

# 3. æ£€æŸ¥ crontab è¯­æ³•
crontab -l

# 4. æ‰‹åŠ¨æ‰§è¡Œæµ‹è¯•
sudo /path/to/backup-db.sh
```

### é—®é¢˜ 2ï¼šå¤‡ä»½å¤±è´¥

**æ£€æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹å¤‡ä»½æ—¥å¿—
cat /bak/backup.log

# 2. æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /crm/instance/edu_crm.db

# 3. æ£€æŸ¥å¤‡ä»½ç›®å½•æƒé™
ls -ld /bak

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /bak
```

### é—®é¢˜ 3ï¼šæ—§å¤‡ä»½æ²¡æœ‰åˆ é™¤

**æ£€æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
ls -lht /bak/edu_crm_*.db

# 2. æ‰‹åŠ¨æµ‹è¯•æ¸…ç†é€»è¾‘
find /bak -name "edu_crm_*.db" -type f -mtime +2

# 3. æ£€æŸ¥è„šæœ¬ä¸­çš„ KEEP_DAYS å˜é‡
grep KEEP_DAYS /path/to/backup-db.sh
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. æœåŠ¡å™¨ç³»ç»Ÿç‰ˆæœ¬ï¼š`lsb_release -a`
2. å¤‡ä»½æ—¥å¿—ï¼š`cat /bak/backup.log`
3. Crontab é…ç½®ï¼š`crontab -l`
4. é”™è¯¯ä¿¡æ¯æˆªå›¾æˆ–å®Œæ•´è¾“å‡º

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-15)
- âœ¨ åˆå§‹ç‰ˆæœ¬
- âœ… æ”¯æŒæ¯å¤©è‡ªåŠ¨å¤‡ä»½
- âœ… æ”¯æŒä¿ç•™æœ€è¿‘ 3 å¤©å¤‡ä»½
- âœ… æ”¯æŒè¯¦ç»†æ—¥å¿—è®°å½•
- âœ… æä¾›ä¸€é”®å®‰è£…è„šæœ¬

---

## ğŸ“„ è®¸å¯è¯

æœ¬è„šæœ¬ä¸º EduConnect CRM é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œä»…ä¾›å†…éƒ¨ä½¿ç”¨ã€‚

