# 业务流程优化说明

**优化日期**: 2025-09-30  
**优化版本**: v2.0  
**优化类型**: 字段位置调整

---

## 📋 优化背景

### 实际业务流程

根据实际业务流程，销售人员的工作流程如下：

1. **获取线索** - 获取家长联系方式
2. **线下见面** - 与家长和学员面谈
3. **合同沟通** - 确定服务内容、奖项目标、额外要求等
4. **付款跟进** - 跟进首笔、次笔、全款支付
5. **转为客户** - 付款完成后转交给班主任执行

**关键发现**：
- ✅ 销售在**签合同时**就已经确定了服务类型、奖项等级、额外要求
- ✅ 班主任只需要**接受并执行**这些要求
- ❌ 之前的设计要求在转客户后才能设置这些字段，不符合实际流程

---

## 🔄 优化内容

### 字段位置调整

| 字段 | 优化前 | 优化后 | 说明 |
|-----|-------|-------|------|
| **服务类型** | ✅ 线索表 | ✅ 线索表 | 保持不变 |
| **竞赛奖项等级** | ❌ 仅客户表 | ✅ 线索表 + 客户表 | **新增到线索表** |
| **额外要求** | ❌ 仅客户表 | ✅ 线索表 + 客户表 | **新增到线索表** |

### 数据流转逻辑

```
┌─────────────────────────────────────────────────────────────┐
│                    线索阶段 (销售负责)                        │
├─────────────────────────────────────────────────────────────┤
│ 1. 获取联系方式                                              │
│ 2. 线下见面                                                  │
│ 3. 合同沟通 ← 确定服务类型、奖项等级、额外要求               │
│ 4. 付款跟进                                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓ 转客户
┌─────────────────────────────────────────────────────────────┐
│                    客户阶段 (班主任负责)                      │
├─────────────────────────────────────────────────────────────┤
│ 1. 接收客户信息（从线索表复制）                              │
│ 2. 执行服务交付                                              │
│ 3. 如需调整，可在客户表修改                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 数据库结构

### 线索表 (leads)

```sql
CREATE TABLE leads (
    id INTEGER PRIMARY KEY,
    student_name VARCHAR(50),
    parent_wechat_display_name VARCHAR(50) NOT NULL,
    parent_wechat_name VARCHAR(50) NOT NULL,
    contact_info VARCHAR(100),
    sales_user_id INTEGER NOT NULL,
    grade VARCHAR(10),
    stage VARCHAR(50) NOT NULL,
    contract_amount DECIMAL(10, 2),
    
    -- 服务内容（销售在合同沟通时确定）
    service_types TEXT,                      -- JSON: ["tutoring", "competition"]
    competition_award_level VARCHAR(20),     -- ✨ 新增：市奖/国奖
    additional_requirements TEXT,            -- ✨ 新增：额外要求
    
    created_at DATETIME,
    updated_at DATETIME
);
```

### 客户表 (customers)

```sql
CREATE TABLE customers (
    id INTEGER PRIMARY KEY,
    lead_id INTEGER NOT NULL,
    teacher_user_id INTEGER,
    exam_year INTEGER,
    
    -- 从线索表复制的字段（可在客户阶段调整）
    competition_award_level VARCHAR(20),     -- 从线索表复制
    additional_requirements TEXT,            -- 从线索表复制
    
    converted_at DATETIME,
    created_at DATETIME,
    updated_at DATETIME
);
```

---

## 💻 代码实现

### 1. 模型定义 (models.py)

```python
class Lead(db.Model):
    """学员线索表"""
    __tablename__ = 'leads'
    
    id = db.Column(db.Integer, primary_key=True)
    student_name = db.Column(db.String(50))
    # ... 其他字段 ...
    
    # 服务内容（销售在合同沟通时确定）
    service_types = db.Column(db.Text, comment='服务类型JSON')
    competition_award_level = db.Column(db.String(20), comment='竞赛奖项等级：市奖/国奖')
    additional_requirements = db.Column(db.Text, comment='额外要求')
```

### 2. 线索编辑页面 (templates/leads/edit.html)

新增表单字段：

```html
<!-- 竞赛奖项等级 -->
<div class="mt-6">
    <label for="competition_award_level">竞赛奖项等级</label>
    <select id="competition_award_level" name="competition_award_level">
        <option value="">无奖项要求</option>
        <option value="市奖">市奖</option>
        <option value="国奖">国奖</option>
    </select>
</div>

<!-- 额外要求 -->
<div class="mt-6">
    <label for="additional_requirements">额外要求</label>
    <textarea id="additional_requirements" name="additional_requirements" 
              placeholder="例如：按时报名竞赛、退款条件、特殊服务要求等"></textarea>
</div>
```

### 3. 线索编辑路由 (routes/leads.py)

```python
@leads_bp.route('/<int:lead_id>/edit', methods=['GET', 'POST'])
def edit_lead(lead_id):
    if request.method == 'POST':
        # 获取表单数据
        competition_award_level = request.form.get('competition_award_level', '').strip()
        additional_requirements = request.form.get('additional_requirements', '').strip()
        
        # 更新线索
        lead.competition_award_level = competition_award_level if competition_award_level else None
        lead.additional_requirements = additional_requirements if additional_requirements else None
        
        db.session.commit()
```

### 4. 转客户逻辑 (routes/leads.py)

```python
@leads_bp.route('/<int:lead_id>/convert', methods=['POST'])
def convert_to_customer(lead_id):
    lead = Lead.query.get_or_404(lead_id)
    
    # 创建客户记录，从线索表复制字段
    result = db.session.execute(insert_sql, {
        'lead_id': lead.id,
        'teacher_user_id': teacher_id,
        'competition_award_level': lead.competition_award_level,  # 从线索表复制
        'additional_requirements': lead.additional_requirements,  # 从线索表复制
        'exam_year': exam_year,
        # ...
    })
```

---

## 🎯 使用场景

### 场景1：销售签合同时设置

```
销售：张三
线索：李四（高一学生）

1. 线下见面后，确定服务内容：
   - 服务类型：课题辅导 + 竞赛辅导
   - 奖项目标：国奖
   - 额外要求：需要在2027年5月前完成，否则退款50%

2. 在线索编辑页面设置：
   ✅ 服务类型：勾选"课题辅导"和"竞赛辅导"
   ✅ 竞赛奖项等级：选择"国奖"
   ✅ 额外要求：填写"需要在2027年5月前完成，否则退款50%"

3. 保存后，这些信息存储在线索表中

4. 付款完成后，点击"转客户"：
   ✅ 自动将这些信息复制到客户表
   ✅ 班主任可以直接看到所有要求
```

### 场景2：班主任接收客户

```
班主任：王老师
客户：李四（从线索转换而来）

1. 在客户管理页面查看客户详情：
   ✅ 服务类型：课题辅导 + 竞赛辅导（从线索表读取）
   ✅ 奖项目标：国奖（从客户表读取，已从线索表复制）
   ✅ 额外要求：需要在2027年5月前完成，否则退款50%

2. 如果需要调整：
   ✅ 可以在客户编辑页面修改奖项等级和额外要求
   ✅ 修改后只更新客户表，不影响线索表
```

---

## ✅ 优化优势

### 1. 符合实际业务流程

- ✅ 销售在签合同时就能设置所有要求
- ✅ 不需要等到转客户后才能设置
- ✅ 减少操作步骤，提高效率

### 2. 数据完整性

- ✅ 线索阶段就记录了完整的合同信息
- ✅ 转客户时自动复制，避免遗漏
- ✅ 客户表保留副本，支持后续调整

### 3. 灵活性

- ✅ 线索阶段可以设置（销售负责）
- ✅ 客户阶段可以调整（班主任负责）
- ✅ 两个阶段的数据相互独立，互不影响

---

## 📝 数据示例

### 线索阶段

```python
lead = Lead.query.get(1)

# 销售设置的信息
lead.service_types = '["tutoring", "competition"]'
lead.competition_award_level = '国奖'
lead.additional_requirements = '需要在2027年5月前完成，否则退款50%'
```

### 转客户时

```python
# 自动从线索表复制到客户表
customer = Customer(
    lead_id=lead.id,
    competition_award_level=lead.competition_award_level,  # '国奖'
    additional_requirements=lead.additional_requirements,  # '需要在2027年5月前完成...'
)
```

### 客户阶段

```python
customer = Customer.query.get(1)

# 班主任可以查看
print(customer.competition_award_level)  # '国奖'
print(customer.additional_requirements)  # '需要在2027年5月前完成...'

# 班主任可以调整
customer.competition_award_level = '市奖'  # 降低目标
customer.additional_requirements = '需要在2027年5月前完成'  # 修改要求
```

---

## 🔄 迁移说明

### 现有数据处理

对于已经存在的数据：

1. **线索表**：
   - `competition_award_level` 和 `additional_requirements` 字段已存在
   - 现有线索这两个字段为 NULL
   - 可以通过编辑页面设置

2. **客户表**：
   - 已有客户的这两个字段保持不变
   - 新转换的客户会从线索表复制

3. **无需数据迁移**：
   - 数据库表结构无需修改
   - 只是启用了之前未使用的字段

---

## 📊 对比总结

| 方面 | 优化前 | 优化后 |
|-----|-------|-------|
| **设置时机** | 转客户后 | 线索阶段 ✅ |
| **操作人员** | 班主任 | 销售 ✅ |
| **业务流程** | 不符合 | 符合 ✅ |
| **操作步骤** | 多 | 少 ✅ |
| **数据完整性** | 延迟记录 | 及时记录 ✅ |

---

## 🎉 总结

通过将 `competition_award_level` 和 `additional_requirements` 字段恢复到线索表，系统现在完全符合实际业务流程：

1. ✅ **销售在签合同时**就能设置所有服务要求
2. ✅ **转客户时自动复制**，班主任直接看到完整信息
3. ✅ **班主任可以调整**，支持后续变更
4. ✅ **减少操作步骤**，提高工作效率

这个优化使系统更加贴近实际业务，提升了用户体验！

---

**文档结束**

