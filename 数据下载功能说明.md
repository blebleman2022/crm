# 数据下载功能说明

## 功能概述

为销售管理角色（`sales_manager`）添加了数据下载功能，可以选择多个数据表并导出为Excel文件。

## 访问权限

- **仅销售管理角色可访问**（`sales_manager`）
- 其他角色无法看到此菜单项

## 功能特性

### 1. 多表选择
- 支持同时选择多个数据表
- 提供全选/取消全选快捷按钮
- 实时显示已选择的表数量

### 2. 数据预览
- 每个表卡片显示：
  - 表的中文名称
  - 表名（英文）
  - 字段数量
  - 记录总数（实时加载）
- 点击"预览"按钮可查看前10条数据

### 3. Excel导出
- 一键下载选中的所有表
- 每个表作为独立的Sheet页
- 列名自动转换为中文
- 文件名包含时间戳：`数据导出_20251022_225959.xlsx`

### 4. 数据格式化
- 日期时间：格式化为 `YYYY-MM-DD HH:MM:SS`
- 布尔值：转换为"是"/"否"
- 角色字段：转换为中文（管理员、销售管理等）
- 状态字段：转换为"启用"/"禁用"

## 可导出的数据表

系统支持导出以下10个数据表：

| 表名 | 中文名称 | 说明 |
|------|---------|------|
| users | 用户表 | 系统用户信息 |
| leads | 线索表 | 学员线索信息 |
| customers | 客户表 | 成交客户信息 |
| payments | 付款记录表 | 付款记录 |
| teachers | 老师表 | 老师信息 |
| tutoring_deliveries | 课题辅导交付表 | 课题辅导服务交付 |
| competition_deliveries | 竞赛交付表 | 竞赛奖项获取交付 |
| communication_records | 沟通记录表 | 线索和客户沟通记录 |
| login_logs | 登录日志表 | 用户登录日志 |
| competition_names | 竞赛名称配置表 | 竞赛名称配置 |

## 使用步骤

### 1. 登录系统
使用销售管理角色账号登录系统。

### 2. 进入数据下载页面
在左侧导航栏点击"数据下载"菜单项。

### 3. 选择要导出的表
- 点击表卡片或复选框选择表
- 可使用"全选"按钮快速选择所有表
- 可点击"预览"按钮查看表数据

### 4. 下载数据
点击"下载选中的表"按钮，系统将生成Excel文件并自动下载。

## 技术实现

### 后端
- **路由文件**: `routes/data_export.py`
- **权限控制**: `@sales_manager_required` 装饰器
- **数据导出**: 使用 `pandas` 和 `openpyxl` 库
- **蓝图注册**: `/data_export` 路径前缀

### 前端
- **模板文件**: `templates/data_export/index.html`
- **样式**: Tailwind CSS
- **交互**: 原生JavaScript
- **图标**: Material Symbols

### 依赖包
```
pandas==2.1.4
openpyxl==3.1.2
```

## API接口

### 1. 数据下载页面
```
GET /data_export/export
```
返回数据下载页面。

### 2. 下载数据
```
POST /data_export/export/download
Content-Type: application/json

{
  "tables": ["users", "leads", "customers"]
}
```
返回Excel文件流。

### 3. 预览表数据
```
GET /data_export/export/preview/<table_key>
```
返回表的前10条数据和总记录数。

响应示例：
```json
{
  "success": true,
  "table_name": "用户表",
  "columns": ["ID", "用户名", "手机号", "角色", "状态"],
  "data": [
    {"ID": "1", "用户名": "admin", "手机号": "13800138000", "角色": "管理员", "状态": "启用"}
  ],
  "total_count": 7
}
```

## 安全考虑

### 1. 权限控制
- 仅销售管理角色可访问
- 其他角色访问会被重定向到仪表板

### 2. 数据脱敏
- 用户表不导出密码字段
- 敏感信息可根据需要进一步脱敏

### 3. 文件安全
- 文件在内存中生成，不保存到磁盘
- 使用 `io.BytesIO()` 临时存储

## 性能优化

### 1. 分页加载
- 预览功能只加载前10条数据
- 减少数据库查询压力

### 2. 异步加载
- 记录数统计异步加载
- 不阻塞页面渲染

### 3. 按需导出
- 只导出选中的表
- 减少不必要的数据处理

## 未来扩展

### 可能的改进方向：

1. **筛选导出**
   - 支持按日期范围筛选
   - 支持按条件筛选数据

2. **定时导出**
   - 设置定时任务自动导出
   - 发送到指定邮箱

3. **导出格式**
   - 支持CSV格式
   - 支持JSON格式

4. **数据统计**
   - 导出时生成统计报表
   - 添加图表和分析

5. **导出历史**
   - 记录导出历史
   - 支持重新下载历史文件

## 故障排查

### 问题1：无法看到"数据下载"菜单
**原因**: 当前用户不是销售管理角色  
**解决**: 使用销售管理角色账号登录

### 问题2：下载失败
**原因**: 可能是数据量过大或网络问题  
**解决**: 
- 减少选择的表数量
- 检查网络连接
- 查看服务器日志

### 问题3：Excel文件打不开
**原因**: 文件损坏或格式不兼容  
**解决**: 
- 重新下载
- 使用最新版本的Excel或WPS
- 检查服务器端openpyxl版本

### 问题4：中文乱码
**原因**: Excel编码问题  
**解决**: 
- 使用Excel 2016或更高版本
- 使用WPS Office
- 当前实现已使用openpyxl，不应出现乱码

## 测试建议

### 功能测试
1. 测试单表导出
2. 测试多表导出
3. 测试全选导出
4. 测试预览功能
5. 测试权限控制

### 性能测试
1. 测试大数据量导出（10000+记录）
2. 测试并发导出
3. 测试内存占用

### 兼容性测试
1. 测试不同浏览器（Chrome、Firefox、Safari）
2. 测试不同Excel版本
3. 测试移动端访问

## 维护说明

### 添加新表
如需添加新的可导出表，在 `routes/data_export.py` 的 `EXPORTABLE_TABLES` 字典中添加：

```python
'new_table': {
    'name': '新表名',
    'model': NewModel,
    'columns': ['id', 'field1', 'field2'],
    'column_names': ['ID', '字段1', '字段2']
}
```

### 修改字段
修改 `columns` 和 `column_names` 列表即可。

### 自定义格式化
在 `download_data()` 函数中添加特殊处理逻辑。

---

**开发时间**: 2025-10-22  
**版本**: 1.0.0  
**开发者**: AI Assistant

