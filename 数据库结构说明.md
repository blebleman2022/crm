# EduConnect CRM 数据库结构说明

## 📊 优化后的表结构

### 1. 线索表 (leads)

#### 设计原则
**线索表存储销售阶段的信息**，包括客户获取、跟进、成交过程中的所有数据。

#### 字段列表

| 字段名 | 类型 | 说明 | 是否必填 | 备注 |
|--------|------|------|---------|------|
| **基本信息** |
| `id` | Integer | 主键 | ✅ | 自增ID |
| `student_name` | String(50) | 学员姓名 | ❌ | 可选，初期可能不知道 |
| `parent_wechat_display_name` | String(50) | 家长微信名 | ✅ | 必填 |
| `parent_wechat_name` | String(50) | 家长微信号 | ✅ | 必填，唯一 |
| `contact_info` | String(100) | 联系方式 | ❌ | 手机号等 |
| `contact_locked` | Boolean | 联系方式是否锁定 | - | 默认True |
| `grade` | String(10) | 年级 | ❌ | 1-9年级、高一、高二、高三 |
| `district` | String(20) | 行政区 | ❌ | 如：浦东、浦西 |
| `school` | String(100) | 学校 | ❌ | 学校名称 |
| **业务信息** |
| `lead_source` | String(50) | 线索来源 | ❌ | 渠道来源 |
| `sales_user_id` | Integer | 责任销售ID | ✅ | 外键关联users表 |
| `stage` | String(50) | 线索阶段 | ✅ | 自动计算 |
| `contract_amount` | Numeric(10,2) | 合同金额 | ❌ | 预计或实际金额 |
| **时间节点** |
| `contact_obtained_at` | DateTime | 获取联系方式时间 | ❌ | 填写后锁定 |
| `meeting_at` | DateTime | 线下见面时间 | ❌ | 填写后锁定 |
| `meeting_location` | String(20) | 见面地点 | ❌ | 浦东/浦西 |
| `first_payment_at` | DateTime | 首笔支付时间 | ❌ | 自动从payment表同步 |
| `second_payment_at` | DateTime | 次笔支付时间 | ❌ | 自动从payment表同步 |
| **服务内容** |
| `service_types` | Text | 服务类型JSON | ❌ | ["tutoring", "competition", "upgrade_guidance"] |
| **其他** |
| `follow_up_notes` | Text | 跟进备注 | ❌ | 销售跟进记录 |
| `created_at` | DateTime | 创建时间 | - | 自动生成 |
| `updated_at` | DateTime | 更新时间 | - | 自动更新 |

#### 辅助方法

```python
# 获取服务类型列表
lead.get_service_types_list()  # 返回 ['tutoring', 'competition']

# 设置服务类型列表
lead.set_service_types_list(['tutoring', 'competition'])

# 检查是否包含某个服务类型
lead.has_service_type('tutoring')  # 返回 True/False

# 获取显示名称
lead.get_display_name()  # 返回学员姓名或家长微信名
```

---

### 2. 客户表 (customers)

#### 设计原则
**客户表存储交付阶段的信息**，包括成交后的服务要求、交付状态等。

#### 字段列表

| 字段名 | 类型 | 说明 | 是否必填 | 备注 |
|--------|------|------|---------|------|
| **关联信息** |
| `id` | Integer | 主键 | ✅ | 自增ID |
| `lead_id` | Integer | 关联线索ID | ✅ | 外键关联leads表 |
| `teacher_user_id` | Integer | 责任班主任ID | ❌ | 外键关联users表 |
| **服务要求** |
| `payment_amount` | Numeric(10,2) | 支付金额 | ✅ | 实际支付金额 |
| `competition_award_level` | String(20) | 竞赛奖项等级 | ❌ | 市奖/国奖/无 |
| `additional_requirements` | Text | 额外要求 | ❌ | 特殊要求说明 |
| `exam_year` | Integer | 中高考年份 | ❌ | 根据年级自动计算 |
| **其他** |
| `customer_notes` | Text | 客户备注 | ❌ | 交付阶段备注 |
| `converted_at` | DateTime | 线索转客户时间 | ❌ | 记录转换时间 |
| `is_priority` | Boolean | 是否重点关注 | - | 默认False |
| `created_at` | DateTime | 创建时间 | - | 自动生成 |
| `updated_at` | DateTime | 更新时间 | - | 自动更新 |

#### 辅助方法

```python
# 获取责任销售（从线索表读取）
customer.get_sales_user()  # 返回 User 对象

# 获取服务类型列表（从线索表读取）
customer.get_service_types()  # 返回 ['tutoring', 'competition']

# 获取服务到期时间（根据exam_year计算）
customer.get_expire_date()  # 返回 date(exam_year, 5, 31)
```

---

## 🔄 数据读取逻辑

### 从线索表读取的数据

在客户管理中，以下数据**从线索表读取**：

```python
# 基本信息
customer.lead.student_name              # 学员姓名
customer.lead.parent_wechat_display_name # 家长微信名
customer.lead.parent_wechat_name        # 家长微信号
customer.lead.contact_info              # 联系方式
customer.lead.grade                     # 年级
customer.lead.district                  # 行政区
customer.lead.school                    # 学校

# 责任销售
customer.lead.sales_user                # 责任销售对象
customer.lead.sales_user.username       # 责任销售姓名
# 或使用辅助方法
customer.get_sales_user()               # 返回责任销售对象

# 服务类型
customer.lead.service_types             # JSON字符串
customer.lead.get_service_types_list()  # 列表格式
# 或使用辅助方法
customer.get_service_types()            # 返回列表
```

### 从客户表读取的数据

在客户管理中，以下数据**从客户表读取**：

```python
# 交付信息
customer.teacher_user                   # 责任班主任对象
customer.teacher_user.username          # 责任班主任姓名

# 服务要求
customer.competition_award_level        # 竞赛奖项等级
customer.additional_requirements        # 额外要求
customer.exam_year                      # 中高考年份

# 其他
customer.payment_amount                 # 支付金额
customer.customer_notes                 # 客户备注
customer.is_priority                    # 是否重点关注
```

### 计算得出的数据

```python
# 服务到期时间（根据exam_year计算）
customer.get_expire_date()              # 返回 date(exam_year, 5, 31)
```

---

## ✏️ 编辑更新逻辑

### 1. 编辑线索 (`routes/leads.py`)

#### 可编辑字段

```python
# 基本信息（可编辑）
- student_name          # 学员姓名
- contact_info          # 联系方式（锁定后不可编辑）
- grade                 # 年级
- district              # 行政区
- school                # 学校

# 业务信息（可编辑）
- sales_user_id         # 责任销售
- contract_amount       # 合同金额
- service_types         # 服务类型（多选）

# 时间节点（填写后锁定）
- contact_obtained_at   # 获取联系方式时间
- meeting_at            # 线下见面时间
- meeting_location      # 见面地点

# 备注（可编辑）
- follow_up_notes       # 跟进备注
```

#### 特殊逻辑

```python
# 1. 年级变化时，自动更新客户的exam_year
if grade_changed and customer_exists:
    customer.exam_year = calculate_exam_year(new_grade)
    # 添加沟通记录
    add_communication_record(f"年级更新为 {new_grade}，中高考年份自动更新为 {exam_year}年")

# 2. 联系方式锁定机制
if contact_obtained_at is not None:
    contact_locked = True  # 锁定后不可编辑contact_info

# 3. 支付时间自动同步
# first_payment_at 和 second_payment_at 从 payment 表自动同步
update_lead_payment_times(lead_id)
```

---

### 2. 编辑客户 (`routes/customers.py`)

#### 可编辑字段

```python
# 基本信息（同步到线索表）
- student_name          # 学员姓名 → lead.student_name
- contact_info          # 联系方式 → lead.contact_info
- sales_user_id         # 责任销售 → lead.sales_user_id

# 交付信息（存储在客户表）
- teacher_user_id       # 责任班主任
- competition_award_level    # 竞赛奖项等级
- additional_requirements    # 额外要求
- exam_year             # 中高考年份

# 备注（存储在客户表）
- customer_notes        # 客户备注
```

#### 更新逻辑

```python
def edit_customer(customer_id):
    # 1. 获取表单数据
    student_name = request.form.get('student_name')
    contact_info = request.form.get('contact_info')
    sales_user_id = request.form.get('sales_user_id')
    teacher_user_id = request.form.get('teacher_user_id')
    competition_award_level = request.form.get('competition_award_level')
    additional_requirements = request.form.get('additional_requirements')
    exam_year = request.form.get('exam_year')
    notes = request.form.get('notes')
    
    # 2. 更新线索表（基本信息）
    customer.lead.student_name = student_name
    customer.lead.contact_info = contact_info
    customer.lead.sales_user_id = sales_user_id
    customer.lead.updated_at = datetime.utcnow()
    
    # 3. 更新客户表（交付信息）
    customer.teacher_user_id = teacher_user_id
    customer.competition_award_level = competition_award_level
    customer.additional_requirements = additional_requirements
    customer.exam_year = exam_year
    customer.customer_notes = notes
    customer.updated_at = datetime.utcnow()
    
    # 4. 如果备注有变化，添加沟通记录
    if notes and notes != old_notes:
        add_communication_record(f"客户信息更新备注：{notes}")
    
    # 5. 提交更改
    db.session.commit()
```

---

### 3. 线索转客户 (`routes/leads.py`)

#### 转换逻辑

```python
def convert_to_customer(lead_id):
    # 1. 根据年级自动计算中高考年份
    exam_year = calculate_exam_year(lead.grade)
    
    # 2. 创建客户记录
    customer = Customer(
        lead_id=lead.id,
        teacher_user_id=teacher_id,          # 可选的班主任
        payment_amount=0,                    # 初始为0，后续填写
        competition_award_level=None,        # 后续在客户管理中设置
        additional_requirements=None,        # 后续在客户管理中设置
        exam_year=exam_year,                 # 自动计算
        converted_at=datetime.now()
    )
    
    # 3. 如果分配了班主任，创建交付记录
    if teacher_id:
        tutoring_delivery = TutoringDelivery(customer_id=customer.id)
        db.session.add(tutoring_delivery)
    
    # 4. 提交
    db.session.commit()
```

---

## 📋 数据流向图

```
┌─────────────────────────────────────────────────────────────┐
│                        线索阶段                              │
├─────────────────────────────────────────────────────────────┤
│  线索表 (leads)                                              │
│  ├─ 基本信息: 学员姓名、联系方式、年级、学校等                │
│  ├─ 责任销售: sales_user_id                                  │
│  ├─ 服务类型: service_types (JSON)                           │
│  ├─ 时间节点: 获取联系、见面、支付时间                        │
│  └─ 跟进备注: follow_up_notes                                │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 线索转客户
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        客户阶段                              │
├─────────────────────────────────────────────────────────────┤
│  客户表 (customers)                                          │
│  ├─ 关联线索: lead_id → 读取线索表的基本信息和责任销售        │
│  ├─ 责任班主任: teacher_user_id                              │
│  ├─ 奖项要求: competition_award_level                        │
│  ├─ 额外要求: additional_requirements                        │
│  ├─ 中高考年份: exam_year (根据年级自动计算)                 │
│  └─ 客户备注: customer_notes                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 设计优势

### 1. **职责分离**
- **线索表**：负责销售阶段的数据
- **客户表**：负责交付阶段的数据
- 各司其职，逻辑清晰

### 2. **避免冗余**
- 基本信息只存储在线索表
- 客户表通过 `lead_id` 关联读取
- 责任销售只存储在线索表

### 3. **灵活扩展**
- 服务类型使用JSON格式，支持多选
- 辅助方法封装复杂逻辑
- 计算字段按需生成

### 4. **数据一致性**
- 单一数据源，避免不一致
- 自动同步机制（如年级变化时更新exam_year）
- 锁定机制防止误操作

---

## ⚠️ 注意事项

### 1. **编辑客户时的双表更新**
编辑客户时会同时更新两个表：
- 基本信息 → 更新线索表
- 交付信息 → 更新客户表

### 2. **服务类型的读取**
- 线索表存储：`service_types` (JSON字符串)
- 客户表读取：通过 `customer.lead.get_service_types_list()` 或 `customer.get_service_types()`

### 3. **到期时间的计算**
- 不再存储在数据库中
- 通过 `customer.get_expire_date()` 实时计算
- 计算规则：`exam_year年5月31日`

### 4. **旧字段的处理**
- 旧字段仍存在于数据库中（SQLite不支持删除列）
- 但已从模型中移除，不会被使用
- 不影响系统功能

---

## 📚 使用示例

### 示例1：显示客户列表

```python
# 在模板中
{% for customer in customers %}
    <tr>
        <td>{{ customer.lead.student_name }}</td>
        <td>{{ customer.lead.sales_user.username }}</td>
        <td>{{ customer.teacher_user.username if customer.teacher_user else '待分配' }}</td>
        <td>{{ customer.competition_award_level or '无' }}</td>
        <td>{{ customer.exam_year }}年</td>
    </tr>
{% endfor %}
```

### 示例2：编辑客户

```python
# 在视图中
customer = Customer.query.get(customer_id)

# 读取数据
student_name = customer.lead.student_name
sales_user = customer.lead.sales_user
service_types = customer.get_service_types()
award_level = customer.competition_award_level

# 更新数据
customer.lead.student_name = new_name
customer.lead.sales_user_id = new_sales_id
customer.competition_award_level = new_award_level
db.session.commit()
```

### 示例3：筛选客户

```python
# 按奖项等级筛选
customers = Customer.query.filter_by(competition_award_level='国奖').all()

# 按责任销售筛选（需要join线索表）
customers = Customer.query.join(Lead).filter(Lead.sales_user_id == user_id).all()
```

---

**文档生成时间**: 2025-09-30
**系统版本**: EduConnect CRM v1.0.0

