# EduConnect CRM æ•°æ®åº“ç»“æ„è¯´æ˜

## ğŸ“Š ä¼˜åŒ–åçš„è¡¨ç»“æ„

### 1. çº¿ç´¢è¡¨ (leads)

#### è®¾è®¡åŸåˆ™
**çº¿ç´¢è¡¨å­˜å‚¨é”€å”®é˜¶æ®µçš„ä¿¡æ¯**ï¼ŒåŒ…æ‹¬å®¢æˆ·è·å–ã€è·Ÿè¿›ã€æˆäº¤è¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚

#### å­—æ®µåˆ—è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…å¡« | å¤‡æ³¨ |
|--------|------|------|---------|------|
| **åŸºæœ¬ä¿¡æ¯** |
| `id` | Integer | ä¸»é”® | âœ… | è‡ªå¢ID |
| `student_name` | String(50) | å­¦å‘˜å§“å | âŒ | å¯é€‰ï¼ŒåˆæœŸå¯èƒ½ä¸çŸ¥é“ |
| `parent_wechat_display_name` | String(50) | å®¶é•¿å¾®ä¿¡å | âœ… | å¿…å¡« |
| `parent_wechat_name` | String(50) | å®¶é•¿å¾®ä¿¡å· | âœ… | å¿…å¡«ï¼Œå”¯ä¸€ |
| `contact_info` | String(100) | è”ç³»æ–¹å¼ | âŒ | æ‰‹æœºå·ç­‰ |
| `contact_locked` | Boolean | è”ç³»æ–¹å¼æ˜¯å¦é”å®š | - | é»˜è®¤True |
| `grade` | String(10) | å¹´çº§ | âŒ | 1-9å¹´çº§ã€é«˜ä¸€ã€é«˜äºŒã€é«˜ä¸‰ |
| `district` | String(20) | è¡Œæ”¿åŒº | âŒ | å¦‚ï¼šæµ¦ä¸œã€æµ¦è¥¿ |
| `school` | String(100) | å­¦æ ¡ | âŒ | å­¦æ ¡åç§° |
| **ä¸šåŠ¡ä¿¡æ¯** |
| `lead_source` | String(50) | çº¿ç´¢æ¥æº | âŒ | æ¸ é“æ¥æº |
| `sales_user_id` | Integer | è´£ä»»é”€å”®ID | âœ… | å¤–é”®å…³è”usersè¡¨ |
| `stage` | String(50) | çº¿ç´¢é˜¶æ®µ | âœ… | è‡ªåŠ¨è®¡ç®— |
| `contract_amount` | Numeric(10,2) | åˆåŒé‡‘é¢ | âŒ | é¢„è®¡æˆ–å®é™…é‡‘é¢ |
| **æ—¶é—´èŠ‚ç‚¹** |
| `contact_obtained_at` | DateTime | è·å–è”ç³»æ–¹å¼æ—¶é—´ | âŒ | å¡«å†™åé”å®š |
| `meeting_at` | DateTime | çº¿ä¸‹è§é¢æ—¶é—´ | âŒ | å¡«å†™åé”å®š |
| `meeting_location` | String(20) | è§é¢åœ°ç‚¹ | âŒ | æµ¦ä¸œ/æµ¦è¥¿ |
| `first_payment_at` | DateTime | é¦–ç¬”æ”¯ä»˜æ—¶é—´ | âŒ | è‡ªåŠ¨ä»paymentè¡¨åŒæ­¥ |
| `second_payment_at` | DateTime | æ¬¡ç¬”æ”¯ä»˜æ—¶é—´ | âŒ | è‡ªåŠ¨ä»paymentè¡¨åŒæ­¥ |
| **æœåŠ¡å†…å®¹** |
| `service_types` | Text | æœåŠ¡ç±»å‹JSON | âŒ | ["tutoring", "competition", "upgrade_guidance"] |
| **å…¶ä»–** |
| `follow_up_notes` | Text | è·Ÿè¿›å¤‡æ³¨ | âŒ | é”€å”®è·Ÿè¿›è®°å½• |
| `created_at` | DateTime | åˆ›å»ºæ—¶é—´ | - | è‡ªåŠ¨ç”Ÿæˆ |
| `updated_at` | DateTime | æ›´æ–°æ—¶é—´ | - | è‡ªåŠ¨æ›´æ–° |

#### è¾…åŠ©æ–¹æ³•

```python
# è·å–æœåŠ¡ç±»å‹åˆ—è¡¨
lead.get_service_types_list()  # è¿”å› ['tutoring', 'competition']

# è®¾ç½®æœåŠ¡ç±»å‹åˆ—è¡¨
lead.set_service_types_list(['tutoring', 'competition'])

# æ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªæœåŠ¡ç±»å‹
lead.has_service_type('tutoring')  # è¿”å› True/False

# è·å–æ˜¾ç¤ºåç§°
lead.get_display_name()  # è¿”å›å­¦å‘˜å§“åæˆ–å®¶é•¿å¾®ä¿¡å
```

---

### 2. å®¢æˆ·è¡¨ (customers)

#### è®¾è®¡åŸåˆ™
**å®¢æˆ·è¡¨å­˜å‚¨äº¤ä»˜é˜¶æ®µçš„ä¿¡æ¯**ï¼ŒåŒ…æ‹¬æˆäº¤åçš„æœåŠ¡è¦æ±‚ã€äº¤ä»˜çŠ¶æ€ç­‰ã€‚

#### å­—æ®µåˆ—è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…å¡« | å¤‡æ³¨ |
|--------|------|------|---------|------|
| **å…³è”ä¿¡æ¯** |
| `id` | Integer | ä¸»é”® | âœ… | è‡ªå¢ID |
| `lead_id` | Integer | å…³è”çº¿ç´¢ID | âœ… | å¤–é”®å…³è”leadsè¡¨ |
| `teacher_user_id` | Integer | è´£ä»»ç­ä¸»ä»»ID | âŒ | å¤–é”®å…³è”usersè¡¨ |
| **æœåŠ¡è¦æ±‚** |
| `payment_amount` | Numeric(10,2) | æ”¯ä»˜é‡‘é¢ | âœ… | å®é™…æ”¯ä»˜é‡‘é¢ |
| `competition_award_level` | String(20) | ç«èµ›å¥–é¡¹ç­‰çº§ | âŒ | å¸‚å¥–/å›½å¥–/æ—  |
| `additional_requirements` | Text | é¢å¤–è¦æ±‚ | âŒ | ç‰¹æ®Šè¦æ±‚è¯´æ˜ |
| `exam_year` | Integer | ä¸­é«˜è€ƒå¹´ä»½ | âŒ | æ ¹æ®å¹´çº§è‡ªåŠ¨è®¡ç®— |
| **å…¶ä»–** |
| `customer_notes` | Text | å®¢æˆ·å¤‡æ³¨ | âŒ | äº¤ä»˜é˜¶æ®µå¤‡æ³¨ |
| `converted_at` | DateTime | çº¿ç´¢è½¬å®¢æˆ·æ—¶é—´ | âŒ | è®°å½•è½¬æ¢æ—¶é—´ |
| `is_priority` | Boolean | æ˜¯å¦é‡ç‚¹å…³æ³¨ | - | é»˜è®¤False |
| `created_at` | DateTime | åˆ›å»ºæ—¶é—´ | - | è‡ªåŠ¨ç”Ÿæˆ |
| `updated_at` | DateTime | æ›´æ–°æ—¶é—´ | - | è‡ªåŠ¨æ›´æ–° |

#### è¾…åŠ©æ–¹æ³•

```python
# è·å–è´£ä»»é”€å”®ï¼ˆä»çº¿ç´¢è¡¨è¯»å–ï¼‰
customer.get_sales_user()  # è¿”å› User å¯¹è±¡

# è·å–æœåŠ¡ç±»å‹åˆ—è¡¨ï¼ˆä»çº¿ç´¢è¡¨è¯»å–ï¼‰
customer.get_service_types()  # è¿”å› ['tutoring', 'competition']

# è·å–æœåŠ¡åˆ°æœŸæ—¶é—´ï¼ˆæ ¹æ®exam_yearè®¡ç®—ï¼‰
customer.get_expire_date()  # è¿”å› date(exam_year, 5, 31)
```

---

## ğŸ”„ æ•°æ®è¯»å–é€»è¾‘

### ä»çº¿ç´¢è¡¨è¯»å–çš„æ•°æ®

åœ¨å®¢æˆ·ç®¡ç†ä¸­ï¼Œä»¥ä¸‹æ•°æ®**ä»çº¿ç´¢è¡¨è¯»å–**ï¼š

```python
# åŸºæœ¬ä¿¡æ¯
customer.lead.student_name              # å­¦å‘˜å§“å
customer.lead.parent_wechat_display_name # å®¶é•¿å¾®ä¿¡å
customer.lead.parent_wechat_name        # å®¶é•¿å¾®ä¿¡å·
customer.lead.contact_info              # è”ç³»æ–¹å¼
customer.lead.grade                     # å¹´çº§
customer.lead.district                  # è¡Œæ”¿åŒº
customer.lead.school                    # å­¦æ ¡

# è´£ä»»é”€å”®
customer.lead.sales_user                # è´£ä»»é”€å”®å¯¹è±¡
customer.lead.sales_user.username       # è´£ä»»é”€å”®å§“å
# æˆ–ä½¿ç”¨è¾…åŠ©æ–¹æ³•
customer.get_sales_user()               # è¿”å›è´£ä»»é”€å”®å¯¹è±¡

# æœåŠ¡ç±»å‹
customer.lead.service_types             # JSONå­—ç¬¦ä¸²
customer.lead.get_service_types_list()  # åˆ—è¡¨æ ¼å¼
# æˆ–ä½¿ç”¨è¾…åŠ©æ–¹æ³•
customer.get_service_types()            # è¿”å›åˆ—è¡¨
```

### ä»å®¢æˆ·è¡¨è¯»å–çš„æ•°æ®

åœ¨å®¢æˆ·ç®¡ç†ä¸­ï¼Œä»¥ä¸‹æ•°æ®**ä»å®¢æˆ·è¡¨è¯»å–**ï¼š

```python
# äº¤ä»˜ä¿¡æ¯
customer.teacher_user                   # è´£ä»»ç­ä¸»ä»»å¯¹è±¡
customer.teacher_user.username          # è´£ä»»ç­ä¸»ä»»å§“å

# æœåŠ¡è¦æ±‚
customer.competition_award_level        # ç«èµ›å¥–é¡¹ç­‰çº§
customer.additional_requirements        # é¢å¤–è¦æ±‚
customer.exam_year                      # ä¸­é«˜è€ƒå¹´ä»½

# å…¶ä»–
customer.payment_amount                 # æ”¯ä»˜é‡‘é¢
customer.customer_notes                 # å®¢æˆ·å¤‡æ³¨
customer.is_priority                    # æ˜¯å¦é‡ç‚¹å…³æ³¨
```

### è®¡ç®—å¾—å‡ºçš„æ•°æ®

```python
# æœåŠ¡åˆ°æœŸæ—¶é—´ï¼ˆæ ¹æ®exam_yearè®¡ç®—ï¼‰
customer.get_expire_date()              # è¿”å› date(exam_year, 5, 31)
```

---

## âœï¸ ç¼–è¾‘æ›´æ–°é€»è¾‘

### 1. ç¼–è¾‘çº¿ç´¢ (`routes/leads.py`)

#### å¯ç¼–è¾‘å­—æ®µ

```python
# åŸºæœ¬ä¿¡æ¯ï¼ˆå¯ç¼–è¾‘ï¼‰
- student_name          # å­¦å‘˜å§“å
- contact_info          # è”ç³»æ–¹å¼ï¼ˆé”å®šåä¸å¯ç¼–è¾‘ï¼‰
- grade                 # å¹´çº§
- district              # è¡Œæ”¿åŒº
- school                # å­¦æ ¡

# ä¸šåŠ¡ä¿¡æ¯ï¼ˆå¯ç¼–è¾‘ï¼‰
- sales_user_id         # è´£ä»»é”€å”®
- contract_amount       # åˆåŒé‡‘é¢
- service_types         # æœåŠ¡ç±»å‹ï¼ˆå¤šé€‰ï¼‰

# æ—¶é—´èŠ‚ç‚¹ï¼ˆå¡«å†™åé”å®šï¼‰
- contact_obtained_at   # è·å–è”ç³»æ–¹å¼æ—¶é—´
- meeting_at            # çº¿ä¸‹è§é¢æ—¶é—´
- meeting_location      # è§é¢åœ°ç‚¹

# å¤‡æ³¨ï¼ˆå¯ç¼–è¾‘ï¼‰
- follow_up_notes       # è·Ÿè¿›å¤‡æ³¨
```

#### ç‰¹æ®Šé€»è¾‘

```python
# 1. å¹´çº§å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°å®¢æˆ·çš„exam_year
if grade_changed and customer_exists:
    customer.exam_year = calculate_exam_year(new_grade)
    # æ·»åŠ æ²Ÿé€šè®°å½•
    add_communication_record(f"å¹´çº§æ›´æ–°ä¸º {new_grade}ï¼Œä¸­é«˜è€ƒå¹´ä»½è‡ªåŠ¨æ›´æ–°ä¸º {exam_year}å¹´")

# 2. è”ç³»æ–¹å¼é”å®šæœºåˆ¶
if contact_obtained_at is not None:
    contact_locked = True  # é”å®šåä¸å¯ç¼–è¾‘contact_info

# 3. æ”¯ä»˜æ—¶é—´è‡ªåŠ¨åŒæ­¥
# first_payment_at å’Œ second_payment_at ä» payment è¡¨è‡ªåŠ¨åŒæ­¥
update_lead_payment_times(lead_id)
```

---

### 2. ç¼–è¾‘å®¢æˆ· (`routes/customers.py`)

#### å¯ç¼–è¾‘å­—æ®µ

```python
# åŸºæœ¬ä¿¡æ¯ï¼ˆåŒæ­¥åˆ°çº¿ç´¢è¡¨ï¼‰
- student_name          # å­¦å‘˜å§“å â†’ lead.student_name
- contact_info          # è”ç³»æ–¹å¼ â†’ lead.contact_info
- sales_user_id         # è´£ä»»é”€å”® â†’ lead.sales_user_id

# äº¤ä»˜ä¿¡æ¯ï¼ˆå­˜å‚¨åœ¨å®¢æˆ·è¡¨ï¼‰
- teacher_user_id       # è´£ä»»ç­ä¸»ä»»
- competition_award_level    # ç«èµ›å¥–é¡¹ç­‰çº§
- additional_requirements    # é¢å¤–è¦æ±‚
- exam_year             # ä¸­é«˜è€ƒå¹´ä»½

# å¤‡æ³¨ï¼ˆå­˜å‚¨åœ¨å®¢æˆ·è¡¨ï¼‰
- customer_notes        # å®¢æˆ·å¤‡æ³¨
```

#### æ›´æ–°é€»è¾‘

```python
def edit_customer(customer_id):
    # 1. è·å–è¡¨å•æ•°æ®
    student_name = request.form.get('student_name')
    contact_info = request.form.get('contact_info')
    sales_user_id = request.form.get('sales_user_id')
    teacher_user_id = request.form.get('teacher_user_id')
    competition_award_level = request.form.get('competition_award_level')
    additional_requirements = request.form.get('additional_requirements')
    exam_year = request.form.get('exam_year')
    notes = request.form.get('notes')
    
    # 2. æ›´æ–°çº¿ç´¢è¡¨ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼‰
    customer.lead.student_name = student_name
    customer.lead.contact_info = contact_info
    customer.lead.sales_user_id = sales_user_id
    customer.lead.updated_at = datetime.utcnow()
    
    # 3. æ›´æ–°å®¢æˆ·è¡¨ï¼ˆäº¤ä»˜ä¿¡æ¯ï¼‰
    customer.teacher_user_id = teacher_user_id
    customer.competition_award_level = competition_award_level
    customer.additional_requirements = additional_requirements
    customer.exam_year = exam_year
    customer.customer_notes = notes
    customer.updated_at = datetime.utcnow()
    
    # 4. å¦‚æœå¤‡æ³¨æœ‰å˜åŒ–ï¼Œæ·»åŠ æ²Ÿé€šè®°å½•
    if notes and notes != old_notes:
        add_communication_record(f"å®¢æˆ·ä¿¡æ¯æ›´æ–°å¤‡æ³¨ï¼š{notes}")
    
    # 5. æäº¤æ›´æ”¹
    db.session.commit()
```

---

### 3. çº¿ç´¢è½¬å®¢æˆ· (`routes/leads.py`)

#### è½¬æ¢é€»è¾‘

```python
def convert_to_customer(lead_id):
    # 1. æ ¹æ®å¹´çº§è‡ªåŠ¨è®¡ç®—ä¸­é«˜è€ƒå¹´ä»½
    exam_year = calculate_exam_year(lead.grade)
    
    # 2. åˆ›å»ºå®¢æˆ·è®°å½•
    customer = Customer(
        lead_id=lead.id,
        teacher_user_id=teacher_id,          # å¯é€‰çš„ç­ä¸»ä»»
        payment_amount=0,                    # åˆå§‹ä¸º0ï¼Œåç»­å¡«å†™
        competition_award_level=None,        # åç»­åœ¨å®¢æˆ·ç®¡ç†ä¸­è®¾ç½®
        additional_requirements=None,        # åç»­åœ¨å®¢æˆ·ç®¡ç†ä¸­è®¾ç½®
        exam_year=exam_year,                 # è‡ªåŠ¨è®¡ç®—
        converted_at=datetime.now()
    )
    
    # 3. å¦‚æœåˆ†é…äº†ç­ä¸»ä»»ï¼Œåˆ›å»ºäº¤ä»˜è®°å½•
    if teacher_id:
        tutoring_delivery = TutoringDelivery(customer_id=customer.id)
        db.session.add(tutoring_delivery)
    
    # 4. æäº¤
    db.session.commit()
```

---

## ğŸ“‹ æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        çº¿ç´¢é˜¶æ®µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çº¿ç´¢è¡¨ (leads)                                              â”‚
â”‚  â”œâ”€ åŸºæœ¬ä¿¡æ¯: å­¦å‘˜å§“åã€è”ç³»æ–¹å¼ã€å¹´çº§ã€å­¦æ ¡ç­‰                â”‚
â”‚  â”œâ”€ è´£ä»»é”€å”®: sales_user_id                                  â”‚
â”‚  â”œâ”€ æœåŠ¡ç±»å‹: service_types (JSON)                           â”‚
â”‚  â”œâ”€ æ—¶é—´èŠ‚ç‚¹: è·å–è”ç³»ã€è§é¢ã€æ”¯ä»˜æ—¶é—´                        â”‚
â”‚  â””â”€ è·Ÿè¿›å¤‡æ³¨: follow_up_notes                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ çº¿ç´¢è½¬å®¢æˆ·
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·é˜¶æ®µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¢æˆ·è¡¨ (customers)                                          â”‚
â”‚  â”œâ”€ å…³è”çº¿ç´¢: lead_id â†’ è¯»å–çº¿ç´¢è¡¨çš„åŸºæœ¬ä¿¡æ¯å’Œè´£ä»»é”€å”®        â”‚
â”‚  â”œâ”€ è´£ä»»ç­ä¸»ä»»: teacher_user_id                              â”‚
â”‚  â”œâ”€ å¥–é¡¹è¦æ±‚: competition_award_level                        â”‚
â”‚  â”œâ”€ é¢å¤–è¦æ±‚: additional_requirements                        â”‚
â”‚  â”œâ”€ ä¸­é«˜è€ƒå¹´ä»½: exam_year (æ ¹æ®å¹´çº§è‡ªåŠ¨è®¡ç®—)                 â”‚
â”‚  â””â”€ å®¢æˆ·å¤‡æ³¨: customer_notes                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. **èŒè´£åˆ†ç¦»**
- **çº¿ç´¢è¡¨**ï¼šè´Ÿè´£é”€å”®é˜¶æ®µçš„æ•°æ®
- **å®¢æˆ·è¡¨**ï¼šè´Ÿè´£äº¤ä»˜é˜¶æ®µçš„æ•°æ®
- å„å¸å…¶èŒï¼Œé€»è¾‘æ¸…æ™°

### 2. **é¿å…å†—ä½™**
- åŸºæœ¬ä¿¡æ¯åªå­˜å‚¨åœ¨çº¿ç´¢è¡¨
- å®¢æˆ·è¡¨é€šè¿‡ `lead_id` å…³è”è¯»å–
- è´£ä»»é”€å”®åªå­˜å‚¨åœ¨çº¿ç´¢è¡¨

### 3. **çµæ´»æ‰©å±•**
- æœåŠ¡ç±»å‹ä½¿ç”¨JSONæ ¼å¼ï¼Œæ”¯æŒå¤šé€‰
- è¾…åŠ©æ–¹æ³•å°è£…å¤æ‚é€»è¾‘
- è®¡ç®—å­—æ®µæŒ‰éœ€ç”Ÿæˆ

### 4. **æ•°æ®ä¸€è‡´æ€§**
- å•ä¸€æ•°æ®æºï¼Œé¿å…ä¸ä¸€è‡´
- è‡ªåŠ¨åŒæ­¥æœºåˆ¶ï¼ˆå¦‚å¹´çº§å˜åŒ–æ—¶æ›´æ–°exam_yearï¼‰
- é”å®šæœºåˆ¶é˜²æ­¢è¯¯æ“ä½œ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **ç¼–è¾‘å®¢æˆ·æ—¶çš„åŒè¡¨æ›´æ–°**
ç¼–è¾‘å®¢æˆ·æ—¶ä¼šåŒæ—¶æ›´æ–°ä¸¤ä¸ªè¡¨ï¼š
- åŸºæœ¬ä¿¡æ¯ â†’ æ›´æ–°çº¿ç´¢è¡¨
- äº¤ä»˜ä¿¡æ¯ â†’ æ›´æ–°å®¢æˆ·è¡¨

### 2. **æœåŠ¡ç±»å‹çš„è¯»å–**
- çº¿ç´¢è¡¨å­˜å‚¨ï¼š`service_types` (JSONå­—ç¬¦ä¸²)
- å®¢æˆ·è¡¨è¯»å–ï¼šé€šè¿‡ `customer.lead.get_service_types_list()` æˆ– `customer.get_service_types()`

### 3. **åˆ°æœŸæ—¶é—´çš„è®¡ç®—**
- ä¸å†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- é€šè¿‡ `customer.get_expire_date()` å®æ—¶è®¡ç®—
- è®¡ç®—è§„åˆ™ï¼š`exam_yearå¹´5æœˆ31æ—¥`

### 4. **æ—§å­—æ®µçš„å¤„ç†**
- æ—§å­—æ®µä»å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼ˆSQLiteä¸æ”¯æŒåˆ é™¤åˆ—ï¼‰
- ä½†å·²ä»æ¨¡å‹ä¸­ç§»é™¤ï¼Œä¸ä¼šè¢«ä½¿ç”¨
- ä¸å½±å“ç³»ç»ŸåŠŸèƒ½

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨

```python
# åœ¨æ¨¡æ¿ä¸­
{% for customer in customers %}
    <tr>
        <td>{{ customer.lead.student_name }}</td>
        <td>{{ customer.lead.sales_user.username }}</td>
        <td>{{ customer.teacher_user.username if customer.teacher_user else 'å¾…åˆ†é…' }}</td>
        <td>{{ customer.competition_award_level or 'æ— ' }}</td>
        <td>{{ customer.exam_year }}å¹´</td>
    </tr>
{% endfor %}
```

### ç¤ºä¾‹2ï¼šç¼–è¾‘å®¢æˆ·

```python
# åœ¨è§†å›¾ä¸­
customer = Customer.query.get(customer_id)

# è¯»å–æ•°æ®
student_name = customer.lead.student_name
sales_user = customer.lead.sales_user
service_types = customer.get_service_types()
award_level = customer.competition_award_level

# æ›´æ–°æ•°æ®
customer.lead.student_name = new_name
customer.lead.sales_user_id = new_sales_id
customer.competition_award_level = new_award_level
db.session.commit()
```

### ç¤ºä¾‹3ï¼šç­›é€‰å®¢æˆ·

```python
# æŒ‰å¥–é¡¹ç­‰çº§ç­›é€‰
customers = Customer.query.filter_by(competition_award_level='å›½å¥–').all()

# æŒ‰è´£ä»»é”€å”®ç­›é€‰ï¼ˆéœ€è¦joinçº¿ç´¢è¡¨ï¼‰
customers = Customer.query.join(Lead).filter(Lead.sales_user_id == user_id).all()
```

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-09-30
**ç³»ç»Ÿç‰ˆæœ¬**: EduConnect CRM v1.0.0

