# å¤‡ä»½æ¢å¤æŒ‡å—

## ğŸ¯ å¤‡ä»½æ–¹æ¡ˆè¯´æ˜

### ä¸¤ä¸ªåˆ†æ”¯çš„ç”¨é€”

1. **masteråˆ†æ”¯** - ä»£ç åˆ†æ”¯
   - åªåŒ…å«æºä»£ç 
   - ä¸åŒ…å«æ•°æ®åº“æ–‡ä»¶
   - ç”¨äºä»£ç ç‰ˆæœ¬ç®¡ç†

2. **bakåˆ†æ”¯** - å¤‡ä»½åˆ†æ”¯
   - åŒ…å«å®Œæ•´é¡¹ç›®
   - åŒ…å«æ•°æ®åº“æ–‡ä»¶
   - åŒ…å«æ‰€æœ‰é…ç½®
   - ç”¨äºå®Œæ•´å¤‡ä»½å’Œæ¢å¤

---

## ğŸ“¦ å®Œæ•´å¤‡ä»½åˆ°bakåˆ†æ”¯

### æ–¹æ³•1: ä½¿ç”¨è‡ªåŠ¨å¤‡ä»½è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd ~/crm
bash backup-to-gitee.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… æ£€æŸ¥ç¯å¢ƒ
2. âœ… ä¿å­˜å½“å‰çŠ¶æ€
3. âœ… åˆ›å»º/åˆ‡æ¢åˆ°bakåˆ†æ”¯
4. âœ… æ·»åŠ æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ•°æ®åº“ï¼‰
5. âœ… æäº¤å¤‡ä»½
6. âœ… æ¨é€åˆ°Gitee
7. âœ… æ¢å¤åˆ°åŸåˆ†æ”¯

**è€—æ—¶**ï¼šçº¦30ç§’-1åˆ†é’Ÿ

---

### æ–¹æ³•2: æ‰‹åŠ¨å¤‡ä»½

```bash
# 1. ä¿å­˜å½“å‰å·¥ä½œ
git stash

# 2. åˆ›å»º/åˆ‡æ¢åˆ°bakåˆ†æ”¯
git checkout -b bak  # é¦–æ¬¡åˆ›å»º
# æˆ–
git checkout bak     # å·²å­˜åœ¨åˆ™åˆ‡æ¢

# 3. åˆ›å»ºå¤‡ä»½ä¸“ç”¨çš„.gitignore
cat > .gitignore <<EOF
# åªæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
__pycache__/
*.py[cod]
venv/
.vscode/
.idea/
.DS_Store
EOF

# 4. æ·»åŠ æ‰€æœ‰æ–‡ä»¶
git add -A

# 5. æäº¤å¤‡ä»½
git commit -m "backup: å®Œæ•´å¤‡ä»½ - $(date '+%Y-%m-%d %H:%M:%S')"

# 6. å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹bakåˆ†æ”¯
git push -f origin bak

# 7. åˆ‡æ¢å›masteråˆ†æ”¯
git checkout master

# 8. æ¢å¤å·¥ä½œåŒº
git stash pop
```

---

## ğŸ“¥ ä»bakåˆ†æ”¯æ¢å¤

### æ–¹æ³•1: ä½¿ç”¨æ¢å¤è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd ~/crm
bash restore-from-bak.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… å¤‡ä»½å½“å‰æ•°æ®åº“
2. âœ… è·å–bakåˆ†æ”¯
3. âœ… æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
4. âœ… æ¢å¤æ•°æ®åº“æ–‡ä»¶
5. âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§

**é€‰é¡¹**ï¼š
- åªæ¢å¤æ•°æ®åº“ï¼ˆæ¨èï¼‰
- æ¢å¤æ‰€æœ‰æ–‡ä»¶

---

### æ–¹æ³•2: æ‰‹åŠ¨æ¢å¤

#### æ¢å¤æ•°æ®åº“æ–‡ä»¶

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®åº“
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d).db

# 2. ä»bakåˆ†æ”¯æ¢å¤æ•°æ®åº“
git fetch origin bak
git checkout origin/bak -- instance/edu_crm.db

# 3. é‡å¯æœåŠ¡
sudo systemctl restart crm
```

#### æ¢å¤æ•´ä¸ªé¡¹ç›®

```bash
# 1. å…‹éš†bakåˆ†æ”¯åˆ°æ–°ç›®å½•
git clone -b bak https://gitee.com/blebleman/crm.git crm-restore

# 2. å¤åˆ¶éœ€è¦çš„æ–‡ä»¶
cp crm-restore/instance/edu_crm.db ~/crm/instance/

# 3. é‡å¯æœåŠ¡
cd ~/crm
sudo systemctl restart crm
```

---

## ğŸ”„ å®šæœŸè‡ªåŠ¨å¤‡ä»½

### è®¾ç½®å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
0 2 * * * cd /root/crm && bash backup-to-gitee.sh >> /var/log/crm/backup.log 2>&1

# æˆ–æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * 0 cd /root/crm && bash backup-to-gitee.sh >> /var/log/crm/backup.log 2>&1
```

### æŸ¥çœ‹å¤‡ä»½æ—¥å¿—

```bash
tail -f /var/log/crm/backup.log
```

---

## ğŸ“Š å¤‡ä»½å†…å®¹å¯¹æ¯”

### masteråˆ†æ”¯ï¼ˆä»£ç åˆ†æ”¯ï¼‰

```
crm/
â”œâ”€â”€ routes/          âœ… åŒ…å«
â”œâ”€â”€ templates/       âœ… åŒ…å«
â”œâ”€â”€ static/          âœ… åŒ…å«
â”œâ”€â”€ models.py        âœ… åŒ…å«
â”œâ”€â”€ run.py           âœ… åŒ…å«
â”œâ”€â”€ config.py        âœ… åŒ…å«
â”œâ”€â”€ requirements.txt âœ… åŒ…å«
â”œâ”€â”€ instance/
â”‚   â””â”€â”€ edu_crm.db   âŒ ä¸åŒ…å«ï¼ˆè¢«.gitignoreæ’é™¤ï¼‰
â””â”€â”€ logs/            âŒ ä¸åŒ…å«ï¼ˆè¢«.gitignoreæ’é™¤ï¼‰
```

### bakåˆ†æ”¯ï¼ˆå¤‡ä»½åˆ†æ”¯ï¼‰

```
crm/
â”œâ”€â”€ routes/          âœ… åŒ…å«
â”œâ”€â”€ templates/       âœ… åŒ…å«
â”œâ”€â”€ static/          âœ… åŒ…å«
â”œâ”€â”€ models.py        âœ… åŒ…å«
â”œâ”€â”€ run.py           âœ… åŒ…å«
â”œâ”€â”€ config.py        âœ… åŒ…å«
â”œâ”€â”€ requirements.txt âœ… åŒ…å«
â”œâ”€â”€ instance/
â”‚   â””â”€â”€ edu_crm.db   âœ… åŒ…å«ï¼ˆå®Œæ•´æ•°æ®åº“ï¼‰
â””â”€â”€ logs/            âœ… åŒ…å«ï¼ˆå¦‚æœæœ‰ï¼‰
```

---

## ğŸ” æŸ¥çœ‹å¤‡ä»½

### åœ¨Giteeç½‘é¡µæŸ¥çœ‹

1. è®¿é—®ï¼šhttps://gitee.com/blebleman/crm
2. ç‚¹å‡»åˆ†æ”¯ä¸‹æ‹‰èœå•
3. é€‰æ‹© `bak` åˆ†æ”¯
4. å¯ä»¥çœ‹åˆ°å®Œæ•´çš„é¡¹ç›®æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ•°æ®åº“ï¼‰

### åœ¨æœ¬åœ°æŸ¥çœ‹

```bash
# åˆ‡æ¢åˆ°bakåˆ†æ”¯
git checkout bak

# æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
ls -lh instance/

# æŸ¥çœ‹æ•°æ®åº“å¤§å°
du -h instance/edu_crm.db

# æŸ¥çœ‹æœ€æ–°å¤‡ä»½ä¿¡æ¯
git log -1

# åˆ‡æ¢å›masteråˆ†æ”¯
git checkout master
```

---

## ğŸ“‹ å¤‡ä»½éªŒè¯

### éªŒè¯å¤‡ä»½å®Œæ•´æ€§

```bash
# 1. åˆ‡æ¢åˆ°bakåˆ†æ”¯
git checkout bak

# 2. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -lh instance/edu_crm.db

# 3. éªŒè¯æ•°æ®åº“å®Œæ•´æ€§
sqlite3 instance/edu_crm.db "PRAGMA integrity_check;"

# 4. æŸ¥çœ‹æ•°æ®åº“è¡¨
sqlite3 instance/edu_crm.db ".tables"

# 5. æŸ¥çœ‹ç”¨æˆ·æ•°é‡
sqlite3 instance/edu_crm.db "SELECT COUNT(*) FROM users;"

# 6. åˆ‡æ¢å›master
git checkout master
```

---

## ğŸš¨ ç´§æ€¥æ¢å¤åœºæ™¯

### åœºæ™¯1: æ•°æ®åº“æŸå

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop crm

# 2. ä»bakåˆ†æ”¯æ¢å¤æ•°æ®åº“
bash restore-from-bak.sh

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start crm

# 4. éªŒè¯
curl -I http://localhost/health
```

### åœºæ™¯2: æœåŠ¡å™¨é‡è£…

```bash
# 1. å…‹éš†bakåˆ†æ”¯
git clone -b bak https://gitee.com/blebleman/crm.git ~/crm

# 2. è¿›å…¥ç›®å½•
cd ~/crm

# 3. éƒ¨ç½²æœåŠ¡
sudo bash ubuntu-deploy.sh

# 4. éªŒè¯
sudo systemctl status crm
```

### åœºæ™¯3: è¯¯åˆ é™¤æ–‡ä»¶

```bash
# 1. ä»bakåˆ†æ”¯æ¢å¤ç‰¹å®šæ–‡ä»¶
git checkout origin/bak -- path/to/file

# 2. æˆ–æ¢å¤æ•´ä¸ªç›®å½•
git checkout origin/bak -- instance/

# 3. é‡å¯æœåŠ¡
sudo systemctl restart crm
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¤‡ä»½é¢‘ç‡

**æ¨è**ï¼š
- å¼€å‘ç¯å¢ƒï¼šæ¯å¤©å¤‡ä»½
- æµ‹è¯•ç¯å¢ƒï¼šæ¯å‘¨å¤‡ä»½
- ç”Ÿäº§ç¯å¢ƒï¼šæ¯å¤©å¤‡ä»½ + é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¤‡ä»½

### 2. å¤‡ä»½å‰æ£€æŸ¥

```bash
# æ£€æŸ¥æ•°æ®åº“å¤§å°
du -h instance/edu_crm.db

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sqlite3 instance/edu_crm.db "PRAGMA integrity_check;"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

### 3. å¤‡ä»½åéªŒè¯

```bash
# éªŒè¯æ¨é€æˆåŠŸ
git ls-remote origin bak

# æŸ¥çœ‹è¿œç¨‹å¤‡ä»½
git log origin/bak -1

# éªŒè¯æ–‡ä»¶å­˜åœ¨
git show origin/bak:instance/edu_crm.db > /dev/null && echo "æ•°æ®åº“æ–‡ä»¶å­˜åœ¨"
```

### 4. ä¿ç•™å¤šä¸ªå¤‡ä»½

```bash
# ä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„åˆ†æ”¯å
git checkout -b bak-20250102
git push origin bak-20250102

# æˆ–ä½¿ç”¨æ ‡ç­¾
git tag backup-20250102
git push origin backup-20250102
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ç§æœ‰ä»“åº“

ç¡®ä¿Giteeä»“åº“è®¾ç½®ä¸ºç§æœ‰ï¼š
- ç™»å½•Gitee
- è¿›å…¥ä»“åº“è®¾ç½®
- ç¡®è®¤"ç§æœ‰"çŠ¶æ€

### 2. è®¿é—®æ§åˆ¶

- ä¸è¦åˆ†äº«ä»“åº“è®¿é—®æƒé™
- å®šæœŸæ›´æ”¹Gitå¯†ç 
- ä½¿ç”¨SSHå¯†é’¥è®¤è¯

### 3. æ•æ„Ÿæ•°æ®

å¦‚æœæ•°æ®åº“åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼š
- è€ƒè™‘åŠ å¯†å¤‡ä»½
- ä½¿ç”¨ç§æœ‰GitæœåŠ¡å™¨
- å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: bakåˆ†æ”¯ä¼šå½±å“masteråˆ†æ”¯å—ï¼Ÿ

**A**: ä¸ä¼šã€‚ä¸¤ä¸ªåˆ†æ”¯å®Œå…¨ç‹¬ç«‹ã€‚

### Q2: å¤‡ä»½ä¼šå ç”¨å¾ˆå¤šç©ºé—´å—ï¼Ÿ

**A**: 
- æ•°æ®åº“æ–‡ä»¶é€šå¸¸å‡ MBåˆ°å‡ ç™¾MB
- Gitä¼šå‹ç¼©å­˜å‚¨
- Giteeå…è´¹ç‰ˆæœ‰5GBç©ºé—´

### Q3: å¦‚ä½•åˆ é™¤æ—§å¤‡ä»½ï¼Ÿ

**A**:
```bash
# åˆ é™¤æœ¬åœ°bakåˆ†æ”¯
git branch -D bak

# åˆ é™¤è¿œç¨‹bakåˆ†æ”¯
git push origin --delete bak
```

### Q4: å¤‡ä»½å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**:
```bash
# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
git status

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping gitee.com

# æ£€æŸ¥è¿œç¨‹ä»“åº“
git remote -v

# å¼ºåˆ¶æ¨é€
git push -f origin bak
```

### Q5: å¦‚ä½•æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„å¤‡ä»½ï¼Ÿ

**A**:
```bash
# æŸ¥çœ‹bakåˆ†æ”¯çš„æäº¤å†å²
git log origin/bak --oneline

# æ¢å¤åˆ°ç‰¹å®šæäº¤
git checkout <commit-hash> -- instance/edu_crm.db
```

---

## ğŸ“š ç›¸å…³è„šæœ¬

1. **backup-to-gitee.sh** - è‡ªåŠ¨å¤‡ä»½è„šæœ¬
2. **restore-from-bak.sh** - è‡ªåŠ¨æ¢å¤è„šæœ¬
3. **quick-update.sh** - ä»£ç å¿«é€Ÿæ›´æ–°
4. **safe-update.sh** - å®‰å…¨æ›´æ–°ï¼ˆä¿æŠ¤æ•°æ®åº“ï¼‰

---

## ğŸ¯ æ€»ç»“

### å¤‡ä»½æµç¨‹

```
æœåŠ¡å™¨é¡¹ç›® â†’ backup-to-gitee.sh â†’ Gitee bakåˆ†æ”¯
```

### æ¢å¤æµç¨‹

```
Gitee bakåˆ†æ”¯ â†’ restore-from-bak.sh â†’ æœåŠ¡å™¨é¡¹ç›®
```

### å…³é”®å‘½ä»¤

```bash
# å¤‡ä»½
bash backup-to-gitee.sh

# æ¢å¤
bash restore-from-bak.sh

# æŸ¥çœ‹å¤‡ä»½
git checkout bak

# å®šæ—¶å¤‡ä»½
0 2 * * * cd /root/crm && bash backup-to-gitee.sh
```

---

**æœ€åæ›´æ–°**: 2025-01-02  
**ç‰ˆæœ¬**: 1.0

