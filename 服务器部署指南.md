# EduConnect CRM 服务器部署更新指南

## 📋 概述

本指南提供了在服务器上安全部署最新代码并迁移数据库的完整流程。

**当前服务器数据库**: `instance/edu_crm_1022.db`  
**目标**: 部署最新代码（包括数据下载功能）并保持数据完整性

---

## 🎯 部署方案（推荐）

### 方案特点
- ✅ **简单**: 一键执行，自动化所有步骤
- ✅ **安全**: 自动备份，失败可回滚
- ✅ **快速**: 5-10分钟完成部署
- ✅ **零停机**: 最小化服务中断时间

---

## 📦 准备工作

### 1. 确认服务器环境

```bash
# 登录服务器
ssh user@your-server

# 进入项目目录
cd /path/to/CRM1

# 确认当前数据库
ls -lh instance/edu_crm_1022.db
```

### 2. 确认 Git 仓库状态

```bash
# 查看当前分支
git branch

# 查看是否有未提交的更改
git status
```

---

## 🚀 部署步骤

### 方法一：使用自动化脚本（推荐）

#### 步骤 1: 下载部署脚本

```bash
# 拉取最新代码（包含部署脚本）
git fetch origin
git pull origin master
```

#### 步骤 2: 赋予执行权限

```bash
chmod +x deploy_update.sh
```

#### 步骤 3: 执行部署

```bash
bash deploy_update.sh
```

**脚本会自动完成以下操作：**
1. ✅ 备份数据库到 `backups/` 目录
2. ✅ 停止当前运行的服务
3. ✅ 拉取最新代码
4. ✅ 安装/更新依赖（pandas, openpyxl）
5. ✅ 执行数据库迁移（如需要）
6. ✅ 验证数据库完整性
7. ✅ 启动服务

#### 步骤 4: 验证部署

```bash
# 检查服务是否运行
ps aux | grep "python.*run.py"

# 查看日志
tail -f logs/app.log

# 测试访问（替换为实际地址）
curl http://localhost:5000/auth/login
```

---

### 方法二：手动部署（更灵活）

#### 步骤 1: 备份数据库

```bash
# 创建备份目录
mkdir -p backups

# 备份数据库
cp instance/edu_crm_1022.db backups/edu_crm_1022_backup_$(date +%Y%m%d_%H%M%S).db

# 确认备份成功
ls -lh backups/
```

#### 步骤 2: 停止服务

```bash
# 停止 Python 进程
pkill -f "python.*run.py"

# 确认已停止
ps aux | grep "python.*run.py"
```

#### 步骤 3: 更新代码

```bash
# 拉取最新代码
git fetch origin
git pull origin master

# 查看更新内容
git log -5 --oneline
```

#### 步骤 4: 安装依赖

```bash
# 激活虚拟环境
source venv/bin/activate

# 安装新依赖（使用国内镜像）
pip install pandas==2.1.4 openpyxl==3.1.2 -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn

# 或安装所有依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn
```

#### 步骤 5: 数据库迁移（可选）

```bash
# 使用 Python 迁移脚本
python migrate_database.py

# 或手动检查是否需要迁移
sqlite3 instance/edu_crm_1022.db "SELECT name FROM sqlite_master WHERE type='table' AND name='teachers'"
```

#### 步骤 6: 验证数据库

```bash
# 检查数据库完整性
sqlite3 instance/edu_crm_1022.db "PRAGMA integrity_check;"

# 查看表列表
sqlite3 instance/edu_crm_1022.db ".tables"

# 查看记录数
sqlite3 instance/edu_crm_1022.db "SELECT COUNT(*) FROM users; SELECT COUNT(*) FROM leads;"
```

#### 步骤 7: 启动服务

```bash
# 设置环境变量（生产环境）
export FLASK_ENV=production
export DATABASE_URL="sqlite:///$(pwd)/instance/edu_crm_1022.db"

# 创建日志目录
mkdir -p logs

# 后台启动服务
nohup python run.py > logs/app.log 2>&1 &

# 查看进程
ps aux | grep "python.*run.py"

# 查看日志
tail -f logs/app.log
```

---

## 🔍 验证部署成功

### 1. 检查服务状态

```bash
# 查看进程
ps aux | grep "python.*run.py"

# 查看端口占用
lsof -i :5000  # 或实际端口
```

### 2. 测试功能

```bash
# 测试登录页面
curl -I http://localhost:5000/auth/login

# 测试管理员数据下载（需要登录）
# 使用浏览器访问并登录管理员账号
```

### 3. 检查日志

```bash
# 查看最新日志
tail -50 logs/app.log

# 实时监控日志
tail -f logs/app.log

# 查看错误日志
grep -i error logs/app.log
```

---

## 🔄 回滚方案

如果部署出现问题，可以快速回滚：

### 方法 1: 恢复数据库备份

```bash
# 停止服务
pkill -f "python.*run.py"

# 查看备份列表
ls -lh backups/

# 恢复最新备份（替换时间戳）
cp backups/edu_crm_1022_backup_20241023_120000.db instance/edu_crm_1022.db

# 重启服务
nohup python run.py > logs/app.log 2>&1 &
```

### 方法 2: 回滚代码

```bash
# 查看提交历史
git log -5 --oneline

# 回滚到上一个版本
git reset --hard HEAD~1

# 或回滚到指定提交
git reset --hard <commit-hash>

# 重启服务
pkill -f "python.*run.py"
nohup python run.py > logs/app.log 2>&1 &
```

---

## 📊 数据库迁移说明

### 当前数据库状态

**edu_crm_1022.db** (服务器生产数据库):
- 用户数: 6
- 线索数: 66
- **缺少**: `teachers` 和 `teacher_images` 表

**edu_crm.db** (本地开发数据库):
- 用户数: 13
- 线索数: 24
- **包含**: `teachers` 和 `teacher_images` 表

### 迁移内容

本次部署会自动添加以下表（如果不存在）：

1. **teachers** 表 - 老师信息
2. **teacher_images** 表 - 老师图片

**注意**: 迁移只添加表结构，不会影响现有数据。

---

## ⚠️ 注意事项

### 1. 数据库文件名

- 服务器使用: `edu_crm_1022.db`
- 本地开发使用: `edu_crm.db`
- 部署脚本会自动使用正确的文件名

### 2. 环境变量

生产环境需要设置：

```bash
export FLASK_ENV=production
export DATABASE_URL="sqlite:///$(pwd)/instance/edu_crm_1022.db"
```

### 3. 权限问题

确保数据库文件有正确的权限：

```bash
chmod 644 instance/edu_crm_1022.db
chown www-data:www-data instance/edu_crm_1022.db  # 根据实际用户调整
```

### 4. 防火墙

确保应用端口已开放：

```bash
# 检查端口
netstat -tlnp | grep 5000

# 开放端口（如使用 ufw）
sudo ufw allow 5000
```

---

## 🛠️ 常用命令

### 服务管理

```bash
# 启动服务
nohup python run.py > logs/app.log 2>&1 &

# 停止服务
pkill -f "python.*run.py"

# 重启服务
pkill -f "python.*run.py" && sleep 2 && nohup python run.py > logs/app.log 2>&1 &

# 查看进程
ps aux | grep "python.*run.py"
```

### 日志查看

```bash
# 查看最新日志
tail -50 logs/app.log

# 实时监控
tail -f logs/app.log

# 查看错误
grep -i error logs/app.log

# 查看访问日志
grep "GET\|POST" logs/app.log
```

### 数据库操作

```bash
# 进入数据库
sqlite3 instance/edu_crm_1022.db

# 查看表
.tables

# 查看表结构
.schema users

# 查询数据
SELECT * FROM users LIMIT 5;

# 退出
.quit
```

---

## 📞 故障排查

### 问题 1: 服务启动失败

```bash
# 查看详细错误
tail -50 logs/app.log

# 检查端口占用
lsof -i :5000

# 检查 Python 环境
which python
python --version
```

### 问题 2: 数据库连接失败

```bash
# 检查数据库文件
ls -lh instance/edu_crm_1022.db

# 检查数据库完整性
sqlite3 instance/edu_crm_1022.db "PRAGMA integrity_check;"

# 检查环境变量
echo $DATABASE_URL
```

### 问题 3: 依赖安装失败

```bash
# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 升级 pip
pip install --upgrade pip

# 清除缓存
pip cache purge
```

---

## ✅ 部署检查清单

部署前：
- [ ] 已备份数据库
- [ ] 已确认 Git 仓库状态
- [ ] 已停止当前服务

部署中：
- [ ] 代码已更新
- [ ] 依赖已安装
- [ ] 数据库已迁移
- [ ] 数据库完整性已验证

部署后：
- [ ] 服务已启动
- [ ] 日志无错误
- [ ] 登录功能正常
- [ ] 数据下载功能可用（管理员）
- [ ] 备份文件已保存

---

## 📝 更新日志

### 2024-10-23
- 添加数据下载功能（仅管理员）
- 修复复选框点击冲突问题
- 添加 pandas 和 openpyxl 依赖
- 更新侧边栏菜单

---

## 🆘 紧急联系

如遇到无法解决的问题：

1. 立即停止服务
2. 恢复数据库备份
3. 回滚代码到上一版本
4. 查看日志并记录错误信息
5. 联系技术支持

---

**祝部署顺利！** 🎉

