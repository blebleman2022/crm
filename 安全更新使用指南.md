# 安全更新使用指南

## 🎯 目标

确保每次更新时：
- ✅ **只更新代码文件**
- ✅ **完全保护数据库文件**
- ✅ **自动备份数据库**
- ✅ **零数据丢失风险**

---

## 🚀 快速开始

### Linux/Mac服务器（推荐）

```bash
cd ~/crm
bash safe-update.sh
```

### Windows本地开发

```powershell
cd d:\git\crm
powershell -ExecutionPolicy Bypass -File safe-update.ps1
```

---

## 📋 脚本功能详解

### safe-update.sh / safe-update.ps1

这个脚本会自动完成以下步骤：

#### 1️⃣ 环境检查
- 验证是否在项目目录
- 检查Git是否安装
- 检查Docker是否安装

#### 2️⃣ 数据库备份
- 自动创建带时间戳的备份文件
- 格式：`instance/edu_crm_backup_YYYYMMDD_HHMMSS.db`
- 显示数据库大小

#### 3️⃣ 保护数据库
- 临时移动数据库到安全位置
- 确保Git操作不会影响数据库

#### 4️⃣ 清理Git状态
- 移除数据库文件的Git追踪
- 重置本地更改（不影响数据库）

#### 5️⃣ 拉取最新代码
- 从远程仓库拉取最新代码
- 显示更新内容
- 如果失败，自动恢复数据库

#### 6️⃣ 恢复数据库
- 将数据库移回原位置
- 验证数据库完整性

#### 7️⃣ 重新构建Docker
- 停止旧容器
- 重新构建镜像（使用最新代码）
- 启动新容器
- 验证容器状态

---

## 🔍 使用示例

### 服务器端完整更新流程

```bash
# 1. SSH登录服务器
ssh root@your-server

# 2. 进入项目目录
cd ~/crm

# 3. 首次使用需要先拉取脚本
git fetch origin
git checkout origin/master -- safe-update.sh
chmod +x safe-update.sh

# 4. 运行安全更新脚本
bash safe-update.sh

# 5. 按提示确认执行
# 输入 y 并回车

# 6. 等待更新完成（通常需要2-5分钟）

# 7. 验证更新
# 浏览器访问系统，检查功能是否正常
```

### 本地开发环境更新

```powershell
# 1. 打开PowerShell
# 2. 进入项目目录
cd d:\git\crm

# 3. 运行安全更新脚本
powershell -ExecutionPolicy Bypass -File safe-update.ps1

# 4. 按提示确认执行
# 输入 y 并回车

# 5. 等待更新完成

# 6. 浏览器访问 http://localhost:5000 验证
```

---

## ⚠️ 重要说明

### 数据库文件保护机制

1. **临时移动**
   - 更新前：数据库移到 `/tmp` 或 `%TEMP%`
   - 更新后：数据库移回原位置

2. **自动备份**
   - 每次更新都会创建备份
   - 备份文件保留在 `instance/` 目录
   - 建议定期清理30天前的备份

3. **Git忽略**
   - 数据库文件已在 `.gitignore` 中
   - Git操作不会影响数据库文件

### 为什么不能用 `docker compose restart`？

| 操作 | 更新代码 | 重新构建 | 适用场景 |
|------|---------|---------|---------|
| `docker compose restart` | ❌ | ❌ | 只重启服务 |
| `docker compose up -d` | ❌ | ❌ | 启动容器 |
| `docker compose build` | ✅ | ✅ | **代码更新** |
| `safe-update.sh` | ✅ | ✅ | **推荐使用** |

**关键点**：
- 代码更新后，必须重新构建Docker镜像
- `restart` 只是重启容器，容器内的代码仍是旧版本
- `safe-update.sh` 会自动完成所有必要步骤

---

## 🔧 故障排除

### 问题1: 脚本执行权限不足

**Linux/Mac**:
```bash
chmod +x safe-update.sh
bash safe-update.sh
```

**Windows**:
```powershell
powershell -ExecutionPolicy Bypass -File safe-update.ps1
```

### 问题2: Git冲突

如果遇到Git冲突，脚本会自动处理：
1. 移除数据库文件的Git追踪
2. 重置本地更改
3. 拉取最新代码
4. 恢复数据库文件

### 问题3: Docker构建失败

**检查日志**:
```bash
docker compose logs
```

**常见原因**:
- 网络问题：等待网络恢复后重试
- 端口占用：检查5000端口是否被占用
- 磁盘空间不足：清理Docker镜像

**解决方案**:
```bash
# 清理未使用的Docker资源
docker system prune -a

# 重新运行更新脚本
bash safe-update.sh
```

### 问题4: 容器启动失败

**检查容器状态**:
```bash
docker compose ps
docker compose logs
```

**手动启动**:
```bash
docker compose up -d
```

### 问题5: 数据库恢复失败

**从备份恢复**:
```bash
# 查看备份文件
ls -lh instance/edu_crm_backup_*.db

# 恢复最新备份
cp instance/edu_crm_backup_20250102_143000.db instance/edu_crm.db

# 重启容器
docker compose restart
```

---

## 📊 更新流程对比

### 传统方式（不推荐）

```bash
git pull origin master
docker compose restart  # ❌ 代码不会更新
```

**问题**：
- 容器内代码仍是旧版本
- 可能覆盖数据库文件
- 没有备份机制

### 手动方式（繁琐）

```bash
# 1. 备份数据库
cp instance/edu_crm.db instance/backup.db

# 2. 拉取代码
git pull origin master

# 3. 重新构建
docker compose down
docker compose build --no-cache
docker compose up -d

# 4. 检查数据库是否被覆盖
# 如果被覆盖，手动恢复
```

**问题**：
- 步骤繁琐，容易遗漏
- 需要手动检查和恢复
- 没有自动化保护

### 安全更新脚本（推荐）✅

```bash
bash safe-update.sh
```

**优势**：
- ✅ 一键完成所有步骤
- ✅ 自动备份数据库
- ✅ 自动保护数据库
- ✅ 失败自动回滚
- ✅ 完整的日志输出

---

## 📁 备份文件管理

### 查看备份文件

```bash
# Linux/Mac
ls -lh instance/edu_crm_backup_*.db

# Windows
dir instance\edu_crm_backup_*.db
```

### 清理旧备份

```bash
# 删除30天前的备份（Linux/Mac）
find instance/ -name "edu_crm_backup_*.db" -mtime +30 -delete

# 手动删除指定备份
rm instance/edu_crm_backup_20241201_*.db
```

### 从备份恢复

```bash
# 1. 停止容器
docker compose down

# 2. 恢复备份
cp instance/edu_crm_backup_20250102_143000.db instance/edu_crm.db

# 3. 启动容器
docker compose up -d
```

---

## 🎯 最佳实践

### 1. 定期更新

建议每周检查一次更新：
```bash
cd ~/crm
git fetch origin
git log HEAD..origin/master --oneline
```

如果有更新，运行：
```bash
bash safe-update.sh
```

### 2. 更新前检查

- ✅ 确认当前系统运行正常
- ✅ 选择低峰时段更新
- ✅ 通知用户系统将短暂维护

### 3. 更新后验证

- ✅ 检查容器状态：`docker compose ps`
- ✅ 查看日志：`docker compose logs --tail=50`
- ✅ 浏览器测试主要功能
- ✅ 检查数据库数据完整性

### 4. 保留备份

- ✅ 至少保留最近7天的备份
- ✅ 重要更新前手动创建额外备份
- ✅ 定期清理30天前的备份

---

## 📞 获取帮助

### 查看脚本执行日志

脚本会输出详细的执行日志，包括：
- 每个步骤的执行状态
- 数据库备份位置
- Git更新内容
- Docker构建过程
- 容器启动状态

### 常用检查命令

```bash
# 检查Git状态
git status
git log --oneline -5

# 检查Docker状态
docker compose ps
docker compose logs --tail=50

# 检查数据库
ls -lh instance/
sqlite3 instance/edu_crm.db "SELECT COUNT(*) FROM users;"

# 检查磁盘空间
df -h
```

---

## 📝 更新日志

### 2025-01-02
- ✅ 创建安全更新脚本（Linux/Mac版本）
- ✅ 创建安全更新脚本（Windows版本）
- ✅ 添加自动备份功能
- ✅ 添加数据库保护机制
- ✅ 添加失败自动回滚
- ✅ 添加详细日志输出

---

**最后更新**: 2025-01-02  
**版本**: 1.0  
**维护者**: CRM开发团队

