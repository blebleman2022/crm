# Ubuntuéƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€ã€é¦–æ¬¡éƒ¨ç½²ï¼ˆ3åˆ†é’Ÿï¼‰

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://gitee.com/blebleman/crm.git ~/crm
cd ~/crm

# 2. ä¸€é”®éƒ¨ç½²
sudo bash ubuntu-deploy.sh

# 3. éªŒè¯éƒ¨ç½²
sudo systemctl status crm
curl http://localhost/health
```

### äºŒã€æ—¥å¸¸æ›´æ–°ï¼ˆ10ç§’ï¼‰

```bash
cd ~/crm
bash quick-update.sh
```

### ä¸‰ã€å®Œæ•´å¤‡ä»½

```bash
cd ~/crm
bash backup-to-gitee.sh
```

---

## ğŸ“‹ éƒ¨ç½²è„šæœ¬è¯´æ˜

### æ ¸å¿ƒè„šæœ¬ï¼ˆ5ä¸ªï¼‰

| è„šæœ¬ | ç”¨é€” | ä½¿ç”¨é¢‘ç‡ |
|------|------|---------|
| **ubuntu-deploy.sh** | ä¸€é”®éƒ¨ç½²åˆ°Ubuntu | é¦–æ¬¡éƒ¨ç½² |
| **quick-update.sh** | å¿«é€Ÿæ›´æ–°ä»£ç  | æ¯æ¬¡æ›´æ–° |
| **health-check.sh** | å¥åº·æ£€æŸ¥ | å®šæ—¶ä»»åŠ¡ |
| **backup-to-gitee.sh** | å®Œæ•´å¤‡ä»½ | å®šæœŸå¤‡ä»½ |
| **restore-from-bak.sh** | æ¢å¤å¤‡ä»½ | æ•…éšœæ¢å¤ |

---

## âš™ï¸ éƒ¨ç½²è¯¦ç»†è¯´æ˜

### ubuntu-deploy.sh åŠŸèƒ½

**è‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… æ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼ˆUbuntuï¼‰
2. âœ… å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒ
3. âœ… å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬Gunicornï¼‰
4. âœ… é…ç½®systemdæœåŠ¡
   - ä½¿ç”¨Gunicornï¼ˆç”Ÿäº§çº§WSGIæœåŠ¡å™¨ï¼‰
   - è‡ªåŠ¨è®¡ç®—workeræ•°é‡ï¼šCPUæ ¸å¿ƒæ•° Ã— 2 + 1
   - è®¾ç½®ç”Ÿäº§ç¯å¢ƒï¼šFLASK_ENV=production
5. âœ… é…ç½®Nginxåå‘ä»£ç†
6. âœ… é…ç½®æ—¥å¿—è½®è½¬ï¼ˆæ¯å¤©ï¼Œä¿ç•™14å¤©ï¼‰
7. âœ… å¯åŠ¨æœåŠ¡

**éƒ¨ç½²æ—¶é—´**ï¼š2-3åˆ†é’Ÿ

**å…³é”®é…ç½®**ï¼š
```ini
# systemdæœåŠ¡é…ç½®
[Service]
Environment="FLASK_ENV=production"
ExecStart=/root/crm/venv/bin/gunicorn \
    --workers 4 \
    --bind 127.0.0.1:5000 \
    run:app
```

---

### quick-update.sh åŠŸèƒ½

**è‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… å¤‡ä»½æ•°æ®åº“
2. âœ… ä¿æŠ¤æ•°æ®åº“æ–‡ä»¶
3. âœ… æ‹‰å–æœ€æ–°ä»£ç 
4. âœ… é‡å¯æœåŠ¡
5. âœ… éªŒè¯æ›´æ–°

**æ›´æ–°æ—¶é—´**ï¼š5-10ç§’

**æ•°æ®ä¿æŠ¤**ï¼š
- æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
- Gitæ“ä½œä¸ä¼šè¦†ç›–æ•°æ®åº“
- å¤±è´¥è‡ªåŠ¨å›æ»š

---

### health-check.sh åŠŸèƒ½

**æ£€æŸ¥é¡¹ç›®**ï¼š
1. âœ… CRMæœåŠ¡çŠ¶æ€
2. âœ… HTTPå¥åº·æ£€æŸ¥ï¼ˆ/healthç«¯ç‚¹ï¼‰
3. âœ… ç«¯å£ç›‘å¬ï¼ˆ5000ï¼‰
4. âœ… æ•°æ®åº“æ–‡ä»¶
5. âœ… ç£ç›˜ç©ºé—´
6. âœ… å†…å­˜ä½¿ç”¨

**è‡ªåŠ¨ä¿®å¤**ï¼š
- æœåŠ¡åœæ­¢ â†’ è‡ªåŠ¨é‡å¯
- å¥åº·æ£€æŸ¥å¤±è´¥ â†’ è‡ªåŠ¨é‡å¯

**å®šæ—¶ä»»åŠ¡**ï¼š
```bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /root/crm/health-check.sh >> /var/log/crm/health-check.log 2>&1
```

---

### backup-to-gitee.sh åŠŸèƒ½

**å¤‡ä»½å†…å®¹**ï¼š
- âœ… æ‰€æœ‰æºä»£ç 
- âœ… æ•°æ®åº“æ–‡ä»¶
- âœ… é…ç½®æ–‡ä»¶
- âœ… é™æ€æ–‡ä»¶

**å¤‡ä»½ä½ç½®**ï¼šGiteeçš„bakåˆ†æ”¯

**å¤‡ä»½æµç¨‹**ï¼š
1. ä¿å­˜å½“å‰çŠ¶æ€
2. åˆ‡æ¢åˆ°bakåˆ†æ”¯
3. æ·»åŠ æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ•°æ®åº“ï¼‰
4. æäº¤å¤‡ä»½
5. æ¨é€åˆ°Gitee
6. æ¢å¤åˆ°åŸåˆ†æ”¯

**å®šæ—¶å¤‡ä»½**ï¼š
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * cd /root/crm && bash backup-to-gitee.sh >> /var/log/crm/backup.log 2>&1
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
sudo systemctl status crm
```

**é¢„æœŸè¾“å‡º**ï¼š
```
â— crm.service - CRM Flask Application
   Active: active (running)
   Main PID: 1234 (gunicorn)
```

### 2. æ£€æŸ¥Gunicornè¿›ç¨‹

```bash
ps aux | grep gunicorn
```

**é¢„æœŸè¾“å‡º**ï¼š
```
root  1234  gunicorn: master [run:app]
root  1235  gunicorn: worker [run:app]
root  1236  gunicorn: worker [run:app]
root  1237  gunicorn: worker [run:app]
root  1238  gunicorn: worker [run:app]
```

### 3. æ£€æŸ¥å¥åº·ç«¯ç‚¹

```bash
curl http://localhost/health
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "status": "healthy",
  "service": "EduConnect CRM",
  "database": "connected",
  "timestamp": "2025-01-02T10:00:00"
}
```

### 4. æ£€æŸ¥Nginx

```bash
sudo systemctl status nginx
curl -I http://localhost
```

**é¢„æœŸè¾“å‡º**ï¼š
```
HTTP/1.1 200 OK
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo journalctl -u crm -n 50

# å¸¸è§åŸå› 
# 1. ç«¯å£è¢«å ç”¨
sudo netstat -tuln | grep 5000

# 2. Pythonä¾èµ–ç¼ºå¤±
cd ~/crm
source venv/bin/activate
pip install -r requirements.txt

# 3. æ•°æ®åº“æƒé™
sudo chown -R $USER:$USER ~/crm/instance
```

### é—®é¢˜2: Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥CRMæœåŠ¡
sudo systemctl status crm

# æ£€æŸ¥ç«¯å£
curl http://localhost:5000/health

# é‡å¯æœåŠ¡
sudo systemctl restart crm nginx
```

### é—®é¢˜3: æ›´æ–°åæ²¡ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥ä»£ç ç‰ˆæœ¬
git log -1

# å¼ºåˆ¶é‡å¯
sudo systemctl restart crm

# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# æŒ‰ Ctrl+F5
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### Workeræ•°é‡

**è‡ªåŠ¨è®¡ç®—**ï¼šCPUæ ¸å¿ƒæ•° Ã— 2 + 1

**æ‰‹åŠ¨è°ƒæ•´**ï¼š
```bash
# ç¼–è¾‘æœåŠ¡é…ç½®
sudo nano /etc/systemd/system/crm.service

# ä¿®æ”¹workeræ•°é‡
--workers 8

# é‡æ–°åŠ è½½
sudo systemctl daemon-reload
sudo systemctl restart crm
```

### æ—¥å¿—ç®¡ç†

**æ—¥å¿—ä½ç½®**ï¼š
- åº”ç”¨æ—¥å¿—ï¼š`/var/log/crm/access.log`
- é”™è¯¯æ—¥å¿—ï¼š`/var/log/crm/error.log`
- Nginxæ—¥å¿—ï¼š`/var/log/nginx/crm-*.log`

**æ—¥å¿—è½®è½¬**ï¼š
- æ¯å¤©è‡ªåŠ¨è½®è½¬
- ä¿ç•™14å¤©
- è‡ªåŠ¨å‹ç¼©

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. é˜²ç«å¢™é…ç½®

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw enable
```

### 2. SSLè¯ä¹¦ï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£…certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d yourdomain.com
```

### 3. å®šæœŸå¤‡ä»½

```bash
# è®¾ç½®å®šæ—¶å¤‡ä»½
crontab -e

# æ·»åŠ 
0 2 * * * cd /root/crm && bash backup-to-gitee.sh
```

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### æœåŠ¡ç®¡ç†

```bash
# å¯åŠ¨
sudo systemctl start crm

# åœæ­¢
sudo systemctl stop crm

# é‡å¯
sudo systemctl restart crm

# ä¼˜é›…é‡å¯ï¼ˆä¸ä¸­æ–­è¿æ¥ï¼‰
sudo systemctl reload crm

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status crm

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u crm -f
```

### ä»£ç æ›´æ–°

```bash
# å¿«é€Ÿæ›´æ–°
bash quick-update.sh

# æ‰‹åŠ¨æ›´æ–°
git pull origin master
sudo systemctl restart crm
```

### å¤‡ä»½æ¢å¤

```bash
# å®Œæ•´å¤‡ä»½
bash backup-to-gitee.sh

# æ¢å¤å¤‡ä»½
bash restore-from-bak.sh
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. ç”Ÿäº§çº§æ€§èƒ½
- âœ… Gunicornå¤šè¿›ç¨‹ï¼ˆæ€§èƒ½æå‡10-20å€ï¼‰
- âœ… æ”¯æŒå¹¶å‘è¯·æ±‚
- âœ… è‡ªåŠ¨ä¼˜åŒ–workeræ•°é‡

### 2. æ›´æ–°é€Ÿåº¦å¿«
- âœ… 5-10ç§’å®Œæˆæ›´æ–°ï¼ˆé€Ÿåº¦æå‡20-60å€ï¼‰
- âœ… ä¸éœ€è¦é‡æ–°æ„å»ºé•œåƒ
- âœ… è‡ªåŠ¨ä¿æŠ¤æ•°æ®åº“

### 3. ç¨³å®šå¯é 
- âœ… systemdæœåŠ¡ç®¡ç†
- âœ… è‡ªåŠ¨é‡å¯
- âœ… å¥åº·æ£€æŸ¥

### 4. å®Œæ•´å¤‡ä»½
- âœ… ä¸€é”®å¤‡ä»½åˆ°Gitee
- âœ… åŒ…å«æ•°æ®åº“æ–‡ä»¶
- âœ… éšæ—¶æ¢å¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **README.md** - é¡¹ç›®æ€»ä½“è¯´æ˜
2. **æ•°æ®åº“è¯´æ˜.md** - æ•°æ®åº“ç»“æ„å’Œç®¡ç†

---

**ç‰ˆæœ¬**: 2.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª  
**æœ€åæ›´æ–°**: 2025-01-02

