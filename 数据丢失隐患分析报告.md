# æ•°æ®ä¸¢å¤±éšæ‚£åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢æ£€æŸ¥é¡¹ç›®ä»£ç ï¼Œå‘ç°äº†**5ä¸ªé«˜é£é™©éšæ‚£**å’Œ**3ä¸ªä¸­é£é™©éšæ‚£**ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†åˆ†æå’Œä¿®å¤å»ºè®®ã€‚

---

## ğŸš¨ é«˜é£é™©éšæ‚£

### 1. **å¤–é”®çº¦æŸæœªå¯ç”¨ï¼ˆæœ€ä¸¥é‡ï¼‰**

**é—®é¢˜æè¿°ï¼š**
- SQLiteæ•°æ®åº“çš„å¤–é”®çº¦æŸé»˜è®¤æ˜¯**å…³é—­**çš„
- æ£€æŸ¥ç»“æœæ˜¾ç¤ºï¼š`PRAGMA foreign_keys = 0`ï¼ˆæœªå¯ç”¨ï¼‰
- æ‰€æœ‰å¤–é”®å…³ç³»éƒ½è®¾ç½®ä¸º `NO ACTION`ï¼Œæ²¡æœ‰çº§è”åˆ é™¤ä¿æŠ¤

**é£é™©å½±å“ï¼š**
- âŒ åˆ é™¤çˆ¶è®°å½•æ—¶ï¼Œå­è®°å½•ä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤æˆ–é˜»æ­¢
- âŒ å¯èƒ½äº§ç”Ÿ"å­¤å„¿æ•°æ®"ï¼ˆorphaned recordsï¼‰
- âŒ æ•°æ®å®Œæ•´æ€§æ— æ³•ä¿è¯

**å®é™…æ¡ˆä¾‹ï¼š**
```python
# å¦‚æœåˆ é™¤ä¸€ä¸ªLeadï¼Œä½†Customerä»ç„¶å¼•ç”¨å®ƒ
Lead.query.filter_by(id=123).delete()  # Leadè¢«åˆ é™¤
# ä½† Customer.lead_id=123 çš„è®°å½•ä»ç„¶å­˜åœ¨ï¼Œå˜æˆå­¤å„¿æ•°æ®
# è®¿é—® customer.lead æ—¶ä¼šè¿”å› Noneï¼Œå¯¼è‡´é”™è¯¯
```

**ä¿®å¤æ–¹æ¡ˆï¼š**
åœ¨ `config.py` ä¸­æ·»åŠ ï¼š
```python
class BaseConfig:
    SQLALCHEMY_ENGINE_OPTIONS = {
        'connect_args': {
            'check_same_thread': False,
        },
        'pool_pre_ping': True,
    }
    
    @staticmethod
    def init_app(app):
        # å¯ç”¨å¤–é”®çº¦æŸ
        from sqlalchemy import event
        from sqlalchemy.engine import Engine
        
        @event.listens_for(Engine, "connect")
        def set_sqlite_pragma(dbapi_conn, connection_record):
            cursor = dbapi_conn.cursor()
            cursor.execute("PRAGMA foreign_keys=ON")
            cursor.close()
```

---

### 2. **åˆ é™¤æ“ä½œç¼ºå°‘çº§è”å¤„ç†**

**é—®é¢˜ä½ç½®ï¼š** `routes/admin.py` ç¬¬583-630è¡Œ

**é—®é¢˜ä»£ç ï¼š**
```python
@admin_bp.route('/leads/<int:lead_id>/delete', methods=['POST'])
def delete_lead(lead_id):
    lead = Lead.query.get_or_404(lead_id)
    
    # æ‰‹åŠ¨åˆ é™¤å…³è”æ•°æ®
    customer = Customer.query.filter_by(lead_id=lead_id).first()
    if customer:
        TutoringDelivery.query.filter_by(customer_id=customer.id).delete()
        CompetitionDelivery.query.filter_by(customer_id=customer.id).delete()
        db.session.delete(customer)
    
    CommunicationRecord.query.filter_by(lead_id=lead_id).delete()
    Payment.query.filter_by(lead_id=lead_id).delete()
    db.session.delete(lead)
    db.session.commit()
```

**é£é™©åˆ†æï¼š**
- âœ… ä»£ç é€»è¾‘æ­£ç¡®ï¼Œä½†**ä¾èµ–æ‰‹åŠ¨ç»´æŠ¤**
- âŒ å¦‚æœæœªæ¥æ·»åŠ æ–°çš„å…³è”è¡¨ï¼Œå®¹æ˜“é—æ¼
- âŒ å¦‚æœåˆ é™¤è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®åˆ é™¤

**ä¿®å¤å»ºè®®ï¼š**
åœ¨ `models.py` ä¸­ä½¿ç”¨ SQLAlchemy çš„ `cascade` é€‰é¡¹ï¼š
```python
class Lead(db.Model):
    # å…³è”å…³ç³»
    customer = db.relationship('Customer', backref='lead', uselist=False, 
                              cascade='all, delete-orphan')
    payments = db.relationship('Payment', backref='lead', lazy='dynamic',
                              cascade='all, delete-orphan')
    communication_records = db.relationship('CommunicationRecord', backref='lead',
                                           cascade='all, delete-orphan')
```

---

### 3. **äº‹åŠ¡å›æ»šåçŠ¶æ€ä¸ä¸€è‡´**

**é—®é¢˜ä½ç½®ï¼š** å¤šå¤„ `db.session.rollback()` è°ƒç”¨

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```python
try:
    customer.teacher_user_id = teacher_user_id
    db.session.commit()
except Exception as e:
    db.session.rollback()  # å›æ»šæ•°æ®åº“
    # ä½† customer å¯¹è±¡çš„å†…å­˜çŠ¶æ€å·²ç»æ”¹å˜ï¼
    return jsonify({'success': False, 'message': str(e)})
```

**é£é™©åˆ†æï¼š**
- âŒ å›æ»šåï¼ŒPythonå¯¹è±¡çš„çŠ¶æ€ä¸æ•°æ®åº“ä¸ä¸€è‡´
- âŒ åç»­æ“ä½œå¯èƒ½åŸºäºé”™è¯¯çš„å¯¹è±¡çŠ¶æ€
- âŒ å¯èƒ½å¯¼è‡´æ•°æ®è¦†ç›–æˆ–ä¸¢å¤±

**ä¿®å¤å»ºè®®ï¼š**
å›æ»šååˆ·æ–°å¯¹è±¡çŠ¶æ€ï¼š
```python
try:
    customer.teacher_user_id = teacher_user_id
    db.session.commit()
except Exception as e:
    db.session.rollback()
    db.session.refresh(customer)  # åˆ·æ–°å¯¹è±¡çŠ¶æ€
    return jsonify({'success': False, 'message': str(e)})
```

---

### 4. **å¹¶å‘æ›´æ–°æ— é”ä¿æŠ¤**

**é—®é¢˜ä½ç½®ï¼š** `routes/customers.py` ç¬¬484-513è¡Œ

**é—®é¢˜ä»£ç ï¼š**
```python
@customers_bp.route('/<int:customer_id>/toggle_priority', methods=['POST'])
def toggle_customer_priority(customer_id):
    customer = Customer.query.get_or_404(customer_id)
    is_priority = request.json.get('is_priority', False)
    
    customer.is_priority = is_priority  # æ— é”ä¿æŠ¤
    customer.updated_at = datetime.utcnow()
    db.session.commit()
```

**é£é™©åœºæ™¯ï¼š**
```
æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ·Aè¯»å– customer (is_priority=False)
T2: ç”¨æˆ·Bè¯»å– customer (is_priority=False)
T3: ç”¨æˆ·Aè®¾ç½® is_priority=Trueï¼Œæäº¤
T4: ç”¨æˆ·Bè®¾ç½® is_priority=Falseï¼Œæäº¤  â† è¦†ç›–äº†ç”¨æˆ·Açš„ä¿®æ”¹ï¼
```

**ä¿®å¤å»ºè®®ï¼š**
ä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”ï¼š
```python
# æ–¹æ¡ˆ1ï¼šä¹è§‚é”ï¼ˆæ¨èï¼‰
customer = Customer.query.filter_by(
    id=customer_id,
    updated_at=request.json.get('last_updated_at')
).first()
if not customer:
    return jsonify({'success': False, 'message': 'æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•'})

# æ–¹æ¡ˆ2ï¼šæ‚²è§‚é”
customer = Customer.query.with_for_update().get(customer_id)
```

---

### 5. **æ–‡ä»¶åˆ é™¤ä¸æ•°æ®åº“ä¸åŒæ­¥**

**é—®é¢˜ä½ç½®ï¼š** `routes/teachers.py` ç¬¬403-424è¡Œ

**é—®é¢˜ä»£ç ï¼š**
```python
@teachers_bp.route('/delete-image/<int:image_id>', methods=['POST'])
def delete_teacher_image(image_id):
    image = TeacherImage.query.get_or_404(image_id)
    
    # å…ˆåˆ é™¤æ–‡ä»¶
    filepath = os.path.join('static', image.image_path)
    if os.path.exists(filepath):
        os.remove(filepath)  # å¦‚æœè¿™é‡ŒæˆåŠŸ
    
    # å†åˆ é™¤æ•°æ®åº“è®°å½•
    db.session.delete(image)
    db.session.commit()  # å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œæ–‡ä»¶å·²è¢«åˆ é™¤ä½†æ•°æ®åº“è®°å½•è¿˜åœ¨
```

**é£é™©åˆ†æï¼š**
- âŒ æ–‡ä»¶åˆ é™¤æˆåŠŸï¼Œä½†æ•°æ®åº“æäº¤å¤±è´¥ â†’ æ•°æ®åº“è®°å½•æŒ‡å‘ä¸å­˜åœ¨çš„æ–‡ä»¶
- âŒ æ•°æ®åº“åˆ é™¤æˆåŠŸï¼Œä½†æ–‡ä»¶åˆ é™¤å¤±è´¥ â†’ ç£ç›˜ç©ºé—´æµªè´¹ï¼Œæ–‡ä»¶æ³„éœ²

**ä¿®å¤å»ºè®®ï¼š**
è°ƒæ•´é¡ºåºï¼Œå…ˆåˆ é™¤æ•°æ®åº“è®°å½•ï¼š
```python
try:
    # 1. å…ˆè®°å½•æ–‡ä»¶è·¯å¾„
    filepath = os.path.join('static', image.image_path)
    
    # 2. åˆ é™¤æ•°æ®åº“è®°å½•
    db.session.delete(image)
    db.session.commit()
    
    # 3. æœ€ååˆ é™¤æ–‡ä»¶ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“æ•°æ®ä¸€è‡´æ€§ï¼‰
    if os.path.exists(filepath):
        try:
            os.remove(filepath)
        except Exception as e:
            # è®°å½•æ—¥å¿—ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹
            print(f"æ–‡ä»¶åˆ é™¤å¤±è´¥: {filepath}, é”™è¯¯: {e}")
    
    return jsonify({'success': True, 'message': 'å›¾ç‰‡åˆ é™¤æˆåŠŸ'})
except Exception as e:
    db.session.rollback()
    return jsonify({'success': False, 'message': f'åˆ é™¤å¤±è´¥ï¼š{str(e)}'}), 500
```

---

## âš ï¸ ä¸­é£é™©éšæ‚£

### 6. **è½¯åˆ é™¤æœªå®Œå…¨å®ç°**

**é—®é¢˜ä½ç½®ï¼š** `routes/teachers.py` ç¬¬156-181è¡Œ

**é—®é¢˜æè¿°ï¼š**
- Teacher ä½¿ç”¨è½¯åˆ é™¤ï¼ˆstatus=Falseï¼‰
- ä½†æŸ¥è¯¢æ—¶æ²¡æœ‰è¿‡æ»¤ status=False çš„è®°å½•
- å¯èƒ½å¯¼è‡´"å·²åˆ é™¤"çš„è€å¸ˆä»ç„¶å‡ºç°åœ¨åˆ—è¡¨ä¸­

**ä¿®å¤å»ºè®®ï¼š**
```python
# åœ¨æ‰€æœ‰æŸ¥è¯¢ä¸­æ·»åŠ è¿‡æ»¤
Teacher.query.filter_by(status=True).all()

# æˆ–åœ¨æ¨¡å‹ä¸­æ·»åŠ é»˜è®¤ä½œç”¨åŸŸ
class Teacher(db.Model):
    __mapper_args__ = {
        'polymorphic_identity': 'teacher',
        'with_polymorphic': '*'
    }
    
    @classmethod
    def active(cls):
        return cls.query.filter_by(status=True)
```

---

### 7. **JSONå­—æ®µè§£æé”™è¯¯å¤„ç†ä¸è¶³**

**é—®é¢˜ä½ç½®ï¼š** `models.py` ç¬¬105-113è¡Œ

**é—®é¢˜ä»£ç ï¼š**
```python
def get_service_types_list(self):
    if self.service_types:
        try:
            return json.loads(self.service_types)
        except:  # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œä½†ä¸è®°å½•
            return []
    return []
```

**é£é™©åˆ†æï¼š**
- âŒ é™é»˜å¤±è´¥ï¼Œæ— æ³•å‘ç°æ•°æ®æŸå
- âŒ å¯èƒ½è¿”å›ç©ºåˆ—è¡¨ï¼Œå¯¼è‡´ä¸šåŠ¡é€»è¾‘é”™è¯¯

**ä¿®å¤å»ºè®®ï¼š**
```python
def get_service_types_list(self):
    if self.service_types:
        try:
            return json.loads(self.service_types)
        except json.JSONDecodeError as e:
            # è®°å½•é”™è¯¯æ—¥å¿—
            import logging
            logging.error(f"Lead {self.id} service_types JSONè§£æå¤±è´¥: {e}, åŸå§‹æ•°æ®: {self.service_types}")
            return []
    return []
```

---

### 8. **æ‰¹é‡æ“ä½œç¼ºå°‘äº‹åŠ¡ä¿æŠ¤**

**é—®é¢˜ä½ç½®ï¼š** `routes/admin.py` ç¬¬583-630è¡Œ

**é—®é¢˜æè¿°ï¼š**
- åˆ é™¤çº¿ç´¢æ—¶éœ€è¦åˆ é™¤å¤šä¸ªå…³è”è¡¨çš„æ•°æ®
- å¦‚æœä¸­é—´æŸæ­¥å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®åˆ é™¤

**å½“å‰ä»£ç ï¼š**
```python
TutoringDelivery.query.filter_by(customer_id=customer.id).delete()
CompetitionDelivery.query.filter_by(customer_id=customer.id).delete()
db.session.delete(customer)
# å¦‚æœè¿™é‡Œå‡ºé”™ï¼Œå‰é¢çš„åˆ é™¤å·²ç»æ‰§è¡Œ
CommunicationRecord.query.filter_by(lead_id=lead_id).delete()
```

**ä¿®å¤å»ºè®®ï¼š**
å·²ç»æœ‰ try-except åŒ…è£¹ï¼Œä½†å»ºè®®æ·»åŠ æ›´ç»†ç²’åº¦çš„æ£€æŸ¥ï¼š
```python
try:
    # ä½¿ç”¨ savepoint ä¿æŠ¤
    with db.session.begin_nested():
        if customer:
            TutoringDelivery.query.filter_by(customer_id=customer.id).delete()
            CompetitionDelivery.query.filter_by(customer_id=customer.id).delete()
            db.session.delete(customer)
        
        CommunicationRecord.query.filter_by(lead_id=lead_id).delete()
        Payment.query.filter_by(lead_id=lead_id).delete()
        db.session.delete(lead)
    
    db.session.commit()
except Exception as e:
    db.session.rollback()
    return jsonify({'success': False, 'message': f'åˆ é™¤å¤±è´¥ï¼š{str(e)}'})
```

---

## ğŸ“Š é£é™©ç­‰çº§æ€»ç»“

| éšæ‚£ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ä¿®å¤ä¼˜å…ˆçº§ |
|------|---------|---------|-----------|
| 1. å¤–é”®çº¦æŸæœªå¯ç”¨ | ğŸ”´ æé«˜ | å…¨å±€ | P0 ç«‹å³ä¿®å¤ |
| 2. åˆ é™¤æ“ä½œç¼ºå°‘çº§è” | ğŸ”´ é«˜ | Lead/Customeråˆ é™¤ | P0 ç«‹å³ä¿®å¤ |
| 3. äº‹åŠ¡å›æ»šçŠ¶æ€ä¸ä¸€è‡´ | ğŸ”´ é«˜ | æ‰€æœ‰æ›´æ–°æ“ä½œ | P1 å°½å¿«ä¿®å¤ |
| 4. å¹¶å‘æ›´æ–°æ— é”ä¿æŠ¤ | ğŸ”´ é«˜ | å®¢æˆ·ä¿¡æ¯æ›´æ–° | P1 å°½å¿«ä¿®å¤ |
| 5. æ–‡ä»¶åˆ é™¤ä¸åŒæ­¥ | ğŸ”´ é«˜ | å›¾ç‰‡åˆ é™¤ | P1 å°½å¿«ä¿®å¤ |
| 6. è½¯åˆ é™¤æœªå®Œå…¨å®ç° | ğŸŸ¡ ä¸­ | TeacheræŸ¥è¯¢ | P2 è®¡åˆ’ä¿®å¤ |
| 7. JSONè§£æé”™è¯¯å¤„ç† | ğŸŸ¡ ä¸­ | æœåŠ¡ç±»å‹è¯»å– | P2 è®¡åˆ’ä¿®å¤ |
| 8. æ‰¹é‡æ“ä½œäº‹åŠ¡ä¿æŠ¤ | ğŸŸ¡ ä¸­ | æ‰¹é‡åˆ é™¤ | P2 è®¡åˆ’ä¿®å¤ |

---

## ğŸ› ï¸ ç«‹å³è¡ŒåŠ¨å»ºè®®

### ç¬¬ä¸€æ­¥ï¼šå¯ç”¨å¤–é”®çº¦æŸï¼ˆæœ€é‡è¦ï¼‰
ä¿®æ”¹ `config.py`ï¼Œæ·»åŠ å¤–é”®çº¦æŸå¯ç”¨ä»£ç ã€‚

### ç¬¬äºŒæ­¥ï¼šæ·»åŠ çº§è”åˆ é™¤
ä¿®æ”¹ `models.py`ï¼Œåœ¨å…³è”å…³ç³»ä¸­æ·»åŠ  `cascade='all, delete-orphan'`ã€‚

### ç¬¬ä¸‰æ­¥ï¼šä¿®å¤æ–‡ä»¶åˆ é™¤é¡ºåº
ä¿®æ”¹ `routes/teachers.py`ï¼Œå…ˆåˆ é™¤æ•°æ®åº“è®°å½•ï¼Œå†åˆ é™¤æ–‡ä»¶ã€‚

### ç¬¬å››æ­¥ï¼šæ·»åŠ å¹¶å‘æ§åˆ¶
åœ¨å…³é”®æ›´æ–°æ“ä½œä¸­æ·»åŠ ä¹è§‚é”æˆ–æ‚²è§‚é”ã€‚

### ç¬¬äº”æ­¥ï¼šå®Œå–„é”™è¯¯å¤„ç†
åœ¨æ‰€æœ‰ `db.session.rollback()` åæ·»åŠ  `db.session.refresh()`ã€‚

---

## ğŸ“ æ•°æ®å¤‡ä»½å»ºè®®

åœ¨ä¿®å¤è¿™äº›éšæ‚£ä¹‹å‰ï¼Œå¼ºçƒˆå»ºè®®ï¼š

1. **ç«‹å³å¤‡ä»½æ•°æ®åº“**
   ```bash
   cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db
   ```

2. **å¯ç”¨è‡ªåŠ¨å¤‡ä»½**
   é¡¹ç›®ä¸­å·²æœ‰ `backup_database.sh`ï¼Œå»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š
   ```bash
   # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
   0 2 * * * /path/to/backup_database.sh
   ```

3. **æµ‹è¯•æ¢å¤æµç¨‹**
   å®šæœŸæµ‹è¯•å¤‡ä»½æ–‡ä»¶æ˜¯å¦å¯ä»¥æˆåŠŸæ¢å¤ã€‚

---

## ğŸ” ç›‘æ§å»ºè®®

æ·»åŠ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬ï¼š

```python
# check_data_integrity.py
from models import db, Lead, Customer, Payment, CommunicationRecord

def check_orphaned_records():
    """æ£€æŸ¥å­¤å„¿æ•°æ®"""
    issues = []
    
    # æ£€æŸ¥Customeræ˜¯å¦æœ‰æ— æ•ˆçš„lead_id
    orphaned_customers = db.session.query(Customer).filter(
        ~Customer.lead_id.in_(db.session.query(Lead.id))
    ).all()
    if orphaned_customers:
        issues.append(f"å‘ç° {len(orphaned_customers)} ä¸ªå­¤å„¿Customerè®°å½•")
    
    # æ£€æŸ¥Paymentæ˜¯å¦æœ‰æ— æ•ˆçš„lead_id
    orphaned_payments = db.session.query(Payment).filter(
        ~Payment.lead_id.in_(db.session.query(Lead.id))
    ).all()
    if orphaned_payments:
        issues.append(f"å‘ç° {len(orphaned_payments)} ä¸ªå­¤å„¿Paymentè®°å½•")
    
    return issues

if __name__ == '__main__':
    issues = check_orphaned_records()
    if issues:
        print("âš ï¸ æ•°æ®å®Œæ•´æ€§é—®é¢˜ï¼š")
        for issue in issues:
            print(f"  - {issue}")
    else:
        print("âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡")
```

---

## ğŸ“… ä¿®å¤è®¡åˆ’

å»ºè®®åˆ†é˜¶æ®µä¿®å¤ï¼š

**ç¬¬1å‘¨ï¼š**
- å¯ç”¨å¤–é”®çº¦æŸ
- ä¿®å¤æ–‡ä»¶åˆ é™¤é¡ºåº
- æ·»åŠ æ•°æ®å¤‡ä»½

**ç¬¬2å‘¨ï¼š**
- æ·»åŠ çº§è”åˆ é™¤é…ç½®
- å®Œå–„äº‹åŠ¡å›æ»šå¤„ç†
- æ·»åŠ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

**ç¬¬3å‘¨ï¼š**
- å®ç°å¹¶å‘æ§åˆ¶
- å®Œå–„è½¯åˆ é™¤é€»è¾‘
- æ·»åŠ ç›‘æ§å‘Šè­¦

---

ç”Ÿæˆæ—¶é—´ï¼š2025-10-22
åˆ†æäººï¼šAI Assistant

