# 数据库自动备份使用说明

## 📋 功能概述

自动备份系统会在每天凌晨3点自动备份 CRM 数据库文件，并保留最近30天的备份。

## 🚀 快速开始

### 在服务器上配置自动备份

#### 步骤 1：连接到服务器

```bash
ssh your_username@47.100.238.50
```

#### 步骤 2：进入项目目录

```bash
cd /path/to/CRM1  # 替换为实际的项目路径
```

#### 步骤 3：拉取最新代码

```bash
git pull origin main
```

#### 步骤 4：运行配置脚本

```bash
bash setup_backup_cron.sh
```

**脚本会自动完成以下操作**：
1. ✅ 检查备份脚本是否存在
2. ✅ 设置脚本执行权限
3. ✅ 配置 crontab 定时任务
4. ✅ 询问是否立即测试备份

**预期输出**：
```
==========================================
  CRM 数据库自动备份配置工具
==========================================

✅ 备份脚本已设置执行权限
✅ 定时任务配置成功！

==========================================
  配置详情
==========================================

执行时间：每天凌晨 3:00
备份脚本：/path/to/CRM1/backup_database.sh
日志文件：/path/to/CRM1/bak/backup.log
备份目录：/path/to/CRM1/bak/

是否立即运行一次备份测试？[Y/n]
```

## 📁 文件说明

### 1. `backup_database.sh` - 备份脚本

**功能**：
- 备份数据库文件到 `bak/` 目录
- 文件命名格式：`edu_crm_YYYYMMDD_HHMMSS.db`
- 验证备份文件完整性
- 自动清理30天前的旧备份
- 记录备份日志

**手动运行**：
```bash
bash backup_database.sh
```

### 2. `setup_backup_cron.sh` - 配置脚本

**功能**：
- 自动配置 crontab 定时任务
- 设置每天凌晨3点执行备份
- 检测并替换已存在的任务
- 提供立即测试选项

### 3. `bak/` - 备份目录

**结构**：
```
bak/
├── edu_crm_20251004_030000.db  # 2025-10-04 03:00 的备份
├── edu_crm_20251005_030000.db  # 2025-10-05 03:00 的备份
├── edu_crm_20251006_030000.db  # 2025-10-06 03:00 的备份
└── backup.log                   # 备份日志
```

## 🔧 配置选项

### 修改备份时间

编辑 `setup_backup_cron.sh` 文件，修改 `CRON_TIME` 变量：

```bash
# 默认：每天凌晨3点
CRON_TIME="0 3 * * *"

# 示例：每天凌晨2点
CRON_TIME="0 2 * * *"

# 示例：每天中午12点
CRON_TIME="0 12 * * *"

# 示例：每6小时一次
CRON_TIME="0 */6 * * *"

# 示例：每周日凌晨3点
CRON_TIME="0 3 * * 0"
```

**Cron 时间格式**：
```
* * * * *
│ │ │ │ │
│ │ │ │ └─── 星期几 (0-7, 0和7都表示周日)
│ │ │ └───── 月份 (1-12)
│ │ └─────── 日期 (1-31)
│ └───────── 小时 (0-23)
└─────────── 分钟 (0-59)
```

### 修改保留天数

编辑 `backup_database.sh` 文件，修改 `KEEP_DAYS` 变量：

```bash
# 默认：保留30天
KEEP_DAYS=30

# 示例：保留7天
KEEP_DAYS=7

# 示例：保留90天
KEEP_DAYS=90
```

## 📊 管理备份

### 查看备份文件

```bash
# 查看所有备份文件
ls -lh bak/edu_crm_*.db

# 查看最近5个备份
ls -lt bak/edu_crm_*.db | head -5

# 查看备份目录大小
du -sh bak/
```

### 查看备份日志

```bash
# 查看完整日志
cat bak/backup.log

# 实时查看日志
tail -f bak/backup.log

# 查看最近20行
tail -20 bak/backup.log

# 查看今天的备份记录
grep "$(date +%Y-%m-%d)" bak/backup.log
```

### 手动运行备份

```bash
# 运行备份脚本
bash backup_database.sh

# 后台运行并记录日志
nohup bash backup_database.sh >> bak/backup.log 2>&1 &
```

### 恢复备份

```bash
# 1. 停止 CRM 服务
sudo systemctl stop crm
# 或
sudo supervisorctl stop crm

# 2. 备份当前数据库（以防万一）
cp instance/edu_crm.db instance/edu_crm.db.before_restore

# 3. 恢复指定日期的备份
cp bak/edu_crm_20251004_030000.db instance/edu_crm.db

# 4. 重启 CRM 服务
sudo systemctl start crm
# 或
sudo supervisorctl start crm

# 5. 验证恢复是否成功
# 访问系统并检查数据
```

## 🔍 管理 Cron 任务

### 查看当前任务

```bash
crontab -l
```

### 编辑任务

```bash
crontab -e
```

### 删除所有任务

```bash
crontab -r
```

### 删除特定任务

```bash
# 1. 列出当前任务
crontab -l

# 2. 删除包含 backup_database.sh 的任务
crontab -l | grep -v "backup_database.sh" | crontab -
```

### 检查 Cron 服务状态

```bash
# Ubuntu/Debian
sudo systemctl status cron

# CentOS/RHEL
sudo systemctl status crond
```

### 查看 Cron 执行日志

```bash
# Ubuntu/Debian
sudo tail -f /var/log/syslog | grep CRON

# CentOS/RHEL
sudo tail -f /var/log/cron
```

## ⚠️ 故障排查

### 问题 1：备份未自动执行

**检查步骤**：

1. **确认 cron 任务已配置**：
   ```bash
   crontab -l | grep backup_database.sh
   ```

2. **检查 cron 服务是否运行**：
   ```bash
   sudo systemctl status cron
   ```

3. **查看系统日志**：
   ```bash
   sudo tail -100 /var/log/syslog | grep CRON
   ```

4. **检查脚本权限**：
   ```bash
   ls -l backup_database.sh
   # 应该显示 -rwxr-xr-x
   ```

5. **手动运行测试**：
   ```bash
   bash backup_database.sh
   ```

### 问题 2：备份文件损坏

**检查完整性**：
```bash
sqlite3 bak/edu_crm_20251004_030000.db "PRAGMA integrity_check;"
```

**预期输出**：`ok`

### 问题 3：磁盘空间不足

**检查磁盘空间**：
```bash
df -h
```

**清理旧备份**：
```bash
# 手动删除30天前的备份
find bak/ -name "edu_crm_*.db" -type f -mtime +30 -delete

# 或者减少保留天数（修改 KEEP_DAYS）
```

### 问题 4：权限问题

**设置正确的权限**：
```bash
# 脚本执行权限
chmod +x backup_database.sh
chmod +x setup_backup_cron.sh

# 备份目录权限
chmod 755 bak/
```

## 📧 通知配置（可选）

### 配置邮件通知

如果希望备份完成后收到邮件通知，可以修改 cron 任务：

```bash
# 编辑 crontab
crontab -e

# 在文件开头添加邮件地址
MAILTO=your_email@example.com

# cron 任务保持不变
0 3 * * * /path/to/CRM1/backup_database.sh >> /path/to/CRM1/bak/backup.log 2>&1
```

**注意**：需要服务器配置了邮件发送功能（如 sendmail 或 postfix）。

## 📝 最佳实践

### 1. 定期测试恢复

建议每月测试一次备份恢复流程，确保备份文件可用。

### 2. 异地备份

除了本地备份，建议定期将备份文件同步到其他服务器或云存储：

```bash
# 示例：使用 rsync 同步到远程服务器
rsync -avz bak/ user@backup-server:/backup/crm/

# 示例：使用 rclone 同步到云存储
rclone sync bak/ remote:crm-backup/
```

### 3. 监控备份状态

定期检查备份日志，确保备份正常执行：

```bash
# 检查最近一次备份是否成功
tail -20 bak/backup.log | grep "备份任务完成"
```

### 4. 磁盘空间监控

设置磁盘空间告警，避免因空间不足导致备份失败。

## 🔐 安全建议

1. **限制备份目录访问权限**：
   ```bash
   chmod 700 bak/
   ```

2. **加密敏感备份**（可选）：
   ```bash
   # 使用 GPG 加密备份
   gpg --symmetric --cipher-algo AES256 bak/edu_crm_20251004_030000.db
   ```

3. **定期审计备份日志**：
   检查是否有异常的备份活动。

## 📞 支持

如有问题，请检查：
1. 备份日志：`bak/backup.log`
2. 系统日志：`/var/log/syslog` 或 `/var/log/cron`
3. Cron 任务：`crontab -l`

---

**最后更新**：2025-10-04  
**版本**：v1.0

