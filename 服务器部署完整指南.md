# 服务器部署完整指南

## 📋 部署清单

本次需要在服务器上完成以下两项部署：

### ✅ 任务 1：数据库迁移（修复学员详情页错误）
- **问题**：学员详情页显示 JSON 解析错误
- **原因**：数据库缺少 `communication_records.user_id` 字段
- **解决**：运行数据库迁移脚本

### ✅ 任务 2：配置自动备份
- **目的**：每天凌晨3点自动备份数据库
- **备份位置**：`bak/edu_crm_时间.db`
- **保留时间**：30天

---

## 🚀 快速部署（推荐）

### 一键部署脚本

连接到服务器后，执行以下命令：

```bash
# 1. 进入项目目录
cd /path/to/CRM1  # 替换为实际路径，如 /home/crm/CRM1

# 2. 拉取最新代码
git pull origin main

# 3. 运行数据库迁移
bash deploy_migration.sh

# 4. 配置自动备份
bash setup_backup_cron.sh
```

---

## 📝 详细部署步骤

### 步骤 1：连接服务器

```bash
ssh your_username@47.100.238.50
```

### 步骤 2：进入项目目录

```bash
# 查找项目目录（如果不确定路径）
find /home -name "CRM1" -type d 2>/dev/null

# 进入项目目录
cd /path/to/CRM1
```

### 步骤 3：拉取最新代码

```bash
# 查看当前分支
git branch

# 拉取最新代码
git pull origin main
# 或
git pull origin master

# 确认新文件已下载
ls -l *.sh
```

**预期输出**：
```
-rwxr-xr-x 1 user user  5234 Oct  4 15:00 backup_database.sh
-rwxr-xr-x 1 user user  3456 Oct  4 15:00 deploy_migration.sh
-rwxr-xr-x 1 user user  2789 Oct  4 15:00 setup_backup_cron.sh
-rw-r--r-- 1 user user  1234 Oct  4 15:00 add_user_id_to_communications.py
```

### 步骤 4：数据库迁移

#### 方法 A：使用一键部署脚本（推荐）

```bash
bash deploy_migration.sh
```

**脚本会自动完成**：
1. ✅ 检查虚拟环境
2. ✅ 备份数据库
3. ✅ 运行迁移脚本
4. ✅ 询问是否重启服务

**按提示选择重启方式**：
- 选项 1：systemd
- 选项 2：supervisor
- 选项 3：手动重启
- 选项 4：跳过重启

#### 方法 B：手动执行（如果脚本失败）

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 备份数据库
cp instance/edu_crm.db instance/edu_crm.db.backup.$(date +%Y%m%d_%H%M%S)

# 3. 运行迁移
python add_user_id_to_communications.py

# 4. 重启服务
sudo systemctl restart crm
# 或
sudo supervisorctl restart crm
```

### 步骤 5：配置自动备份

```bash
bash setup_backup_cron.sh
```

**脚本会自动完成**：
1. ✅ 设置脚本执行权限
2. ✅ 配置 crontab 定时任务
3. ✅ 询问是否立即测试备份

**建议选择 "Y" 立即测试备份**，确认功能正常。

### 步骤 6：验证部署

#### 验证数据库迁移

1. **访问系统**：http://47.100.238.50
2. **登录账号**：13900139001
3. **测试功能**：
   - 进入线索列表页
   - 点击任意学员姓名
   - 确认学员详情弹窗正常显示
   - 点击"新增沟通记录"
   - 填写内容并保存
   - 确认显示填写人信息（如：Kingble老师）

#### 验证自动备份

```bash
# 1. 检查 cron 任务
crontab -l | grep backup_database.sh

# 2. 检查备份目录
ls -lh bak/

# 3. 查看备份日志
tail -20 bak/backup.log

# 4. 验证备份文件完整性
sqlite3 bak/edu_crm_*.db "PRAGMA integrity_check;"
```

**预期输出**：`ok`

---

## 🔍 故障排查

### 问题 1：git pull 失败

**错误信息**：`Your local changes would be overwritten by merge`

**解决方法**：
```bash
# 保存本地修改
git stash

# 拉取最新代码
git pull origin main

# 恢复本地修改（如果需要）
git stash pop
```

### 问题 2：虚拟环境未找到

**错误信息**：`找不到虚拟环境目录 venv`

**解决方法**：
```bash
# 检查虚拟环境位置
ls -la | grep -E "venv|env|virtualenv"

# 如果虚拟环境在其他位置，手动激活
source path/to/venv/bin/activate

# 如果没有虚拟环境，创建一个
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 问题 3：数据库文件路径错误

**错误信息**：`找不到数据库文件 instance/edu_crm.db`

**解决方法**：
```bash
# 查找数据库文件
find . -name "*.db" -type f

# 如果数据库在 instance/crm.db
# 修改脚本中的路径，或创建软链接
ln -s instance/crm.db instance/edu_crm.db
```

### 问题 4：权限不足

**错误信息**：`Permission denied`

**解决方法**：
```bash
# 设置脚本执行权限
chmod +x *.sh

# 设置数据库文件权限
chmod 644 instance/edu_crm.db

# 设置备份目录权限
chmod 755 bak/
```

### 问题 5：服务重启失败

**检查服务状态**：
```bash
# systemd
sudo systemctl status crm

# supervisor
sudo supervisorctl status crm

# 查看进程
ps aux | grep "python.*run.py"
```

**手动重启**：
```bash
# 停止服务
pkill -f "python run.py"

# 启动服务
cd /path/to/CRM1
source venv/bin/activate
nohup python run.py > logs/app.log 2>&1 &

# 验证服务运行
ps aux | grep "python.*run.py"
```

---

## 📊 部署后检查清单

### 数据库迁移检查

- [ ] 数据库已备份
- [ ] 迁移脚本执行成功
- [ ] 服务已重启
- [ ] 学员详情页正常显示
- [ ] 新增沟通记录显示填写人
- [ ] 历史记录显示"未知"

### 自动备份检查

- [ ] cron 任务已配置
- [ ] 备份目录已创建
- [ ] 测试备份成功
- [ ] 备份文件完整性验证通过
- [ ] 备份日志正常记录

---

## 📁 重要文件位置

### 脚本文件
```
CRM1/
├── deploy_migration.sh              # 数据库迁移部署脚本
├── add_user_id_to_communications.py # 数据库迁移脚本
├── backup_database.sh               # 数据库备份脚本
├── setup_backup_cron.sh             # 备份配置脚本
├── 部署指南-数据库迁移.md           # 迁移详细文档
└── 数据库备份使用说明.md           # 备份详细文档
```

### 数据文件
```
CRM1/
├── instance/
│   ├── edu_crm.db                   # 主数据库文件
│   └── edu_crm.db.backup.*          # 迁移前备份
└── bak/
    ├── edu_crm_20251004_030000.db   # 自动备份文件
    ├── edu_crm_20251005_030000.db
    └── backup.log                    # 备份日志
```

### 日志文件
```
CRM1/
├── logs/
│   └── app.log                      # 应用日志
└── bak/
    └── backup.log                    # 备份日志
```

---

## 🔐 安全建议

1. **备份目录权限**：
   ```bash
   chmod 700 bak/
   ```

2. **定期检查备份**：
   ```bash
   # 添加到 crontab，每周一发送备份报告
   0 9 * * 1 ls -lh /path/to/CRM1/bak/ | mail -s "CRM 备份报告" your_email@example.com
   ```

3. **异地备份**（可选）：
   ```bash
   # 使用 rsync 同步到备份服务器
   0 4 * * * rsync -avz /path/to/CRM1/bak/ backup-server:/backup/crm/
   ```

---

## 📞 技术支持

### 查看日志

```bash
# 应用日志
tail -f logs/app.log

# 备份日志
tail -f bak/backup.log

# 系统日志
sudo tail -f /var/log/syslog | grep CRON
```

### 常用命令

```bash
# 查看服务状态
sudo systemctl status crm

# 查看 cron 任务
crontab -l

# 查看磁盘空间
df -h

# 查看备份文件
ls -lh bak/
```

---

**最后更新**：2025-10-04  
**版本**：v1.0  
**服务器**：47.100.238.50

