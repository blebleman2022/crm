# æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¸…å•

æœ¬æ¬¡éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®Œæˆä»¥ä¸‹ä¸¤é¡¹éƒ¨ç½²ï¼š

### âœ… ä»»åŠ¡ 1ï¼šæ•°æ®åº“è¿ç§»ï¼ˆä¿®å¤å­¦å‘˜è¯¦æƒ…é¡µé”™è¯¯ï¼‰
- **é—®é¢˜**ï¼šå­¦å‘˜è¯¦æƒ…é¡µæ˜¾ç¤º JSON è§£æé”™è¯¯
- **åŸå› **ï¼šæ•°æ®åº“ç¼ºå°‘ `communication_records.user_id` å­—æ®µ
- **è§£å†³**ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

### âœ… ä»»åŠ¡ 2ï¼šé…ç½®è‡ªåŠ¨å¤‡ä»½
- **ç›®çš„**ï¼šæ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
- **å¤‡ä»½ä½ç½®**ï¼š`bak/edu_crm_æ—¶é—´.db`
- **ä¿ç•™æ—¶é—´**ï¼š30å¤©

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

### ä¸€é”®éƒ¨ç½²è„šæœ¬

è¿æ¥åˆ°æœåŠ¡å™¨åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/CRM1  # æ›¿æ¢ä¸ºå®é™…è·¯å¾„ï¼Œå¦‚ /home/crm/CRM1

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. è¿è¡Œæ•°æ®åº“è¿ç§»
bash deploy_migration.sh

# 4. é…ç½®è‡ªåŠ¨å¤‡ä»½
bash setup_backup_cron.sh
```

---

## ğŸ“ è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šè¿æ¥æœåŠ¡å™¨

```bash
ssh your_username@47.100.238.50
```

### æ­¥éª¤ 2ï¼šè¿›å…¥é¡¹ç›®ç›®å½•

```bash
# æŸ¥æ‰¾é¡¹ç›®ç›®å½•ï¼ˆå¦‚æœä¸ç¡®å®šè·¯å¾„ï¼‰
find /home -name "CRM1" -type d 2>/dev/null

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/CRM1
```

### æ­¥éª¤ 3ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
# æŸ¥çœ‹å½“å‰åˆ†æ”¯
git branch

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main
# æˆ–
git pull origin master

# ç¡®è®¤æ–°æ–‡ä»¶å·²ä¸‹è½½
ls -l *.sh
```

**é¢„æœŸè¾“å‡º**ï¼š
```
-rwxr-xr-x 1 user user  5234 Oct  4 15:00 backup_database.sh
-rwxr-xr-x 1 user user  3456 Oct  4 15:00 deploy_migration.sh
-rwxr-xr-x 1 user user  2789 Oct  4 15:00 setup_backup_cron.sh
-rw-r--r-- 1 user user  1234 Oct  4 15:00 add_user_id_to_communications.py
```

### æ­¥éª¤ 4ï¼šæ•°æ®åº“è¿ç§»

#### æ–¹æ³• Aï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
bash deploy_migration.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
2. âœ… å¤‡ä»½æ•°æ®åº“
3. âœ… è¿è¡Œè¿ç§»è„šæœ¬
4. âœ… è¯¢é—®æ˜¯å¦é‡å¯æœåŠ¡

**æŒ‰æç¤ºé€‰æ‹©é‡å¯æ–¹å¼**ï¼š
- é€‰é¡¹ 1ï¼šsystemd
- é€‰é¡¹ 2ï¼šsupervisor
- é€‰é¡¹ 3ï¼šæ‰‹åŠ¨é‡å¯
- é€‰é¡¹ 4ï¼šè·³è¿‡é‡å¯

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨æ‰§è¡Œï¼ˆå¦‚æœè„šæœ¬å¤±è´¥ï¼‰

```bash
# 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 2. å¤‡ä»½æ•°æ®åº“
cp instance/edu_crm.db instance/edu_crm.db.backup.$(date +%Y%m%d_%H%M%S)

# 3. è¿è¡Œè¿ç§»
python add_user_id_to_communications.py

# 4. é‡å¯æœåŠ¡
sudo systemctl restart crm
# æˆ–
sudo supervisorctl restart crm
```

### æ­¥éª¤ 5ï¼šé…ç½®è‡ªåŠ¨å¤‡ä»½

```bash
bash setup_backup_cron.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
2. âœ… é…ç½® crontab å®šæ—¶ä»»åŠ¡
3. âœ… è¯¢é—®æ˜¯å¦ç«‹å³æµ‹è¯•å¤‡ä»½

**å»ºè®®é€‰æ‹© "Y" ç«‹å³æµ‹è¯•å¤‡ä»½**ï¼Œç¡®è®¤åŠŸèƒ½æ­£å¸¸ã€‚

### æ­¥éª¤ 6ï¼šéªŒè¯éƒ¨ç½²

#### éªŒè¯æ•°æ®åº“è¿ç§»

1. **è®¿é—®ç³»ç»Ÿ**ï¼šhttp://47.100.238.50
2. **ç™»å½•è´¦å·**ï¼š13900139001
3. **æµ‹è¯•åŠŸèƒ½**ï¼š
   - è¿›å…¥çº¿ç´¢åˆ—è¡¨é¡µ
   - ç‚¹å‡»ä»»æ„å­¦å‘˜å§“å
   - ç¡®è®¤å­¦å‘˜è¯¦æƒ…å¼¹çª—æ­£å¸¸æ˜¾ç¤º
   - ç‚¹å‡»"æ–°å¢æ²Ÿé€šè®°å½•"
   - å¡«å†™å†…å®¹å¹¶ä¿å­˜
   - ç¡®è®¤æ˜¾ç¤ºå¡«å†™äººä¿¡æ¯ï¼ˆå¦‚ï¼šKingbleè€å¸ˆï¼‰

#### éªŒè¯è‡ªåŠ¨å¤‡ä»½

```bash
# 1. æ£€æŸ¥ cron ä»»åŠ¡
crontab -l | grep backup_database.sh

# 2. æ£€æŸ¥å¤‡ä»½ç›®å½•
ls -lh bak/

# 3. æŸ¥çœ‹å¤‡ä»½æ—¥å¿—
tail -20 bak/backup.log

# 4. éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
sqlite3 bak/edu_crm_*.db "PRAGMA integrity_check;"
```

**é¢„æœŸè¾“å‡º**ï¼š`ok`

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šgit pull å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š`Your local changes would be overwritten by merge`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# ä¿å­˜æœ¬åœ°ä¿®æ”¹
git stash

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ¢å¤æœ¬åœ°ä¿®æ”¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git stash pop
```

### é—®é¢˜ 2ï¼šè™šæ‹Ÿç¯å¢ƒæœªæ‰¾åˆ°

**é”™è¯¯ä¿¡æ¯**ï¼š`æ‰¾ä¸åˆ°è™šæ‹Ÿç¯å¢ƒç›®å½• venv`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒä½ç½®
ls -la | grep -E "venv|env|virtualenv"

# å¦‚æœè™šæ‹Ÿç¯å¢ƒåœ¨å…¶ä»–ä½ç½®ï¼Œæ‰‹åŠ¨æ¿€æ´»
source path/to/venv/bin/activate

# å¦‚æœæ²¡æœ‰è™šæ‹Ÿç¯å¢ƒï¼Œåˆ›å»ºä¸€ä¸ª
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### é—®é¢˜ 3ï¼šæ•°æ®åº“æ–‡ä»¶è·¯å¾„é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`æ‰¾ä¸åˆ°æ•°æ®åº“æ–‡ä»¶ instance/edu_crm.db`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æŸ¥æ‰¾æ•°æ®åº“æ–‡ä»¶
find . -name "*.db" -type f

# å¦‚æœæ•°æ®åº“åœ¨ instance/crm.db
# ä¿®æ”¹è„šæœ¬ä¸­çš„è·¯å¾„ï¼Œæˆ–åˆ›å»ºè½¯é“¾æ¥
ln -s instance/crm.db instance/edu_crm.db
```

### é—®é¢˜ 4ï¼šæƒé™ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š`Permission denied`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
chmod +x *.sh

# è®¾ç½®æ•°æ®åº“æ–‡ä»¶æƒé™
chmod 644 instance/edu_crm.db

# è®¾ç½®å¤‡ä»½ç›®å½•æƒé™
chmod 755 bak/
```

### é—®é¢˜ 5ï¼šæœåŠ¡é‡å¯å¤±è´¥

**æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š
```bash
# systemd
sudo systemctl status crm

# supervisor
sudo supervisorctl status crm

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep "python.*run.py"
```

**æ‰‹åŠ¨é‡å¯**ï¼š
```bash
# åœæ­¢æœåŠ¡
pkill -f "python run.py"

# å¯åŠ¨æœåŠ¡
cd /path/to/CRM1
source venv/bin/activate
nohup python run.py > logs/app.log 2>&1 &

# éªŒè¯æœåŠ¡è¿è¡Œ
ps aux | grep "python.*run.py"
```

---

## ğŸ“Š éƒ¨ç½²åæ£€æŸ¥æ¸…å•

### æ•°æ®åº“è¿ç§»æ£€æŸ¥

- [ ] æ•°æ®åº“å·²å¤‡ä»½
- [ ] è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] æœåŠ¡å·²é‡å¯
- [ ] å­¦å‘˜è¯¦æƒ…é¡µæ­£å¸¸æ˜¾ç¤º
- [ ] æ–°å¢æ²Ÿé€šè®°å½•æ˜¾ç¤ºå¡«å†™äºº
- [ ] å†å²è®°å½•æ˜¾ç¤º"æœªçŸ¥"

### è‡ªåŠ¨å¤‡ä»½æ£€æŸ¥

- [ ] cron ä»»åŠ¡å·²é…ç½®
- [ ] å¤‡ä»½ç›®å½•å·²åˆ›å»º
- [ ] æµ‹è¯•å¤‡ä»½æˆåŠŸ
- [ ] å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡
- [ ] å¤‡ä»½æ—¥å¿—æ­£å¸¸è®°å½•

---

## ğŸ“ é‡è¦æ–‡ä»¶ä½ç½®

### è„šæœ¬æ–‡ä»¶
```
CRM1/
â”œâ”€â”€ deploy_migration.sh              # æ•°æ®åº“è¿ç§»éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ add_user_id_to_communications.py # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ backup_database.sh               # æ•°æ®åº“å¤‡ä»½è„šæœ¬
â”œâ”€â”€ setup_backup_cron.sh             # å¤‡ä»½é…ç½®è„šæœ¬
â”œâ”€â”€ éƒ¨ç½²æŒ‡å—-æ•°æ®åº“è¿ç§».md           # è¿ç§»è¯¦ç»†æ–‡æ¡£
â””â”€â”€ æ•°æ®åº“å¤‡ä»½ä½¿ç”¨è¯´æ˜.md           # å¤‡ä»½è¯¦ç»†æ–‡æ¡£
```

### æ•°æ®æ–‡ä»¶
```
CRM1/
â”œâ”€â”€ instance/
â”‚   â”œâ”€â”€ edu_crm.db                   # ä¸»æ•°æ®åº“æ–‡ä»¶
â”‚   â””â”€â”€ edu_crm.db.backup.*          # è¿ç§»å‰å¤‡ä»½
â””â”€â”€ bak/
    â”œâ”€â”€ edu_crm_20251004_030000.db   # è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶
    â”œâ”€â”€ edu_crm_20251005_030000.db
    â””â”€â”€ backup.log                    # å¤‡ä»½æ—¥å¿—
```

### æ—¥å¿—æ–‡ä»¶
```
CRM1/
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ app.log                      # åº”ç”¨æ—¥å¿—
â””â”€â”€ bak/
    â””â”€â”€ backup.log                    # å¤‡ä»½æ—¥å¿—
```

---

## ğŸ” å®‰å…¨å»ºè®®

1. **å¤‡ä»½ç›®å½•æƒé™**ï¼š
   ```bash
   chmod 700 bak/
   ```

2. **å®šæœŸæ£€æŸ¥å¤‡ä»½**ï¼š
   ```bash
   # æ·»åŠ åˆ° crontabï¼Œæ¯å‘¨ä¸€å‘é€å¤‡ä»½æŠ¥å‘Š
   0 9 * * 1 ls -lh /path/to/CRM1/bak/ | mail -s "CRM å¤‡ä»½æŠ¥å‘Š" your_email@example.com
   ```

3. **å¼‚åœ°å¤‡ä»½**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   # ä½¿ç”¨ rsync åŒæ­¥åˆ°å¤‡ä»½æœåŠ¡å™¨
   0 4 * * * rsync -avz /path/to/CRM1/bak/ backup-server:/backup/crm/
   ```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æŸ¥çœ‹æ—¥å¿—

```bash
# åº”ç”¨æ—¥å¿—
tail -f logs/app.log

# å¤‡ä»½æ—¥å¿—
tail -f bak/backup.log

# ç³»ç»Ÿæ—¥å¿—
sudo tail -f /var/log/syslog | grep CRON
```

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status crm

# æŸ¥çœ‹ cron ä»»åŠ¡
crontab -l

# æŸ¥çœ‹ç£ç›˜ç©ºé—´
df -h

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh bak/
```

---

**æœ€åæ›´æ–°**ï¼š2025-10-04  
**ç‰ˆæœ¬**ï¼šv1.0  
**æœåŠ¡å™¨**ï¼š47.100.238.50

