# æœåŠ¡å™¨æ›´æ–°æ­¥éª¤

## ðŸ”´ å½“å‰é—®é¢˜

æœåŠ¡å™¨ä¸Šçš„Dockerå®¹å™¨æŠ¥é”™ï¼š`ModuleNotFoundError: No module named 'PIL'`

**åŽŸå› **: æœåŠ¡å™¨ä¸Šçš„ä»£ç ç‰ˆæœ¬è¿‡æ—§ï¼Œç¼ºå°‘ä»¥ä¸‹ä¿®å¤ï¼š
1. routes/admin.py ä¸­çš„ PIL å¯é€‰å¯¼å…¥
2. requirements.txt ä¸­çš„ Pillow ä¾èµ–

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤1: åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æœ€æ–°ä»£ç 

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/crm

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
git log --oneline -3

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# ç¡®è®¤æ›´æ–°æˆåŠŸ
git log --online -3
```

**é¢„æœŸè¾“å‡º**ï¼ˆæœ€æ–°çš„3ä¸ªæäº¤ï¼‰:
```
730c9cf docs: æ·»åŠ Docker Composeéƒ¨ç½²æ–‡ä»¶æ¸…å•
a1300f8 docs: æ·»åŠ äº‘æœåŠ¡å™¨é…ç½®æ£€æŸ¥æŠ¥å‘Š
9c02fa7 fix: ä¿®å¤run.pyé…ç½®åŠ è½½é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€çš„config.pyï¼›æ·»åŠ é…ç½®æ£€æŸ¥è„šæœ¬
```

---

### æ­¥éª¤2: éªŒè¯å…³é”®æ–‡ä»¶å·²æ›´æ–°

#### æ£€æŸ¥ routes/admin.py

```bash
head -20 routes/admin.py
```

**é¢„æœŸè¾“å‡º**ï¼ˆåº”è¯¥åŒ…å«å¯é€‰å¯¼å…¥ï¼‰:
```python
# PILæ˜¯å¯é€‰ä¾èµ–ï¼Œä»…ç”¨äºŽlogoä¸Šä¼ åŠŸèƒ½
try:
    from PIL import Image
    HAS_PIL = True
except ImportError:
    HAS_PIL = False
```

#### æ£€æŸ¥ requirements.txt

```bash
grep Pillow requirements.txt
```

**é¢„æœŸè¾“å‡º**:
```
Pillow==10.1.0
```

---

### æ­¥éª¤3: é‡æ–°æž„å»ºå¹¶å¯åŠ¨Dockerå®¹å™¨

```bash
# åœæ­¢çŽ°æœ‰å®¹å™¨
docker compose down

# æ¸…ç†Dockerç¼“å­˜ï¼ˆå¯é€‰ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç ï¼‰
docker system prune -f

# é‡æ–°æž„å»ºé•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker compose build --no-cache

# å¯åŠ¨å®¹å™¨
docker compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker compose logs -f
```

---

### æ­¥éª¤4: éªŒè¯éƒ¨ç½²æˆåŠŸ

#### æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker compose ps
```

**é¢„æœŸè¾“å‡º**:
```
NAME       IMAGE       COMMAND            STATUS         PORTS
crm-app    crm-app     "python run.py"    Up X seconds   0.0.0.0:5000->5000/tcp
```

#### æ£€æŸ¥åº”ç”¨æ—¥å¿—

```bash
docker compose logs --tail=50
```

**é¢„æœŸè¾“å‡º**ï¼ˆåº”è¯¥æ²¡æœ‰é”™è¯¯ï¼‰:
```
crm-app  | æ­£åœ¨åˆ›å»ºFlaskåº”ç”¨å®žä¾‹...
crm-app  |  * Serving Flask app 'run'
crm-app  |  * Debug mode: on
crm-app  | WARNING: This is a development server. Do not use it in a production deployment.
crm-app  |  * Running on all addresses (0.0.0.0)
crm-app  |  * Running on http://127.0.0.1:5000
crm-app  |  * Running on http://172.x.x.x:5000
```

#### æµ‹è¯•åº”ç”¨å“åº”

```bash
curl -I http://localhost:5000/auth/login
```

**é¢„æœŸè¾“å‡º**:
```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
...
```

---

## ðŸš€ ä¸€é”®æ›´æ–°è„šæœ¬

å¦‚æžœæ‚¨æƒ³ç®€åŒ–æ“ä½œï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ›´æ–°è„šæœ¬ï¼š

```bash
# åˆ›å»ºæ›´æ–°è„šæœ¬
cat > update.sh << 'EOF'
#!/bin/bash

echo "========================================="
echo "  CRMç³»ç»Ÿæ›´æ–°è„šæœ¬"
echo "========================================="

# 1. æ‹‰å–æœ€æ–°ä»£ç 
echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin master

# 2. åœæ­¢çŽ°æœ‰å®¹å™¨
echo "ðŸ›‘ åœæ­¢çŽ°æœ‰å®¹å™¨..."
docker compose down

# 3. é‡æ–°æž„å»ºé•œåƒ
echo "ðŸ”¨ é‡æ–°æž„å»ºé•œåƒ..."
docker compose build --no-cache

# 4. å¯åŠ¨å®¹å™¨
echo "ðŸš€ å¯åŠ¨å®¹å™¨..."
docker compose up -d

# 5. ç­‰å¾…å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

# 6. æŸ¥çœ‹çŠ¶æ€
echo "ðŸ“Š æŸ¥çœ‹å®¹å™¨çŠ¶æ€..."
docker compose ps

# 7. æŸ¥çœ‹æ—¥å¿—
echo "ðŸ“‹ æŸ¥çœ‹æœ€æ–°æ—¥å¿—..."
docker compose logs --tail=20

echo ""
echo "========================================="
echo "  âœ… æ›´æ–°å®Œæˆï¼"
echo "========================================="
echo ""
echo "è®¿é—®åœ°å€: http://localhost:5000"
echo "æŸ¥çœ‹æ—¥å¿—: docker compose logs -f"
echo ""
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x update.sh

# æ‰§è¡Œæ›´æ–°
./update.sh
```

---

## ðŸ“‹ å®Œæ•´å‘½ä»¤æ¸…å•ï¼ˆå¤åˆ¶ç²˜è´´ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/crm

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# åœæ­¢å®¹å™¨
docker compose down

# é‡æ–°æž„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker compose build --no-cache

# å¯åŠ¨å®¹å™¨
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: git pull æç¤ºå†²çªæ€Žä¹ˆåŠžï¼Ÿ

```bash
# æŸ¥çœ‹å†²çªæ–‡ä»¶
git status

# å¦‚æžœç¡®å®šè¦ä½¿ç”¨è¿œç¨‹ç‰ˆæœ¬ï¼Œå¼ºåˆ¶è¦†ç›–
git fetch origin
git reset --hard origin/master
```

### Q2: Dockeræž„å»ºå¾ˆæ…¢æ€Žä¹ˆåŠžï¼Ÿ

**åŽŸå› **: å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–é•œåƒæºé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é…ç½®Dockeré•œåƒæº
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null << EOF
{
    "registry-mirrors": [
        "https://docker.mirrors.ustc.edu.cn",
        "https://hub-mirror.c.163.com"
    ]
}
EOF

# é‡å¯Docker
sudo systemctl restart docker

# é‡æ–°æž„å»º
docker compose build --no-cache
```

### Q3: å®¹å™¨å¯åŠ¨åŽç«‹å³é€€å‡ºæ€Žä¹ˆåŠžï¼Ÿ

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs

# æŸ¥çœ‹å®¹å™¨é€€å‡ºåŽŸå› 
docker compose ps -a

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker compose run --rm crm-app bash
```

---

## ðŸ“Š æ›´æ–°éªŒè¯æ¸…å•

- [ ] git pull æˆåŠŸ
- [ ] routes/admin.py åŒ…å« PIL å¯é€‰å¯¼å…¥
- [ ] requirements.txt åŒ…å« Pillow==10.1.0
- [ ] docker compose build æˆåŠŸ
- [ ] docker compose up æˆåŠŸ
- [ ] å®¹å™¨çŠ¶æ€ä¸º Up
- [ ] æ—¥å¿—ä¸­æ²¡æœ‰é”™è¯¯
- [ ] curl æµ‹è¯•è¿”å›ž 200
- [ ] æµè§ˆå™¨å¯ä»¥è®¿é—®ç™»å½•é¡µé¢

---

## ðŸŽ¯ é¢„æœŸç»“æžœ

æ›´æ–°æˆåŠŸåŽï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… å®¹å™¨æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰ PIL é”™è¯¯
2. âœ… è®¿é—® http://æœåŠ¡å™¨IP:5000 çœ‹åˆ°ç™»å½•é¡µé¢
3. âœ… ä½¿ç”¨ admin/admin123 ç™»å½•ç³»ç»Ÿ
4. âœ… Logoä¸Šä¼ åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

**å¿«é€Ÿæ›´æ–°å‘½ä»¤**ï¼ˆä¸€è¡Œæžå®šï¼‰:
```bash
cd ~/crm && git pull origin master && docker compose down && docker compose build --no-cache && docker compose up -d && docker compose logs -f
```

