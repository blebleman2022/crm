# 沟通记录填写人功能说明

## 📋 功能概述

为沟通记录添加填写人信息，在学员详情页显示每条沟通记录的填写人姓名和角色。

## 🔧 数据库变更

### 新增字段

在 `communication_records` 表中添加了 `user_id` 字段：

```sql
ALTER TABLE communication_records ADD COLUMN user_id INTEGER;
```

### 字段说明

- **字段名**: `user_id`
- **类型**: INTEGER
- **可空**: 是（允许为空，兼容历史数据）
- **外键**: 关联到 `users.id`
- **用途**: 记录沟通记录的填写人

## 📦 部署步骤

### 1. 更新代码

```bash
git pull origin master
```

### 2. 执行数据库迁移

在服务器上执行以下命令添加 `user_id` 字段：

```bash
cd /path/to/crm
source venv/bin/activate

# 使用Python执行迁移
python -c "
from run import create_app
from models import db
from sqlalchemy import text

app = create_app('production')

with app.app_context():
    try:
        # 检查字段是否已存在
        result = db.session.execute(
            text(\"SELECT COUNT(*) FROM pragma_table_info('communication_records') WHERE name='user_id'\")
        ).scalar()
        
        if result == 0:
            # 添加user_id字段
            db.session.execute(
                text('ALTER TABLE communication_records ADD COLUMN user_id INTEGER')
            )
            db.session.commit()
            print('✅ 成功添加user_id字段到communication_records表')
        else:
            print('ℹ️  user_id字段已存在，跳过添加')
            
    except Exception as e:
        db.session.rollback()
        print(f'❌ 添加字段失败: {e}')
        raise
"
```

### 3. 重启服务

```bash
# 如果使用systemd
sudo systemctl restart crm

# 或者如果使用其他方式
# 停止并重新启动应用
```

## 💡 功能说明

### 1. 数据模型变更

**models.py**:
```python
class CommunicationRecord(db.Model):
    # ... 其他字段 ...
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True, comment='填写人ID')
    
    # 关联关系
    user = db.relationship('User', backref='communication_records')
```

### 2. API变更

**添加沟通记录时可传入填写人ID**:

```python
# 线索阶段
CommunicationManager.add_lead_communication(
    lead_id=1,
    content="沟通内容",
    user_id=current_user.id  # 新增参数
)

# 客户阶段
CommunicationManager.add_customer_communication(
    lead_id=1,
    customer_id=1,
    content="沟通内容",
    user_id=current_user.id  # 新增参数
)
```

**API返回数据包含填写人信息**:

```json
{
  "communications": [
    {
      "id": 1,
      "content": "沟通内容",
      "created_at": "2025-10-04 13:40",
      "user_name": "张三",
      "user_role": "sales_manager"
    }
  ]
}
```

### 3. 前端显示

在学员详情模态框中显示填写人信息：

- **格式**: `用户名老师（角色）`
- **示例**: 
  - 张三老师（销售管理）
  - 李四老师（销售）
  - 王五老师（班主任）
  - 赵六老师（管理员）

**角色映射**:
- `admin` → 管理员
- `sales_manager` → 销售管理
- `salesperson` → 销售
- `teacher` → 班主任

## 🔄 兼容性说明

### 历史数据处理

- 历史沟通记录的 `user_id` 字段为 `NULL`
- 前端会显示为"未知用户老师"（如果没有填写人信息）
- 不影响现有功能的正常使用

### 向后兼容

- `user_id` 参数为可选参数，默认为 `None`
- 不传入 `user_id` 时，记录仍可正常创建
- 旧版本代码调用新API不会报错

## ✅ 测试验证

### 测试场景

1. **线索详情页**:
   - ✅ 显示线索阶段沟通记录
   - ✅ 显示填写人姓名和角色
   - ✅ 角色中文映射正确

2. **客户详情页**:
   - ✅ 显示客户阶段沟通记录
   - ✅ 显示填写人姓名和角色
   - ✅ 角色中文映射正确

3. **历史数据**:
   - ✅ 无填写人的记录正常显示
   - ✅ 不影响其他功能

## 📝 注意事项

1. **数据库迁移**必须在更新代码后执行
2. 迁移脚本是**幂等**的，可以重复执行
3. 建议在**低峰期**执行迁移
4. 迁移前建议**备份数据库**
5. 新增沟通记录时建议传入 `user_id` 参数

## 🔗 相关文件

- `models.py` - 数据模型定义
- `communication_utils.py` - 沟通记录管理工具
- `routes/leads.py` - 线索API
- `routes/customers.py` - 客户API
- `templates/components/student_detail_modal.html` - 学员详情模态框

## 📅 更新日期

2025-10-04

