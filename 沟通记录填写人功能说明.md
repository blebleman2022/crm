# æ²Ÿé€šè®°å½•å¡«å†™äººåŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ºæ²Ÿé€šè®°å½•æ·»åŠ å¡«å†™äººä¿¡æ¯ï¼Œåœ¨å­¦å‘˜è¯¦æƒ…é¡µæ˜¾ç¤ºæ¯æ¡æ²Ÿé€šè®°å½•çš„å¡«å†™äººå§“åå’Œè§’è‰²ã€‚

## ğŸ”§ æ•°æ®åº“å˜æ›´

### æ–°å¢å­—æ®µ

åœ¨ `communication_records` è¡¨ä¸­æ·»åŠ äº† `user_id` å­—æ®µï¼š

```sql
ALTER TABLE communication_records ADD COLUMN user_id INTEGER;
```

### å­—æ®µè¯´æ˜

- **å­—æ®µå**: `user_id`
- **ç±»å‹**: INTEGER
- **å¯ç©º**: æ˜¯ï¼ˆå…è®¸ä¸ºç©ºï¼Œå…¼å®¹å†å²æ•°æ®ï¼‰
- **å¤–é”®**: å…³è”åˆ° `users.id`
- **ç”¨é€”**: è®°å½•æ²Ÿé€šè®°å½•çš„å¡«å†™äºº

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°ä»£ç 

```bash
git pull origin master
```

### 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ·»åŠ  `user_id` å­—æ®µï¼š

```bash
cd /path/to/crm
source venv/bin/activate

# ä½¿ç”¨Pythonæ‰§è¡Œè¿ç§»
python -c "
from run import create_app
from models import db
from sqlalchemy import text

app = create_app('production')

with app.app_context():
    try:
        # æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨
        result = db.session.execute(
            text(\"SELECT COUNT(*) FROM pragma_table_info('communication_records') WHERE name='user_id'\")
        ).scalar()
        
        if result == 0:
            # æ·»åŠ user_idå­—æ®µ
            db.session.execute(
                text('ALTER TABLE communication_records ADD COLUMN user_id INTEGER')
            )
            db.session.commit()
            print('âœ… æˆåŠŸæ·»åŠ user_idå­—æ®µåˆ°communication_recordsè¡¨')
        else:
            print('â„¹ï¸  user_idå­—æ®µå·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ')
            
    except Exception as e:
        db.session.rollback()
        print(f'âŒ æ·»åŠ å­—æ®µå¤±è´¥: {e}')
        raise
"
```

### 3. é‡å¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨systemd
sudo systemctl restart crm

# æˆ–è€…å¦‚æœä½¿ç”¨å…¶ä»–æ–¹å¼
# åœæ­¢å¹¶é‡æ–°å¯åŠ¨åº”ç”¨
```

## ğŸ’¡ åŠŸèƒ½è¯´æ˜

### 1. æ•°æ®æ¨¡å‹å˜æ›´

**models.py**:
```python
class CommunicationRecord(db.Model):
    # ... å…¶ä»–å­—æ®µ ...
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True, comment='å¡«å†™äººID')
    
    # å…³è”å…³ç³»
    user = db.relationship('User', backref='communication_records')
```

### 2. APIå˜æ›´

**æ·»åŠ æ²Ÿé€šè®°å½•æ—¶å¯ä¼ å…¥å¡«å†™äººID**:

```python
# çº¿ç´¢é˜¶æ®µ
CommunicationManager.add_lead_communication(
    lead_id=1,
    content="æ²Ÿé€šå†…å®¹",
    user_id=current_user.id  # æ–°å¢å‚æ•°
)

# å®¢æˆ·é˜¶æ®µ
CommunicationManager.add_customer_communication(
    lead_id=1,
    customer_id=1,
    content="æ²Ÿé€šå†…å®¹",
    user_id=current_user.id  # æ–°å¢å‚æ•°
)
```

**APIè¿”å›æ•°æ®åŒ…å«å¡«å†™äººä¿¡æ¯**:

```json
{
  "communications": [
    {
      "id": 1,
      "content": "æ²Ÿé€šå†…å®¹",
      "created_at": "2025-10-04 13:40",
      "user_name": "å¼ ä¸‰",
      "user_role": "sales_manager"
    }
  ]
}
```

### 3. å‰ç«¯æ˜¾ç¤º

åœ¨å­¦å‘˜è¯¦æƒ…æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºå¡«å†™äººä¿¡æ¯ï¼š

- **æ ¼å¼**: `ç”¨æˆ·åè€å¸ˆï¼ˆè§’è‰²ï¼‰`
- **ç¤ºä¾‹**: 
  - å¼ ä¸‰è€å¸ˆï¼ˆé”€å”®ç®¡ç†ï¼‰
  - æå››è€å¸ˆï¼ˆé”€å”®ï¼‰
  - ç‹äº”è€å¸ˆï¼ˆç­ä¸»ä»»ï¼‰
  - èµµå…­è€å¸ˆï¼ˆç®¡ç†å‘˜ï¼‰

**è§’è‰²æ˜ å°„**:
- `admin` â†’ ç®¡ç†å‘˜
- `sales_manager` â†’ é”€å”®ç®¡ç†
- `salesperson` â†’ é”€å”®
- `teacher` â†’ ç­ä¸»ä»»

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### å†å²æ•°æ®å¤„ç†

- å†å²æ²Ÿé€šè®°å½•çš„ `user_id` å­—æ®µä¸º `NULL`
- å‰ç«¯ä¼šæ˜¾ç¤ºä¸º"æœªçŸ¥ç”¨æˆ·è€å¸ˆ"ï¼ˆå¦‚æœæ²¡æœ‰å¡«å†™äººä¿¡æ¯ï¼‰
- ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨

### å‘åå…¼å®¹

- `user_id` å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œé»˜è®¤ä¸º `None`
- ä¸ä¼ å…¥ `user_id` æ—¶ï¼Œè®°å½•ä»å¯æ­£å¸¸åˆ›å»º
- æ—§ç‰ˆæœ¬ä»£ç è°ƒç”¨æ–°APIä¸ä¼šæŠ¥é”™

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **çº¿ç´¢è¯¦æƒ…é¡µ**:
   - âœ… æ˜¾ç¤ºçº¿ç´¢é˜¶æ®µæ²Ÿé€šè®°å½•
   - âœ… æ˜¾ç¤ºå¡«å†™äººå§“åå’Œè§’è‰²
   - âœ… è§’è‰²ä¸­æ–‡æ˜ å°„æ­£ç¡®

2. **å®¢æˆ·è¯¦æƒ…é¡µ**:
   - âœ… æ˜¾ç¤ºå®¢æˆ·é˜¶æ®µæ²Ÿé€šè®°å½•
   - âœ… æ˜¾ç¤ºå¡«å†™äººå§“åå’Œè§’è‰²
   - âœ… è§’è‰²ä¸­æ–‡æ˜ å°„æ­£ç¡®

3. **å†å²æ•°æ®**:
   - âœ… æ— å¡«å†™äººçš„è®°å½•æ­£å¸¸æ˜¾ç¤º
   - âœ… ä¸å½±å“å…¶ä»–åŠŸèƒ½

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**å¿…é¡»åœ¨æ›´æ–°ä»£ç åæ‰§è¡Œ
2. è¿ç§»è„šæœ¬æ˜¯**å¹‚ç­‰**çš„ï¼Œå¯ä»¥é‡å¤æ‰§è¡Œ
3. å»ºè®®åœ¨**ä½å³°æœŸ**æ‰§è¡Œè¿ç§»
4. è¿ç§»å‰å»ºè®®**å¤‡ä»½æ•°æ®åº“**
5. æ–°å¢æ²Ÿé€šè®°å½•æ—¶å»ºè®®ä¼ å…¥ `user_id` å‚æ•°

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `models.py` - æ•°æ®æ¨¡å‹å®šä¹‰
- `communication_utils.py` - æ²Ÿé€šè®°å½•ç®¡ç†å·¥å…·
- `routes/leads.py` - çº¿ç´¢API
- `routes/customers.py` - å®¢æˆ·API
- `templates/components/student_detail_modal.html` - å­¦å‘˜è¯¦æƒ…æ¨¡æ€æ¡†

## ğŸ“… æ›´æ–°æ—¥æœŸ

2025-10-04

