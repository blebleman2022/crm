# 云服务器更新部署步骤

## 📋 本次更新内容（2025-10-30）

### 功能更新
- ✅ **付款记录锁定功能**：管理员可设置锁定月份，防止班主任修改历史付款记录
  - 系统配置表（SystemConfig模型）
  - 管理员后台锁定管理页面
  - 后端API和锁定验证逻辑
  - 前端锁定状态显示
- ✅ **付款管理优化**：
  - 时间筛选功能
  - 统计模块优化（客户总数、总金额、付款总额）
  - 筛选时间段内的付款统计
- ✅ **项目清理**：删除失效文件和旧备份，项目结构更清晰

### 数据库变更
- ✅ 新增 `system_config` 表，用于存储系统配置
- ✅ 新增 `customer_payments` 表，用于管理客户付款信息
- ✅ 所有数据库迁移已整合到 `migrate_database.py`

---

## 🚀 一键部署（推荐）

### 步骤1：登录服务器并进入项目目录

```bash
# 登录服务器
ssh user@your-server

# 进入项目目录（根据实际路径调整）
cd /path/to/CRM1
```

### 步骤2：执行部署脚本

```bash
# 一键部署（自动完成所有步骤）
bash deploy_update.sh
```

**脚本会自动完成：**
1. ✅ 备份数据库到 `backups/` 目录
2. ✅ 停止当前运行的服务
3. ✅ 拉取最新代码
4. ✅ 安装/更新依赖
5. ✅ 执行数据库迁移（自动创建新表和字段）
6. ✅ 验证数据库完整性
7. ✅ 启动服务

### 步骤3：验证部署成功

**如果使用 systemd 服务：**

```bash
# 查看服务状态
sudo systemctl status crm

# 查看实时日志
sudo journalctl -u crm -f
```

**如果使用手动启动：**

```bash
# 检查服务是否运行
ps aux | grep gunicorn

# 查看日志
tail -f logs/app.log
```

**测试功能：**

```bash
# 测试访问（替换为实际地址）
curl http://localhost:5000/auth/login
```

---

## 📝 手动部署（可选）

如果需要更精细的控制，可以手动执行以下步骤：

### 1. 备份数据库

```bash
mkdir -p backups
cp instance/edu_crm.db backups/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db
ls -lh backups/
```

### 2. 停止服务

**如果使用 systemd：**
```bash
sudo systemctl stop crm
```

**如果手动启动：**
```bash
pkill -f "gunicorn.*run:app"
pkill -f "python.*run.py"
```

### 3. 更新代码

```bash
git fetch origin
git pull origin master
```

### 4. 安装依赖

```bash
source venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn
```

### 5. 执行数据库迁移

```bash
# 执行数据库迁移（自动创建所有表和字段）
python migrate_database.py
```

### 6. 验证数据库

```bash
# 检查数据库完整性
sqlite3 instance/edu_crm.db "PRAGMA integrity_check;"

# 验证新表是否创建成功
sqlite3 instance/edu_crm.db ".tables" | grep -E "system_config|customer_payments"
```

### 7. 启动服务

**如果使用 systemd：**
```bash
sudo systemctl start crm
sudo systemctl status crm
```

**如果手动启动：**
```bash
export FLASK_ENV=production
mkdir -p logs
nohup gunicorn -w 4 -b 0.0.0.0:5000 --timeout 120 --access-logfile logs/access.log --error-logfile logs/error.log run:app > logs/app.log 2>&1 &
```

---

## 🔍 验证迁移成功

### 检查数据库表

```bash
# 进入数据库
sqlite3 instance/edu_crm.db

# 查看所有表
.tables

# 查看 system_config 表结构
.schema system_config

# 查看 customer_payments 表结构
.schema customer_payments

# 查看系统配置
SELECT * FROM system_config;

# 退出
.quit
```

### 预期结果

```sql
-- 应该包含以下新表
system_config
customer_payments

-- system_config 表结构
CREATE TABLE system_config (
    id INTEGER NOT NULL,
    config_key VARCHAR(50) NOT NULL,
    config_value VARCHAR(200),
    description VARCHAR(200),
    created_at DATETIME,
    updated_at DATETIME,
    updated_by INTEGER,
    PRIMARY KEY (id),
    UNIQUE (config_key),
    FOREIGN KEY(updated_by) REFERENCES users (id)
);

-- customer_payments 表结构
CREATE TABLE customer_payments (
    customer_id INTEGER NOT NULL,
    first_payment NUMERIC(10, 2),
    first_payment_date DATE,
    second_payment NUMERIC(10, 2),
    second_payment_date DATE,
    third_payment NUMERIC(10, 2),
    third_payment_date DATE,
    total_amount NUMERIC(10, 2),
    PRIMARY KEY (customer_id),
    FOREIGN KEY(customer_id) REFERENCES customers (id)
);
```

---

## 🔄 回滚方案

如果部署出现问题，可以快速回滚：

### 方法1：恢复数据库备份

```bash
# 停止服务
sudo systemctl stop crm
# 或
pkill -f "gunicorn.*run:app"

# 查看备份列表
ls -lh backups/

# 恢复最新备份（替换时间戳）
cp backups/edu_crm_backup_20241029_120000.db instance/edu_crm.db

# 重启服务
sudo systemctl start crm
# 或
nohup gunicorn -w 4 -b 0.0.0.0:5000 run:app > logs/app.log 2>&1 &
```

### 方法2：回滚代码

```bash
# 查看提交历史
git log -5 --oneline

# 回滚到上一个版本
git reset --hard HEAD~1

# 重启服务
sudo systemctl restart crm
```

---

## ⚠️ 注意事项

### 1. 数据迁移说明

- **新表创建**：自动创建 `system_config` 和 `customer_payments` 表
- **现有数据**：不影响现有客户和线索数据
- **数据安全**：迁移前会自动备份，失败可回滚

### 2. 业务影响

- **新功能**：管理员可以锁定付款记录，防止历史数据被修改
- **权限变化**：
  - 管理员：可设置付款锁定月份
  - 班主任：无法修改被锁定月份及之前的付款记录
- **用户体验**：被锁定的付款记录显示灰色背景，无法编辑

### 3. 兼容性

- **向后兼容**：不影响现有功能
- **数据完整性**：所有关联关系保持正确
- **幂等操作**：重复执行迁移脚本不会出错

---

## 🛠️ 常用命令

### Systemd 服务管理

```bash
# 查看服务状态
sudo systemctl status crm

# 启动服务
sudo systemctl start crm

# 停止服务
sudo systemctl stop crm

# 重启服务
sudo systemctl restart crm

# 查看实时日志
sudo journalctl -u crm -f

# 查看最近100条日志
sudo journalctl -u crm -n 100
```

### 手动服务管理

```bash
# 查看进程
ps aux | grep gunicorn

# 停止服务
pkill -f "gunicorn.*run:app"

# 查看日志
tail -f logs/app.log
tail -f logs/error.log
tail -f logs/access.log
```

### 数据库操作

```bash
# 进入数据库
sqlite3 instance/edu_crm.db

# 查看所有表
.tables

# 查看表结构
.schema teachers

# 查询数据
SELECT * FROM teachers;
SELECT * FROM users WHERE role='teacher_supervisor';

# 退出
.quit
```

---

## 📞 故障排查

### 问题1：服务启动失败

```bash
# 查看详细错误
tail -50 logs/app.log
sudo journalctl -u crm -n 50

# 检查端口占用
lsof -i :5000

# 检查 Python 环境
which python
python --version
```

### 问题2：数据库迁移失败

```bash
# 查看迁移日志
cat logs/app.log | grep -i migration

# 手动执行迁移
source venv/bin/activate
python migrate_database.py

# 检查数据库完整性
sqlite3 instance/edu_crm.db "PRAGMA integrity_check;"
```

### 问题3：权限问题

```bash
# 检查文件权限
ls -lh instance/edu_crm.db

# 修复权限（根据实际用户调整）
chmod 644 instance/edu_crm.db
chown www-data:www-data instance/edu_crm.db
```

---

## ✅ 部署检查清单

**部署前：**
- [ ] 已登录服务器
- [ ] 已进入项目目录
- [ ] 已确认当前服务运行正常

**部署中：**
- [ ] 数据库已自动备份
- [ ] 代码已更新
- [ ] 依赖已安装
- [ ] 数据库迁移已完成
- [ ] 服务已重启

**部署后：**
- [ ] 服务运行正常
- [ ] 日志无错误
- [ ] 登录功能正常
- [ ] 老师管理功能正常
- [ ] 数据隔离功能正常

---

## 📊 预期结果

部署成功后，系统应该：

1. ✅ **服务正常运行**：可以正常访问登录页面
2. ✅ **数据库已更新**：包含 `system_config` 和 `customer_payments` 表
3. ✅ **付款管理功能正常**：班主任可以管理客户付款信息
4. ✅ **付款锁定功能正常**：管理员可以设置锁定月份
5. ✅ **锁定验证正常**：被锁定的付款记录无法编辑
6. ✅ **统计功能正常**：显示客户总数、总金额、付款总额

---

**祝部署顺利！** 🎉

如有问题，请查看日志文件或联系技术支持。

