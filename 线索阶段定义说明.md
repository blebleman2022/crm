# 线索阶段定义说明

## 📋 概述

本文档详细说明了EduConnect CRM系统中线索阶段（stage）的定义、自动更新逻辑和使用方式。

**文档版本**: v1.0  
**更新时间**: 2025-09-30  
**系统**: EduConnect CRM

---

## 🎯 线索阶段定义

### 当前系统中的阶段

根据代码分析，系统中定义了以下线索阶段：

| 阶段名称 | 英文标识 | 触发条件 | 优先级 |
|---------|---------|---------|--------|
| **获取联系方式** | contact | 默认初始阶段 | 5（最低） |
| **线下见面** | meeting | 设置了见面时间（meeting_at） | 4 |
| **首笔支付** | deposit | 有1笔付款记录 | 3 |
| **次笔支付** | payment | 有2笔或以上付款记录 | 2 |
| **全款支付** | full_payment | 已付款 ≥ 合同金额（且合同金额 > 0） | 1（最高） |

### 数据库中的实际值

根据数据库查询，当前实际使用的阶段值：
- `初步接触`
- `合同签订`

**⚠️ 发现问题**: 代码定义与数据库实际值不一致！

---

## 🔄 自动更新逻辑

### 核心函数

**文件**: `routes/leads.py`  
**函数**: `auto_update_lead_stage(lead)`

### 更新规则（按优先级从高到低）

```python
def auto_update_lead_stage(lead):
    """根据线索的各种操作自动更新阶段"""
    # 获取该线索的所有付款记录
    payments = Payment.query.filter_by(lead_id=lead.id).order_by(Payment.payment_date.asc()).all()
    
    # 计算已付款总额
    total_paid = sum(payment.amount for payment in payments) if payments else 0
    contract_amount = lead.contract_amount or 0
    
    # 阶段判断逻辑（按优先级从高到低）
    
    # 1. 如果已付款等于或超过合同金额，且合同金额大于0，则为"全款支付"
    if contract_amount > 0 and total_paid >= contract_amount:
        lead.stage = '全款支付'
    
    # 2. 如果有两笔或以上付款，则为"次笔支付"
    elif len(payments) >= 2:
        lead.stage = '次笔支付'
    
    # 3. 如果有一笔付款，则为"首笔支付"
    elif len(payments) >= 1:
        lead.stage = '首笔支付'
    
    # 4. 如果设置了见面时间，则为"线下见面"
    elif lead.meeting_at:
        lead.stage = '线下见面'
    
    # 5. 默认为"获取联系方式"
    else:
        lead.stage = '获取联系方式'
```

### 触发时机

阶段自动更新会在以下操作时触发：

1. **添加付款记录** - 自动根据付款次数更新阶段
2. **删除付款记录** - 重新计算阶段
3. **设置见面时间** - 如果没有付款，更新为"线下见面"
4. **修改合同金额** - 重新判断是否达到"全款支付"

---

## 📊 阶段流转图

```
┌─────────────────┐
│  获取联系方式    │ ← 初始阶段
└────────┬────────┘
         │ 设置见面时间
         ▼
┌─────────────────┐
│   线下见面      │
└────────┬────────┘
         │ 第1笔付款
         ▼
┌─────────────────┐
│   首笔支付      │
└────────┬────────┘
         │ 第2笔付款
         ▼
┌─────────────────┐
│   次笔支付      │
└────────┬────────┘
         │ 付款总额 ≥ 合同金额
         ▼
┌─────────────────┐
│   全款支付      │ ← 最终阶段
└─────────────────┘
```

---

## 🎨 前端显示

### 阶段颜色标识

**文件**: `templates/leads/detail.html`

```html
<span class="mt-1 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
    {% if lead.stage == '获取联系方式' %}bg-blue-100 text-blue-800
    {% elif lead.stage == '线下见面' %}bg-yellow-100 text-yellow-800
    {% elif lead.stage == '定金支付' %}bg-orange-100 text-orange-800
    {% elif lead.stage == '次笔款项支付' %}bg-green-100 text-green-800
    {% else %}bg-gray-100 text-gray-800{% endif %}">
    {{ lead.stage }}
</span>
```

### 颜色方案

| 阶段 | 背景色 | 文字色 | 说明 |
|------|--------|--------|------|
| 获取联系方式 | `bg-blue-100` | `text-blue-800` | 蓝色 - 初始阶段 |
| 线下见面 | `bg-yellow-100` | `text-yellow-800` | 黄色 - 进行中 |
| 定金支付 | `bg-orange-100` | `text-orange-800` | 橙色 - 有进展 |
| 次笔款项支付 | `bg-green-100` | `text-green-800` | 绿色 - 接近完成 |
| 其他 | `bg-gray-100` | `text-gray-800` | 灰色 - 默认 |

---

## ⚠️ 发现的问题

### 1. 代码与数据库不一致

**代码中定义的阶段**:
- 获取联系方式
- 线下见面
- 首笔支付
- 次笔支付
- 全款支付

**数据库中实际的阶段**:
- 初步接触
- 合同签订

**问题**: 阶段名称不匹配，可能导致：
- 前端显示异常（颜色标识不正确）
- 业务逻辑混乱
- 数据统计错误

### 2. 前端显示不一致

**detail.html中的阶段**:
- 获取联系方式
- 线下见面
- 定金支付 ⚠️（代码中是"首笔支付"）
- 次笔款项支付 ⚠️（代码中是"次笔支付"）

**问题**: 前端显示的阶段名称与后端逻辑不一致

### 3. 验证器中的定义不一致

**文件**: `utils/validators.py`

```python
def validate_lead_stage_transition(current_stage, new_stage):
    stages = ['获取联系方式', '线下见面', '定金支付', '第二笔款项支付']
```

**问题**: 验证器中的阶段定义与自动更新逻辑不一致

---

## 🔧 建议的修复方案

### 方案1: 统一为代码定义的阶段（推荐）

**优点**: 
- 代码逻辑已经完善
- 自动更新机制已实现
- 修改成本低

**需要修改**:
1. 更新数据库中的现有数据
2. 统一前端显示名称
3. 更新验证器定义

**修改步骤**:

```sql
-- 1. 更新数据库中的阶段值
UPDATE leads SET stage = '获取联系方式' WHERE stage = '初步接触';
UPDATE leads SET stage = '全款支付' WHERE stage = '合同签订';

-- 2. 验证更新结果
SELECT DISTINCT stage FROM leads;
```

```python
# 2. 统一前端显示（templates/leads/detail.html）
{% if lead.stage == '获取联系方式' %}bg-blue-100 text-blue-800
{% elif lead.stage == '线下见面' %}bg-yellow-100 text-yellow-800
{% elif lead.stage == '首笔支付' %}bg-orange-100 text-orange-800
{% elif lead.stage == '次笔支付' %}bg-green-100 text-green-800
{% elif lead.stage == '全款支付' %}bg-purple-100 text-purple-800
{% else %}bg-gray-100 text-gray-800{% endif %}

# 3. 更新验证器（utils/validators.py）
stages = ['获取联系方式', '线下见面', '首笔支付', '次笔支付', '全款支付']
```

### 方案2: 统一为数据库中的阶段

**优点**: 
- 保持现有数据不变
- 可能更符合业务术语

**缺点**:
- 需要修改大量代码
- 自动更新逻辑需要重写
- 修改成本高

**不推荐此方案**

---

## 📝 标准化定义（推荐）

### 统一后的阶段定义

| 阶段名称 | 英文标识 | 触发条件 | 颜色标识 |
|---------|---------|---------|---------|
| **获取联系方式** | contact | 默认初始阶段 | 蓝色 |
| **线下见面** | meeting | 设置了见面时间 | 黄色 |
| **首笔支付** | first_payment | 有1笔付款记录 | 橙色 |
| **次笔支付** | second_payment | 有2笔或以上付款记录 | 绿色 |
| **全款支付** | full_payment | 已付款 ≥ 合同金额 | 紫色 |

### 数据库字段

```python
# models.py
class Lead(db.Model):
    stage = db.Column(db.String(50), nullable=False, comment='线索阶段')
    
    # 允许的阶段值
    ALLOWED_STAGES = [
        '获取联系方式',
        '线下见面',
        '首笔支付',
        '次笔支付',
        '全款支付'
    ]
```

### 前端显示映射

```python
# 阶段显示配置
STAGE_DISPLAY = {
    '获取联系方式': {
        'color': 'blue',
        'icon': 'contact_phone',
        'description': '已获取家长联系方式'
    },
    '线下见面': {
        'color': 'yellow',
        'icon': 'meeting_room',
        'description': '已安排线下见面'
    },
    '首笔支付': {
        'color': 'orange',
        'icon': 'payment',
        'description': '已收到首笔款项'
    },
    '次笔支付': {
        'color': 'green',
        'icon': 'payments',
        'description': '已收到第二笔款项'
    },
    '全款支付': {
        'color': 'purple',
        'icon': 'check_circle',
        'description': '已完成全款支付'
    }
}
```

---

## 🚀 实施建议

### 立即执行

1. ✅ **数据清理** - 统一数据库中的阶段值
2. ✅ **前端统一** - 更新所有模板中的阶段显示
3. ✅ **验证器更新** - 统一验证器中的阶段定义

### 短期优化

1. 📝 **添加阶段常量** - 在models.py中定义阶段常量
2. 📝 **添加验证器** - 使用SQLAlchemy的@validates装饰器
3. 📝 **文档完善** - 更新所有相关文档

### 长期优化

1. 🔍 **阶段分析** - 添加阶段转换统计
2. 📈 **转化率分析** - 分析各阶段的转化率
3. 🎯 **预警机制** - 长时间停留在某阶段的预警

---

## 📚 相关文件

### 核心文件

1. **models.py** - 数据模型定义
2. **routes/leads.py** - 线索路由和自动更新逻辑
3. **utils/validators.py** - 阶段验证器

### 模板文件

1. **templates/leads/detail.html** - 线索详情页（阶段显示）
2. **templates/leads/edit.html** - 线索编辑页
3. **templates/leads/list.html** - 线索列表页

---

## 💡 总结

### 当前状态

- ⚠️ **代码定义**: 获取联系方式、线下见面、首笔支付、次笔支付、全款支付
- ⚠️ **数据库实际**: 初步接触、合同签订
- ⚠️ **前端显示**: 获取联系方式、线下见面、定金支付、次笔款项支付
- ⚠️ **验证器**: 获取联系方式、线下见面、定金支付、第二笔款项支付

### 问题

1. ❌ 阶段名称不统一
2. ❌ 代码与数据不一致
3. ❌ 前端显示与后端逻辑不匹配
4. ❌ 验证器定义不一致

### 建议

1. ✅ 统一使用代码中定义的阶段名称
2. ✅ 更新数据库中的现有数据
3. ✅ 统一所有前端显示
4. ✅ 更新验证器定义
5. ✅ 添加阶段常量和验证器

---

**需要立即执行数据清理和统一工作，确保系统的一致性和稳定性！** ⚠️

