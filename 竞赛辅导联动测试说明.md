# 竞赛辅导与奖项等级联动功能测试说明

**功能**: 线索编辑页面，竞赛奖项等级选项与竞赛辅导服务联动  
**测试日期**: 2025-09-30  
**测试地址**: http://localhost:5001

---

## 📋 功能说明

### 业务逻辑

只有当销售选择了"竞赛辅导"服务时，才需要设置"竞赛奖项等级"（市奖/国奖）。

### 联动规则

1. **未选中竞赛辅导** → 隐藏奖项等级选择框
2. **选中竞赛辅导** → 显示奖项等级选择框，且必须选择
3. **取消竞赛辅导** → 隐藏奖项等级选择框，并清空已选值

---

## 🧪 手动测试步骤

### 步骤1：登录系统

1. 打开浏览器访问：http://localhost:5001
2. 使用管理员账号登录：
   - 手机号：`13909999451`
   - 点击"登录"按钮

### 步骤2：进入线索编辑页面

1. 点击左侧菜单"线索管理"
2. 找到任意一条线索，点击"编辑"按钮
3. 进入线索编辑页面

### 步骤3：测试联动效果

#### 测试3.1：初始状态检查

**操作**：查看页面初始状态

**预期结果**：
- 如果"竞赛辅导"复选框**已选中** → 奖项等级选择框**可见**
- 如果"竞赛辅导"复选框**未选中** → 奖项等级选择框**隐藏**

#### 测试3.2：选中竞赛辅导

**操作**：
1. 勾选"竞赛辅导"复选框

**预期结果**：
- ✅ 奖项等级选择框**立即显示**
- ✅ 显示标签"竞赛奖项等级 *"（带红色星号）
- ✅ 显示提示文字"选择了竞赛辅导服务，必须设置目标奖项等级"

#### 测试3.3：取消竞赛辅导

**操作**：
1. 取消勾选"竞赛辅导"复选框

**预期结果**：
- ✅ 奖项等级选择框**立即隐藏**
- ✅ 奖项等级的值被**自动清空**

#### 测试3.4：表单验证（选中竞赛但不选奖项）

**操作**：
1. 勾选"竞赛辅导"复选框
2. 奖项等级选择框保持"请选择目标奖项等级"（空值）
3. 点击"保存"按钮

**预期结果**：
- ✅ 弹出警告框："选择了竞赛辅导服务，必须设置目标奖项等级！"
- ✅ 表单**不提交**，停留在编辑页面
- ✅ 焦点自动定位到奖项等级选择框

#### 测试3.5：正确填写并提交

**操作**：
1. 勾选"竞赛辅导"复选框
2. 在奖项等级选择框中选择"国奖"或"市奖"
3. 点击"保存"按钮

**预期结果**：
- ✅ 表单**成功提交**
- ✅ 跳转到线索列表页面
- ✅ 显示成功提示消息

#### 测试3.6：服务器端验证

**操作**：
1. 使用浏览器开发者工具，修改HTML，删除JavaScript验证
2. 勾选"竞赛辅导"，但不选奖项等级
3. 提交表单

**预期结果**：
- ✅ 服务器返回错误消息："选择了竞赛辅导服务，必须设置目标奖项等级"
- ✅ 表单不提交，停留在编辑页面

---

## 🎯 测试检查清单

### 前端联动

- [ ] 选中竞赛辅导 → 显示奖项等级
- [ ] 取消竞赛辅导 → 隐藏奖项等级
- [ ] 取消竞赛辅导 → 清空奖项等级值
- [ ] 页面加载时正确显示/隐藏

### 前端验证

- [ ] 选中竞赛但不选奖项 → 弹出警告
- [ ] 警告后焦点定位到选择框
- [ ] 正确填写后可以提交

### 后端验证

- [ ] 服务器端验证竞赛和奖项的联动
- [ ] 返回正确的错误消息
- [ ] 数据正确保存到数据库

---

## 💻 技术实现

### 前端代码 (templates/leads/edit.html)

#### HTML结构

```html
<!-- 竞赛奖项等级（仅在选择竞赛辅导时显示） -->
<div class="mt-6" id="competition_award_level_section" style="display: none;">
    <label for="competition_award_level">
        竞赛奖项等级 <span class="text-red-500">*</span>
    </label>
    <select id="competition_award_level" name="competition_award_level">
        <option value="">请选择目标奖项等级</option>
        <option value="市奖">市奖</option>
        <option value="国奖">国奖</option>
    </select>
    <p>选择了竞赛辅导服务，必须设置目标奖项等级</p>
</div>
```

#### JavaScript联动逻辑

```javascript
// 更新奖项等级显示/隐藏
function updateCompetitionAwardLevelVisibility() {
    const competitionCheckbox = document.getElementById('service_competition');
    const awardLevelSection = document.getElementById('competition_award_level_section');
    const awardLevelSelect = document.getElementById('competition_award_level');
    
    if (competitionCheckbox && awardLevelSection) {
        if (competitionCheckbox.checked) {
            // 显示奖项等级选择
            awardLevelSection.style.display = 'block';
        } else {
            // 隐藏奖项等级选择，并清空值
            awardLevelSection.style.display = 'none';
            awardLevelSelect.value = '';
        }
    }
}

// 页面加载时检查
document.addEventListener('DOMContentLoaded', function() {
    updateCompetitionAwardLevelVisibility();
    
    // 监听复选框变化
    const competitionCheckbox = document.getElementById('service_competition');
    if (competitionCheckbox) {
        competitionCheckbox.addEventListener('change', updateCompetitionAwardLevelVisibility);
    }
});
```

#### JavaScript表单验证

```javascript
// 表单提交时验证
document.querySelector('form').addEventListener('submit', function(e) {
    const competitionCheckbox = document.getElementById('service_competition');
    const awardLevelSelect = document.getElementById('competition_award_level');
    
    if (competitionCheckbox && competitionCheckbox.checked) {
        if (!awardLevelSelect.value) {
            e.preventDefault();
            alert('选择了竞赛辅导服务，必须设置目标奖项等级！');
            awardLevelSelect.focus();
            return false;
        }
    }
    
    // ... 其他验证逻辑
});
```

### 后端代码 (routes/leads.py)

```python
@leads_bp.route('/<int:lead_id>/edit', methods=['GET', 'POST'])
def edit_lead(lead_id):
    if request.method == 'POST':
        # 获取服务类型
        service_types = request.form.getlist('service_types')
        competition_award_level = request.form.get('competition_award_level', '').strip()
        
        # 验证竞赛辅导和奖项等级的联动
        if 'competition' in service_types:
            if not competition_award_level:
                flash('选择了竞赛辅导服务，必须设置目标奖项等级', 'error')
                return render_template('leads/edit.html', lead=lead, ...)
        
        # 保存数据
        lead.set_service_types_list(service_types)
        lead.competition_award_level = competition_award_level if competition_award_level else None
        db.session.commit()
```

---

## 📸 预期效果截图说明

### 未选中竞赛辅导
```
服务类型：
  ☐ 课题辅导
  ☐ 竞赛辅导
  ☐ 升学陪跑

(奖项等级选择框隐藏)

额外要求：
  [文本框]
```

### 选中竞赛辅导
```
服务类型：
  ☑ 课题辅导
  ☑ 竞赛辅导
  ☐ 升学陪跑

竞赛奖项等级 *
  [请选择目标奖项等级 ▼]
  提示：选择了竞赛辅导服务，必须设置目标奖项等级

额外要求：
  [文本框]
```

---

## ✅ 测试结果记录

### 测试环境
- 浏览器：_____________
- 测试时间：_____________
- 测试人员：_____________

### 测试结果

| 测试项 | 预期结果 | 实际结果 | 通过 |
|-------|---------|---------|------|
| 初始状态检查 | 根据竞赛辅导状态显示/隐藏 | | ☐ |
| 选中竞赛辅导 | 显示奖项等级 | | ☐ |
| 取消竞赛辅导 | 隐藏并清空奖项等级 | | ☐ |
| 前端验证 | 阻止提交并提示 | | ☐ |
| 后端验证 | 返回错误消息 | | ☐ |
| 正确提交 | 成功保存 | | ☐ |

### 发现的问题

1. _____________________________________________
2. _____________________________________________
3. _____________________________________________

### 备注

_____________________________________________
_____________________________________________

---

**测试完成日期**: _______________  
**测试结论**: ☐ 通过 ☐ 不通过


