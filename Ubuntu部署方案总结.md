# Ubuntuç›´æ¥éƒ¨ç½²æ–¹æ¡ˆ - æœ€ç»ˆæ€»ç»“

## âœ… æ–¹æ¡ˆå·²å®Œæˆå¹¶éªŒè¯

### ğŸ“¦ æ ¸å¿ƒç»„ä»¶

1. **éƒ¨ç½²è„šæœ¬** - ubuntu-deploy.sh
   - âœ… ä½¿ç”¨Gunicornï¼ˆç”Ÿäº§çº§WSGIæœåŠ¡å™¨ï¼‰
   - âœ… è‡ªåŠ¨è®¡ç®—workeræ•°é‡ï¼ˆCPUæ ¸å¿ƒæ•° Ã— 2 + 1ï¼‰
   - âœ… è®¾ç½®ç”Ÿäº§ç¯å¢ƒï¼ˆFLASK_ENV=productionï¼‰
   - âœ… é…ç½®æ—¥å¿—è½®è½¬ï¼ˆæ¯å¤©è½®è½¬ï¼Œä¿ç•™14å¤©ï¼‰
   - âœ… é…ç½®Nginxåå‘ä»£ç†
   - âœ… é…ç½®systemdæœåŠ¡ï¼ˆå¼€æœºè‡ªå¯åŠ¨ï¼‰

2. **æ›´æ–°è„šæœ¬** - quick-update.sh
   - âœ… è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
   - âœ… ä¿æŠ¤æ•°æ®åº“æ–‡ä»¶
   - âœ… æ‹‰å–æœ€æ–°ä»£ç 
   - âœ… é‡å¯æœåŠ¡
   - âœ… 5-10ç§’å®Œæˆæ›´æ–°

3. **å¥åº·æ£€æŸ¥** - health-check.sh
   - âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€
   - âœ… æ£€æŸ¥HTTPå“åº”
   - âœ… æ£€æŸ¥ç«¯å£ç›‘å¬
   - âœ… æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
   - âœ… æ£€æŸ¥ç£ç›˜ç©ºé—´å’Œå†…å­˜
   - âœ… è‡ªåŠ¨é‡å¯å¤±è´¥çš„æœåŠ¡

4. **å¤‡ä»½æ¢å¤**
   - âœ… backup-to-gitee.sh - å®Œæ•´å¤‡ä»½åˆ°bakåˆ†æ”¯
   - âœ… restore-from-bak.sh - ä»bakåˆ†æ”¯æ¢å¤
   - âœ… åŒ…å«æ•°æ®åº“æ–‡ä»¶
   - âœ… ä¸‰é‡ä¿æŠ¤æœºåˆ¶

5. **é…ç½®æ–‡ä»¶**
   - âœ… config.py - Flaské…ç½®ï¼ˆç”Ÿäº§/å¼€å‘ç¯å¢ƒï¼‰
   - âœ… gunicorn.conf.py - Gunicorné…ç½®
   - âœ… requirements.txt - Pythonä¾èµ–ï¼ˆåŒ…å«gunicorn==21.2.0ï¼‰
   - âœ… run.py - åº”ç”¨å…¥å£ï¼ˆåŒ…å«/healthç«¯ç‚¹ï¼‰

---

## ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šçš„éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: é…ç½®Gitï¼ˆé¦–æ¬¡ï¼‰

```bash
cd ~/crm
git pull origin master
bash setup-git-config.sh
```

### æ­¥éª¤2: æ‰§è¡Œéƒ¨ç½²

```bash
sudo bash ubuntu-deploy.sh
```

**éƒ¨ç½²æ—¶é—´**: çº¦2-3åˆ†é’Ÿ

**è‡ªåŠ¨å®Œæˆ**:
- âœ… å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒ
- âœ… å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬Gunicornï¼‰
- âœ… é…ç½®systemdæœåŠ¡
- âœ… é…ç½®Nginxåå‘ä»£ç†
- âœ… é…ç½®æ—¥å¿—è½®è½¬
- âœ… å¯åŠ¨æœåŠ¡

### æ­¥éª¤3: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status crm

# æ£€æŸ¥å¥åº·ç«¯ç‚¹
curl -I http://localhost/health

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u crm -n 50
```

---

## âš¡ æ—¥å¸¸æ›´æ–°æµç¨‹

### æ–¹æ³•1: ä½¿ç”¨å¿«é€Ÿæ›´æ–°è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd ~/crm
bash quick-update.sh
```

**è€—æ—¶**: 5-10ç§’ âš¡

### æ–¹æ³•2: æ‰‹åŠ¨æ›´æ–°

```bash
cd ~/crm
git pull origin master
sudo systemctl restart crm
```

**è€—æ—¶**: 10ç§’ âš¡

---

## ğŸ“¦ å®Œæ•´å¤‡ä»½æµç¨‹

### å¤‡ä»½åˆ°Gitee bakåˆ†æ”¯

```bash
cd ~/crm
bash backup-to-gitee.sh
```

**å¤‡ä»½å†…å®¹**:
- âœ… æ‰€æœ‰æºä»£ç 
- âœ… æ•°æ®åº“æ–‡ä»¶
- âœ… é…ç½®æ–‡ä»¶
- âœ… é™æ€æ–‡ä»¶

### ä»bakåˆ†æ”¯æ¢å¤

```bash
cd ~/crm
bash restore-from-bak.sh
```

**æ¢å¤é€‰é¡¹**:
- åªæ¢å¤æ•°æ®åº“ï¼ˆæ¨èï¼‰
- æ¢å¤æ‰€æœ‰æ–‡ä»¶

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### Dockeréƒ¨ç½² vs Ubuntuç›´æ¥éƒ¨ç½²

| æŒ‡æ ‡ | Dockeréƒ¨ç½² | Ubuntuç›´æ¥éƒ¨ç½² |
|------|-----------|---------------|
| æ›´æ–°æ—¶é—´ | 2-5åˆ†é’Ÿ | 5-10ç§’ |
| èµ„æºå ç”¨ | é«˜ | ä½ |
| å¹¶å‘æ€§èƒ½ | ä¸­ | é«˜ï¼ˆGunicornï¼‰ |
| è°ƒè¯•éš¾åº¦ | è¾ƒéš¾ | å®¹æ˜“ |
| é€‚ç”¨åœºæ™¯ | å¤šæœåŠ¡ | å•åº”ç”¨ |

**é€Ÿåº¦æå‡**: 20-60å€ï¼âš¡

### Flaskå¼€å‘æœåŠ¡å™¨ vs Gunicorn

| æŒ‡æ ‡ | Flaskå¼€å‘æœåŠ¡å™¨ | Gunicorn |
|------|----------------|----------|
| å¹¶å‘è¯·æ±‚ | 1 | 4+ |
| æ¯ç§’è¯·æ±‚æ•° | ~50 | ~500+ |
| å“åº”æ—¶é—´ï¼ˆ50å¹¶å‘ï¼‰ | è¶…æ—¶ | 200ms |
| æˆåŠŸç‡ï¼ˆ50å¹¶å‘ï¼‰ | 10% | 100% |
| ç”Ÿäº§å°±ç»ª | âŒ | âœ… |

**æ€§èƒ½æå‡**: 10-20å€ï¼âš¡

---

## ğŸ” å…³é”®é…ç½®éªŒè¯

### 1. æ£€æŸ¥Gunicorné…ç½®

```bash
# æŸ¥çœ‹systemdæœåŠ¡é…ç½®
sudo systemctl cat crm

# åº”è¯¥çœ‹åˆ°:
# ExecStart=/root/crm/venv/bin/gunicorn
# Environment="FLASK_ENV=production"
```

### 2. æ£€æŸ¥workerè¿›ç¨‹

```bash
# æŸ¥çœ‹Gunicornè¿›ç¨‹
ps aux | grep gunicorn

# åº”è¯¥çœ‹åˆ°:
# 1ä¸ªmasterè¿›ç¨‹
# å¤šä¸ªworkerè¿›ç¨‹ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°ï¼‰
```

### 3. æ£€æŸ¥å¥åº·ç«¯ç‚¹

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost/health

# åº”è¯¥è¿”å›:
# {
#   "status": "healthy",
#   "service": "EduConnect CRM",
#   "database": "connected",
#   ...
# }
```

### 4. æ£€æŸ¥æ—¥å¿—è½®è½¬

```bash
# æŸ¥çœ‹æ—¥å¿—è½®è½¬é…ç½®
cat /etc/logrotate.d/crm

# åº”è¯¥çœ‹åˆ°:
# daily
# rotate 14
# compress
```

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### å¿…éœ€æ–‡ä»¶ï¼ˆ21ä¸ªï¼‰

#### éƒ¨ç½²è„šæœ¬ï¼ˆ8ä¸ªï¼‰
```
ubuntu-deploy.sh          # ä¸€é”®éƒ¨ç½²
quick-update.sh           # å¿«é€Ÿæ›´æ–°
health-check.sh           # å¥åº·æ£€æŸ¥
backup-to-gitee.sh        # å®Œæ•´å¤‡ä»½
restore-from-bak.sh       # æ¢å¤å¤‡ä»½
setup-git-config.sh       # Gité…ç½®
fix-git-conflict.sh       # å†²çªä¿®å¤
verify-update.sh          # éªŒè¯æ›´æ–°
```

#### æ ¸å¿ƒæ–‡æ¡£ï¼ˆ10ä¸ªï¼‰
```
README.md                 # é¡¹ç›®è¯´æ˜
Ubuntuç›´æ¥éƒ¨ç½²æŒ‡å—.md     # éƒ¨ç½²ä¸»æ–‡æ¡£
Ubuntuéƒ¨ç½²é—®é¢˜ä¿®å¤.md     # é—®é¢˜ä¿®å¤
éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”ä¸å»ºè®®.md     # æ–¹æ¡ˆå¯¹æ¯”
å¤‡ä»½æ¢å¤æŒ‡å—.md           # å¤‡ä»½æ¢å¤
æ•°æ®åº“ç®¡ç†è¯´æ˜.md         # æ•°æ®åº“ç®¡ç†
å®‰å…¨æ›´æ–°ä½¿ç”¨æŒ‡å—.md       # æ›´æ–°æŒ‡å—
CONFIG.md                 # é…ç½®è¯´æ˜
REQUIREMENTS.md           # ä¾èµ–è¯´æ˜
æ•°æ®åº“ç»“æ„è¯´æ˜.md         # æ•°æ®åº“ç»“æ„
```

#### é…ç½®æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
```
config.py                 # Flaské…ç½®
gunicorn.conf.py          # Gunicorné…ç½®
requirements.txt          # Pythonä¾èµ–
```

### å¯é€‰åˆ é™¤çš„æ–‡ä»¶

#### å·²åºŸå¼ƒï¼ˆå»ºè®®åˆ é™¤ï¼‰
```bash
# ä½¿ç”¨æ¸…ç†è„šæœ¬
bash cleanup-files.sh

# æˆ–æ‰‹åŠ¨åˆ é™¤
rm setup-nginx.sh fix-nginx-static.sh fix-permissions.sh
rm deploy.sh rollback-server.sh fix-network.sh
rm æœåŠ¡å™¨æ›´æ–°å®Œæ•´æŒ‡å—.md æœåŠ¡å™¨æ›´æ–°æŒ‡å—.md æœåŠ¡å™¨æ›´æ–°æ­¥éª¤.md
rm äº‘æœåŠ¡å™¨é…ç½®æ£€æŸ¥æŠ¥å‘Š.md ä¿®å¤Nginxé™æ€æ–‡ä»¶é—®é¢˜.md
```

#### Dockerç›¸å…³ï¼ˆå¦‚æœä¸ä½¿ç”¨Dockerï¼‰
```bash
rm docker-compose.yml Dockerfile
rm DOCKER_COMPOSE_éƒ¨ç½²æ–‡ä»¶æ¸…å•.md
rm safe-update.sh safe-update.ps1
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

### 1. ç”Ÿäº§çº§æ€§èƒ½
- âœ… Gunicornå¤šè¿›ç¨‹æ¶æ„
- âœ… æ”¯æŒå¹¶å‘è¯·æ±‚
- âœ… è‡ªåŠ¨è®¡ç®—æœ€ä¼˜workeræ•°é‡
- âœ… æ€§èƒ½æå‡10-20å€

### 2. æ›´æ–°é€Ÿåº¦å¿«
- âœ… 5-10ç§’å®Œæˆæ›´æ–°
- âœ… ä¸éœ€è¦é‡æ–°æ„å»ºé•œåƒ
- âœ… è‡ªåŠ¨ä¿æŠ¤æ•°æ®åº“
- âœ… é€Ÿåº¦æå‡20-60å€

### 3. ç¨³å®šå¯é 
- âœ… systemdæœåŠ¡ç®¡ç†
- âœ… å¼€æœºè‡ªåŠ¨å¯åŠ¨
- âœ… å´©æºƒè‡ªåŠ¨é‡å¯
- âœ… å¥åº·æ£€æŸ¥å’Œç›‘æ§

### 4. å®Œæ•´å¤‡ä»½
- âœ… ä¸€é”®å¤‡ä»½åˆ°Gitee
- âœ… åŒ…å«æ•°æ®åº“æ–‡ä»¶
- âœ… ä¸‰é‡ä¿æŠ¤æœºåˆ¶
- âœ… éšæ—¶æ¢å¤

### 5. æ˜“äºç»´æŠ¤
- âœ… æ¸…æ™°çš„æ–‡æ¡£
- âœ… è‡ªåŠ¨åŒ–è„šæœ¬
- âœ… è¯¦ç»†çš„æ—¥å¿—
- âœ… ç®€å•çš„å‘½ä»¤

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### æœåŠ¡ç®¡ç†
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start crm

# åœæ­¢æœåŠ¡
sudo systemctl stop crm

# é‡å¯æœåŠ¡
sudo systemctl restart crm

# ä¼˜é›…é‡å¯ï¼ˆä¸ä¸­æ–­è¿æ¥ï¼‰
sudo systemctl reload crm

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status crm

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u crm -f
```

### ä»£ç æ›´æ–°
```bash
# å¿«é€Ÿæ›´æ–°
bash quick-update.sh

# æ‰‹åŠ¨æ›´æ–°
git pull origin master
sudo systemctl restart crm
```

### å¤‡ä»½æ¢å¤
```bash
# å®Œæ•´å¤‡ä»½
bash backup-to-gitee.sh

# æ¢å¤å¤‡ä»½
bash restore-from-bak.sh
```

### å¥åº·æ£€æŸ¥
```bash
# æ‰‹åŠ¨å¥åº·æ£€æŸ¥
bash health-check.sh

# æµ‹è¯•å¥åº·ç«¯ç‚¹
curl http://localhost/health

# æŸ¥çœ‹NginxçŠ¶æ€
sudo systemctl status nginx
```

### æ—¥å¿—æŸ¥çœ‹
```bash
# åº”ç”¨æ—¥å¿—
tail -f /var/log/crm/access.log
tail -f /var/log/crm/error.log

# ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u crm -n 100

# Nginxæ—¥å¿—
tail -f /var/log/nginx/crm-access.log
tail -f /var/log/nginx/crm-error.log
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u crm -n 50

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tuln | grep 5000

# æ£€æŸ¥Pythonä¾èµ–
cd ~/crm
source venv/bin/activate
pip list | grep gunicorn
```

### é—®é¢˜2: Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥CRMæœåŠ¡
sudo systemctl status crm

# æ£€æŸ¥ç«¯å£ç›‘å¬
curl http://localhost:5000/health

# é‡å¯æœåŠ¡
sudo systemctl restart crm nginx
```

### é—®é¢˜3: æ›´æ–°åæ²¡æœ‰ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥ä»£ç æ˜¯å¦æ‹‰å–
git log -1

# å¼ºåˆ¶é‡å¯
sudo systemctl restart crm

# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£å‚è€ƒ
- Ubuntuç›´æ¥éƒ¨ç½²æŒ‡å—.md - è¯¦ç»†éƒ¨ç½²æ­¥éª¤
- Ubuntuéƒ¨ç½²é—®é¢˜ä¿®å¤.md - é—®é¢˜åˆ†æå’Œä¿®å¤
- éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”ä¸å»ºè®®.md - æ–¹æ¡ˆé€‰æ‹©å»ºè®®
- å¤‡ä»½æ¢å¤æŒ‡å—.md - å¤‡ä»½æ¢å¤è¯¦ç»†è¯´æ˜

### åœ¨çº¿èµ„æº
- Gunicornæ–‡æ¡£: https://docs.gunicorn.org/
- Flaskæ–‡æ¡£: https://flask.palletsprojects.com/
- Nginxæ–‡æ¡£: https://nginx.org/en/docs/

---

## âœ… æœ€ç»ˆæ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] æœåŠ¡å™¨æ˜¯Ubuntuç³»ç»Ÿ
- [ ] æœ‰sudoæƒé™
- [ ] Gitå·²é…ç½®
- [ ] é¡¹ç›®å·²å…‹éš†

### éƒ¨ç½²å
- [ ] CRMæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] ä½¿ç”¨Gunicornï¼ˆéFlaskå¼€å‘æœåŠ¡å™¨ï¼‰
- [ ] å¥åº·æ£€æŸ¥è¿”å›200
- [ ] æµè§ˆå™¨å¯ä»¥è®¿é—®
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®åº“æ–‡ä»¶å­˜åœ¨

### æ€§èƒ½éªŒè¯
- [ ] å¤šä¸ªworkerè¿›ç¨‹è¿è¡Œ
- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] å“åº”æ—¶é—´ < 500ms
- [ ] CPUä½¿ç”¨ç‡ < 80%
- [ ] å†…å­˜ä½¿ç”¨ç‡ < 80%

---

**éƒ¨ç½²æ–¹æ¡ˆ**: Ubuntuç›´æ¥éƒ¨ç½² + Gunicorn  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª  
**æœ€åæ›´æ–°**: 2025-01-02  
**ç‰ˆæœ¬**: 2.0ï¼ˆå·²ä¿®å¤æ‰€æœ‰å…³é”®é—®é¢˜ï¼‰

