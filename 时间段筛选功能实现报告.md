# æ—¶é—´æ®µç­›é€‰åŠŸèƒ½å®ç°æŠ¥å‘Š

## ğŸ“‹ éœ€æ±‚è¯´æ˜

ä¸ºçº¿ç´¢åˆ—è¡¨é¡µå’Œå®¢æˆ·åˆ—è¡¨é¡µæ·»åŠ æ—¶é—´æ®µç­›é€‰åŠŸèƒ½ï¼š

### çº¿ç´¢åˆ—è¡¨é¡µ
- å¯é€‰æ‹©æŒ‰ç…§**é¦–ç¬”æ”¯ä»˜**ã€**æ¬¡ç¬”æ”¯ä»˜**ã€**å…¨æ¬¾æ”¯ä»˜**æ—¶é—´æ¥ç­›é€‰
- æä¾›å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸè¾“å…¥æ¡†
- æä¾›æŸ¥è¯¢æŒ‰é’®

### å®¢æˆ·åˆ—è¡¨é¡µ
- æŒ‰ç…§**å®¢æˆ·æ–°å¢æ—¶é—´**ç­›é€‰
- æä¾›å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸè¾“å…¥æ¡†
- æä¾›æŸ¥è¯¢æŒ‰é’®

### æ ·å¼è¦æ±‚
- å¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸä½¿ç”¨æ—¥æœŸé€‰æ‹©å™¨
- æŸ¥è¯¢æŒ‰é’®ä¸ºè“è‰²ï¼Œå¸¦æœç´¢å›¾æ ‡
- æ•´ä½“å¸ƒå±€æ¸…æ™°ï¼Œæ˜“äºä½¿ç”¨

---

## âœ… å®ç°å†…å®¹

### 1ï¸âƒ£ çº¿ç´¢åˆ—è¡¨é¡µï¼ˆtemplates/leads/list.htmlï¼‰

#### å‰ç«¯ä¿®æ”¹

**æ–°å¢æ—¶é—´æ®µç­›é€‰åŒºåŸŸ**ï¼š

```html
<!-- ç¬¬äºŒè¡Œï¼šæ—¶é—´æ®µç­›é€‰ -->
<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
    <!-- æ—¶é—´ç±»å‹é€‰æ‹© -->
    <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">æ—¶é—´ç±»å‹:</label>
        <select name="date_type">
            <option value="">ä¸ç­›é€‰</option>
            <option value="first_payment">é¦–ç¬”æ”¯ä»˜</option>
            <option value="second_payment">æ¬¡ç¬”æ”¯ä»˜</option>
            <option value="full_payment">å…¨æ¬¾æ”¯ä»˜</option>
        </select>
    </div>
    
    <!-- å¼€å§‹æ—¥æœŸ -->
    <div class="flex items-center gap-2">
        <label for="start_date">å¼€å§‹æ—¥æœŸ:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}"/>
    </div>
    
    <!-- ç»“æŸæ—¥æœŸ -->
    <div class="flex items-center gap-2">
        <label for="end_date">ç»“æŸæ—¥æœŸ:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}"/>
    </div>
    
    <!-- æŸ¥è¯¢æŒ‰é’® -->
    <button type="submit" class="...bg-blue-600...">
        <span class="material-symbols-outlined">search</span>
        æŸ¥è¯¢
    </button>
</div>
```

**å¸ƒå±€è°ƒæ•´**ï¼š
- åŸæœ‰ç­›é€‰é¡¹ï¼ˆæœç´¢ã€é˜¶æ®µã€é”€å”®ï¼‰ä¿æŒåœ¨ç¬¬ä¸€è¡Œ
- æ–°å¢æ—¶é—´æ®µç­›é€‰åœ¨ç¬¬äºŒè¡Œï¼Œç‹¬ç«‹åŒºåŸŸ
- ä½¿ç”¨ç°è‰²èƒŒæ™¯åŒºåˆ†

---

### 2ï¸âƒ£ çº¿ç´¢åˆ—è¡¨è·¯ç”±ï¼ˆroutes/leads.pyï¼‰

#### åç«¯ä¿®æ”¹

**æ–°å¢å‚æ•°æ¥æ”¶**ï¼š

```python
# æ—¶é—´æ®µç­›é€‰å‚æ•°
date_type = request.args.get('date_type', '', type=str)  # first_payment, second_payment, full_payment
start_date = request.args.get('start_date', '', type=str)
end_date = request.args.get('end_date', '', type=str)
```

**æ—¶é—´æ®µç­›é€‰é€»è¾‘**ï¼š

```python
# æ—¶é—´æ®µç­›é€‰
if date_type and start_date and end_date:
    try:
        start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
        end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
        
        if date_type == 'first_payment':
            # é¦–ç¬”æ”¯ä»˜æ—¶é—´ç­›é€‰
            query = query.filter(
                and_(
                    Lead.first_payment_at.isnot(None),
                    func.date(Lead.first_payment_at) >= start_dt,
                    func.date(Lead.first_payment_at) <= end_dt
                )
            )
        elif date_type == 'second_payment':
            # æ¬¡ç¬”æ”¯ä»˜æ—¶é—´ç­›é€‰
            query = query.filter(
                and_(
                    Lead.second_payment_at.isnot(None),
                    func.date(Lead.second_payment_at) >= start_dt,
                    func.date(Lead.second_payment_at) <= end_dt
                )
            )
        elif date_type == 'full_payment':
            # å…¨æ¬¾æ”¯ä»˜æ—¶é—´ç­›é€‰
            query = query.filter(
                and_(
                    Lead.stage == 'å…¨æ¬¾æ”¯ä»˜',
                    Lead.updated_at.isnot(None),
                    func.date(Lead.updated_at) >= start_dt,
                    func.date(Lead.updated_at) <= end_dt
                )
            )
    except ValueError:
        pass
```

**å‚æ•°ä¼ é€’åˆ°æ¨¡æ¿**ï¼š

```python
return render_template('leads/list.html',
                     leads=leads,
                     search=search,
                     stage_filter=stage_filter,
                     sales_filter=sales_filter,
                     sales_users=sales_users,
                     stages=stages,
                     filter_type=filter_type,
                     filter_period=filter_period,
                     teachers=teachers,
                     date_type=date_type,      # æ–°å¢
                     start_date=start_date,    # æ–°å¢
                     end_date=end_date)        # æ–°å¢
```

---

### 3ï¸âƒ£ å®¢æˆ·åˆ—è¡¨é¡µï¼ˆtemplates/customers/list.htmlï¼‰

#### å‰ç«¯ä¿®æ”¹

**æ–°å¢æ—¶é—´æ®µç­›é€‰åŒºåŸŸ**ï¼š

```html
<!-- ç¬¬äºŒè¡Œï¼šæ—¶é—´æ®µç­›é€‰ -->
<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
    <!-- å¼€å§‹æ—¥æœŸ -->
    <div class="flex items-center gap-2">
        <label for="start_date">å¼€å§‹æ—¥æœŸ:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}"/>
    </div>
    
    <!-- ç»“æŸæ—¥æœŸ -->
    <div class="flex items-center gap-2">
        <label for="end_date">ç»“æŸæ—¥æœŸ:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}"/>
    </div>
    
    <!-- æŸ¥è¯¢æŒ‰é’® -->
    <button type="submit" class="...bg-blue-600...">
        <span class="material-symbols-outlined">search</span>
        æŸ¥è¯¢
    </button>
</div>
```

**è¯´æ˜**ï¼š
- å®¢æˆ·åˆ—è¡¨é¡µä¸éœ€è¦æ—¶é—´ç±»å‹é€‰æ‹©ï¼ˆå›ºå®šæŒ‰æ–°å¢æ—¶é—´ç­›é€‰ï¼‰
- åªæä¾›å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ
- æ ·å¼ä¸çº¿ç´¢åˆ—è¡¨é¡µä¿æŒä¸€è‡´

---

### 4ï¸âƒ£ å®¢æˆ·åˆ—è¡¨è·¯ç”±ï¼ˆroutes/customers.pyï¼‰

#### åç«¯ä¿®æ”¹

**æ–°å¢å‚æ•°æ¥æ”¶**ï¼š

```python
# æ—¶é—´æ®µç­›é€‰å‚æ•°ï¼ˆæŒ‰å®¢æˆ·æ–°å¢æ—¶é—´ï¼‰
start_date = request.args.get('start_date', '', type=str)
end_date = request.args.get('end_date', '', type=str)
```

**æ—¶é—´æ®µç­›é€‰é€»è¾‘**ï¼š

```python
# æ—¶é—´æ®µç­›é€‰ï¼ˆæŒ‰å®¢æˆ·æ–°å¢æ—¶é—´ï¼‰
if start_date and end_date:
    try:
        from sqlalchemy import func, and_
        start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
        end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
        
        query = query.filter(
            and_(
                func.date(Customer.created_at) >= start_dt,
                func.date(Customer.created_at) <= end_dt
            )
        )
    except ValueError:
        pass
```

**å‚æ•°ä¼ é€’åˆ°æ¨¡æ¿**ï¼š

```python
return render_template('customers/list.html',
                     customers=customers,
                     search=search,
                     teacher_filter=teacher_filter,
                     award_filter=award_filter,
                     teachers=teachers,
                     start_date=start_date,    # æ–°å¢
                     end_date=end_date)        # æ–°å¢
```

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### çº¿ç´¢åˆ—è¡¨é¡µæ—¶é—´ç­›é€‰

| æ—¶é—´ç±»å‹ | ç­›é€‰å­—æ®µ | è¯´æ˜ |
|---------|---------|------|
| **é¦–ç¬”æ”¯ä»˜** | `Lead.first_payment_at` | ç¬¬ä¸€ç¬”ä»˜æ¬¾çš„æ—¶é—´ |
| **æ¬¡ç¬”æ”¯ä»˜** | `Lead.second_payment_at` | ç¬¬äºŒç¬”ä»˜æ¬¾çš„æ—¶é—´ |
| **å…¨æ¬¾æ”¯ä»˜** | `Lead.updated_at` + `stage='å…¨æ¬¾æ”¯ä»˜'` | è¾¾åˆ°å…¨æ¬¾æ”¯ä»˜é˜¶æ®µçš„æ—¶é—´ |

### å®¢æˆ·åˆ—è¡¨é¡µæ—¶é—´ç­›é€‰

| ç­›é€‰ç»´åº¦ | ç­›é€‰å­—æ®µ | è¯´æ˜ |
|---------|---------|------|
| **å®¢æˆ·æ–°å¢æ—¶é—´** | `Customer.created_at` | å®¢æˆ·è®°å½•åˆ›å»ºæ—¶é—´ |

---

## ğŸ¨ æ ·å¼è®¾è®¡

### å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€è¡Œï¼šæœç´¢æ¡† | é˜¶æ®µ/å¥–é¡¹ | é”€å”®/ç­ä¸»ä»»                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬äºŒè¡Œï¼ˆç°è‰²èƒŒæ™¯ï¼‰ï¼š                                      â”‚
â”‚   æ—¶é—´ç±»å‹ | å¼€å§‹æ—¥æœŸ | ç»“æŸæ—¥æœŸ | [æŸ¥è¯¢æŒ‰é’®]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ·å¼ç‰¹ç‚¹

- **ç°è‰²èƒŒæ™¯åŒºåŸŸ**ï¼š`bg-gray-50 p-3 rounded-md`
- **æ—¥æœŸè¾“å…¥æ¡†**ï¼šåŸç”ŸHTML5æ—¥æœŸé€‰æ‹©å™¨
- **æŸ¥è¯¢æŒ‰é’®**ï¼šè“è‰²èƒŒæ™¯ + æœç´¢å›¾æ ‡
- **å“åº”å¼å¸ƒå±€**ï¼šä½¿ç”¨Flexboxï¼Œè‡ªé€‚åº”å±å¹•å®½åº¦

---

## ğŸ” ä½¿ç”¨ç¤ºä¾‹

### çº¿ç´¢åˆ—è¡¨é¡µ

**åœºæ™¯1ï¼šæŸ¥è¯¢2025å¹´8æœˆ15æ—¥è‡³9æœˆ30æ—¥çš„é¦–ç¬”æ”¯ä»˜çº¿ç´¢**
1. æ—¶é—´ç±»å‹ï¼šé€‰æ‹©"é¦–ç¬”æ”¯ä»˜"
2. å¼€å§‹æ—¥æœŸï¼š2025/08/15
3. ç»“æŸæ—¥æœŸï¼š2025/09/30
4. ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®

**åœºæ™¯2ï¼šæŸ¥è¯¢2025å¹´9æœˆçš„å…¨æ¬¾æ”¯ä»˜çº¿ç´¢**
1. æ—¶é—´ç±»å‹ï¼šé€‰æ‹©"å…¨æ¬¾æ”¯ä»˜"
2. å¼€å§‹æ—¥æœŸï¼š2025/09/01
3. ç»“æŸæ—¥æœŸï¼š2025/09/30
4. ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®

### å®¢æˆ·åˆ—è¡¨é¡µ

**åœºæ™¯ï¼šæŸ¥è¯¢2025å¹´8æœˆ15æ—¥è‡³9æœˆ30æ—¥æ–°å¢çš„å®¢æˆ·**
1. å¼€å§‹æ—¥æœŸï¼š2025/08/15
2. ç»“æŸæ—¥æœŸï¼š2025/09/30
3. ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. æ—¥æœŸæ ¼å¼å¤„ç†

```python
# å‰ç«¯ä¼ é€’æ ¼å¼ï¼šYYYY-MM-DD
# åç«¯è§£æ
start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
```

### 2. SQLAlchemyæ—¥æœŸæŸ¥è¯¢

```python
from sqlalchemy import func, and_

# ä½¿ç”¨func.date()å°†datetimeè½¬æ¢ä¸ºdateè¿›è¡Œæ¯”è¾ƒ
query = query.filter(
    and_(
        func.date(Lead.first_payment_at) >= start_dt,
        func.date(Lead.first_payment_at) <= end_dt
    )
)
```

### 3. å¼‚å¸¸å¤„ç†

```python
try:
    start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
    end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
    # ç­›é€‰é€»è¾‘
except ValueError:
    pass  # æ—¥æœŸæ ¼å¼é”™è¯¯æ—¶å¿½ç•¥ç­›é€‰
```

---

## âœ… å®Œæˆæ¸…å•

- [x] çº¿ç´¢åˆ—è¡¨é¡µå‰ç«¯ï¼šæ·»åŠ æ—¶é—´æ®µç­›é€‰UI
- [x] çº¿ç´¢åˆ—è¡¨é¡µåç«¯ï¼šå®ç°æ—¶é—´æ®µç­›é€‰é€»è¾‘
- [x] çº¿ç´¢åˆ—è¡¨é¡µï¼šæ”¯æŒé¦–ç¬”æ”¯ä»˜æ—¶é—´ç­›é€‰
- [x] çº¿ç´¢åˆ—è¡¨é¡µï¼šæ”¯æŒæ¬¡ç¬”æ”¯ä»˜æ—¶é—´ç­›é€‰
- [x] çº¿ç´¢åˆ—è¡¨é¡µï¼šæ”¯æŒå…¨æ¬¾æ”¯ä»˜æ—¶é—´ç­›é€‰
- [x] å®¢æˆ·åˆ—è¡¨é¡µå‰ç«¯ï¼šæ·»åŠ æ—¶é—´æ®µç­›é€‰UI
- [x] å®¢æˆ·åˆ—è¡¨é¡µåç«¯ï¼šå®ç°å®¢æˆ·æ–°å¢æ—¶é—´ç­›é€‰
- [x] å‚æ•°ä¼ é€’ï¼šå°†ç­›é€‰å‚æ•°ä¼ é€’åˆ°æ¨¡æ¿
- [x] æ ·å¼ç»Ÿä¸€ï¼šä¸¤ä¸ªé¡µé¢æ ·å¼ä¿æŒä¸€è‡´

---

## ğŸ‰ æ€»ç»“

### åŠŸèƒ½äº®ç‚¹

1. âœ… **çµæ´»çš„æ—¶é—´ç­›é€‰**ï¼šçº¿ç´¢åˆ—è¡¨æ”¯æŒ3ç§æ—¶é—´ç±»å‹ç­›é€‰
2. âœ… **ç›´è§‚çš„UIè®¾è®¡**ï¼šæ—¥æœŸé€‰æ‹©å™¨ + æŸ¥è¯¢æŒ‰é’®
3. âœ… **æ¸…æ™°çš„å¸ƒå±€**ï¼šç°è‰²èƒŒæ™¯åŒºåˆ†ç­›é€‰åŒºåŸŸ
4. âœ… **å®Œå–„çš„å¼‚å¸¸å¤„ç†**ï¼šæ—¥æœŸæ ¼å¼é”™è¯¯æ—¶ä¸å½±å“æ­£å¸¸ä½¿ç”¨
5. âœ… **ç»Ÿä¸€çš„æ ·å¼**ï¼šä¸¤ä¸ªé¡µé¢ä¿æŒä¸€è‡´çš„è®¾è®¡é£æ ¼

### æŠ€æœ¯ç‰¹ç‚¹

- ä½¿ç”¨HTML5åŸç”Ÿæ—¥æœŸé€‰æ‹©å™¨
- SQLAlchemyæ—¥æœŸèŒƒå›´æŸ¥è¯¢
- å¼‚å¸¸å¤„ç†ä¿è¯ç³»ç»Ÿç¨³å®šæ€§
- å“åº”å¼å¸ƒå±€é€‚é…ä¸åŒå±å¹•

**æ—¶é—´æ®µç­›é€‰åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼** ğŸ‰

