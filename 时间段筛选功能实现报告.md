# 时间段筛选功能实现报告

## 📋 需求说明

为线索列表页和客户列表页添加时间段筛选功能：

### 线索列表页
- 可选择按照**首笔支付**、**次笔支付**、**全款支付**时间来筛选
- 提供开始日期和结束日期输入框
- 提供查询按钮

### 客户列表页
- 按照**客户新增时间**筛选
- 提供开始日期和结束日期输入框
- 提供查询按钮

### 样式要求
- 开始日期、结束日期使用日期选择器
- 查询按钮为蓝色，带搜索图标
- 整体布局清晰，易于使用

---

## ✅ 实现内容

### 1️⃣ 线索列表页（templates/leads/list.html）

#### 前端修改

**新增时间段筛选区域**：

```html
<!-- 第二行：时间段筛选 -->
<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
    <!-- 时间类型选择 -->
    <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">时间类型:</label>
        <select name="date_type">
            <option value="">不筛选</option>
            <option value="first_payment">首笔支付</option>
            <option value="second_payment">次笔支付</option>
            <option value="full_payment">全款支付</option>
        </select>
    </div>
    
    <!-- 开始日期 -->
    <div class="flex items-center gap-2">
        <label for="start_date">开始日期:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}"/>
    </div>
    
    <!-- 结束日期 -->
    <div class="flex items-center gap-2">
        <label for="end_date">结束日期:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}"/>
    </div>
    
    <!-- 查询按钮 -->
    <button type="submit" class="...bg-blue-600...">
        <span class="material-symbols-outlined">search</span>
        查询
    </button>
</div>
```

**布局调整**：
- 原有筛选项（搜索、阶段、销售）保持在第一行
- 新增时间段筛选在第二行，独立区域
- 使用灰色背景区分

---

### 2️⃣ 线索列表路由（routes/leads.py）

#### 后端修改

**新增参数接收**：

```python
# 时间段筛选参数
date_type = request.args.get('date_type', '', type=str)  # first_payment, second_payment, full_payment
start_date = request.args.get('start_date', '', type=str)
end_date = request.args.get('end_date', '', type=str)
```

**时间段筛选逻辑**：

```python
# 时间段筛选
if date_type and start_date and end_date:
    try:
        start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
        end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
        
        if date_type == 'first_payment':
            # 首笔支付时间筛选
            query = query.filter(
                and_(
                    Lead.first_payment_at.isnot(None),
                    func.date(Lead.first_payment_at) >= start_dt,
                    func.date(Lead.first_payment_at) <= end_dt
                )
            )
        elif date_type == 'second_payment':
            # 次笔支付时间筛选
            query = query.filter(
                and_(
                    Lead.second_payment_at.isnot(None),
                    func.date(Lead.second_payment_at) >= start_dt,
                    func.date(Lead.second_payment_at) <= end_dt
                )
            )
        elif date_type == 'full_payment':
            # 全款支付时间筛选
            query = query.filter(
                and_(
                    Lead.stage == '全款支付',
                    Lead.updated_at.isnot(None),
                    func.date(Lead.updated_at) >= start_dt,
                    func.date(Lead.updated_at) <= end_dt
                )
            )
    except ValueError:
        pass
```

**参数传递到模板**：

```python
return render_template('leads/list.html',
                     leads=leads,
                     search=search,
                     stage_filter=stage_filter,
                     sales_filter=sales_filter,
                     sales_users=sales_users,
                     stages=stages,
                     filter_type=filter_type,
                     filter_period=filter_period,
                     teachers=teachers,
                     date_type=date_type,      # 新增
                     start_date=start_date,    # 新增
                     end_date=end_date)        # 新增
```

---

### 3️⃣ 客户列表页（templates/customers/list.html）

#### 前端修改

**新增时间段筛选区域**：

```html
<!-- 第二行：时间段筛选 -->
<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-md">
    <!-- 开始日期 -->
    <div class="flex items-center gap-2">
        <label for="start_date">开始日期:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}"/>
    </div>
    
    <!-- 结束日期 -->
    <div class="flex items-center gap-2">
        <label for="end_date">结束日期:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}"/>
    </div>
    
    <!-- 查询按钮 -->
    <button type="submit" class="...bg-blue-600...">
        <span class="material-symbols-outlined">search</span>
        查询
    </button>
</div>
```

**说明**：
- 客户列表页不需要时间类型选择（固定按新增时间筛选）
- 只提供开始日期和结束日期
- 样式与线索列表页保持一致

---

### 4️⃣ 客户列表路由（routes/customers.py）

#### 后端修改

**新增参数接收**：

```python
# 时间段筛选参数（按客户新增时间）
start_date = request.args.get('start_date', '', type=str)
end_date = request.args.get('end_date', '', type=str)
```

**时间段筛选逻辑**：

```python
# 时间段筛选（按客户新增时间）
if start_date and end_date:
    try:
        from sqlalchemy import func, and_
        start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
        end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
        
        query = query.filter(
            and_(
                func.date(Customer.created_at) >= start_dt,
                func.date(Customer.created_at) <= end_dt
            )
        )
    except ValueError:
        pass
```

**参数传递到模板**：

```python
return render_template('customers/list.html',
                     customers=customers,
                     search=search,
                     teacher_filter=teacher_filter,
                     award_filter=award_filter,
                     teachers=teachers,
                     start_date=start_date,    # 新增
                     end_date=end_date)        # 新增
```

---

## 📊 功能特性

### 线索列表页时间筛选

| 时间类型 | 筛选字段 | 说明 |
|---------|---------|------|
| **首笔支付** | `Lead.first_payment_at` | 第一笔付款的时间 |
| **次笔支付** | `Lead.second_payment_at` | 第二笔付款的时间 |
| **全款支付** | `Lead.updated_at` + `stage='全款支付'` | 达到全款支付阶段的时间 |

### 客户列表页时间筛选

| 筛选维度 | 筛选字段 | 说明 |
|---------|---------|------|
| **客户新增时间** | `Customer.created_at` | 客户记录创建时间 |

---

## 🎨 样式设计

### 布局结构

```
┌─────────────────────────────────────────────────────────┐
│ 第一行：搜索框 | 阶段/奖项 | 销售/班主任                │
├─────────────────────────────────────────────────────────┤
│ 第二行（灰色背景）：                                      │
│   时间类型 | 开始日期 | 结束日期 | [查询按钮]            │
└─────────────────────────────────────────────────────────┘
```

### 样式特点

- **灰色背景区域**：`bg-gray-50 p-3 rounded-md`
- **日期输入框**：原生HTML5日期选择器
- **查询按钮**：蓝色背景 + 搜索图标
- **响应式布局**：使用Flexbox，自适应屏幕宽度

---

## 🔍 使用示例

### 线索列表页

**场景1：查询2025年8月15日至9月30日的首笔支付线索**
1. 时间类型：选择"首笔支付"
2. 开始日期：2025/08/15
3. 结束日期：2025/09/30
4. 点击"查询"按钮

**场景2：查询2025年9月的全款支付线索**
1. 时间类型：选择"全款支付"
2. 开始日期：2025/09/01
3. 结束日期：2025/09/30
4. 点击"查询"按钮

### 客户列表页

**场景：查询2025年8月15日至9月30日新增的客户**
1. 开始日期：2025/08/15
2. 结束日期：2025/09/30
3. 点击"查询"按钮

---

## 📝 技术要点

### 1. 日期格式处理

```python
# 前端传递格式：YYYY-MM-DD
# 后端解析
start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
```

### 2. SQLAlchemy日期查询

```python
from sqlalchemy import func, and_

# 使用func.date()将datetime转换为date进行比较
query = query.filter(
    and_(
        func.date(Lead.first_payment_at) >= start_dt,
        func.date(Lead.first_payment_at) <= end_dt
    )
)
```

### 3. 异常处理

```python
try:
    start_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
    end_dt = datetime.strptime(end_date, '%Y-%m-%d').date()
    # 筛选逻辑
except ValueError:
    pass  # 日期格式错误时忽略筛选
```

---

## ✅ 完成清单

- [x] 线索列表页前端：添加时间段筛选UI
- [x] 线索列表页后端：实现时间段筛选逻辑
- [x] 线索列表页：支持首笔支付时间筛选
- [x] 线索列表页：支持次笔支付时间筛选
- [x] 线索列表页：支持全款支付时间筛选
- [x] 客户列表页前端：添加时间段筛选UI
- [x] 客户列表页后端：实现客户新增时间筛选
- [x] 参数传递：将筛选参数传递到模板
- [x] 样式统一：两个页面样式保持一致

---

## 🎉 总结

### 功能亮点

1. ✅ **灵活的时间筛选**：线索列表支持3种时间类型筛选
2. ✅ **直观的UI设计**：日期选择器 + 查询按钮
3. ✅ **清晰的布局**：灰色背景区分筛选区域
4. ✅ **完善的异常处理**：日期格式错误时不影响正常使用
5. ✅ **统一的样式**：两个页面保持一致的设计风格

### 技术特点

- 使用HTML5原生日期选择器
- SQLAlchemy日期范围查询
- 异常处理保证系统稳定性
- 响应式布局适配不同屏幕

**时间段筛选功能已成功实现！** 🎉

