# å¥–é¡¹è¦æ±‚æ•°æ®è¯»å–è¯´æ˜

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-09-30  
**ç³»ç»Ÿ**: EduConnect CRM

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ç³»ç»Ÿä¸­ä¸¤ä¸ªå…³é”®ä½ç½®çš„å¥–é¡¹è¦æ±‚æ•°æ®è¯»å–é€»è¾‘ï¼š
1. **å­¦å‘˜è¯¦æƒ…å¼¹çª—** - ç‚¹å‡»å­¦å‘˜å§“åæ—¶æ˜¾ç¤ºçš„è¯¦æƒ…å¼¹çª—
2. **å®¢æˆ·åˆ—è¡¨é¡µ** - å®¢æˆ·ç®¡ç†é¡µé¢çš„åˆ—è¡¨æ˜¾ç¤º

---

## ğŸ¯ æ•°æ®è¯»å–ä½ç½®æ€»ç»“

| ä½ç½® | æ•°æ®æ¥æº | è¯»å–å­—æ®µ | è¯´æ˜ |
|-----|---------|---------|------|
| **å­¦å‘˜è¯¦æƒ…å¼¹çª—** | çº¿ç´¢API / å®¢æˆ·API | `competition_award_level` + `additional_requirements` | ä¼˜å…ˆä»çº¿ç´¢è¡¨è¯»å–ï¼Œå¦‚å·²è½¬å®¢æˆ·åˆ™ä»å®¢æˆ·è¡¨è¯»å– |
| **å®¢æˆ·åˆ—è¡¨é¡µ** | å®¢æˆ·è¡¨ | `customer.competition_award_level` | ç›´æ¥ä»å®¢æˆ·è¡¨è¯»å– |

---

## 1ï¸âƒ£ å­¦å‘˜è¯¦æƒ…å¼¹çª—

### ğŸ“ è§¦å‘ä½ç½®

- **çº¿ç´¢åˆ—è¡¨é¡µ** (`templates/leads/list.html`)ï¼šç‚¹å‡»å­¦å‘˜å§“å
- **å®¢æˆ·åˆ—è¡¨é¡µ** (`templates/customers/list.html`)ï¼šç‚¹å‡»å­¦å‘˜å§“å

### ğŸ”„ æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»å­¦å‘˜å§“å
    â†“
JavaScriptè°ƒç”¨ showStudentDetailModal(studentId, isCustomer)
    â†“
æ ¹æ®isCustomerå‚æ•°é€‰æ‹©APIç«¯ç‚¹ï¼š
  - çº¿ç´¢ï¼š/leads/{id}/api
  - å®¢æˆ·ï¼š/customers/{id}/api
    â†“
åç«¯è¿”å›JSONæ•°æ®
    â†“
å‰ç«¯å¡«å……å¼¹çª—å†…å®¹
```

### ğŸ“Š åç«¯APIå®ç°

#### çº¿ç´¢API (`routes/leads.py` ç¬¬810-846è¡Œ)

<augment_code_snippet path="routes/leads.py" mode="EXCERPT">
```python
@leads_bp.route('/<int:lead_id>/api')
def lead_api(lead_id):
    """çº¿ç´¢APIè¯¦æƒ… - ç”¨äºå¼¹çª—æ˜¾ç¤º"""
    lead = Lead.query.get_or_404(lead_id)
    
    # æ£€æŸ¥æ˜¯å¦å·²è½¬ä¸ºå®¢æˆ·
    customer = Customer.query.filter_by(lead_id=lead.id).first()
    
    lead_data = {
        'id': lead.id,
        'student_name': lead.student_name,
        # ... å…¶ä»–å­—æ®µ ...
        'service_types': lead.get_service_types_list(),
        
        # âœ¨ å…³é”®é€»è¾‘ï¼šä¼˜å…ˆä»çº¿ç´¢è¡¨è¯»å–ï¼Œå¦‚å·²è½¬å®¢æˆ·åˆ™ä»å®¢æˆ·è¡¨è¯»å–
        'competition_award_level': customer.competition_award_level if customer else lead.competition_award_level,
        'additional_requirements': customer.additional_requirements if customer else lead.additional_requirements,
    }
    
    return jsonify({'success': True, 'lead': lead_data})
```
</augment_code_snippet>

**è¯»å–é€»è¾‘**ï¼š
1. æŸ¥è¯¢è¯¥çº¿ç´¢æ˜¯å¦å·²è½¬ä¸ºå®¢æˆ·
2. **å¦‚æœå·²è½¬å®¢æˆ·**ï¼šä» `customer.competition_award_level` å’Œ `customer.additional_requirements` è¯»å–
3. **å¦‚æœè¿˜æ˜¯çº¿ç´¢**ï¼šä» `lead.competition_award_level` å’Œ `lead.additional_requirements` è¯»å–

#### å®¢æˆ·API (`routes/customers.py` ç¬¬262-316è¡Œ)

<augment_code_snippet path="routes/customers.py" mode="EXCERPT">
```python
@customers_bp.route('/<int:customer_id>/api')
def customer_api(customer_id):
    """å®¢æˆ·APIè¯¦æƒ… - ç”¨äºå¼¹çª—æ˜¾ç¤º"""
    customer = Customer.query.get_or_404(customer_id)
    
    customer_data = {
        'id': customer.id,
        'student_name': customer.lead.student_name,
        # ... å…¶ä»–å­—æ®µ ...
        'service_types': customer.get_service_types(),
        
        # âœ¨ ç›´æ¥ä»å®¢æˆ·è¡¨è¯»å–
        'competition_award_level': customer.competition_award_level,
        'additional_requirements': customer.additional_requirements,
    }
    
    return jsonify({'success': True, 'customer': customer_data})
```
</augment_code_snippet>

**è¯»å–é€»è¾‘**ï¼š
- ç›´æ¥ä» `customer.competition_award_level` å’Œ `customer.additional_requirements` è¯»å–

### ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºé€»è¾‘

#### å¼¹çª—æ¨¡æ¿ (`templates/components/student_detail_modal.html`)

**ç«èµ›å¥–é¡¹æ˜¾ç¤º** (ç¬¬195è¡Œ):
```javascript
let awardText = studentData.competition_award_level || studentData.award_requirement || 'æ— è¦æ±‚';
```

**é¢å¤–è¦æ±‚æ˜¾ç¤º** (ç¬¬210-214è¡Œ):
```javascript
if (studentData.additional_requirements) {
    const extraRow = document.getElementById('extraRequirementsRow');
    extraRow.classList.remove('hidden');
    document.getElementById('extraRequirements').textContent = studentData.additional_requirements;
}
```

### ğŸ“ æ•°æ®ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šçº¿ç´¢é˜¶æ®µï¼ˆæœªè½¬å®¢æˆ·ï¼‰

**APIè¯·æ±‚**: `GET /leads/6/api`

**è¿”å›æ•°æ®**:
```json
{
  "success": true,
  "lead": {
    "id": 6,
    "student_name": "æµ‹è¯•å­¦å‘˜A",
    "service_types": ["tutoring", "competition"],
    "competition_award_level": "å›½å¥–",  // ä» lead.competition_award_level è¯»å–
    "additional_requirements": "éœ€è¦åœ¨2026å¹´5æœˆå‰å®Œæˆ"  // ä» lead.additional_requirements è¯»å–
  }
}
```

#### ç¤ºä¾‹2ï¼šå®¢æˆ·é˜¶æ®µï¼ˆå·²è½¬å®¢æˆ·ï¼‰

**APIè¯·æ±‚**: `GET /leads/6/api` æˆ– `GET /customers/6/api`

**è¿”å›æ•°æ®**:
```json
{
  "success": true,
  "lead": {  // æˆ– "customer"
    "id": 6,
    "student_name": "æµ‹è¯•å­¦å‘˜A",
    "service_types": ["tutoring", "competition"],
    "competition_award_level": "å›½å¥–",  // ä» customer.competition_award_level è¯»å–
    "additional_requirements": "æµ‹è¯•é¢å¤–è¦æ±‚ï¼šéœ€è¦åœ¨2026å¹´5æœˆå‰å®Œæˆæ‰€æœ‰è¯¾ç¨‹å¹¶è·å¾—å›½å¥–"  // ä» customer.additional_requirements è¯»å–
  }
}
```

---

## 2ï¸âƒ£ å®¢æˆ·åˆ—è¡¨é¡µ

### ğŸ“ æ˜¾ç¤ºä½ç½®

**æ–‡ä»¶**: `templates/customers/list.html`  
**ä½ç½®**: ç¬¬94-102è¡Œ

### ğŸ“Š æ•°æ®è¯»å–

#### åç«¯è·¯ç”± (`routes/customers.py` ç¬¬28-74è¡Œ)

```python
@customers_bp.route('/list')
def list_customers():
    """å®¢æˆ·åˆ—è¡¨"""
    query = Customer.query.join(Lead).options(
        db.joinedload(Customer.tutoring_delivery),
        db.joinedload(Customer.competition_delivery)
    )
    
    # å¥–é¡¹è¦æ±‚è¿‡æ»¤
    if award_filter:
        query = query.filter(Customer.competition_award_level == award_filter)
    
    customers = query.order_by(Customer.created_at.desc()).paginate(...)
    
    return render_template('customers/list.html', customers=customers, ...)
```

#### å‰ç«¯æ¨¡æ¿æ˜¾ç¤º

<augment_code_snippet path="templates/customers/list.html" mode="EXCERPT">
```html
<td class="whitespace-nowrap px-6 py-4 text-sm">
    {% if customer.competition_award_level == 'å¸‚å¥–' %}
        <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">å¸‚å¥–</span>
    {% elif customer.competition_award_level == 'å›½å¥–' %}
        <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">å›½å¥–</span>
    {% else %}
        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">æ— </span>
    {% endif %}
</td>
```
</augment_code_snippet>

**è¯»å–é€»è¾‘**ï¼š
- âœ… ç›´æ¥ä» `customer.competition_award_level` è¯»å–
- âœ… æ ¹æ®å€¼æ˜¾ç¤ºä¸åŒé¢œè‰²çš„æ ‡ç­¾ï¼š
  - `'å¸‚å¥–'` â†’ è“è‰²æ ‡ç­¾
  - `'å›½å¥–'` â†’ çº¢è‰²æ ‡ç­¾
  - `None` æˆ–å…¶ä»– â†’ ç°è‰²æ ‡ç­¾æ˜¾ç¤º"æ— "

### ğŸ“ æ•°æ®ç¤ºä¾‹

#### å®¢æˆ·åˆ—è¡¨æ˜¾ç¤º

| å­¦å‘˜å§“å | ç­ä¸»ä»» | å¥–é¡¹è¦æ±‚ | ä¸­é«˜è€ƒå¹´ä»½ |
|---------|-------|---------|-----------|
| æµ‹è¯•å­¦å‘˜A | Kingble | ğŸ”´ å›½å¥– | 2026å¹´ |
| å”èŠ¯å¿¬ | è‘› | âšª æ—  | 2027å¹´ |
| æå›› | ç‹è€å¸ˆ | ğŸ”µ å¸‚å¥– | 2028å¹´ |

**æ•°æ®æ¥æº**ï¼š
- å¥–é¡¹è¦æ±‚ï¼š`customer.competition_award_level`ï¼ˆå®¢æˆ·è¡¨ï¼‰
- å­¦å‘˜å§“åï¼š`customer.lead.student_name`ï¼ˆçº¿ç´¢è¡¨ï¼‰
- ç­ä¸»ä»»ï¼š`customer.teacher_user`ï¼ˆç”¨æˆ·è¡¨ï¼‰
- ä¸­é«˜è€ƒå¹´ä»½ï¼š`customer.exam_year`ï¼ˆå®¢æˆ·è¡¨ï¼‰

---

## ğŸ”„ æ•°æ®åŒæ­¥æœºåˆ¶

### çº¿ç´¢è½¬å®¢æˆ·æ—¶çš„æ•°æ®å¤åˆ¶

**æ–‡ä»¶**: `routes/leads.py` ç¬¬896-910è¡Œ

```python
@leads_bp.route('/<int:lead_id>/convert', methods=['POST'])
def convert_to_customer(lead_id):
    """å°†çº¿ç´¢è½¬æ¢ä¸ºå®¢æˆ·"""
    lead = Lead.query.get_or_404(lead_id)
    
    # åˆ›å»ºå®¢æˆ·è®°å½•ï¼Œä»çº¿ç´¢è¡¨å¤åˆ¶å­—æ®µ
    result = db.session.execute(insert_sql, {
        'lead_id': lead.id,
        'teacher_user_id': teacher_id,
        'competition_award_level': lead.competition_award_level,  # âœ¨ ä»çº¿ç´¢è¡¨å¤åˆ¶
        'additional_requirements': lead.additional_requirements,  # âœ¨ ä»çº¿ç´¢è¡¨å¤åˆ¶
        'exam_year': exam_year,
        # ...
    })
```

**åŒæ­¥é€»è¾‘**ï¼š
1. çº¿ç´¢è½¬å®¢æˆ·æ—¶ï¼Œè‡ªåŠ¨å°† `lead.competition_award_level` å¤åˆ¶åˆ° `customer.competition_award_level`
2. è‡ªåŠ¨å°† `lead.additional_requirements` å¤åˆ¶åˆ° `customer.additional_requirements`
3. è½¬æ¢åï¼Œä¸¤ä¸ªè¡¨éƒ½ä¿ç•™è¿™äº›æ•°æ®

---

## ğŸ“Š æ•°æ®å­˜å‚¨æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çº¿ç´¢è¡¨ (leads)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: 6                                                        â”‚
â”‚ student_name: 'æµ‹è¯•å­¦å‘˜A'                                    â”‚
â”‚ competition_award_level: 'å›½å¥–'  â† é”€å”®åœ¨çº¿ç´¢é˜¶æ®µè®¾ç½®       â”‚
â”‚ additional_requirements: 'éœ€è¦åœ¨2026å¹´5æœˆå‰å®Œæˆ'            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ è½¬å®¢æˆ·æ—¶å¤åˆ¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®¢æˆ·è¡¨ (customers)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: 6                                                        â”‚
â”‚ lead_id: 6                                                   â”‚
â”‚ competition_award_level: 'å›½å¥–'  â† ä»çº¿ç´¢è¡¨å¤åˆ¶             â”‚
â”‚ additional_requirements: 'éœ€è¦åœ¨2026å¹´5æœˆå‰å®Œæˆ'            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ è¯»å–ä¼˜å…ˆçº§æ€»ç»“

### å­¦å‘˜è¯¦æƒ…å¼¹çª—

| åœºæ™¯ | æ•°æ®æ¥æº | ä¼˜å…ˆçº§ |
|-----|---------|-------|
| çº¿ç´¢é˜¶æ®µï¼ˆæœªè½¬å®¢æˆ·ï¼‰ | `lead.competition_award_level` | çº¿ç´¢è¡¨ |
| å®¢æˆ·é˜¶æ®µï¼ˆå·²è½¬å®¢æˆ·ï¼‰ | `customer.competition_award_level` | å®¢æˆ·è¡¨ âœ¨ |

**åˆ¤æ–­é€»è¾‘**ï¼š
```python
customer = Customer.query.filter_by(lead_id=lead.id).first()
award_level = customer.competition_award_level if customer else lead.competition_award_level
```

### å®¢æˆ·åˆ—è¡¨é¡µ

| åœºæ™¯ | æ•°æ®æ¥æº | è¯´æ˜ |
|-----|---------|------|
| å®¢æˆ·åˆ—è¡¨ | `customer.competition_award_level` | åªæ˜¾ç¤ºå·²è½¬å®¢æˆ·çš„æ•°æ® |

**è¯»å–é€»è¾‘**ï¼š
```python
customer.competition_award_level  # ç›´æ¥ä»å®¢æˆ·è¡¨è¯»å–
```

---

## ğŸ’¡ å…³é”®è¦ç‚¹

### 1. æ•°æ®ä¸€è‡´æ€§

- âœ… çº¿ç´¢é˜¶æ®µï¼šé”€å”®åœ¨çº¿ç´¢è¡¨è®¾ç½®å¥–é¡¹è¦æ±‚
- âœ… è½¬å®¢æˆ·æ—¶ï¼šè‡ªåŠ¨å¤åˆ¶åˆ°å®¢æˆ·è¡¨
- âœ… å®¢æˆ·é˜¶æ®µï¼šå¯ä»¥åœ¨å®¢æˆ·è¡¨ä¿®æ”¹

### 2. è¯»å–ç­–ç•¥

- âœ… **å­¦å‘˜è¯¦æƒ…å¼¹çª—**ï¼šæ™ºèƒ½è¯»å–ï¼ˆä¼˜å…ˆå®¢æˆ·è¡¨ï¼Œå›é€€çº¿ç´¢è¡¨ï¼‰
- âœ… **å®¢æˆ·åˆ—è¡¨é¡µ**ï¼šç›´æ¥è¯»å–å®¢æˆ·è¡¨

### 3. æ•°æ®æµå‘

```
é”€å”®è®¾ç½®ï¼ˆçº¿ç´¢è¡¨ï¼‰
    â†“
è½¬å®¢æˆ·ï¼ˆå¤åˆ¶åˆ°å®¢æˆ·è¡¨ï¼‰
    â†“
ç­ä¸»ä»»å¯ä¿®æ”¹ï¼ˆå®¢æˆ·è¡¨ï¼‰
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### å¯¹äºå¼€å‘è€…

1. **å­¦å‘˜è¯¦æƒ…å¼¹çª—**ï¼š
   - å¿…é¡»æ£€æŸ¥æ˜¯å¦å·²è½¬å®¢æˆ·
   - ä¼˜å…ˆä»å®¢æˆ·è¡¨è¯»å–
   - å›é€€åˆ°çº¿ç´¢è¡¨

2. **å®¢æˆ·åˆ—è¡¨é¡µ**ï¼š
   - ç›´æ¥ä»å®¢æˆ·è¡¨è¯»å–
   - ä¸éœ€è¦æ£€æŸ¥çº¿ç´¢è¡¨

3. **æ•°æ®ä¿®æ”¹**ï¼š
   - çº¿ç´¢é˜¶æ®µï¼šä¿®æ”¹çº¿ç´¢è¡¨
   - å®¢æˆ·é˜¶æ®µï¼šä¿®æ”¹å®¢æˆ·è¡¨
   - è½¬å®¢æˆ·æ—¶ï¼šè‡ªåŠ¨åŒæ­¥

### å¯¹äºç”¨æˆ·

1. **é”€å”®äººå‘˜**ï¼š
   - åœ¨çº¿ç´¢ç¼–è¾‘é¡µé¢è®¾ç½®å¥–é¡¹è¦æ±‚
   - è½¬å®¢æˆ·æ—¶è‡ªåŠ¨å¸¦å…¥

2. **ç­ä¸»ä»»**ï¼š
   - åœ¨å®¢æˆ·ç¼–è¾‘é¡µé¢æŸ¥çœ‹å’Œä¿®æ”¹å¥–é¡¹è¦æ±‚
   - ä¿®æ”¹åªå½±å“å®¢æˆ·è¡¨

---

**æ–‡æ¡£ç»“æŸ**

