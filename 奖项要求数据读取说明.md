# 奖项要求数据读取说明

**文档版本**: v1.0  
**更新时间**: 2025-09-30  
**系统**: EduConnect CRM

---

## 📋 概述

本文档详细说明了系统中两个关键位置的奖项要求数据读取逻辑：
1. **学员详情弹窗** - 点击学员姓名时显示的详情弹窗
2. **客户列表页** - 客户管理页面的列表显示

---

## 🎯 数据读取位置总结

| 位置 | 数据来源 | 读取字段 | 说明 |
|-----|---------|---------|------|
| **学员详情弹窗** | 线索API / 客户API | `competition_award_level` + `additional_requirements` | 优先从线索表读取，如已转客户则从客户表读取 |
| **客户列表页** | 客户表 | `customer.competition_award_level` | 直接从客户表读取 |

---

## 1️⃣ 学员详情弹窗

### 📍 触发位置

- **线索列表页** (`templates/leads/list.html`)：点击学员姓名
- **客户列表页** (`templates/customers/list.html`)：点击学员姓名

### 🔄 数据流程

```
用户点击学员姓名
    ↓
JavaScript调用 showStudentDetailModal(studentId, isCustomer)
    ↓
根据isCustomer参数选择API端点：
  - 线索：/leads/{id}/api
  - 客户：/customers/{id}/api
    ↓
后端返回JSON数据
    ↓
前端填充弹窗内容
```

### 📊 后端API实现

#### 线索API (`routes/leads.py` 第810-846行)

<augment_code_snippet path="routes/leads.py" mode="EXCERPT">
```python
@leads_bp.route('/<int:lead_id>/api')
def lead_api(lead_id):
    """线索API详情 - 用于弹窗显示"""
    lead = Lead.query.get_or_404(lead_id)
    
    # 检查是否已转为客户
    customer = Customer.query.filter_by(lead_id=lead.id).first()
    
    lead_data = {
        'id': lead.id,
        'student_name': lead.student_name,
        # ... 其他字段 ...
        'service_types': lead.get_service_types_list(),
        
        # ✨ 关键逻辑：优先从线索表读取，如已转客户则从客户表读取
        'competition_award_level': customer.competition_award_level if customer else lead.competition_award_level,
        'additional_requirements': customer.additional_requirements if customer else lead.additional_requirements,
    }
    
    return jsonify({'success': True, 'lead': lead_data})
```
</augment_code_snippet>

**读取逻辑**：
1. 查询该线索是否已转为客户
2. **如果已转客户**：从 `customer.competition_award_level` 和 `customer.additional_requirements` 读取
3. **如果还是线索**：从 `lead.competition_award_level` 和 `lead.additional_requirements` 读取

#### 客户API (`routes/customers.py` 第262-316行)

<augment_code_snippet path="routes/customers.py" mode="EXCERPT">
```python
@customers_bp.route('/<int:customer_id>/api')
def customer_api(customer_id):
    """客户API详情 - 用于弹窗显示"""
    customer = Customer.query.get_or_404(customer_id)
    
    customer_data = {
        'id': customer.id,
        'student_name': customer.lead.student_name,
        # ... 其他字段 ...
        'service_types': customer.get_service_types(),
        
        # ✨ 直接从客户表读取
        'competition_award_level': customer.competition_award_level,
        'additional_requirements': customer.additional_requirements,
    }
    
    return jsonify({'success': True, 'customer': customer_data})
```
</augment_code_snippet>

**读取逻辑**：
- 直接从 `customer.competition_award_level` 和 `customer.additional_requirements` 读取

### 🖥️ 前端显示逻辑

#### 弹窗模板 (`templates/components/student_detail_modal.html`)

**竞赛奖项显示** (第195行):
```javascript
let awardText = studentData.competition_award_level || studentData.award_requirement || '无要求';
```

**额外要求显示** (第210-214行):
```javascript
if (studentData.additional_requirements) {
    const extraRow = document.getElementById('extraRequirementsRow');
    extraRow.classList.remove('hidden');
    document.getElementById('extraRequirements').textContent = studentData.additional_requirements;
}
```

### 📝 数据示例

#### 示例1：线索阶段（未转客户）

**API请求**: `GET /leads/6/api`

**返回数据**:
```json
{
  "success": true,
  "lead": {
    "id": 6,
    "student_name": "测试学员A",
    "service_types": ["tutoring", "competition"],
    "competition_award_level": "国奖",  // 从 lead.competition_award_level 读取
    "additional_requirements": "需要在2026年5月前完成"  // 从 lead.additional_requirements 读取
  }
}
```

#### 示例2：客户阶段（已转客户）

**API请求**: `GET /leads/6/api` 或 `GET /customers/6/api`

**返回数据**:
```json
{
  "success": true,
  "lead": {  // 或 "customer"
    "id": 6,
    "student_name": "测试学员A",
    "service_types": ["tutoring", "competition"],
    "competition_award_level": "国奖",  // 从 customer.competition_award_level 读取
    "additional_requirements": "测试额外要求：需要在2026年5月前完成所有课程并获得国奖"  // 从 customer.additional_requirements 读取
  }
}
```

---

## 2️⃣ 客户列表页

### 📍 显示位置

**文件**: `templates/customers/list.html`  
**位置**: 第94-102行

### 📊 数据读取

#### 后端路由 (`routes/customers.py` 第28-74行)

```python
@customers_bp.route('/list')
def list_customers():
    """客户列表"""
    query = Customer.query.join(Lead).options(
        db.joinedload(Customer.tutoring_delivery),
        db.joinedload(Customer.competition_delivery)
    )
    
    # 奖项要求过滤
    if award_filter:
        query = query.filter(Customer.competition_award_level == award_filter)
    
    customers = query.order_by(Customer.created_at.desc()).paginate(...)
    
    return render_template('customers/list.html', customers=customers, ...)
```

#### 前端模板显示

<augment_code_snippet path="templates/customers/list.html" mode="EXCERPT">
```html
<td class="whitespace-nowrap px-6 py-4 text-sm">
    {% if customer.competition_award_level == '市奖' %}
        <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">市奖</span>
    {% elif customer.competition_award_level == '国奖' %}
        <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">国奖</span>
    {% else %}
        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">无</span>
    {% endif %}
</td>
```
</augment_code_snippet>

**读取逻辑**：
- ✅ 直接从 `customer.competition_award_level` 读取
- ✅ 根据值显示不同颜色的标签：
  - `'市奖'` → 蓝色标签
  - `'国奖'` → 红色标签
  - `None` 或其他 → 灰色标签显示"无"

### 📝 数据示例

#### 客户列表显示

| 学员姓名 | 班主任 | 奖项要求 | 中高考年份 |
|---------|-------|---------|-----------|
| 测试学员A | Kingble | 🔴 国奖 | 2026年 |
| 唐芯忬 | 葛 | ⚪ 无 | 2027年 |
| 李四 | 王老师 | 🔵 市奖 | 2028年 |

**数据来源**：
- 奖项要求：`customer.competition_award_level`（客户表）
- 学员姓名：`customer.lead.student_name`（线索表）
- 班主任：`customer.teacher_user`（用户表）
- 中高考年份：`customer.exam_year`（客户表）

---

## 🔄 数据同步机制

### 线索转客户时的数据复制

**文件**: `routes/leads.py` 第896-910行

```python
@leads_bp.route('/<int:lead_id>/convert', methods=['POST'])
def convert_to_customer(lead_id):
    """将线索转换为客户"""
    lead = Lead.query.get_or_404(lead_id)
    
    # 创建客户记录，从线索表复制字段
    result = db.session.execute(insert_sql, {
        'lead_id': lead.id,
        'teacher_user_id': teacher_id,
        'competition_award_level': lead.competition_award_level,  # ✨ 从线索表复制
        'additional_requirements': lead.additional_requirements,  # ✨ 从线索表复制
        'exam_year': exam_year,
        # ...
    })
```

**同步逻辑**：
1. 线索转客户时，自动将 `lead.competition_award_level` 复制到 `customer.competition_award_level`
2. 自动将 `lead.additional_requirements` 复制到 `customer.additional_requirements`
3. 转换后，两个表都保留这些数据

---

## 📊 数据存储架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    线索表 (leads)                            │
├─────────────────────────────────────────────────────────────┤
│ id: 6                                                        │
│ student_name: '测试学员A'                                    │
│ competition_award_level: '国奖'  ← 销售在线索阶段设置       │
│ additional_requirements: '需要在2026年5月前完成'            │
└─────────────────────────────────────────────────────────────┘
                            ↓ 转客户时复制
┌─────────────────────────────────────────────────────────────┐
│                   客户表 (customers)                         │
├─────────────────────────────────────────────────────────────┤
│ id: 6                                                        │
│ lead_id: 6                                                   │
│ competition_award_level: '国奖'  ← 从线索表复制             │
│ additional_requirements: '需要在2026年5月前完成'            │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 读取优先级总结

### 学员详情弹窗

| 场景 | 数据来源 | 优先级 |
|-----|---------|-------|
| 线索阶段（未转客户） | `lead.competition_award_level` | 线索表 |
| 客户阶段（已转客户） | `customer.competition_award_level` | 客户表 ✨ |

**判断逻辑**：
```python
customer = Customer.query.filter_by(lead_id=lead.id).first()
award_level = customer.competition_award_level if customer else lead.competition_award_level
```

### 客户列表页

| 场景 | 数据来源 | 说明 |
|-----|---------|------|
| 客户列表 | `customer.competition_award_level` | 只显示已转客户的数据 |

**读取逻辑**：
```python
customer.competition_award_level  # 直接从客户表读取
```

---

## 💡 关键要点

### 1. 数据一致性

- ✅ 线索阶段：销售在线索表设置奖项要求
- ✅ 转客户时：自动复制到客户表
- ✅ 客户阶段：可以在客户表修改

### 2. 读取策略

- ✅ **学员详情弹窗**：智能读取（优先客户表，回退线索表）
- ✅ **客户列表页**：直接读取客户表

### 3. 数据流向

```
销售设置（线索表）
    ↓
转客户（复制到客户表）
    ↓
班主任可修改（客户表）
```

---

## 📝 注意事项

### 对于开发者

1. **学员详情弹窗**：
   - 必须检查是否已转客户
   - 优先从客户表读取
   - 回退到线索表

2. **客户列表页**：
   - 直接从客户表读取
   - 不需要检查线索表

3. **数据修改**：
   - 线索阶段：修改线索表
   - 客户阶段：修改客户表
   - 转客户时：自动同步

### 对于用户

1. **销售人员**：
   - 在线索编辑页面设置奖项要求
   - 转客户时自动带入

2. **班主任**：
   - 在客户编辑页面查看和修改奖项要求
   - 修改只影响客户表

---

**文档结束**

