# 服务器部署命令 - 简化版

## 🚀 快速部署（复制粘贴执行）

### 步骤 1：进入项目目录并拉取代码

```bash
cd /root/crm
git pull origin main
```

### 步骤 2：激活虚拟环境

```bash
# 查找虚拟环境目录
ls -la | grep -E "venv|env|virtualenv"

# 激活虚拟环境（根据实际目录名选择）
source venv/bin/activate
# 或
source env/bin/activate
# 或
source .venv/bin/activate
```

**确认虚拟环境已激活**：
- 命令行前面应该显示 `(venv)` 或 `(env)`
- 运行 `which python` 应该显示虚拟环境中的 Python 路径

### 步骤 3：运行数据库迁移

```bash
python add_user_id_to_communications.py
```

**预期输出**：
```
=== 开始数据库迁移：添加 user_id 字段到 communication_records 表 ===

正在添加 user_id 字段...
✅ user_id 字段添加成功

=== 迁移完成 ===
```

或者（如果字段已存在）：
```
=== 开始数据库迁移：添加 user_id 字段到 communication_records 表 ===

✅ user_id 字段已存在，无需添加

=== 迁移完成 ===
```

### 步骤 4：重启服务

```bash
# 方法 1：使用 systemd
sudo systemctl restart crm

# 方法 2：使用 supervisor
sudo supervisorctl restart crm

# 方法 3：手动重启
pkill -f "python.*run.py"
nohup python run.py > logs/app.log 2>&1 &
```

### 步骤 5：配置自动备份

```bash
# 确保仍在虚拟环境中
bash setup_backup_cron.sh
```

按提示操作：
1. 看到 "是否立即运行一次备份测试？[Y/n]" 时，输入 `y`
2. 确认备份成功

### 步骤 6：验证部署

```bash
# 1. 检查备份目录
ls -lh bak/

# 2. 查看备份日志
tail -20 bak/backup.log

# 3. 查看 cron 任务
crontab -l

# 4. 检查服务状态
sudo systemctl status crm
# 或
sudo supervisorctl status crm
```

---

## 🔍 故障排查

### 问题 1：找不到虚拟环境

```bash
# 在项目目录下查找
find . -name "activate" -type f

# 如果找到，激活它
source ./path/to/venv/bin/activate
```

### 问题 2：ModuleNotFoundError: No module named 'flask'

**原因**：虚拟环境未激活

**解决**：
```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 确认 Python 路径
which python
# 应该显示：/root/crm/venv/bin/python

# 3. 重新运行迁移
python add_user_id_to_communications.py
```

### 问题 3：数据库文件不存在

```bash
# 查找数据库文件
find . -name "*.db" -type f

# 应该找到：./instance/edu_crm.db
```

### 问题 4：权限不足

```bash
# 设置脚本执行权限
chmod +x *.sh

# 设置数据库文件权限
chmod 644 instance/edu_crm.db
```

---

## 📋 完整的一键命令（复制粘贴）

```bash
# 进入项目目录
cd /root/crm

# 拉取最新代码
git pull origin main

# 激活虚拟环境（根据实际情况选择）
source venv/bin/activate

# 运行数据库迁移
python add_user_id_to_communications.py

# 重启服务（根据实际情况选择）
sudo systemctl restart crm

# 配置自动备份
bash setup_backup_cron.sh

# 验证部署
echo "=== 检查备份目录 ==="
ls -lh bak/

echo "=== 检查 cron 任务 ==="
crontab -l

echo "=== 检查服务状态 ==="
sudo systemctl status crm
```

---

## ✅ 验证清单

部署完成后，请验证以下内容：

### 数据库迁移验证
- [ ] 访问 http://47.100.238.50
- [ ] 登录账号：13900139001
- [ ] 进入线索列表页
- [ ] 点击任意学员姓名
- [ ] 确认学员详情弹窗正常显示（无 JSON 错误）
- [ ] 点击"新增沟通记录"
- [ ] 填写内容并保存
- [ ] 确认显示填写人信息（如：Kingble老师）

### 自动备份验证
- [ ] 运行 `crontab -l` 看到备份任务
- [ ] 运行 `ls -lh bak/` 看到备份文件
- [ ] 运行 `tail -20 bak/backup.log` 看到备份日志
- [ ] 备份文件格式：`edu_crm_YYYYMMDD_HHMMSS.db`

---

**服务器**：47.100.238.50  
**项目路径**：/root/crm  
**数据库文件**：instance/edu_crm.db  
**备份目录**：bak/

