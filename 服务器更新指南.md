# Ubuntu 云服务器项目更新指南

## 📋 更新前准备

### 1. 确认当前部署方式

首先需要确认服务器上的部署方式，执行以下命令：

```bash
# 检查是否使用 Docker
docker ps | grep crm

# 检查是否使用 systemd 服务
systemctl status crm

# 检查是否使用 supervisor
supervisorctl status

# 检查是否直接运行 Python 进程
ps aux | grep python | grep crm
```

---

## 🔄 更新步骤（Docker 部署方式）

### 步骤 1: 备份数据库

```bash
# 进入项目目录
cd /path/to/crm

# 备份数据库
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db

# 验证备份
ls -lh instance/edu_crm_backup_*.db
```

### 步骤 2: 拉取最新代码

```bash
# 查看当前分支和状态
git status
git branch

# 拉取最新代码
git pull origin master

# 如果有本地修改冲突，先备份本地修改
git stash
git pull origin master
# 如需恢复本地修改: git stash pop
```

### 步骤 3: 停止服务

```bash
# 停止 Docker 容器
docker compose down

# 或者使用旧版本命令
docker-compose down
```

### 步骤 4: 重新构建并启动

```bash
# 重新构建镜像（如果有代码变更）
docker compose build --no-cache

# 启动服务
docker compose up -d

# 查看启动日志
docker compose logs -f crm-app
```

### 步骤 5: 验证服务

```bash
# 检查容器状态
docker compose ps

# 检查应用健康状态
curl http://localhost:5000/auth/login

# 查看最近的日志
docker compose logs --tail=50 crm-app
```

---

## 🔄 更新步骤（直接运行方式）

### 步骤 1: 备份数据库

```bash
# 进入项目目录
cd /path/to/crm

# 备份数据库
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db
```

### 步骤 2: 停止服务

```bash
# 如果使用 systemd
sudo systemctl stop crm

# 如果使用 supervisor
sudo supervisorctl stop crm

# 如果直接运行，找到进程并停止
ps aux | grep "python.*run.py"
kill -15 <PID>  # 使用上面找到的进程ID
```

### 步骤 3: 拉取最新代码

```bash
# 拉取最新代码
git pull origin master

# 激活虚拟环境
source venv/bin/activate

# 更新依赖（如果 requirements.txt 有变化）
pip install -r requirements.txt --upgrade
```

### 步骤 4: 重启服务

```bash
# 如果使用 systemd
sudo systemctl start crm
sudo systemctl status crm

# 如果使用 supervisor
sudo supervisorctl start crm
sudo supervisorctl status crm

# 如果直接运行
nohup python run.py > logs/app.log 2>&1 &
```

### 步骤 5: 验证服务

```bash
# 检查进程
ps aux | grep python | grep crm

# 检查应用
curl http://localhost:5000/auth/login

# 查看日志
tail -f logs/crm.log
```

---

## 🚨 回滚方案

如果更新后出现问题，可以快速回滚：

### Docker 方式回滚

```bash
# 停止当前服务
docker compose down

# 回退代码
git log --oneline -5  # 查看最近的提交
git reset --hard <上一个提交的hash>

# 恢复数据库
cp instance/edu_crm_backup_YYYYMMDD_HHMMSS.db instance/edu_crm.db

# 重新启动
docker compose up -d
```

### 直接运行方式回滚

```bash
# 停止服务
sudo systemctl stop crm  # 或 supervisorctl stop crm

# 回退代码
git reset --hard <上一个提交的hash>

# 恢复数据库
cp instance/edu_crm_backup_YYYYMMDD_HHMMSS.db instance/edu_crm.db

# 重启服务
sudo systemctl start crm  # 或 supervisorctl start crm
```

---

## 📝 本次更新内容

### 主要变更

1. **线索删除功能修复**
   - 修复了删除线索时的外键约束错误
   - 现在会正确删除所有关联数据（沟通记录、付款记录、客户数据等）

2. **项目清理**
   - 删除了83个失效文件（测试脚本、临时工具、过时文档）
   - 项目结构更加清晰

3. **代码优化**
   - 优化了管理员线索管理功能
   - 改进了时间段筛选功能

### 数据库变更

本次更新**没有数据库结构变更**，无需执行数据库迁移。

---

## ✅ 更新检查清单

更新完成后，请检查以下项目：

- [ ] 服务正常启动
- [ ] 登录功能正常
- [ ] 线索列表页正常显示
- [ ] 客户列表页正常显示
- [ ] 管理员线索管理功能正常
- [ ] 删除线索功能正常（测试删除一个测试线索）
- [ ] 时间段筛选功能正常
- [ ] 数据库备份已创建

---

## 🆘 常见问题

### 1. 端口被占用

```bash
# 查看端口占用
sudo lsof -i :5000

# 杀死占用进程
sudo kill -9 <PID>
```

### 2. 权限问题

```bash
# 修复文件权限
sudo chown -R $USER:$USER /path/to/crm
chmod -R 755 /path/to/crm
```

### 3. Docker 镜像构建失败

```bash
# 清理旧镜像
docker system prune -a

# 重新构建
docker compose build --no-cache
```

### 4. 数据库锁定

```bash
# 检查是否有进程占用数据库
lsof instance/edu_crm.db

# 停止所有相关进程后重试
```

---

## 📞 技术支持

如果遇到问题，请提供以下信息：

1. 部署方式（Docker / 直接运行）
2. 错误日志（`docker compose logs` 或 `logs/crm.log`）
3. 系统信息（`uname -a`）
4. Python 版本（`python --version`）

---

## 🔐 安全建议

1. **定期备份数据库**
   ```bash
   # 添加到 crontab
   0 2 * * * cd /path/to/crm && cp instance/edu_crm.db instance/edu_crm_backup_$(date +\%Y\%m\%d).db
   ```

2. **保留最近7天的备份**
   ```bash
   # 清理旧备份
   find instance/ -name "edu_crm_backup_*.db" -mtime +7 -delete
   ```

3. **监控日志文件大小**
   ```bash
   # 检查日志大小
   du -sh logs/
   ```

