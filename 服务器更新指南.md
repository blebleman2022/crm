# Ubuntu äº‘æœåŠ¡å™¨é¡¹ç›®æ›´æ–°æŒ‡å—

## ğŸ“‹ æ›´æ–°å‰å‡†å¤‡

### 1. ç¡®è®¤å½“å‰éƒ¨ç½²æ–¹å¼

é¦–å…ˆéœ€è¦ç¡®è®¤æœåŠ¡å™¨ä¸Šçš„éƒ¨ç½²æ–¹å¼ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ Docker
docker ps | grep crm

# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ systemd æœåŠ¡
systemctl status crm

# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ supervisor
supervisorctl status

# æ£€æŸ¥æ˜¯å¦ç›´æ¥è¿è¡Œ Python è¿›ç¨‹
ps aux | grep python | grep crm
```

---

## ğŸ”„ æ›´æ–°æ­¥éª¤ï¼ˆDocker éƒ¨ç½²æ–¹å¼ï¼‰

### æ­¥éª¤ 1: å¤‡ä»½æ•°æ®åº“

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/crm

# å¤‡ä»½æ•°æ®åº“
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db

# éªŒè¯å¤‡ä»½
ls -lh instance/edu_crm_backup_*.db
```

### æ­¥éª¤ 2: æ‹‰å–æœ€æ–°ä»£ç 

```bash
# æŸ¥çœ‹å½“å‰åˆ†æ”¯å’ŒçŠ¶æ€
git status
git branch

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# å¦‚æœæœ‰æœ¬åœ°ä¿®æ”¹å†²çªï¼Œå…ˆå¤‡ä»½æœ¬åœ°ä¿®æ”¹
git stash
git pull origin master
# å¦‚éœ€æ¢å¤æœ¬åœ°ä¿®æ”¹: git stash pop
```

### æ­¥éª¤ 3: åœæ­¢æœåŠ¡

```bash
# åœæ­¢ Docker å®¹å™¨
docker compose down

# æˆ–è€…ä½¿ç”¨æ—§ç‰ˆæœ¬å‘½ä»¤
docker-compose down
```

### æ­¥éª¤ 4: é‡æ–°æ„å»ºå¹¶å¯åŠ¨

```bash
# é‡æ–°æ„å»ºé•œåƒï¼ˆå¦‚æœæœ‰ä»£ç å˜æ›´ï¼‰
docker compose build --no-cache

# å¯åŠ¨æœåŠ¡
docker compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker compose logs -f crm-app
```

### æ­¥éª¤ 5: éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose ps

# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
curl http://localhost:5000/auth/login

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
docker compose logs --tail=50 crm-app
```

---

## ğŸ”„ æ›´æ–°æ­¥éª¤ï¼ˆç›´æ¥è¿è¡Œæ–¹å¼ï¼‰

### æ­¥éª¤ 1: å¤‡ä»½æ•°æ®åº“

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/crm

# å¤‡ä»½æ•°æ®åº“
cp instance/edu_crm.db instance/edu_crm_backup_$(date +%Y%m%d_%H%M%S).db
```

### æ­¥éª¤ 2: åœæ­¢æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨ systemd
sudo systemctl stop crm

# å¦‚æœä½¿ç”¨ supervisor
sudo supervisorctl stop crm

# å¦‚æœç›´æ¥è¿è¡Œï¼Œæ‰¾åˆ°è¿›ç¨‹å¹¶åœæ­¢
ps aux | grep "python.*run.py"
kill -15 <PID>  # ä½¿ç”¨ä¸Šé¢æ‰¾åˆ°çš„è¿›ç¨‹ID
```

### æ­¥éª¤ 3: æ‹‰å–æœ€æ–°ä»£ç 

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ requirements.txt æœ‰å˜åŒ–ï¼‰
pip install -r requirements.txt --upgrade
```

### æ­¥éª¤ 4: é‡å¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨ systemd
sudo systemctl start crm
sudo systemctl status crm

# å¦‚æœä½¿ç”¨ supervisor
sudo supervisorctl start crm
sudo supervisorctl status crm

# å¦‚æœç›´æ¥è¿è¡Œ
nohup python run.py > logs/app.log 2>&1 &
```

### æ­¥éª¤ 5: éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep python | grep crm

# æ£€æŸ¥åº”ç”¨
curl http://localhost:5000/auth/login

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/crm.log
```

---

## ğŸš¨ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ›´æ–°åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### Docker æ–¹å¼å›æ»š

```bash
# åœæ­¢å½“å‰æœåŠ¡
docker compose down

# å›é€€ä»£ç 
git log --oneline -5  # æŸ¥çœ‹æœ€è¿‘çš„æäº¤
git reset --hard <ä¸Šä¸€ä¸ªæäº¤çš„hash>

# æ¢å¤æ•°æ®åº“
cp instance/edu_crm_backup_YYYYMMDD_HHMMSS.db instance/edu_crm.db

# é‡æ–°å¯åŠ¨
docker compose up -d
```

### ç›´æ¥è¿è¡Œæ–¹å¼å›æ»š

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop crm  # æˆ– supervisorctl stop crm

# å›é€€ä»£ç 
git reset --hard <ä¸Šä¸€ä¸ªæäº¤çš„hash>

# æ¢å¤æ•°æ®åº“
cp instance/edu_crm_backup_YYYYMMDD_HHMMSS.db instance/edu_crm.db

# é‡å¯æœåŠ¡
sudo systemctl start crm  # æˆ– supervisorctl start crm
```

---

## ğŸ“ æœ¬æ¬¡æ›´æ–°å†…å®¹

### ä¸»è¦å˜æ›´

1. **çº¿ç´¢åˆ é™¤åŠŸèƒ½ä¿®å¤**
   - ä¿®å¤äº†åˆ é™¤çº¿ç´¢æ—¶çš„å¤–é”®çº¦æŸé”™è¯¯
   - ç°åœ¨ä¼šæ­£ç¡®åˆ é™¤æ‰€æœ‰å…³è”æ•°æ®ï¼ˆæ²Ÿé€šè®°å½•ã€ä»˜æ¬¾è®°å½•ã€å®¢æˆ·æ•°æ®ç­‰ï¼‰

2. **é¡¹ç›®æ¸…ç†**
   - åˆ é™¤äº†83ä¸ªå¤±æ•ˆæ–‡ä»¶ï¼ˆæµ‹è¯•è„šæœ¬ã€ä¸´æ—¶å·¥å…·ã€è¿‡æ—¶æ–‡æ¡£ï¼‰
   - é¡¹ç›®ç»“æ„æ›´åŠ æ¸…æ™°

3. **ä»£ç ä¼˜åŒ–**
   - ä¼˜åŒ–äº†ç®¡ç†å‘˜çº¿ç´¢ç®¡ç†åŠŸèƒ½
   - æ”¹è¿›äº†æ—¶é—´æ®µç­›é€‰åŠŸèƒ½

### æ•°æ®åº“å˜æ›´

æœ¬æ¬¡æ›´æ–°**æ²¡æœ‰æ•°æ®åº“ç»“æ„å˜æ›´**ï¼Œæ— éœ€æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

---

## âœ… æ›´æ–°æ£€æŸ¥æ¸…å•

æ›´æ–°å®Œæˆåï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] çº¿ç´¢åˆ—è¡¨é¡µæ­£å¸¸æ˜¾ç¤º
- [ ] å®¢æˆ·åˆ—è¡¨é¡µæ­£å¸¸æ˜¾ç¤º
- [ ] ç®¡ç†å‘˜çº¿ç´¢ç®¡ç†åŠŸèƒ½æ­£å¸¸
- [ ] åˆ é™¤çº¿ç´¢åŠŸèƒ½æ­£å¸¸ï¼ˆæµ‹è¯•åˆ é™¤ä¸€ä¸ªæµ‹è¯•çº¿ç´¢ï¼‰
- [ ] æ—¶é—´æ®µç­›é€‰åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®åº“å¤‡ä»½å·²åˆ›å»º

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :5000

# æ€æ­»å ç”¨è¿›ç¨‹
sudo kill -9 <PID>
```

### 2. æƒé™é—®é¢˜

```bash
# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R $USER:$USER /path/to/crm
chmod -R 755 /path/to/crm
```

### 3. Docker é•œåƒæ„å»ºå¤±è´¥

```bash
# æ¸…ç†æ—§é•œåƒ
docker system prune -a

# é‡æ–°æ„å»º
docker compose build --no-cache
```

### 4. æ•°æ®åº“é”å®š

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹å ç”¨æ•°æ®åº“
lsof instance/edu_crm.db

# åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹åé‡è¯•
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. éƒ¨ç½²æ–¹å¼ï¼ˆDocker / ç›´æ¥è¿è¡Œï¼‰
2. é”™è¯¯æ—¥å¿—ï¼ˆ`docker compose logs` æˆ– `logs/crm.log`ï¼‰
3. ç³»ç»Ÿä¿¡æ¯ï¼ˆ`uname -a`ï¼‰
4. Python ç‰ˆæœ¬ï¼ˆ`python --version`ï¼‰

---

## ğŸ” å®‰å…¨å»ºè®®

1. **å®šæœŸå¤‡ä»½æ•°æ®åº“**
   ```bash
   # æ·»åŠ åˆ° crontab
   0 2 * * * cd /path/to/crm && cp instance/edu_crm.db instance/edu_crm_backup_$(date +\%Y\%m\%d).db
   ```

2. **ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½**
   ```bash
   # æ¸…ç†æ—§å¤‡ä»½
   find instance/ -name "edu_crm_backup_*.db" -mtime +7 -delete
   ```

3. **ç›‘æ§æ—¥å¿—æ–‡ä»¶å¤§å°**
   ```bash
   # æ£€æŸ¥æ—¥å¿—å¤§å°
   du -sh logs/
   ```

