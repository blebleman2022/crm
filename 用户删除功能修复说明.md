# ç”¨æˆ·åˆ é™¤åŠŸèƒ½ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¥æœŸ**: 2025-09-30  
**é—®é¢˜**: ç”¨æˆ·è´¦å·åˆ é™¤å¤±è´¥ï¼Œæç¤º"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•"  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ

åœ¨ç®¡ç†é¡µé¢å°è¯•åˆ é™¤ç”¨æˆ·è´¦å·æ—¶ï¼Œç³»ç»Ÿæç¤ºï¼š

```
127.0.0.1:5001 æ˜¾ç¤º
æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•
```

### é”™è¯¯åŸå› 

åœ¨ `routes/admin.py` çš„ `delete_user` å‡½æ•°ä¸­ï¼Œä»£ç å°è¯•è®¿é—® `user.customers_as_sales` å…³ç³»ï¼š

```python
customers_count = user.customers_as_sales.count() + user.customers_as_teacher.count()
```

ä½†æ˜¯åœ¨ `models.py` çš„ User æ¨¡å‹ä¸­ï¼Œåªå®šä¹‰äº† `customers_as_teacher` å…³ç³»ï¼Œæ²¡æœ‰å®šä¹‰ `customers_as_sales` å…³ç³»ï¼š

```python
class User(UserMixin, db.Model):
    # å…³è”å…³ç³»
    leads_as_sales = db.relationship('Lead', foreign_keys='Lead.sales_user_id', ...)
    customers_as_teacher = db.relationship('Customer', foreign_keys='Customer.teacher_user_id', ...)
    # âŒ ç¼ºå°‘ customers_as_sales å…³ç³»
```

### ä¸ºä»€ä¹ˆç¼ºå°‘è¿™ä¸ªå…³ç³»ï¼Ÿ

åœ¨ä¹‹å‰çš„"æ–¹æ¡ˆBå½»åº•ä¼˜åŒ–"ä¸­ï¼Œå®¢æˆ·è¡¨çš„ `sales_user_id` å­—æ®µè¢«ä»æ¨¡å‹ä¸­ç§»é™¤äº†ï¼ˆè™½ç„¶æ•°æ®åº“è¡¨ä¸­ä»ç„¶å­˜åœ¨ï¼‰ã€‚ç°åœ¨é”€å”®ä¿¡æ¯é€šè¿‡ `customer.lead.sales_user_id` è®¿é—®ï¼Œè€Œä¸æ˜¯ç›´æ¥å­˜å‚¨åœ¨å®¢æˆ·è¡¨ä¸­ã€‚

å› æ­¤ï¼ŒUser æ¨¡å‹ä¸å†éœ€è¦ `customers_as_sales` å…³ç³»ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**: `routes/admin.py`  
**ä½ç½®**: ç¬¬192è¡Œ

**ä¿®æ”¹å‰**:
```python
# æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
leads_count = user.leads_as_sales.count()
customers_count = user.customers_as_sales.count() + user.customers_as_teacher.count()
```

**ä¿®æ”¹å**:
```python
# æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
leads_count = user.leads_as_sales.count()
customers_count = user.customers_as_teacher.count()
```

### ä¿®å¤é€»è¾‘

1. **é”€å”®äººå‘˜**ï¼š
   - æ£€æŸ¥ `leads_as_sales`ï¼ˆä½œä¸ºé”€å”®è´Ÿè´£çš„çº¿ç´¢ï¼‰
   - ä¸éœ€è¦æ£€æŸ¥å®¢æˆ·è¡¨ï¼Œå› ä¸ºé”€å”®ä¿¡æ¯åœ¨çº¿ç´¢è¡¨ä¸­

2. **ç­ä¸»ä»»**ï¼š
   - æ£€æŸ¥ `customers_as_teacher`ï¼ˆä½œä¸ºç­ä¸»ä»»è´Ÿè´£çš„å®¢æˆ·ï¼‰

3. **åˆ é™¤æ¡ä»¶**ï¼š
   - å¦‚æœç”¨æˆ·æœ‰å…³è”çš„çº¿ç´¢æˆ–å®¢æˆ·ï¼Œä¸å…è®¸åˆ é™¤
   - å¦‚æœæ²¡æœ‰å…³è”æ•°æ®ï¼Œå¯ä»¥åˆ é™¤

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `test_delete_user.py` æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯åˆ é™¤åŠŸèƒ½ï¼š

```python
# 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
test_user = User(username='æµ‹è¯•ç”¨æˆ·_å¾…åˆ é™¤', phone='13999999999', role='sales')

# 2. æ·»åŠ ç™»å½•æ—¥å¿—
login_log = LoginLog(user_id=test_user.id, phone=test_user.phone)

# 3. æ£€æŸ¥å…³è”æ•°æ®
leads_count = test_user.leads_as_sales.count()
customers_count = test_user.customers_as_teacher.count()

# 4. æ‰§è¡Œåˆ é™¤
LoginLog.query.filter_by(user_id=test_user.id).delete()
db.session.delete(test_user)
db.session.commit()

# 5. éªŒè¯åˆ é™¤ç»“æœ
âœ… ç”¨æˆ·å·²è¢«åˆ é™¤
âœ… ç™»å½•æ—¥å¿—å·²è¢«åˆ é™¤
```

### æµ‹è¯•ç»“æœ

```
============================================================
æµ‹è¯•ç”¨æˆ·åˆ é™¤åŠŸèƒ½
============================================================

1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·...
âœ… åˆ›å»ºæˆåŠŸï¼Œç”¨æˆ·ID: 20

2. æ·»åŠ ç™»å½•æ—¥å¿—...
âœ… ç™»å½•æ—¥å¿—æ·»åŠ æˆåŠŸ

3. æ£€æŸ¥å…³è”æ•°æ®...
  å…³è”çº¿ç´¢æ•°: 0
  å…³è”å®¢æˆ·æ•°: 0
  ç™»å½•æ—¥å¿—æ•°: 1
  å¯åˆ é™¤: æ˜¯

4. æ‰§è¡Œåˆ é™¤æ“ä½œ...
  âœ… åˆ é™¤äº† 1 æ¡ç™»å½•æ—¥å¿—
  âœ… åˆ é™¤ç”¨æˆ·æˆåŠŸ: æµ‹è¯•ç”¨æˆ·_å¾…åˆ é™¤

5. éªŒè¯åˆ é™¤ç»“æœ...
  âœ… ç”¨æˆ·å·²è¢«åˆ é™¤
  âœ… ç™»å½•æ—¥å¿—å·²è¢«åˆ é™¤

============================================================
âœ… æµ‹è¯•å®Œæˆ
============================================================
```

---

## ğŸ“Š ç”¨æˆ·åˆ é™¤è§„åˆ™

### å¯ä»¥åˆ é™¤çš„ç”¨æˆ·

- âœ… æ²¡æœ‰å…³è”çº¿ç´¢çš„é”€å”®äººå‘˜
- âœ… æ²¡æœ‰å…³è”å®¢æˆ·çš„ç­ä¸»ä»»
- âœ… æ²¡æœ‰ä»»ä½•å…³è”æ•°æ®çš„ç®¡ç†å‘˜ï¼ˆé™¤äº†å½“å‰ç™»å½•çš„ç®¡ç†å‘˜ï¼‰

### ä¸èƒ½åˆ é™¤çš„ç”¨æˆ·

- âŒ å½“å‰ç™»å½•çš„ç”¨æˆ·ï¼ˆè‡ªå·±ï¼‰
- âŒ æœ‰å…³è”çº¿ç´¢çš„é”€å”®äººå‘˜
- âŒ æœ‰å…³è”å®¢æˆ·çš„ç­ä¸»ä»»

### åˆ é™¤æ—¶çš„æ¸…ç†æ“ä½œ

1. **åˆ é™¤ç™»å½•æ—¥å¿—**ï¼šè‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç™»å½•æ—¥å¿—
2. **åˆ é™¤ç”¨æˆ·è®°å½•**ï¼šä»ç”¨æˆ·è¡¨ä¸­åˆ é™¤è¯¥ç”¨æˆ·

---

## ğŸ’» å®Œæ•´çš„åˆ é™¤å‡½æ•°

```python
@admin_bp.route('/users/<int:user_id>/delete', methods=['POST'])
@login_required
@admin_required
def delete_user(user_id):
    """åˆ é™¤ç”¨æˆ·"""
    user = User.query.get_or_404(user_id)

    # ä¸èƒ½åˆ é™¤è‡ªå·±
    if user.id == current_user.id:
        return jsonify({'success': False, 'message': 'ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦å·'})

    # æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
    leads_count = user.leads_as_sales.count()
    customers_count = user.customers_as_teacher.count()

    if leads_count > 0 or customers_count > 0:
        return jsonify({
            'success': False,
            'message': f'ç”¨æˆ· {user.username} æœ‰å…³è”çš„çº¿ç´¢æˆ–å®¢æˆ·æ•°æ®ï¼Œæ— æ³•åˆ é™¤'
        })

    try:
        username = user.username

        # åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç™»å½•æ—¥å¿—
        LoginLog.query.filter_by(user_id=user.id).delete()

        # åˆ é™¤ç”¨æˆ·
        db.session.delete(user)
        db.session.commit()
        return jsonify({
            'success': True,
            'message': f'ç”¨æˆ· {username} å·²åˆ é™¤'
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'åˆ é™¤å¤±è´¥: {str(e)}'})
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šåˆ é™¤æ²¡æœ‰å…³è”æ•°æ®çš„ç”¨æˆ·

```
1. ç®¡ç†å‘˜è¿›å…¥"ç”¨æˆ·ç®¡ç†"é¡µé¢
2. æ‰¾åˆ°è¦åˆ é™¤çš„ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šå¼ ä¸‰ï¼‰
3. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
4. ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†
   â†“
5. ç³»ç»Ÿæ£€æŸ¥ï¼š
   - å…³è”çº¿ç´¢æ•°: 0
   - å…³è”å®¢æˆ·æ•°: 0
   â†“
6. âœ… åˆ é™¤æˆåŠŸ
   - åˆ é™¤ç™»å½•æ—¥å¿—
   - åˆ é™¤ç”¨æˆ·è®°å½•
   - æ˜¾ç¤ºæç¤ºï¼š"ç”¨æˆ· å¼ ä¸‰ å·²åˆ é™¤"
   - é¡µé¢è‡ªåŠ¨åˆ·æ–°
```

### åœºæ™¯2ï¼šå°è¯•åˆ é™¤æœ‰å…³è”æ•°æ®çš„ç”¨æˆ·

```
1. ç®¡ç†å‘˜è¿›å…¥"ç”¨æˆ·ç®¡ç†"é¡µé¢
2. æ‰¾åˆ°è¦åˆ é™¤çš„ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šKingbleï¼‰
3. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
4. ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†
   â†“
5. ç³»ç»Ÿæ£€æŸ¥ï¼š
   - å…³è”çº¿ç´¢æ•°: 6
   - å…³è”å®¢æˆ·æ•°: 1
   â†“
6. âŒ åˆ é™¤å¤±è´¥
   - æ˜¾ç¤ºæç¤ºï¼š"ç”¨æˆ· Kingble æœ‰å…³è”çš„çº¿ç´¢æˆ–å®¢æˆ·æ•°æ®ï¼Œæ— æ³•åˆ é™¤"
   - ç”¨æˆ·è®°å½•ä¿æŒä¸å˜
```

### åœºæ™¯3ï¼šå°è¯•åˆ é™¤è‡ªå·±

```
1. ç®¡ç†å‘˜è¿›å…¥"ç”¨æˆ·ç®¡ç†"é¡µé¢
2. æ‰¾åˆ°è‡ªå·±çš„è´¦å·
3. "åˆ é™¤"æŒ‰é’®ä¸æ˜¾ç¤ºï¼ˆå‰ç«¯å·²éšè—ï¼‰
   
å¦‚æœé€šè¿‡APIç›´æ¥è°ƒç”¨ï¼š
   â†“
4. âŒ åˆ é™¤å¤±è´¥
   - æ˜¾ç¤ºæç¤ºï¼š"ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦å·"
```

---

## ğŸ“ å½“å‰ç³»ç»Ÿç”¨æˆ·çŠ¶æ€

æ ¹æ®æµ‹è¯•ç»“æœï¼Œå½“å‰ç³»ç»Ÿä¸­çš„ç”¨æˆ·çŠ¶æ€ï¼š

| ID | ç”¨æˆ·å | è§’è‰² | å…³è”çº¿ç´¢ | å…³è”å®¢æˆ· | å¯åˆ é™¤ |
|----|--------|------|---------|---------|--------|
| 1  | admin | admin | 0 | 0 | âœ… æ˜¯ |
| 8  | Lucol | sales | 0 | 0 | âœ… æ˜¯ |
| 9  | ç‰å©· | sales | 0 | 0 | âœ… æ˜¯ |
| 10 | Tom | teacher | 0 | 0 | âœ… æ˜¯ |
| 12 | admin | admin | 0 | 0 | âœ… æ˜¯ |
| 13 | Kingble | sales | 6 | 1 | âŒ å¦ |
| 14 | è‘› | teacher | 0 | 5 | âŒ å¦ |
| 15 | å¼ ä¸‰ | sales | 0 | 0 | âœ… æ˜¯ |
| 16 | æå›› | sales | 0 | 0 | âœ… æ˜¯ |
| 17 | ç‹äº” | teacher | 0 | 0 | âœ… æ˜¯ |
| 18 | èµµå…­ | teacher | 0 | 0 | âœ… æ˜¯ |
| 19 | é’±ä¸ƒ | sales | 0 | 0 | âœ… æ˜¯ |

---

## ğŸ‰ æ€»ç»“

### ä¿®å¤å†…å®¹

- âœ… ä¿®å¤äº†ç”¨æˆ·åˆ é™¤åŠŸèƒ½çš„ä»£ç é”™è¯¯
- âœ… ç§»é™¤äº†ä¸å­˜åœ¨çš„ `customers_as_sales` å…³ç³»å¼•ç”¨
- âœ… ä¿ç•™äº†æ­£ç¡®çš„å…³è”æ•°æ®æ£€æŸ¥é€»è¾‘

### åŠŸèƒ½éªŒè¯

- âœ… å¯ä»¥æˆåŠŸåˆ é™¤æ²¡æœ‰å…³è”æ•°æ®çš„ç”¨æˆ·
- âœ… æ­£ç¡®é˜»æ­¢åˆ é™¤æœ‰å…³è”æ•°æ®çš„ç”¨æˆ·
- âœ… æ­£ç¡®é˜»æ­¢åˆ é™¤å½“å‰ç™»å½•ç”¨æˆ·
- âœ… è‡ªåŠ¨æ¸…ç†ç™»å½•æ—¥å¿—

### æ•°æ®å®‰å…¨

- âœ… åˆ é™¤å‰æ£€æŸ¥å…³è”æ•°æ®
- âœ… é˜²æ­¢è¯¯åˆ æœ‰ä¸šåŠ¡æ•°æ®çš„ç”¨æˆ·
- âœ… äº‹åŠ¡å›æ»šæœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-09-30  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**ç³»ç»ŸçŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ


