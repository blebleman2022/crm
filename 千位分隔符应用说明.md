# 千位分隔符功能实现说明

## 📋 功能概述

已实现两个主要功能：
1. **付款明细弹窗**：线索列表页点击合同金额可查看付款明细
2. **千位分隔符**：所有金额显示增加千位分隔符格式化

---

## ✅ 已完成的修改

### 1. 后端修改

#### `run.py` - 添加千位分隔符过滤器

```python
# 添加千位分隔符过滤器
@app.template_filter('format_currency')
def format_currency(value):
    """格式化货币，添加千位分隔符"""
    if value is None:
        return '-'
    try:
        # 转换为浮点数
        num = float(value)
        # 格式化为带千位分隔符的字符串，保留2位小数
        return '{:,.2f}'.format(num)
    except (ValueError, TypeError):
        return value
```

**使用方法**：
```html
{{ lead.contract_amount|format_currency }}
```

**输出示例**：
- 输入：`50000` → 输出：`50,000.00`
- 输入：`1234567.89` → 输出：`1,234,567.89`

#### `routes/leads.py` - 添加付款明细API

新增路由：`/leads/<int:lead_id>/payments`

**功能**：
- 获取指定线索的付款明细
- 返回合同金额、已付金额、未付金额和付款记录列表
- 权限控制：销售人员只能查看自己负责的线索，销售管理可以查看所有

**返回数据格式**：
```json
{
  "success": true,
  "lead": {
    "id": 1,
    "student_name": "张三",
    "parent_wechat_display_name": "张妈妈",
    "contract_amount": 50000.00,
    "total_paid": 30000.00,
    "unpaid": 20000.00
  },
  "payments": [
    {
      "id": 1,
      "payment_date": "2025-01-01",
      "amount": 20000.00,
      "payment_notes": "首付款"
    },
    {
      "id": 2,
      "payment_date": "2025-01-15",
      "amount": 10000.00,
      "payment_notes": "第二笔"
    }
  ]
}
```

### 2. 前端修改

#### `templates/leads/list.html` - 线索列表页

**修改1：合同金额显示**
```html
<!-- 修改前 -->
<span class="font-medium text-green-600">¥{{ "%.0f"|format(lead.contract_amount) }}</span>

<!-- 修改后 -->
<button type="button" 
        onclick="showPaymentDetails({{ lead.id }})"
        class="font-medium text-green-600 hover:text-green-800 hover:underline cursor-pointer">
    ¥{{ lead.contract_amount|format_currency }}
</button>
```

**修改2：添加付款明细弹窗**
- 弹窗显示合同金额、已付金额、未付金额统计
- 显示学员和家长信息
- 显示付款记录表格
- 所有金额使用千位分隔符格式化

**修改3：添加JavaScript函数**
- `formatCurrency(value)` - 前端格式化货币函数
- `showPaymentDetails(leadId)` - 显示付款明细弹窗
- `hidePaymentDetails()` - 隐藏付款明细弹窗

---

## 🔧 需要继续应用千位分隔符的文件

以下文件中涉及金额显示，建议应用千位分隔符：

### 高优先级

1. **`templates/leads/edit.html`**
   - 合同金额显示
   - 已付金额显示
   - 未付金额显示
   - 付款记录表格中的金额

2. **`templates/leads/dashboard.html`**
   - 仪表板统计数据中的金额

3. **`templates/admin/leads.html`**
   - 管理员线索列表中的合同金额

### 中优先级

4. **`templates/customers/*.html`**
   - 客户管理相关页面的金额显示

5. **`templates/delivery/*.html`**
   - 交付管理相关页面的金额显示

6. **`templates/consultations/*.html`**
   - 咨询管理相关页面的金额显示

---

## 📝 应用千位分隔符的步骤

### 方法1：使用Jinja2过滤器（推荐）

在模板中查找所有金额显示，替换为：

```html
<!-- 修改前 -->
¥{{ "%.2f"|format(amount) }}
¥{{ "%.0f"|format(amount) }}

<!-- 修改后 -->
¥{{ amount|format_currency }}
```

### 方法2：使用JavaScript格式化

对于动态生成的内容，使用JavaScript函数：

```javascript
function formatCurrency(value) {
    if (value === null || value === undefined) return '0.00';
    return parseFloat(value).toLocaleString('zh-CN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// 使用
element.textContent = '¥' + formatCurrency(amount);
```

---

## 🎯 权限说明

### 付款明细查看权限

| 角色 | 权限 |
|------|------|
| **销售管理** | 可查看所有线索的付款明细 |
| **销售人员** | 只能查看自己负责的线索的付款明细 |
| **管理员** | 通过管理员专用页面查看 |
| **班主任** | 无权限 |

---

## 🚀 部署说明

### 服务器更新命令

```bash
cd ~/crm
git pull origin master
sudo systemctl restart crm
```

### 测试步骤

1. **测试付款明细弹窗**
   - 登录销售管理或销售人员账号
   - 进入线索列表页面
   - 点击任意有合同金额的线索的金额数字
   - 应该弹出付款明细窗口

2. **测试千位分隔符**
   - 检查线索列表页的合同金额显示
   - 应该显示为：¥50,000.00 格式

3. **测试权限**
   - 销售人员登录，尝试查看其他销售负责的线索付款明细
   - 应该提示无权限

---

## 📊 提交记录

**提交**: 9513dd2  
**分支**: master / main  
**仓库**: Gitee ✅ | GitHub ✅

**提交信息**:
```
feat: 添加付款明细弹窗和千位分隔符功能

- 添加format_currency过滤器用于格式化货币显示
- 线索列表页合同金额可点击查看付款明细弹窗
- 销售管理具备所有线索的付款明细查看权限
- 付款明细弹窗显示合同金额、已付金额、未付金额和付款记录
- 所有金额显示增加千位分隔符
```

---

## 🔍 后续优化建议

1. **批量应用千位分隔符**
   - 使用脚本批量替换所有模板中的金额显示
   - 确保所有页面的金额格式统一

2. **性能优化**
   - 考虑缓存付款明细数据
   - 对于大量付款记录，添加分页功能

3. **用户体验优化**
   - 添加加载动画
   - 添加错误提示优化
   - 支持键盘ESC关闭弹窗

---

**文档创建时间**: 2025-01-02  
**最后更新**: 2025-01-02

